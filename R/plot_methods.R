#' Get species from nodes
#' @param list 
#'
#' @details By convention the node naming scheme is set as the following:
#'  species_code + _ + class_nb. This function is just a wrapper around
#'  extract_all().
#'
get_species <- function(node_list) {

  species_resource_list <- stringr::str_extract_all(
    node_list, "[A-Za-z]+", simplify = TRUE)

  species_resource_list

}

#' Colours species 
#'
#'  
#' @inheritParams set_layout_graph a object generated by build_metaweb
#'
#' @return a colour scale 
set_color_species <- function (node_list = NULL, species_list = NULL,  resource_list = NULL,
  col_resource = NULL) {
  # Extract species
  if (is.null(species_list)) {
    sp_list <- stringr::str_extract_all(
      node_list, "[A-Z]+", simplify = TRUE) %>%
    as.vector %>%
    unique
    sp_list <- sp_list[sp_list != ""]
  } else {
    regex_pattern <- paste0(species_list, collapse = "|")
    sp_list <- stringr::str_extract_all(
      node_list, regex_pattern, simplify = TRUE) %>%
    as.vector %>%
    unique
    # Remove empty names
    sp_list <- sp_list[sp_list != ""]
  }
  # get hue color
  gg_color_hue <- function(n) {
    hues = seq(0, 360, length = n + 1)
    hcl(h = hues, l = 65, c = 100)[1:n]
  }
  species_color <- gg_color_hue(length(sp_list))
  names(species_color) <- sp_list

  #Resource:
  if (is.null(resource_list)) {
    resource_list <- stringr::str_extract_all(
      node_list, "[a-z]+", simplify = TRUE) %>%
    as.vector %>%
    unique
    # Remove empty names
    resource_list <- resource_list[resource_list != ""]
  }
  if (is.null(col_resource)) {
    col_resource <- "#CCCCCC"
  }
  resource_color <- rep(col_resource, length(resource_list))
  names(resource_color) <- resource_list
  c(species_color, resource_color)
}
my_crap_temporal_network <- function (net = NULL, metaweb = parent.frame()$meta$metaweb, network_data = parent.frame()$network_analysis, ...) {

net_list <- net %>%
  select(date, from, to) %>%
  arrange(date) %>%
  group_by(date) %>%
  nest(.key = "network")

try(
size_analysis <- network_data %>%
  select(opcod, composition) %>%
  filter(opcod %in% net$opcod) %>%
  unnest() %>%
  left_join(select(net, date, opcod) %>%
  distinct(opcod, date)) %>%
  select(date, biomass, species) %>%
  arrange(date) %>%
  group_by(date) %>%
  nest() %>%
  mutate(biomass = map(data, function(x){
      val <- x$biomass
      names(val) <- x$species
      val
  }))
)
net_list %<>%
  left_join(select(size_analysis, date, biomass))
#Node position:
node <- net_list$network %>% unlist(., use.names = FALSE) %>% unique
try(
test <- graph_from_adjacency_matrix(metaweb) %>% 
  igraph::as_data_frame(.) %>%
  mutate_all(list(~str_extract_all(., "[a-zA-Z]+", simplify = TRUE))) %>%
  distinct(from, to)
)
node_position <- create_layout(graph_from_data_frame(test), layout = "kk")$x
names(node_position) <- create_layout(graph_from_data_frame(test), layout = "kk")$name
#color:
color <- set_color_species(node_list = node, species_list = NULL,
  resource_list = NULL,
  col_resource = NULL)

plot_temporal_network(
  data = net_list,
  net_var = network,
  date = date,
  x = node_position,
  y = net_list[["y"]],
  size = net_list[["biomass"]]
)
}

#' Temporal graph for a station
#'
#' @param net data.frame contaning date variable and network list
#' @param meta an object created by build_metaweb
#' @param dead character vector indicating which node are basal
#' @param x named vector of node x position
#' @param y list of named vector of node vertical position
#' @param ... optional parameters for set_layout_graph  
#' @return a plot_grid object 
#' @seealso set_layout_graph
#' 
plot_temporal_network <- function(data = NULL, net_var = NULL, date = NULL,
  y = NULL, x = NULL, size = NULL, color = NULL, ...){

  net_var <- rlang::enquo(net_var)
  net_var_chr <- rlang::quo_name(net_var)
  date_var <- rlang::enquo(date)
  date_var_chr <- rlang::quo_name(date_var)

  if (is.null(color)) {
  # Get species_resource list
  species_resource_list <- purrr::map(data[[net_var_chr]], function(net) {
    if (any(class(net) == "data.frame")) {
      net <- igraph::graph_from_data_frame(net, directed = TRUE)
    } else if (any(class(net) == "matrix")) {
      net <- igraph::graph_from_adjacency_matrix(net, mode = "directed")
    } else {
      stopifnot(any(class(net) == "igraph"))
    }
    attr(V(net), "name")
      }) %>%
  unlist(., use.names = FALSE) %>%
  unique
  color <- set_color_species(species_resource_list)
  }

  for (i in 1:nrow(data)) {
    data[[net_var_chr]][[i]] <- set_layout_graph(
      net = data[[net_var_chr]][[i]],
      y = y[[i]],
      title = data[[date_var_chr]][[i]],
      biomass = size[[i]],
      x = x,
      color_scale = color
    )
  }
  #data %<>% mutate(
  #!!net_var := purrr::pmap(
    #list(
      #net = !!net_var,
      #y = y,
      #title = !!date_var,
      #biomass = size),
    #set_layout_graph, x = x,
      #color_scale = color
    #)
  #)
    species_colour_legend <- cowplot::get_legend(
      data[[net_var_chr]][[1]] +
    scale_color_manual(values = color, limits = names(color)) +
    labs(colour = "Species", size = "Biomass") +
    guides(
      colour = guide_legend(nrow = 3, byrow = TRUE, title.position = "left"),
      size = guide_legend(nrow = 1, byrow = TRUE, title.position = "left")
    ) +
    theme(legend.direction = "vertical", 
        legend.position = "bottom",
	legend.box = "horizontal")
  )

  ## Remove legend in the other plots
  data %<>%
    mutate(
      !!net_var := map(!!net_var, function (x) {
    x + theme(legend.position = "none",
      plot.margin = unit(c(0, 0, 0, 0), "cm"))
    })
    )
  p <- cowplot::plot_grid(plotlist = data[[net_var_chr]])
  cowplot::plot_grid(p, species_colour_legend, nrow = 2, rel_heights = c(1, 0.2))
}

#' Generate ggraph with a common layout
#'
#'  
#' @param net: data.frame describing edges 
#' @param glay a layout objet created by create_layout
#' @param title chr
#'
#' @return a ggraph object
set_layout_graph <- function (net = NULL, glay = NULL, x = NULL, y = NULL, title = NULL, biomass = NULL, color_scale= NULL, dead_material = NULL) {

  if (any(class(net) == "data.frame")) {
    net <- graph_from_data_frame(net, directed = TRUE)
  } else if (any(class(net) == "matrix")) {
    net <- graph_from_adjacency_matrix(net, mode = "directed")
  } else {
    stopifnot(class(net) == "igraph")
  }

  if (is.null(glay)) {
    # for species network:
    llay <- ggraph::create_layout(net, layout = "kk")
    node_pos <- NetIndices::TrophInd(as_adjacency_matrix(net, sparse = FALSE), Dead = dead_material)$TL - 1
    llay$y <- node_pos
    llay$species <- get_species(llay$name)
  } else {
    # get node coord from the general:
    node_names <- attr(V(net), "name")
    coord <- filter(glay, name %in% node_names) %>%
      mutate(name = as.character(name))
    # local layout:
    llay <- ggraph::create_layout(net, layout = "kk")
    saved_graph <- attr(llay, "graph")
    saved_circular_attr <- attr(llay, "circular")
    saved_class <- class(llay)
    llay <- select(llay, -x, -y) %>%
      mutate(name = as.character(name)) %>%
      left_join(., coord, by = "name") %>%
      select(x, y, everything())
    attr(llay, "graph") <- saved_graph
    attr(llay, "circular") <- saved_circular_attr
    class(llay) <- saved_class
  }

  node_names <- as.character(llay$name)
  if (!is.null(y)) {

    ## sp to change values:
    mask_y <- names(y) %in%  node_names
    mask_sp <- node_names %in% names(y)
    sp_to_change <- node_names[mask_sp]
    y_to_change <- y[mask_y]
    ## Reorder the two vector
    llay$y[mask_sp][order(factor(sp_to_change))] <- y_to_change[order(factor(names(y_to_change)))]
  }
  if (!is.null(x)) {
    stopifnot(!any(is.null(names(x))))
    x <- x[names(x) %in% node_names]
    llay$x[order(factor(node_names))] <- x[order(factor(names(x)))]
  }
  if (!is.null(color_scale)) {
    if (any(!node_names %in% names(color_scale))) {
      missing_color <- node_names[!node_names %in% names(color_scale)]
      cat("The following nodes do not have defined color: ",
	  missing_color, "They have been replaced by gray color.\n")
      color_to_add <- rep("#CCCCCC", length(missing_color))
      names(color_to_add) <- missing_color
      color_scale <- c(color_scale, color_to_add)
    }
  }
  p <- ggraph::ggraph(llay) +
    ggraph::geom_edge_fan(aes(alpha = ..index..), show.legend = FALSE)
  if (!is.null(biomass)) {
    stopifnot(all(names(biomass) %in% node_names))
    dataset <- p$data
    biomass <- biomass[names(biomass) %in% node_names]
    mask_sp <- dataset$name %in% names(biomass)

    dataset$biomass <- numeric(nrow(dataset))
    dataset$biomass[mask_sp][order(factor(dataset$name[mask_sp]))] <-
      biomass[order(factor(names(biomass)))]
    dataset$biomass[!mask_sp] <- 10

  }
  if (!is.null(title)) {
    p <- p + labs(title = title)
  }
  p <- p + ggraph::theme_graph(
    foreground     = "steelblue",
    fg_text_colour = "white",
    base_family    = "sans",
    background     = NA
  )
  if (!is.null(color_scale) & !is.null(biomass)) {
    p <- p +
      ggraph::geom_node_point(data = dataset, aes(x = x, y = y, size = biomass,
	  color = species)) +
      scale_color_manual(values = color_scale, limits = names(color_scale))
  } else if (!is.null(color_scale) & is.null(biomass)) {
    p <- p +
      ggraph::geom_node_point(aes(color = species)) +
      scale_color_manual(values = color_scale, limits = names(color_scale))
  } else if (is.null(color_scale) & is.null(biomass)) {
    p <- p +
      ggraph::geom_node_point()
  } else if (is.null(color_scale) & !is.null(biomass)) {
    p <- p +
      ggraph::geom_node_point(data = dataset,
	aes(x = x, y = y, size = biomass))
  }
  p

}

#' Personal plot theme
#'
#' @details This theme was design from the theme developped in the hrbrthemes
#' package: https://github.com/hrbrmstr/hrbrthemes 
#' @return a ggplot theme
theme_alain <- function(){

  hrbrthemes::theme_ipsum_rc() +
  theme(#Whipe
    text = element_text(family = "Helvetica", hjust = .5),
    axis.title = element_text(family = "Helvetica", hjust = .5, face = "bold", size = 10),
    plot.title = NULL,
    axis.title.x = NULL,
    axis.title.y = NULL,
    axis.text.x = NULL,
    axis.text.y = NULL,
    strip.text = NULL) +
  theme(#Set up
    plot.title = element_text(family = "Helvetica", hjust = .5, face = "bold", size = 10),
    axis.title.y = element_text(angle = 90, face = "bold"),
    axis.title.x = element_text(face = "bold"),
    axis.text = element_text(size = 8),
    strip.text = element_text(size = 8),
    plot.margin = unit(c(.5, .5, .5, .5), "cm")
    )
}
xylabs <- function (...) {
  dots <- pryr::named_dots(...)
  dots <- map(dots, eval) %>% unlist

  lab_list <- list(
    del = expression(bold(paste("Fraction of global dispersal (", delta, ")"))),
    biomass_cv = paste("CV of biomass"),
    biomass_stab = paste("Stability of Biomass"),
    biomass_avg = paste("Average biomass (g)"),
    network_med = paste("Median of network metrics"),
    nbnode = paste("Number of nodes"),
    richness = paste("Species richness"),
    richness_cv = paste("CV of richness"),
    richness_avg = paste("Average richness"),
    richness_avg = paste("Median richness"),
    connectance = paste("Connectance"),
    connectance_avg = paste("Average connectance"),
    connectance_med = paste("Median connectance"),
    connectance_cv = paste("CV of connectance"),
    diversity = paste("Diversity")
    )
  
  lab_used <- lab_list[dots]
  names(lab_used) <- names(dots)

  labs(
    x = lab_used["x"][[1]],
    y = lab_used["y"][[1]]
    )
}

#' Plot dynamic of biomass by station
#'
#' @param sync data.frame e.g. synchrony dataset, output from get_sync_cv_mat()
#' @param station id of station
#' @param .log logical transform biomass in log (e.g. log10())
plot_dyn_sp_biomass <- function (sync = NULL, station = NULL, .log = FALSE) {

  sync <- sync[sync$station == station, ] 

  .data <- sync$data[[1]]

  main_title <- paste0("Stab = ", round(1/(sync$cv_com), 2),", ", "Sync = ",
    round(sync$synchrony, 2),", ", "CVsp = ", round(sync$cv_sp, 2))
  
  p <- .data %>%
    mutate(label = if_else(date == max(date), as.character(species), NA_character_)) %>%
  ggplot(aes(x = date, y = biomass, colour = species)) + 
  geom_line(aes(linetype = as.factor(troph_group))) + 
  labs(y = "Biomass (g)", x = "Sampling date",
  title = main_title, subtitle = paste0("Station: ", station)) +
  ggrepel::geom_label_repel(aes(label = label),
                  nudge_x = 1,
                  na.rm = TRUE)

  #p <- ggplot(.data,
    #aes(x = date, y = biomass, color = species)) +
    #geom_line(aes(linetype = as.factor(troph_group))) +
    #labs(y = "Biomass (g)", x = "Sampling date",
      #title = main_title, subtitle = paste0("Station: ", station)
    #)

    if (.log) {
      p <- p + scale_y_log10() 
    }

  return(p)
}

###############
#  Labellers  #
###############

mylabel <- function() {
  ggplot2::as_labeller(c(
    connectance = "Connectance",
    connectance_corrected_med = "Median connectance",
    connectance_corrected = "Connectance (corrected)",
    richness = "Species richness",
    max_troph_level = "Highest trophic level",
    mean_troph_level = "Average trophic level",
    mean_troph_level = "Average trophic level",
    mean_troph_level_corrected = "Average trophic level (corrected)",
    mean_troph_level_med = "Median average trophic level",
    mean_troph_level_corrected_med = "Median average trophic level",
    w_troph_lvl_corrected = "Weighted average trophic level (corrected)",
    w_troph_lvl = "Weighted average trophic level",
    modularity = "Modularity",
    modularity_corrected = "Modularity corrected",
    nestedness = "Nestedness",
    nbnode = "Number of nodes",
    nbnode_med = "Median number of nodes",
    richness_cv = "richness CV",
    richness_avg = "Average richness",
    richness_med = "Median richness",
    betadiv = "Beta-diversity",
    synchrony = "Synchrony",
    cv_sp = "Avg species CV",
    biomass_stab = "Biomass stability (1/CV)"
    #betadiv = expression(bold(paste(beta, "-diversity", sep = "")))
    #see https://stackoverflow.com/questions/35524202/as-labeller-with-expression-in-ggplot2-facet-wrap?rq=1
      )
    )
}

#' Troph group labeller
#' Returns a labeller for ggplot2
#' @param troph_class a object created by get_size_class function
#' @return a labeller for ggplot2
troph_group_labeller <- function (troph_class = NULL, round_lvl = 2) {

  if (is.null(troph_class)) {
    myload(trophic_class, dir = mypath("data"))
    troph_class <- trophic_class
  }
  troph_class %<>%
    dplyr::mutate(
      lower = paste("[", round(lower, round_lvl), sep = ""),
      upper = paste(round(upper, round_lvl), "]", sep = "")
      ) %>%
  tidyr::unite(bounds, lower, upper, sep = ";") %>%
  dplyr::rename(troph_group = class_id)

  bounds <- troph_class$bounds
  names(bounds) <- troph_class$troph_group
  as_labeller(bounds)

}
