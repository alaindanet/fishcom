## Stability of biomass

```{r}
myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
myload(temporal_network_metrics, dir = dest_dir)
myload(community_metrics, temporal_community_metrics, synchrony, op_analysis, dir = data_common)
myload(network_analysis, dir = mypath("data", "classes"))
myload(trophic_level, trophic_class, dir = mypath("data"))
myload(hab_type, habitat_pressure, dir = mypath("report"))
source(mypath("R", "synchrony.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "local_network_build.R"))
select <- dplyr::select
stab_div_troph <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) 
```

### Link biomass stability with community structure

```{r stab-div-mult, fig.dim = c(10, 7), fig.cap = "Link between the stability of biomass and diversity"}
biomass_com <- temporal_community_metrics %>%
  left_join(select(synchrony, station, synchrony, cv_sp)) %>%
  select(biomass_stab, synchrony, cv_sp, richness_cv, richness_med, betadiv) %>%
  gather(diversity, div_value, richness_med, richness_cv, betadiv) %>%
  gather(stability, stab_value, biomass_stab, synchrony, cv_sp)

formula <- y ~ x #needed for stat_poly_eq
qplot(div_value, stab_value, data =  biomass_com, geom = "point") +
  facet_grid(stability ~ diversity, labeller = mylabel(), scales = "free") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(x = "Diversity", y = "Stability component")
```



```{r stab-net, fig.cap = "Link between biomass stability and network structure (median)"}
# plot
avg_network <- temporal_network_metrics %>%
  select_at(vars(dplyr::matches("med|station")))
biomass_stab_station <- temporal_community_metrics %>%
  select(station, biomass_stab)
stab_biomass_net_avg <- left_join(avg_network, biomass_stab_station) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")

# TODO: think about not facetting (list of plots ?)
# Facet label:
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(stab_biomass_net_avg, aes(y = biomass_stab, x = values)) +
  geom_point() +
  facet_wrap(~ metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median of the network indices",
    y = "Biomass stability"
  )
p
```

```{r}
synchrony %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_med, y = 1/cv_com)) +
  geom_point() +
  geom_smooth(method = "auto") +
  facet_grid(cols = vars(hab_type))
```

```{r}
synchrony %>%
  gather(rich_type, richness, richness_tot, richness_med) %>%
  ggplot(aes(x = log10(richness), y = log10(1/cv_com))) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(rich_type))
```

### Stability by habitat type

```{r}
st_basin <- get_basin_station()
myload(region_polygon, dir = mypath("data"))
stab_div_basin <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  select(station, troph_group, biomass_stab, richness_avg) %>%
  left_join(st_basin, by = "station") %>%
  filter(!is.na(basin))

# By basin
p_stab_div_basin <- ggplot(stab_div_basin,
  aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
  facet_wrap(~basin, ncol = 4) +
  geom_point() +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
  )
# Total
p_stab_div_tot <-  ggplot(stab_div_basin,
  aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
  geom_point() +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
  )

plot_grid(p_stab_div_basin, p_stab_div_tot, nrow = 2)
```

```{r, fig.dim = c(8, 7)}
myload(biomass_ts_sax, dir = mypath("data"))
p_bbb_stab_div <- stab_div_basin %>%
  mutate(station = as.character(station)) %>%
  left_join(biomass_ts_sax[, c("station", "sax")], by = "station") %>%
  filter(sax == "bbb") %>%
  ggplot(aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
  geom_point() +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
  )

station_map <- get_basin_station(sf_obj = TRUE) %>%
  mutate(station = as.character(station)) %>%
  left_join(biomass_ts_sax[, c("station", "sax")], by = "station") %>%
  mutate(type = ifelse(sax == "bbb", "stable", "unstable")) %>%
  select(type)

p_bbb_map <- ggplot(region_polygon) +
  geom_sf() +
  geom_sf(data = station_map, aes(color = type))
#plot(station_map, pch = 16)

plot_grid(p_bbb_stab_div, p_bbb_map, ncol = 1)
```

```{r}
myload(habitat_pressure, dir = mypath("report"))
```

```{r bimod-stab-div, fig.dim = c(7, 16), fig.cap = "Relationship between stability and diversity by spliting dataset in two according to an environmental variable. The threshold for the dataset split is the median of the environmental variable."}
plot_bin_stab_div <- function (env = NULL) {

  habitat_pressure$env_bin <- ifelse(
    habitat_pressure[[env]] < median(habitat_pressure[[env]], na.rm = TRUE),
    "inf", "sup")
  habitat_pressure <- na.omit(habitat_pressure[, c("station", "env_bin")])
  habitat_pressure %>%
    left_join(stab_div_basin, by = "station") %>%
    ggplot(aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
    geom_point() +
    facet_grid(cols = vars(env_bin)) +
    stat_poly_eq(
      formula = y ~ x,
      eq.with.lhs = "italic(hat(y))~`=`~",
      aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
      parse = TRUE) +
    geom_smooth(method = "lm", formula = y ~ x) +
    ggplot2::scale_color_manual(
      labels = troph_group_labeller(),
      values = c("blue", "green", "red"),
      name = "Trophic level"
    ) +
  labs(title = env, x = "Average species richness", y = "Biomass stability") +
  theme(legend.position = "none")
}

#width_river_mean avg_depth_station_mean
env <- c("width_river_mean", "avg_depth_station_mean", "lat",
  "temperature_med", "flow_med", "d_source", "DBO_med", "nitrates_med")
mult_plot_stab_div_bin <- map(env, ~plot_bin_stab_div(env = .x))

plot_grid(plotlist = mult_plot_stab_div_bin, ncol = 2)
```

The relationship between stability and species diversity (Figure
\@ref(fig:bimod-stab-div)) seemed to work only in station far from the source
(which are deeper, hotter, wider, fig. \@ref(fig:pca-hab))). May be there are
difference in richness distribution.  


```{r}
plot_bin_rich_div <- function (env = NULL) {

  habitat_pressure$env_bin <- ifelse(
    habitat_pressure[[env]] < median(habitat_pressure[[env]], na.rm = TRUE),
    "inf", "sup")
  habitat_pressure <- na.omit(habitat_pressure[, c("station", "env_bin")])
  habitat_pressure %>%
    left_join(stab_div_basin, by = "station") %>%
    ggplot(aes(x = richness_avg, color = troph_group)) +
    geom_histogram() +
    facet_grid(cols = vars(env_bin)) +
    ggplot2::scale_color_manual(
      labels = troph_group_labeller(),
      values = c("blue", "green", "red"),
      name = "Trophic level"
    ) +
  labs(title = env, x = "Average species richness", y = "Frequency") +
  theme(legend.position = "none")
}

mult_plot_rich_div_bin <- map(env, ~plot_bin_rich_div(env = .x))
plot_grid(plotlist = mult_plot_rich_div_bin, ncol = 2)
```


```{r ang-map-bio, include = FALSE}
ang_bm <- network_analysis %>%
  left_join(select(op_analysis, opcod, station), by = "opcod") %>%
  unnest(composition) %>%
  mutate(species = str_extract(sp_class, "[A-Z]{1,3}")) %>%
  filter(species == "ANG") %>%
  group_by(station) %>%
  summarise(cv_biomass = sd(biomass) / mean(biomass),
    biomass = mean(biomass))
  
mult_plot_ang_env <- map(env, function(x) {

  habitat_pressure$env <- habitat_pressure[[x]]

  ang_bm %>%
    left_join(habitat_pressure[, c("station", "env")], by = "station") %>%
    ggplot(aes(x = env, y = biomass)) +
    geom_point() +
    stat_poly_eq(
      formula = y ~ x,
      eq.with.lhs = "italic(hat(y))~`=`~",
      aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
      parse = TRUE) +
    geom_smooth(method = "loess", formula = y ~ x) +
    scale_y_log10() +
    labs(x = x, y = "Average biomass of ANG (g)")

  })
plot_grid(plotlist = mult_plot_ang_env)
```

```{r, fig.dim = c(10, 5)}
myload(hab_type, dir = mypath("report"))
stab_div_basin %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(y = biomass_stab, x = richness_avg, color = troph_group)) +
  geom_point() +
  facet_grid(cols = vars(hab_type)) +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "Stability - Div by habitat type",
    x = "Average species richness (log10)", y = "Biomass stability (log10)")
```

```{r}
model_enrich_temp <- stab_div_basin %>%
  left_join(hab_type, by = "station") %>%
  left_join(habitat_pressure[,c("station", "temperature_med", "temperature_cv", "DBO_med", "DBO_cv")],
    by = "station") %>%
  na.omit() %>%
  group_by(troph_group, hab_type) %>%
  mutate(
    log_rich = log10(richness_avg),
    temp_res = resid(lm(temperature_med ~ log_rich)),
    dbo_res = resid(lm(DBO_med ~ log_rich)),
  ) %>%
  nest() %>%
  mutate(
    corel = map(data, function(x) {
      div_temp <- cor(x = x$richness_avg, y = x$temp_res, method = c("spearman"))
      div_dbo <- cor(x = x$richness_avg, y = x$dbo_res, method = c("spearman"))
      data.frame(div_temp = div_temp, div_dbo = div_dbo)
      }
     ),
    model = map(data, ~lm(log10(biomass_stab) ~
	log_rich  + log_rich:temp_res + log_rich:dbo_res + log_rich:temp_res:dbo_res, data = .x)),
    colinearity = map(model, ~enframe(car::vif(.x))),
    coefs = map(model, ~tidy(.x)),
    sumup = map(model, ~glance(.x))
  )

unnest(model_enrich_temp, coefs) %>%
  mutate_at(vars(estimate, std.error, statistic), ~round(., 2)) %>%
  rename(est = estimate, error = std.error,
    stat = statistic, grp = troph_group) %>%
  kable %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```

```{r}
unnest(model_enrich_temp, colinearity)

```

```{r}
stab_div_troph %>%
  select(station, troph_group, biomass_avg) %>%
  spread(troph_group, biomass_avg) %>%
  mutate(bm_h_m = `3` / (`3` + `2`)) %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = hab_type, y = bm_h_m)) +
  geom_boxplot() +
  labs(x = "Type of river", y = "Proportion of biomass in the high trophic group")
```

```{r}
div_troph_col <- stab_div_troph %>%
  select(station, troph_group, richness_avg) %>%
  spread(troph_group, richness_avg) 

stab_div_troph %>%
  select(station, troph_group, biomass_stab) %>%
  left_join(hab_type, by = "station") %>% 
  left_join(div_troph_col, by = "station") %>%
  ggplot(aes(x = `2`, y = `3`)) +
  geom_point(aes(size = log10(biomass_stab), color = log10(biomass_stab))) +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type))
```

## Temporal correlation between troph group biomass 

```{r}
#TODO: Update cor_troph_group 
myload(cor_troph, dir = mypath("data"))
cor_troph %>%
  left_join(stab_div_troph, by = "station") %>%
  ggplot(aes(y = log10(1/ biomass_cv), x = cor_troph, color = troph_group)) +
  geom_point()

cor_troph %>%
  left_join(stab_div_troph, by = "station") %>%
  ggplot(aes(y = cor_troph, x = log10(richness_tot), color = troph_group)) +
  geom_point()
```

TODO: may be that the altitude station misses the really big fishes that
stabilizes the communities. Look at dist of biomass (biomass avg by station and the shape of biomass dist).

```{r}
myload(network_metrics, dir = mypath("data", "classes"))
avg_troph_lvl <- network_metrics %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  filter(troph_group != 1) %>%
  arrange(opcod, troph_group) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(opcod, troph_group) %>%
  mutate(w_troph_lvl = troph_level * biomass / sum(biomass)) %>%
  summarise(avg_t_lvl = sum(w_troph_lvl))%>%
  left_join(select(op_analysis, opcod, station), by = "opcod") %>%
  group_by(station, troph_group) %>%
  summarise(avg_t_lvl = mean(avg_t_lvl))

avg_troph_lvl %>%
  left_join(select(stab_div_troph, station, troph_group, richness_avg), by = c("station", "troph_group")) %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_avg, y = avg_t_lvl)) +
  geom_point() +
  facet_grid(hab_type~troph_group) +
  stat_poly_eq(
    label.x = "right",
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x)
```

The stability of biomass is determined by the standard deviation and the average
biomass of the community.

```{r}
cv_bm_div_troph_grp <- temporal_network_metrics_classes %>% 
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(!is.na(troph_group) & troph_group != 1) %>%
  rename(bm_st = biomass_avg, div_st = richness_avg, cv_st = biomass_cv) %>%
  mutate(troph_group = as.factor(troph_group))
```

```{r}
cbt_sync_troph_without_ang <- network_analysis %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  rename(species = sp_class) %>%
  mutate(ang_logic = ifelse(!is.na(str_match(species, "ANG")[,1] == "ANG"),
      TRUE, FALSE)) %>%
  filter(troph_group != 1, ang_logic != TRUE) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(troph_group) %>%
  nest() %>%
  mutate(sync = map(data, ~get_sync_cv_mat(com_analysis = .x, op_analysis = op_analysis))) %>%
  unnest(sync) %>%
  mutate(sdt.dev = map_dbl(cov_mat, ~sqrt(sum(.x)))) %>%
  mutate(
    contrib = purrr::pmap(
      list(mat = com_mat, cv_com_tot = cv_com, cv_sp_tot = cv_sp, sync_tot = synchrony),
      ~compute_sp_contrib(mat = ..1, cv_com_tot = ..2, cv_sp_tot = ..3, sync_tot = ..4)),
    troph_sp_nb_med = map_dbl(com_mat, ~rowSums(.x != 0) %>% median),
    troph_sp_nb_avg = map_dbl(com_mat, ~rowSums(.x != 0) %>% mean)
      ) %>% 
  select(troph_group, station, synchrony, cv_sp, cv_com, sdt.dev, contrib,
    troph_sp_nb_avg, troph_sp_nb_med) %>%
  left_join(stab_div_basin, by = c("station", "troph_group"))
```

```{r stab-ang, fig.dim = c(10, 7)}
cbt_sync_troph_without_ang %>%
  mutate(stab_without_ang = 1/cv_com) %>%
  rename(stab_with_ang = biomass_stab) %>%
  filter(troph_group != 1) %>%
  select(station, troph_group, richness_avg, stab_with_ang, stab_without_ang) %>% 
  gather(stab_type, stab, stab_with_ang, stab_without_ang) %>%
  ggplot(aes(x = richness_avg, y = stab, color = troph_group)) +
  geom_point() +
  facet_grid(cols = vars(stab_type)) +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    )
```

### Decompose stability

```{r}
sync_troph <- network_analysis %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  mutate(species = str_extract(sp_class, "[A-Z]{1,3}")) %>%
  select(-sp_class) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(opcod, troph_group, species) %>%
  summarise(
    troph_level = sum(troph_level * biomass /sum(biomass)),
    biomass = sum(biomass)
  ) %>%
  group_by(troph_group) %>%
  nest() %>%
  mutate(sync = map(data, ~get_sync_cv_mat(com_analysis = .x, op_analysis = op_analysis))) %>% 
  unnest(sync)

cbt_sync_troph <- sync_troph %>%
  mutate(sdt.dev = map_dbl(cov_mat, ~sqrt(sum(.x)))) %>%
  mutate(
    contrib = purrr::pmap(
      list(mat = com_mat, cv_com_tot = cv_com, cv_sp_tot = cv_sp, sync_tot = synchrony),
      ~compute_sp_contrib(mat = ..1, cv_com_tot = ..2, cv_sp_tot = ..3, sync_tot = ..4)),
    troph_sp_nb_med = map_dbl(com_mat, ~rowSums(.x != 0) %>% median),
    troph_sp_nb_avg = map_dbl(com_mat, ~rowSums(.x != 0) %>% mean)
      ) %>% 
  select(troph_group, station, synchrony, cv_sp, cv_com, sdt.dev, contrib,
    troph_sp_nb_avg, troph_sp_nb_med) %>%
  left_join(select(temporal_community_metrics, station, richness_avg,
      biomass_avg), by = "station") %>%
  rename(bm_st = biomass_avg, div_st = troph_sp_nb_avg)
```


```{r sd-avg-div}
fit <- stat_poly_eq(
  formula = y ~ x,
  eq.with.lhs = "italic(hat(y))~`=`~",
  aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
  parse = TRUE)

ymax <- max(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
ymin <- min(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
p_bm <- cv_bm_div_troph_grp %>%
  ggplot(aes(y = bm_st, x = div_st)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  fit +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Average biomass (g).", x = "Species richness")

p_sd <- cbt_sync_troph %>%
  ggplot(aes(x = div_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  fit +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Species richness")

plot_grid(p_sd, p_bm, ncol = 1)
```
It seems that the relationship between the standard deviation and the number of
species saturates for 10 species in medium trophic group while it saturates at 7
for the high trophic group (Figure \@ref(fig:sd-avg-div)).

To get opposite stability-diversity relationships in the different trophic
group, it supposes that for medium trophic group, the avg biomass increases
faster than the biomass standard deviation with increasing species richness. And
the reverse for the high trophic group, i.e. that the standard deviation
increases faster than the average biomass.

A question: What are the determinant of the relationship beween avg/standard
deviation and the number of species?

```{r}
ymax <- max(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
ymin <- min(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
p_bm <- cv_bm_div_troph_grp %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(y = bm_st, x = div_st)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  fit +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Average biomass (g).", x = "Species richness")

p_sd <- cbt_sync_troph %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = div_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  fit +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Species richness")

plot_grid(p_sd, p_bm, ncol = 1)
```


```{r}
formula <- y ~ x #needed for stat_poly_eq
cbt_sync_troph %>%
  ggplot(aes(x = bm_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10() +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Average
      biomass (g)")
```

```{r, fig.dim = c(10, 10)}
u_hab <- unique(hab_type$hab_type)
p_test <- map(u_hab, function(x){
cbt_sync_troph %>%
  select(troph_group:cv_com) %>%
  left_join(stab_div_basin, by = c("station", "troph_group")) %>%
  left_join(hab_type, by = "station") %>%
  filter(hab_type == x) %>%
  gather(comp, stab, synchrony:cv_com) %>%
  ggplot(aes(x = richness_avg, y = stab)) +
  geom_smooth(method = "lm", se = FALSE) +
  stat_poly_eq(
    label.x = "right",
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(title = x, x = "Average species richness", y = "Stability component") +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  facet_grid(rows = vars(comp), cols = vars(troph_group), scales = "free_y")
      
      })
plot_grid(plotlist = p_test)
```

```{r, fig.dim = c(10, 7), include = FALSE}
synchrony %>%
  left_join(select(temporal_community_metrics, station), by =
    "station") %>%
  gather(comp, stab, synchrony:cv_com) %>%
  ggplot(aes(x = richness_med, y = stab)) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Species diversity", y = "Stability component") +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  facet_grid(rows = vars(comp), scales = "free_y")
```

#### Contribution

```{r cbt-top, fig.cap = "Contribution of species to the different facets of stability. Positive contribution values mean that the species contributes negatively to the metric."}
top_contrib_sp <- cbt_sync_troph %>%
  unnest(contrib) %>%
  group_by(station, troph_group) %>%
  mutate(cbt_cv_com_n = cbt_cv_com / sd(cbt_cv_com)) %>%
  group_by(troph_group, species) %>%
  summarise(
    avg_cbt_cv_com_n = mean(cbt_cv_com_n),
    avg_cbt_cv_com = mean(cbt_cv_com),
    avg_cbt_cv_sp = mean(cbt_cv_sp),
    avg_cbt_sync = mean(cbt_sync),
    avg_abs_cbt_cv_com = mean(abs(cbt_cv_com))
    ) %>%
  arrange(desc(abs(avg_cbt_cv_com_n))) %>%
  slice(1:10)

p_top_contrib_sp <- map(c(2, 3), function(x){

  mask <- top_contrib_sp$troph_group == x 
  top_sp <- unique(top_contrib_sp[mask,]$species)

  cbt_sync_troph %>%
    unnest(contrib) %>%
    group_by(station, troph_group) %>%
    mutate(cbt_cv_com_n = cbt_cv_com / sd(cbt_cv_com)) %>%
    filter(species %in% top_sp, troph_group == x) %>%
    gather(comp, contrib, cbt_cv_com_n, cbt_cv_com:cbt_sync) %>%
    ggplot(aes(y = contrib, x = species)) +
    geom_violin() +
    facet_grid(rows = vars(comp), scales = "free_y") +
    labs(title = x)
    })
plot_grid(plotlist = p_top_contrib_sp)
```

The figure \@ref(fig:cbt-top), left panel) shows that for the trophic group 2,
TRF, LOF and GOU were the species that contributes the most to the the CV of the
community and to its components (CVsp and synchrony). For the 3 trophic group
(Figure \@ref(fig:cbt-top), right panel), the TRF, ANG and CHE contribute the
most to stability and its facets. Interestingly, the contribution of the species
to the community CV were quite asymetric toward negative values, meaning that
species which contributes the most tend to stabilize more than destabilize
communities. The reason was that the variance of contribution decreases with
species diversity (Figure \@ref(fig:var-cbt)), meaning that each species
contributes less and less. Two reasons might explain that: (1) the biomass
distribution of communities became more even with the increase of species
number, (2) the population stability converges.  Apparently the eveness of
biomass distribution does not change with species diversity (figure
\@ref(fig:even-sdcv-div), A). And the standard deviation of species CV decreases
with species richness (figure
\@ref(fig:even-sdcv-div), A).


```{r var-cbt, fig.dim = c(10, 7)}
var_cbt <- cbt_sync_troph %>%
  unnest(contrib) %>%
  group_by(troph_group, station) %>%
  summarise(
    var_cbt_cv_com = var(cbt_cv_com),
    var_cbt_cv_sp = var(cbt_cv_sp),
    var_cbt_sync = var(cbt_sync)
    ) %>%
  gather(comp, contrib, var_cbt_cv_com:var_cbt_sync) %>%
  left_join(select(stab_div_basin, station, troph_group, richness_avg),
    by = c("station", "troph_group"))

  var_cbt %<>%
    nest() %>%
    mutate(plot = map2(data, troph_group, function(.data, m_title){
	.data %>%
	ggplot(aes(y = contrib, x = richness_avg)) +
	  geom_point() +
	  scale_x_log10() +
	  facet_grid(rows = vars(comp), scales = "free_y") +
	  labs(title = paste0(m_title))
}
    )
    )
plot_grid(plotlist = var_cbt$plot, ncol = 2)
```

#### Statistical averaging

```{r eveness-div}
pielou <- network_analysis %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  mutate(species = str_extract(sp_class, "[A-Z]{1,3}")) %>%
  select(-sp_class) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(opcod, troph_group, species) %>%
  summarise(
    troph_level = sum(troph_level * biomass /sum(biomass)),
    biomass = sum(biomass)
  ) %>%
  group_by(troph_group, opcod) %>%
  mutate(rel_bm = biomass / sum(biomass)) %>%
  summarise(
    richness = n(),
    shannon = vegan::diversity(biomass, index = "shannon"),
    pielou = shannon / log(n())
  )

p_pielou <- pielou %>%
  left_join(select(op_analysis, station, opcod), by = "opcod") %>%
  group_by(station, troph_group) %>%
  summarise(richness_avg = mean(richness), pielou_med = median(pielou)) %>%
  left_join(hab_type, by = c("station")) %>%
  ggplot(aes(x = richness_avg, y = pielou_med, color = hab_type)) +
  #scale_x_log10() +
  geom_point() +
  facet_grid(~troph_group) +
  stat_poly_eq(
    label.x = "right",
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "loess", formula = y ~ x, se = FALSE) +
  labs(x = "Avg species richness", y = "Avagerage evenness of biomass")

p_pielou
```

```{r even-sdcv-div}
var_sp <- sync_troph %>%
  mutate(var_sp = map(var_sp, enframe)) %>%
  unnest(var_sp) %>%
  rename(species = name, var_bm = value) %>% 
  select(station, troph_group, species, var_bm)
avg_sp <- sync_troph %>%
  mutate(avg_sp = map(avg_sp, enframe)) %>%
  unnest(avg_sp) %>%
  rename(species = name, avg_bm = value) %>% 
  group_by(station, troph_group) %>%
  mutate(rel_bm = avg_bm / sum(avg_bm)) %>%
  ungroup() %>%
  select(station, troph_group, species, avg_bm, rel_bm)
cv_bm_sp <- left_join(avg_sp, var_sp, by = c("station", "troph_group", "species")) %>%
  mutate(cv = sqrt(var_bm) / avg_bm, var_bm = NULL) %>%
  rename(bm = avg_bm)

p_cv_sp_div <- map(unique(hab_type$hab_type), function(hab) {
    
var_sp %>%
  left_join(avg_sp, by = c("station", "troph_group", "species")) %>%
  left_join(hab_type, by = c("station")) %>%
  group_by(hab_type) %>%
  filter(rel_bm < .10, hab_type == hab) %>%
  ungroup() %>%
  mutate(cv_sp = sqrt(var_bm) / avg_bm,
    cv_sp_p = cv_sp * rel_bm) %>%
  gather(type, cv_sp, cv_sp, cv_sp_p) %>%
  left_join(select(stab_div_basin, station, troph_group, basin, richness_avg), by = c("station", "troph_group")) %>%
  ggplot(aes(x = richness_avg, y = cv_sp, color = species)) +
  geom_point() +
  #scale_y_log10() +
  facet_grid(cols = vars(troph_group), rows = vars(type), scales = "free_y") +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(x = "Average species richness", y = "Average species CV", title = hab) +
  theme(legend.position = "none")
    })

plot_grid(plotlist = p_cv_sp_div, nrow = 2)
```

```{r}
cv_sp_div_troph <- var_sp %>%
  left_join(avg_sp, by = c("station", "troph_group", "species")) %>%
  left_join(stab_div_basin[, c("station", "troph_group", "richness_avg")], by = c("station", "troph_group")) %>%
  mutate(
    cv_sp = sqrt(var_bm) / avg_bm,
    cv_sp_p = cv_sp * rel_bm
  )

m <- cv_sp_div_troph %>%
  gather(type, cv, rel_bm, cv_sp, cv_sp_p) %>%
  left_join(hab_type, by = c("station")) %>%
  group_by(troph_group, species, type, hab_type) %>%
  nest() %>%
  mutate(
    model = map(data, ~lm(cv ~ richness_avg, data = .x)),
    coeff = map(model, tidy)
  )

coefs <- m %>%
  unnest(coeff)

p_list <- map(unique(coefs$type), function (x) {
  filter(coefs, type == x, term == "richness_avg") %>%
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  facet_grid(cols = vars(hab_type), rows = vars(troph_group), scales = "free_x") + 
  geom_vline(xintercept = 0, color = "grey") +
  #geom_vline(xintercept = mean(estimate), color = "red") +
  labs(title = x)
  })

plot_grid(plotlist = p_list, labels = "AUTO")
```

```{r}
coefs %>%
  filter(term == "richness_avg", type == "rel_bm") %>%
  arrange((estimate))
  
```

```{r}
cv_sp_div_troph %>%
  group_by(station, troph_group) %>%
  summarise(avg_cv = mean(cv_sp), richness_avg = unique(richness_avg)) %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_avg, y = avg_cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type)) +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE)
```

```{r}
cv_sp_div_troph %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_avg, y = cv_sp_p)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type))
```

### Separate core and peripherical species

#### Species peripherical globally

```{r}
myload(occurence_sp_st, dir = mypath("report"))
myload(community_analysis, dir = data_common)

global_med_occ <- occurence_sp_st %>%
  dplyr::summarise_if(is.double, list(~median(., na.rm = TRUE))) %>%
  gather(sp, med_occ, everything())
```

Removing the peripherical species nor at the global scale neither at the station
scale do not affect the stability-diversity relationship. 

```{r stab-sp-occ, fig.dim = c(10, 7), fig.cap = "Relationship between biomass stability and species richness without peripherical species."}

threshold_occ <- c(0, .10, .30, .60, .90)
com_wo_per  <- map(threshold_occ, 
  ~rm_sp_from_com(com = community_analysis, sp_to_rm =
    global_med_occ[global_med_occ$med_occ < .x,]$sp))
names(com_wo_per) <- threshold_occ

res_sync_per <- map2_dfr(com_wo_per, names(com_wo_per), function (.data, .names) {

  sync <- compute_com_synchrony(
    .op = op_analysis,
    com = .data)
  sync$type <- .names 
  sync$biomass_stab <- 1 / sync$cv_com
  return(sync)

})

p_sync_global_per <- res_sync_per %>%
  ggplot(aes(x = richness_med, y = biomass_stab)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  facet_grid(cols = vars(type))

p_sync_global_per
```

```{r, fig.show = "hide"}
res_sync_per %>%
  select(richness_med, biomass_stab, synchrony, cv_sp, type) %>%
  gather(stab, value, biomass_stab, synchrony, cv_sp) %>%
  ggplot(aes(x = richness_med, y = value)) +
  geom_point() +
  geom_smooth(method = "auto") +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  facet_grid(cols = vars(type), rows = vars(stab), scales = "free_y")

```

#### Species peripherical by station 

```{r, fig.cap = "histogram of species occurence by station"}
hist(as.matrix(occurence_sp_st[, !names(occurence_sp_st) %in% "station"])) 
```

```{r, fig.dim = c(14, 14), fig.cap = "Histogram of species evaluation"}
occurence_sp_st[, !names(occurence_sp_st) %in% "station"] %>%
  gather(species, occurence) %>%
  ggplot(aes(x = occurence)) +
  geom_histogram() +
  geom_vline(data = rename(global_med_occ, species = sp, occurence = med_occ),
    aes(xintercept = occurence), color = "red") +
  facet_wrap(~species, scales = "free_y")
```


```{r stab-occ-st, fig.dim = c(10, 7), fig.cap = "Relationship between biomass stability and species richness without peripherical species."}


res_sync_occ_st <- map_dfr(c(threshold_occ, .99), function (.threshold) {
  # List of sp to rm
  sp_to_rm <- occurence_sp_st %>%
    gather(sp, occ, -station) %>%
    group_by(station) %>%
    filter(occ < .threshold) %>%
    summarise(sp2 = list(unique(sp)))

  # Rm species by station
  truncated_com <- community_analysis %>%
    left_join(select(op_analysis, opcod, station), by = "opcod") %>%
    filter(!is.na(station)) %>%
    group_by(station) %>%
    nest() %>%
    left_join(sp_to_rm, by = "station") %>%
    mutate(
      output = map2(data, sp2, function (.data, sp_vec) {
	rm_sp_from_com(com = .data, sp_to_rm = sp_vec)
  })
      ) %>%
  unnest(output) %>%
  select(-station)

  sync <- compute_com_synchrony(
    .op = op_analysis,
    com = truncated_com)

  sync$type <- .threshold 
  sync$biomass_stab <- 1 / sync$cv_com

  return(sync)
    }) 

p_sync_local_per <-  res_sync_occ_st %>%
  select(richness_tot, richness_med, biomass_stab, type) %>%
  gather(rich_type, richness, richness_med, richness_tot) %>%
  ggplot(aes(x = richness, y = biomass_stab)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  facet_grid(cols = vars(type), rows = vars(rich_type))
p_sync_local_per
```

The removal of peripheral species does not change the relationship between stability and species richness meaning that this relation is due to species present most of the time.


#### Remove most abundant species

```{r}
threshold_occ <- c(.50, .80, .90, 1)
com_wo_core  <- map(threshold_occ, 
  ~rm_sp_from_com(com = ungroup(community_analysis), sp_to_rm =
    global_med_occ[global_med_occ$med_occ > .x,]$sp))
names(com_wo_core) <- threshold_occ

res_sync_core <- map2_dfr(com_wo_core, names(com_wo_core), function (.data, .names) {

  sync <- compute_com_synchrony(
    .op = op_analysis,
    com = .data, presence_threshold = NA)
  sync$type <- .names 
  sync$biomass_stab <- 1 / sync$cv_com
  return(sync)

})

p_sync_global_core <- res_sync_core %>%
  ggplot(aes(x = richness_med, y = biomass_stab)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  facet_grid(cols = vars(type))

p_sync_global_core

```

#### Remove low richness 

```{r}
sync_rm <- map_dfr(seq(0, 10, 1),
  function (x)
    filter(synchrony, !richness_tot < x) %>%
      mutate(min_rich = x) 
)
sync_rm_res <- sync_rm %>%
  mutate(
    log_rich = log10(richness_med),
    log_stab = log10(1/cv_com)) %>%
  group_by(min_rich) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(log_stab ~ log_rich, .x)),
    coeff = map(model, broom::tidy),
    plot = map2(.x = data, .y = min_rich,
      ~ .x %>%
	ggplot(aes(x = richness_med, y = 1/cv_com)) +
	geom_point() +
	geom_smooth(method = "lm") +
	stat_poly_eq(
	  formula = y ~ x,
	  eq.with.lhs = "italic(hat(y))~`=`~",
	  aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
	  parse = TRUE) +
	labs(title = .y)
      )
  )
plot_grid(plotlist = sync_rm_res$plot)
```

```{r}
sync_rm_res %>%
  unnest(coeff) %>%
  rename(est = estimate, se = std.error) %>%
  filter(term == "log_rich") %>%
  ggplot(aes(y = est, x = min_rich)) +
  geom_point() +
  geom_errorbar(aes(ymin = est - 2 * se, ymax = est + 2 * se)) +
  geom_hline(yintercept = 0) +
  labs(y = "Slope of linear relationship between Biomass stability and median species richness ()")
```

In fact, the removal of low species station has an notable effect if the
richness cut was done on median richness. However, if total richness is
considered, the removal has far less effect.


### CV sp

```{r abun-sp, fig.dim = c(10, 7), fig.cap = "Species most abundant by trophic group."}
net_sp_troph <- select(network_analysis, opcod, composition) %>%
  unnest(composition)
# Get synchrony and cv sp:
sync_sp_troph <- get_sync_cv_mat(com_analysis = net_sp_troph, op_analysis = op_analysis)
# Sp the most abundant by group
bm_sp_troph_grp <- net_sp_troph %>%
  filter(!is.na(troph_group) & troph_group != 1) %>%
  group_by(troph_group, sp_class, opcod) %>%
  mutate(rel_biomass = biomass / sum(biomass)) %>%
  group_by(troph_group, sp_class) %>%
  summarise(sum_rel_bm = sum(rel_biomass), biomass = mean(biomass)) %>%
  arrange(desc(sum_rel_bm)) %>%
  slice(1:20)
  
p_bm <- map(c(2, 3), .f = function(x) {
  mylim <- sapply(c(min, max),
    FUN = function(x) x(bm_sp_troph_grp$biomass))

  .data <- bm_sp_troph_grp %>%
    filter(troph_group == x)
  if (x == 2) {
    tmp_title <- paste("Medium trophic group (2)")
  } else {
    tmp_title <- paste("High trophic group (3)")
  }

  ggplot(data = .data, aes(x = sp_class, y = biomass)) +
    geom_point() +
    labs(x = "Trophic species", y = "Biomass (g)", title = tmp_title) +
    ylim(mylim[1], mylim[2]) 

})
plot_grid(plotlist = p_bm, ncol = 2)
```

```{r}
# I need:
# - by species:
#   - CV
#   - Biomass 
# - by Trophic group:
#   - Species richness 
#   - CV
#   - biomass 

# Species 

## Variance by sp and station:
var_sp <- sync_sp_troph %>%
  select(station, var_sp) %>%
  mutate(var_sp = map(var_sp, ~enframe(.x))) %>%
  unnest(var_sp) %>%
  rename(species = name, var_sp = value)
## Average biomass by sp and station:
avg_sp <- sync_sp_troph %>%
  select(station, avg_sp) %>%
  mutate(avg_sp = map(avg_sp, ~enframe(.x))) %>%
  unnest(avg_sp) %>%
  rename(species = name, avg_sp = value)
## CV and biomass by sp and station  
cv_bm_sp <- left_join(avg_sp, var_sp, by = c("station", "species")) %>%
  mutate(cv = sqrt(var_sp) / avg_sp, var_sp = NULL) %>%
  rename(bm = avg_sp)

# By trophic group:

## CV, biomass and div (ALREADY DONE!)
```

#### Diversity is not all

```{r}
library(ade4)
library(factoextra)
myload(habitat_pressure, pca_pressure, dir = mypath("report"))
```

```{r}
div_troph_grp <- cv_bm_div_troph_grp %>%
  select(station, troph_group, cv_st) %>%
  spread(key = troph_group, cv_st) %>%
  rename(mid_cv = `2`, high_cv = `3`)

hab_press_div <- left_join(habitat_pressure,
  temporal_community_metrics[, c("station", "richness_med", "biomass_avg","biomass_stab")],
  by = "station") %>%
left_join(div_troph_grp, by = "station")
pca_hab <- dudi.pca(as.data.frame(select(pca_pressure, -station)), scannf = FALSE, nf = 5, center = TRUE, scale = TRUE)

supp_var <- pca_pressure %>%
  select(station) %>%
  left_join(select(temporal_community_metrics, station, biomass_stab,
      richness_med), by = "station")
#check
stopifnot(all(pca_pressure$station == supp_var$station))

pca_stab <- fviz_pca_biplot(
  pca_hab, geom = "point",
  col.ind = (supp_var$biomass_stab),
  pointsize = 2,
  gradient.cols = "RdYlBu",
) %>% 
ggpubr::ggpar(title = "Biomass stability")

pca_rich <- fviz_pca_biplot(
  pca_hab, geom = "point",
  col.ind = supp_var$richness_med,
  gradient.cols = "RdYlBu",
  pointsize = 2,
) %>% 
ggpubr::ggpar(title = "Species richness")
plot_grid(pca_stab, pca_rich)
```


#### CV sp VS CV group

There was a positive relationship between the species CV of the most abundant
species in the high trophic group and the CV of the same high trophic group
(Figure \@ref(fig:cv-sp-grp3), right panel). Interestingly, this relationship
is less clear (however clearly present for some species) for the most abundant
species in the medium trophic group (Figure \@ref(fig:cv-sp-grp2), right panel).

```{r cv-sp-grp3, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the CV of the different trophic groups"}
cv_sp_grp <- left_join(
  select(cv_bm_sp, -bm),
  select(cv_bm_div_troph_grp, -biomass_stab), by = c("station"))


sp_grp3 <- cv_sp_grp %>%
  filter(troph_group == 3) %>%
  arrange(desc(biomass))
  
u_troph <- unique(cv_sp_grp$troph_group) 
p_cv_abun_sp <- map(u_troph, function(x) {
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  filter(troph_group == u_troph) %>%
  ggplot(aes(x = cv_st, y = cv)) +
  geom_point() +
  facet_grid(rows = vars(species)) +
  labs(x = "CV of the trophic group", y = "CV of the species", title = u_troph)
  })
plot_grid(plotlist = p_cv_abun_sp)
```

```{r cv-sp-grp2, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the CV of the different trophic groups"}
sp_grp2 <- bm_sp_troph_grp %>%
  filter(troph_group == 2) %>%
  arrange(desc(biomass))
  
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = cv_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller =
    labeller(troph_group = troph_group_labeller())) +
  labs(x = "CV of the trophic group", y = "CV of the species")
```

#### CVsp versus Biomass by trophic group

```{r cv-sp-bm-grp3, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the biomass of the different trophic groups"}
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = bm_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller()),
    scales = "free_x") +
  labs(x = "Biomass of the trophic group (g)", y = "CV of the species")
```

```{r cv-sp-bm-grp2, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the biomass of the different trophic groups"}
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = bm_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller()),
    scales = "free_x") +
  labs(x = "Biomass of the trophic group (g)", y = "CV of the species")
```

#### CVsp versus diversity by trophic group

```{r cv-sp-div-grp3, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the species richness in the different trophic groups."}

cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = div_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "Species richness of the trophic group", y = "CV of the species")
```

```{r cv-sp-div-grp2, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the species richness in the different trophic groups."}
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = div_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "Species richness of the trophic group", y = "CV of the species")
```



### Map stability

```{r map-stab, fig.cap = "Repartition of average biomass and biomass stability (logged)."}
myload(station_analysis, region_polygon, dir = data_common)
stab <- temporal_community_metrics %>% 
  select(station, biomass_stab, biomass_avg)
station_stab <- left_join(station_analysis, rename(stab, id = station)) %>%
  filter(!is.na(biomass_stab))
map_stab <- ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_stab)), size = 4) +
    scale_color_gradient(low = "red", high = "green") +
    labs(title = "Biomass stability")

map_bm <- ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_avg)), size = 4) +
    scale_color_gradient(low = "red", high = "green") +
    labs(title = "Average biomass (g)")

plot_grid(map_stab, map_bm, ncol = 2)
```

Biomass stability was lower in south-west of France (Figure
\@ref{fig:map-stab}, left panel). Average fish biomass was lower in moutain
region (Pyrénées, Alps, Massif Central; Figure \@ref{fig:map-stab}, right
panel), generally close to the source.


```{r map-st, fig.dim = c(7, 15), fig.cap = "Repartition of the average biomass, biomass stability and species diversity by trophic group, respectively medium and high for the left and right panel. All the metrics were logged."}
tmp <- rename(cv_bm_div_troph_grp, id = station)
station_troph_div <- left_join(station_analysis, tmp, by = "id")

map_st_metrics <- purrr::map(c("bm_st", "div_st", "biomass_stab"), function (metric) {
  station_troph_div[[metric]] <- log10(station_troph_div[[metric]])
  ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_troph_div, aes_(color = as.name(metric)), size = 4) +
    facet_grid(cols = vars(troph_group)) +
    scale_color_gradient(low = "red", high = "green")
  
  })
plot_grid(plotlist = map_st_metrics, ncol = 1)
```

The biomass in both trophic groups were lower in moutain area (Figure
\@ref(map-st)), the same was true for species diversity. For stability, it is
difficult to see a pattern.




```{r stab-comp, fig.cap = "Link between biomass stability by trophic group and total species richness (median)"}
net_troph_group <- temporal_network_metrics_classes %>% 
  unnest(troph_group) %>%
  mutate(troph_group = as.factor(troph_group))
net_troph_group %<>%
  select_at(vars(dplyr::matches("_med|stab|station|troph_group"))) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", ""))
p <- ggplot(net_troph_group, aes(y = biomass_stab, x = values, color = troph_group)) +
  geom_point() +
  ggplot2::scale_fill_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  facet_wrap(~metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "network_med",
    y = "biomass_stab"
  )
p
```

The Figure \@ref(fig:stab-comp) showed that medium trophic level part of the
network had a positive stability-diversity relationship with while high
trophic level had a negative one.  
Furthermore, we see that high trophic level compartment had a highest stability
than the medium compartment. In the same vein, the latter pattern is confirmed
when looking at the richness by compartment instead of the total richness
(Figure \@ref(fig:stab-comp2)).  


```{r stab-comp2, fig.dim = c(10, 7), fig.cap = "Link between biomass stability and species richness by trophic group (median). (Classes network)"}
net_troph_group <- temporal_network_metrics_classes %>% 
  select(station, troph_group) %>%
  unnest() %>%
  filter(!is.na(troph_group)) %>%
  mutate(troph_group = as.factor(troph_group))
plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_stab"
  )
plot_stab_richness_troph_group
```
 
One hypothesis to explain this opposite pattern might be a disequilibrium
between the two compartment. We can imagine that each compartment can
destabilize each other according to the part of the total biomass of total
species richness that there are in each of them. The figure
\@ref(fig:stab-comp-ratio) showed that the biomass stability of the medium
compartment decreased with the increase of biomass and species number ratio in
the high compartment and we observed the reverse for the high trophic
compartment. It indicates that a trophic compartment is more stable when their
relative biomass increases. 

We are looking forward to fully understand why we observed this inverse
relationship.

```{r stab-comp-ratio, fig.cap = "Biomass stability and ratio of biomass and species number (top and bottom panel resp.) in the high trophic level (classes network) for the medium and high trophic group (resp. left and right panels)."}
ratio_sp <- net_troph_group %>%
  select(station, troph_group, richness_avg) %>%
  spread(troph_group, richness_avg) %>%
  mutate(sp_h_m = `3` / (`3` + `2`)) %>%
  select(station, sp_h_m)

ratio_bm <- net_troph_group %>%
  select(station, troph_group, biomass_avg) %>%
  spread(troph_group, biomass_avg) %>%
  mutate(bm_h_m = `3` / (`2` + `3`)) %>%
  select(station, bm_h_m)

ratio_bm %>%
  left_join(select(temporal_community_metrics, station, biomass_stab)) %>%
  ggplot(aes(x = bm_h_m, y = biomass_stab)) +
  geom_point() +
  scale_x_log10()

net_troph_group <- temporal_network_metrics_classes %>%
  left_join(ratio_sp, by = "station") %>%
  left_join(ratio_bm, by = "station") %>%
  select(station, troph_group, sp_h_m, bm_h_m) %>%
  unnest() %>%
  filter(!is.na(troph_group), troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  gather(ratio_troph, value, sp_h_m, bm_h_m)

plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = value)) +
  geom_point(aes(color = richness_avg)) +
  facet_grid(cols = vars(troph_group), rows = vars(ratio_troph), labeller =
    troph_group_labeller()) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    y = "biomass_stab"
  ) + 
    xlab("Ratio of biomass and species nb in high troph compartment compare to total")
plot_stab_richness_troph_group
```

## P1: Habitat and trophic group determine the shape of the stability-diversity relationship

What are the contributions of environment and trophic level on the shape of the stability-diversity relationship?

### Statistical Model

1. Stability total vs div + habitat 
2. Stability by trophic group vs diversity:trophic group:habitat
   - Random effects: catchement & # sampling years
   - Include composition in the analyses as [@sandau_including_2014]
3. SEM:
   - Paths:
     - Total Stability
     - Stability at trophic level 2 & trophic level 3
     - Diversity at trophic level 2 & trophic level 3
     - Altitude or PCA coordinates 
   - Groups: habitat 
   - Replicate for productivity
4. Test for different datasets
   - factorise calcultation of temporal metrics


## P2: Evt and network structure conjointly drives fonctioning and stability of fish communities


What are the contributions of the the environment and the structure of
the network on the functioning and the stability of the trophic network



### Piecewiese SEM

```{r}
library(lme4)
library(nlme)
library(piecewiseSEM)
```

#### Stability

```{r, fig.dim = c(10, 7), echo = FALSE, fig.cap = "SEM for stability"}
library(nlme)
library(piecewiseSEM)

st_basin <- get_basin_station()
myload(nmds, dir = mypath("report"))
myload(network_metrics, dir = mypath("data", "species"))
sp_network_metrics <- network_metrics
rm(network_metrics)
myload(network_metrics, dir = mypath("data", "classes"))
cl_network_metrics <- network_metrics
rm(network_metrics)

myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)

# Compute stability, network metrics, etc with the new datasets
source(mypath("R", "community_analysis.R"))
#debug(compute_community_temporal_analysis)
com_data <- compute_community_temporal_analysis(.op = op_analysis_bbb)
class_tps_net <- summarise_network_over_time(op = op_analysis_bbb,
class_network = cl_network_metrics,
species_network = sp_network_metrics,
metrics = c("connectance", "w_trph_lvl_avg"),
type_metrics = "classes")

# Compute sem dataset 
sem_data <- map(list(sp = com_data[["tps_net"]], cl = class_tps_net),
~compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = .x, 
  hab_press = habitat_pressure, 
  sync = com_data[["sync"]],
  nmds = NULL,
  basin = st_basin 
  )
)


# Compute SEMs
sem <- map(sem_data, ~compute_stab_sem_rich(.data = .x))

library(DiagrammeR)
sem_graph <- map2(
  sem,
  paste0(mypath("manuscript", "bef_stability"), "/", c("species", "class"), "_stab_sem"),
  function(x, path) {

  export_diagram(
    fit = x,
    file_path = path,
    format = "png",
    width = 700*2,
    height = 900*2  - 900*2*30/100,
    arrows = "ortho",
    val_thd = 0.05,
    env_x_pos_range = c(from = 0, to = 7.5),
    env_y_pos = 0,
    env_y_sep = 1.5,
    order_env_node = c("RC4", "log_RC3", "RC5", "log_RC1", "log_RC2")
  )


}
)
```

```{r, eval = FALSE, fig.cap = "The basic SEM"}
build_stab_sem <- function (evt = NULL, com = NULL, stab_comp = NULL, stab = NULL,  .data = NULL) {

  rs <- map(list(evt = evt, com = com, stab_comp = stab_comp), ~paste(.x, collapse = " + "))
  stab_eq <- paste(stab, rs[["stab_comp"]], sep = " ~ ")
  stab_comp_eq <- map_chr(stab_comp, ~ paste(.x, rs[["com"]], sep = " ~ "))
  com_eq <- map_chr(com, ~paste(.x, rs[["evt"]], sep = " ~ "))


  formulas <- map(c(stab_eq, stab_comp_eq, com_eq), as.formula)

  output <- vector("list", length = length(formulas))

  output[[1]] <- lm(as.formula(stab_eq), data = .data)

  lmer_models <- map(formulas[2:length(formulas)],~lme(fixed = .x, random = ~ 1 | basin, data = .data))
  lmer_models_c <- map2(lmer_models, formulas[2:length(formulas)],
    function (.model, .formula){
      .model$call$fixed <- as.call((.formula))
      return(.model)
  }) 

  output[2:length(output)] <- lmer_models_c
  return(output)

} 

#undebug(build_stab_sem)
corsem <- build_stab_sem(
  evt = c("alt", "width", "DBO_med", "temperature_med"),
  com = c("log_rich", "piel", "c_c", "t_lvl", "beta_bin_c"),
  stab_comp = c("log_sync", "log_cv_sp"),
  stab = c("log_stab"),
  .data = sem_data)

output <- summary(as.psem(corsem), .progressBar = F)
output$coefficients %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")

source(mypath("R", "plot_methods.R"))
ggpiecewisesem(output)
```
```{r, eval = FALSE}

car::vif(lme(log_sync ~ log_rich + piel + alt + c_c + t_lvl + beta_bin_c, random = ~ 1 | basin, data = lav_data))
car::vif(lme(log_sync ~ alt + width + temperature_med + DBO_med + flow_med, random = ~ 1 | basin, data = lav_data))
```


#### Sensivity to dataset

```{r sensitivity, fig.dim = c(10, 7), fig.cap = "Sensivity analysis with different dataset"}
myload(op_analysis, op_analysis_wo_holes, op_analysis_ov, dir = mypath("data"))
myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
op_analysis_cba <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "cba",]$station)
op_analysis_wo_holes_bbb <- filter(op_analysis_wo_holes, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
#library(future)
#plan(multiprocess)
#undebug(build_dataset_get_sem_coefficient)
#undebug(compute_community_temporal_analysis)
#undebug(summarise_network_over_time)
myload(network_metrics, dir = mypath("data", "classes"))
sem_sensivity_data <- list(full = op_analysis, cba = op_analysis_cba, bbb = op_analysis_bbb)
sem_stab_l_data <- furrr::future_map(sem_sensivity_data,
  ~build_dataset_get_sem_coefficient(
    .op = .x,
    sem_fun = compute_stab_sem_rich,
    dest_dir = mypath("data", "classes"))
)

# Nb station by dataset 
nb_station <- map_int(sem_sensivity_data, ~length(unique(.x$station))) 
 
sem_stab_results <- map(sem_stab_l_data,
  ~.x$coefficients[-ncol(.x$coefficients)]) %>%
  enframe() %>%
  rename(dataset = name) %>%
  unnest(value)

# Reformat
colnames(sem_stab_results) <- str_to_lower(colnames(sem_stab_results))
sem_stab_results %>%
  mutate(r_p = str_c(response, predictor, sep = "~")) %>%
  ggplot(aes(x = r_p, y = std.estimate)) +
  geom_point(aes(color = dataset)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, fig.dim = c(10, 5)}
p_sensitivity_stab_sem <- map(sem_stab_l_data, ggpiecewisesem)
p_sensitivity_stab_sem %<>% map2(., names(sem_sensivity_data),  ~ .x + labs(title = .y))
plot_grid(plotlist = p_sensitivity_stab_sem)
```

```{r}
sem_bm_l_data <- furrr::future_map(sem_sensivity_data,
  ~build_dataset_get_sem_coefficient(
    .op = .x,
    sem_fun = compute_prod_sem_rich,
    dest_dir = mypath("data", "classes"))
)
sem_bm_results <- map(sem_bm_l_data,
  ~.x$coefficients[-ncol(.x$coefficients)]) %>%
  enframe() %>%
  rename(dataset = name) %>%
  unnest(value)

# Reformat
colnames(sem_bm_results) <- str_to_lower(colnames(sem_bm_results))
sem_bm_results %>%
  mutate(r_p = str_c(response, predictor, sep = "~")) %>%
  ggplot(aes(x = r_p, y = std.estimate)) +
  geom_point(aes(color = dataset)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
p_sensitivity_bm_sem <- map(sem_bm_l_data, ggpiecewisesem)
p_sensitivity_bm_sem %<>% map2(., names(sem_sensivity_data),  ~ .x + labs(title = .y))
plot_grid(plotlist = p_sensitivity_bm_sem)
```


```{r}
p_op_analysis_protocol_bbb <- op_analysis_bbb %>%
  group_by(station) %>%
  slice(1) %>%
  ggplot(aes(x = protocol_type)) + 
  geom_histogram(stat ="count") +
  labs(title = "Station bbb")

p_op_analysis_protocol <- op_analysis %>%
  group_by(station) %>%
  slice(1) %>%
  ggplot(aes(x = protocol_type)) + 
  geom_histogram(stat ="count") +
  labs(title = "All stations")
plot_grid(p_op_analysis_protocol_bbb, p_op_analysis_protocol, ncol = 2)
```

```{r, eval = FALSE}
bootstrap_bbb <- map(seq(1,10),
  function(x) {

    sampled_st <- map(c(complete = "complete", partial = "partial"), function (y) {
      st_id <- unique(op_analysis_bbb[op_analysis_bbb$protocol_type == y,
	]$station)
      sample(x = st_id, size = 20, replace = FALSE)
    })

    op_analysis_bbb %>%
      filter(station %in% unlist(sampled_st))
  }
)
names(bootstrap_bbb) <- letters[1:10] 

bootstrap_sem <- map(c(bootstrap_bbb, list(full = op_analysis)),
  ~build_dataset_get_sem_coefficient(
    .op = .x,
    sem_fun = compute_stab_sem_rich_beta,
    dest_dir = mypath("data", "species"))
)

sem_results <- map(bootstrap_sem,
  ~.x$coefficients[-ncol(.x$coefficients)]) %>%
  enframe() %>%
  rename(dataset = name) %>%
  unnest(value)

# Reformat
colnames(sem_results) <- str_to_lower(colnames(sem_results))
sem_results %>%
  mutate(r_p = str_c(response, predictor, sep = "~")) %>%
  ggplot(aes(x = r_p, y = std.estimate)) +
  geom_point(aes(color = dataset)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r sampling-span-stab}
span_sampling <- op_analysis %>%
  group_by(station) %>%
  summarise(span = max(year) - min(year) + 1)

sem_data %>%
  left_join(span_sampling, by = "station") %>%
  ggplot(aes(x = span, y = biomass_stab)) +
  geom_point()
```


#### CV by basin

```{r}
st_basin %<>%
  mutate(basin = str_replace_all(basin, "RHIN|MEUSE", "RHIN MEUSE"))
sync_basin <- compute_synchrony_over_basin(com = community_analysis, basin = st_basin, .op = op_analysis)
sync_basin %>%
  filter(!is.na(basin)) %>%
  filter(!basin %in% c("ESCAUT SOMME", "MEUSE", "RHIN")) %>%
  ggplot(aes(x = richness_tot, y = 1/ cv_com, label = basin)) +
  geom_point() +
  geom_text(hjust = 0, nudge_x = 0.05) +
  labs(
    x = "Total richness", y = "Biomass stability",
    title = "Basin scale",
    caption = "Average biomass by species by year and by basin was taken to
    compute CV."
  )
```


#### Productivity


```{r, fig.cap = "Coefficients of the SEM of biomass"}

prod_sem <- compute_prod_sem_rich_beta(.data = sem_data)

prod_sem$coefficients %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```

```{r}
ggpiecewisesem(prod_sem)
```

```{r colin_prod, fig.cap = "Colinearity check for total biomass"}
car::vif(lme(prod ~ log_rich + piel + c_c + t_lvl + beta_bin_c + RC1 + RC2 + RC3 + RC4 + RC5, random = ~ 1 | basin, data = sem_data)) %>%
  enframe %>%
  kable
```

