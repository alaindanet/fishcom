## Stability of biomass

```{r}
myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
myload(temporal_network_metrics, dir = dest_dir)
myload(community_metrics, temporal_community_metrics, synchrony, op_analysis, dir = data_common)
myload(network_analysis, dir = mypath("data", "classes"))
myload( trophic_level, trophic_class, dir = mypath("data"))
myload(hab_type, dir = mypath("report"))
source(mypath("R", "synchrony.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "local_network_build.R"))
stab_div_troph <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) 
```

```{r}
synchrony %>%
  left_join(hab_type, by = "station") %>%
  left_join(select(temporal_community_metrics, station, richness_med), by = "station") %>%
  ggplot(aes(x = richness_med, y = 1/cv_com)) +
  geom_point() +
  geom_smooth(method = "auto") +
  facet_grid(cols = vars(hab_type))
```

```{r}
synchrony %>%
  left_join(hab_type, by = "station") %>%
  left_join(select(temporal_community_metrics, station, richness_med), by = "station") %>%
  ggplot(aes(x = richness_med, y = 1/cv_com)) +
  geom_point() +
  geom_smooth(method = "auto")
```



```{r}
st_basin <- get_basin_station() 
myload(region_polygon, dir = mypath("data"))
stab_div_basin <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  select(station, troph_group, biomass_stab, richness_avg) %>%
  left_join(st_basin, by = "station") %>%
  filter(!is.na(basin))

# By basin
p_stab_div_basin <- ggplot(stab_div_basin,
  aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
  facet_wrap(~basin, ncol = 4) +
  geom_point() +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
  )
# Total
p_stab_div_tot <-  ggplot(stab_div_basin,
  aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
  geom_point() +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
  )

plot_grid(p_stab_div_basin, p_stab_div_tot, nrow = 2)
```

```{r, fig.dim = c(8, 7)}
myload(biomass_ts_sax, dir = mypath("data"))
p_bbb_stab_div <- stab_div_basin %>%
  mutate(station = as.character(station)) %>%
  left_join(biomass_ts_sax[, c("station", "sax")], by = "station") %>%
  filter(sax == "bbb") %>%
  ggplot(aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
  geom_point() +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
  )

station_map <- get_basin_station(sf_obj = TRUE) %>%
  mutate(station = as.character(station)) %>%
  left_join(biomass_ts_sax[, c("station", "sax")], by = "station") %>%
  mutate(type = ifelse(sax == "bbb", "stable", "unstable")) %>%
  select(type)

p_bbb_map <- ggplot(region_polygon) +
  geom_sf() +
  geom_sf(data = station_map, aes(color = type))
#plot(station_map, pch = 16)

plot_grid(p_bbb_stab_div, p_bbb_map, ncol = 1)
```

```{r}
myload(habitat_pressure, dir = mypath("report"))
```

```{r bimod-stab-div, fig.dim = c(7, 16), fig.cap = "Relationship between stability and diversity by spliting dataset in two according to an environmental variable. The threshold for the dataset split is the median of the environmental variable."}
plot_bin_stab_div <- function (env = NULL) {

  habitat_pressure$env_bin <- ifelse(
    habitat_pressure[[env]] < median(habitat_pressure[[env]], na.rm = TRUE),
    "inf", "sup")
  habitat_pressure <- na.omit(habitat_pressure[, c("station", "env_bin")])
  habitat_pressure %>%
    left_join(stab_div_basin, by = "station") %>%
    ggplot(aes(x = richness_avg, y = biomass_stab, color = troph_group)) +
    geom_point() +
    facet_grid(cols = vars(env_bin)) +
    stat_poly_eq(
      formula = y ~ x,
      eq.with.lhs = "italic(hat(y))~`=`~",
      aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
      parse = TRUE) +
    geom_smooth(method = "lm", formula = y ~ x) +
    ggplot2::scale_color_manual(
      labels = troph_group_labeller(),
      values = c("blue", "green", "red"),
      name = "Trophic level"
    ) +
  labs(title = env, x = "Average species richness", y = "Biomass stability") +
  theme(legend.position = "none")
}

#width_river_mean avg_depth_station_mean
env <- c("width_river_mean", "avg_depth_station_mean", "lat",
  "temperature_med", "flow_med", "d_source", "DBO_med", "nitrates_med")
mult_plot_stab_div_bin <- map(env, ~plot_bin_stab_div(env = .x))

plot_grid(plotlist = mult_plot_stab_div_bin, ncol = 2)
```

The relationship between stability and species diversity (Figure
\@ref(fig:bimod-stab-div)) seemed to work only in station far from the source
(which are deeper, hotter, wider, fig. \@ref(fig:pca-hab))). It should be the
place where the ANG is the most present. The ANG were effectively more abundant
in the latter station (Figure: \@ref(fig:ang-map-bio)).

```{r ang-map-bio, include = FALSE}
ang_bm <- network_analysis %>%
  left_join(select(op_analysis, opcod, station), by = "opcod") %>%
  unnest(composition) %>%
  mutate(species = str_extract(sp_class, "[A-Z]{1,3}")) %>%
  filter(species == "ANG") %>%
  group_by(station) %>%
  summarise(cv_biomass = sd(biomass) / mean(biomass),
    biomass = mean(biomass))
  
mult_plot_ang_env <- map(env, function(x) {

  habitat_pressure$env <- habitat_pressure[[x]]

  ang_bm %>%
    left_join(habitat_pressure[, c("station", "env")], by = "station") %>%
    ggplot(aes(x = env, y = biomass)) +
    geom_point() +
    stat_poly_eq(
      formula = y ~ x,
      eq.with.lhs = "italic(hat(y))~`=`~",
      aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
      parse = TRUE) +
    geom_smooth(method = "loess", formula = y ~ x) +
    scale_y_log10() +
    labs(x = x, y = "Average biomass of ANG (g)")

  })
plot_grid(plotlist = mult_plot_ang_env)
```

```{r, fig.dim = c(10, 5)}
myload(hab_type, dir = mypath("report"))
stab_div_basin %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(y = biomass_stab, x = richness_avg, color = troph_group)) +
  geom_point() +
  facet_grid(cols = vars(hab_type)) +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "Stability - Div by habitat type",
    x = "Average species richness (log10)", y = "Biomass stability (log10)")
```

```{r}
model_enrich_temp <- stab_div_basin %>%
  left_join(hab_type, by = "station") %>%
  left_join(habitat_pressure[,c("station", "temperature_med", "temperature_cv", "DBO_med", "DBO_cv")],
    by = "station") %>%
  na.omit() %>%
  group_by(troph_group, hab_type) %>%
  mutate(
    log_rich = log10(richness_avg),
    temp_res = resid(lm(temperature_med ~ log_rich)),
    dbo_res = resid(lm(DBO_med ~ log_rich)),
  ) %>%
  nest() %>%
  mutate(
    corel = map(data, function(x) {
      div_temp <- cor(x = x$richness_avg, y = x$temp_res, method = c("spearman"))
      div_dbo <- cor(x = x$richness_avg, y = x$dbo_res, method = c("spearman"))
      data.frame(div_temp = div_temp, div_dbo = div_dbo)
      }
     ),
    model = map(data, ~lm(log10(biomass_stab) ~
	log_rich  + log_rich:temp_res + log_rich:dbo_res + log_rich:temp_res:dbo_res, data = .x)),
    colinearity = map(model, ~enframe(car::vif(.x))),
    coefs = map(model, ~tidy(.x)),
    sumup = map(model, ~glance(.x))
  )

unnest(model_enrich_temp, coefs) %>%
  mutate_at(vars(estimate, std.error, statistic), ~round(., 2)) %>%
  rename(est = estimate, error = std.error,
    stat = statistic, grp = troph_group) %>%
  kable %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```

```{r}
unnest(model_enrich_temp, colinearity)

```

```{r}
stab_div_troph %>%
  select(station, troph_group, biomass_avg) %>%
  spread(troph_group, biomass_avg) %>%
  mutate(bm_h_m = `3` / (`3` + `2`)) %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = hab_type, y = bm_h_m)) +
  geom_boxplot() +
  labs(x = "Type of river", y = "Proportion of biomass in the high trophic group")
```

```{r}
div_troph_col <- stab_div_troph %>%
  select(station, troph_group, richness_avg) %>%
  spread(troph_group, richness_avg) 

stab_div_troph %>%
  select(station, troph_group, biomass_stab) %>%
  left_join(hab_type, by = "station") %>% 
  left_join(div_troph_col, by = "station") %>%
  ggplot(aes(x = `2`, y = `3`)) +
  geom_point(aes(size = log10(biomass_stab), color = log10(biomass_stab))) +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type))
```

```{r}
#TODO: Update cor_troph_group 
myload(cor_troph_group, dir = mypath("data"))
cor_troph_group %>%
  left_join(hab_type, by = "station") %>%
  filter(!is.na(hab_type)) %>%
  ggplot(aes(x = hab_type, y = cor_troph)) +
  geom_boxplot() 
```

TODO: may be that the altitude station misses the really big fishes that
stabilizes the communities. Look at dist of biomass (biomass avg by station and the shape of biomass dist).

```{r}
myload(network_metrics, dir = mypath("data", "classes"))
avg_troph_lvl <- network_metrics %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  filter(troph_group != 1) %>%
  arrange(opcod, troph_group) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(opcod, troph_group) %>%
  mutate(w_troph_lvl = troph_level * biomass / sum(biomass)) %>%
  summarise(avg_t_lvl = sum(w_troph_lvl))%>%
  left_join(select(op_analysis, opcod, station), by = "opcod") %>%
  group_by(station, troph_group) %>%
  summarise(avg_t_lvl = mean(avg_t_lvl))

avg_troph_lvl %>%
  left_join(select(stab_div_troph, station, troph_group, richness_avg), by = c("station", "troph_group")) %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_avg, y = avg_t_lvl)) +
  geom_point() +
  facet_grid(hab_type~troph_group) +
  stat_poly_eq(
    label.x = "right",
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x)
```


The stability of biomass is determined by the standard deviation and the average
biomass of the community.



```{r}
cv_bm_div_troph_grp <- temporal_network_metrics_classes %>% 
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(!is.na(troph_group) & troph_group != 1) %>%
  rename(bm_st = biomass_avg, div_st = richness_avg, cv_st = biomass_cv) %>%
  mutate(troph_group = as.factor(troph_group))
```

```{r}
cbt_sync_troph_without_ang <- network_analysis %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  rename(species = sp_class) %>%
  mutate(ang_logic = ifelse(!is.na(str_match(species, "ANG")[,1] == "ANG"),
      TRUE, FALSE)) %>%
  filter(troph_group != 1, ang_logic != TRUE) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(troph_group) %>%
  nest() %>%
  mutate(sync = map(data, ~get_sync_cv_mat(com_analysis = .x, op_analysis = op_analysis))) %>%
  unnest(sync) %>%
  mutate(sdt.dev = map_dbl(cov_mat, ~sqrt(sum(.x)))) %>%
  mutate(
    contrib = purrr::pmap(
      list(mat = com_mat, cv_com_tot = cv_com, cv_sp_tot = cv_sp, sync_tot = synchrony),
      ~compute_sp_contrib(mat = ..1, cv_com_tot = ..2, cv_sp_tot = ..3, sync_tot = ..4)),
    troph_sp_nb_med = map_dbl(com_mat, ~rowSums(.x != 0) %>% median),
    troph_sp_nb_avg = map_dbl(com_mat, ~rowSums(.x != 0) %>% mean)
      ) %>% 
  select(troph_group, station, synchrony, cv_sp, cv_com, sdt.dev, contrib,
    troph_sp_nb_avg, troph_sp_nb_med) %>%
  left_join(stab_div_basin, by = c("station", "troph_group"))
```

```{r stab-ang, fig.dim = c(10, 7)}
cbt_sync_troph_without_ang %>%
  mutate(stab_without_ang = 1/cv_com) %>%
  rename(stab_with_ang = biomass_stab) %>%
  filter(troph_group != 1) %>%
  select(station, troph_group, richness_avg, stab_with_ang, stab_without_ang) %>% 
  gather(stab_type, stab, stab_with_ang, stab_without_ang) %>%
  ggplot(aes(x = richness_avg, y = stab, color = troph_group)) +
  geom_point() +
  facet_grid(cols = vars(stab_type)) +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    )
```

### Decompose stability

```{r}
sync_troph <- network_analysis %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  mutate(species = str_extract(sp_class, "[A-Z]{1,3}")) %>%
  select(-sp_class) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(opcod, troph_group, species) %>%
  summarise(
    troph_level = sum(troph_level * biomass /sum(biomass)),
    biomass = sum(biomass)
  ) %>%
  group_by(troph_group) %>%
  nest() %>%
  mutate(sync = map(data, ~get_sync_cv_mat(com_analysis = .x, op_analysis = op_analysis))) %>% 
  unnest(sync)

cbt_sync_troph <- sync_troph %>%
  mutate(sdt.dev = map_dbl(cov_mat, ~sqrt(sum(.x)))) %>%
  mutate(
    contrib = purrr::pmap(
      list(mat = com_mat, cv_com_tot = cv_com, cv_sp_tot = cv_sp, sync_tot = synchrony),
      ~compute_sp_contrib(mat = ..1, cv_com_tot = ..2, cv_sp_tot = ..3, sync_tot = ..4)),
    troph_sp_nb_med = map_dbl(com_mat, ~rowSums(.x != 0) %>% median),
    troph_sp_nb_avg = map_dbl(com_mat, ~rowSums(.x != 0) %>% mean)
      ) %>% 
  select(troph_group, station, synchrony, cv_sp, cv_com, sdt.dev, contrib,
    troph_sp_nb_avg, troph_sp_nb_med) %>%
  left_join(select(temporal_community_metrics, station, richness_avg,
      biomass_avg), by = "station") %>%
  rename(bm_st = biomass_avg, div_st = troph_sp_nb_avg)
```


```{r sd-avg-div}
fit <- stat_poly_eq(
  formula = y ~ x,
  eq.with.lhs = "italic(hat(y))~`=`~",
  aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
  parse = TRUE)

ymax <- max(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
ymin <- min(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
p_bm <- cv_bm_div_troph_grp %>%
  ggplot(aes(y = bm_st, x = div_st)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  fit +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Average biomass (g).", x = "Species richness")

p_sd <- cbt_sync_troph %>%
  ggplot(aes(x = div_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  fit +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Species richness")

plot_grid(p_sd, p_bm, ncol = 1)
```
It seems that the relationship between the standard deviation and the number of
species saturates for 10 species in medium trophic group while it saturates at 7
for the high trophic group (Figure \@ref(fig:sd-avg-div)).

To get opposite stability-diversity relationships in the different trophic
group, it supposes that for medium trophic group, the avg biomass increases
faster than the biomass standard deviation with increasing species richness. And
the reverse for the high trophic group, i.e. that the standard deviation
increases faster than the average biomass.

A question: What are the determinant of the relationship beween avg/standard
deviation and the number of species?

```{r}
ymax <- max(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
ymin <- min(cv_bm_div_troph_grp$bm_st, cbt_sync_troph$sdt.dev)
p_bm <- cv_bm_div_troph_grp %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(y = bm_st, x = div_st)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  fit +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Average biomass (g).", x = "Species richness")

p_sd <- cbt_sync_troph %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = div_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  fit +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Species richness")

plot_grid(p_sd, p_bm, ncol = 1)
```


```{r}
formula <- y ~ x #needed for stat_poly_eq
cbt_sync_troph %>%
  ggplot(aes(x = bm_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10() +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Average
      biomass (g)")
```

```{r, fig.dim = c(10, 10)}
u_hab <- unique(hab_type$hab_type)
p_test <- map(u_hab, function(x){
cbt_sync_troph %>%
  select(troph_group:cv_com) %>%
  left_join(stab_div_basin, by = c("station", "troph_group")) %>%
  left_join(hab_type, by = "station") %>%
  filter(hab_type == x) %>%
  gather(comp, stab, synchrony:cv_com) %>%
  ggplot(aes(x = richness_avg, y = stab)) +
  geom_smooth(method = "lm", se = FALSE) +
  stat_poly_eq(
    label.x = "right",
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(title = x, x = "Average species richness", y = "Stability component") +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  facet_grid(rows = vars(comp), cols = vars(troph_group), scales = "free_y")
      
      })
plot_grid(plotlist = p_test)
```

```{r, fig.dim = c(10, 7), include = FALSE}
synchrony %>%
  left_join(select(temporal_community_metrics, station, richness_med), by =
    "station") %>%
  gather(comp, stab, synchrony:cv_com) %>%
  ggplot(aes(x = richness_med, y = stab)) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Species diversity", y = "Stability component") +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  facet_grid(rows = vars(comp), scales = "free_y")
```

#### Contribution

```{r cbt-top, fig.cap = "Contribution of species to the different facets of stability. Positive contribution values mean that the species contributes negatively to the metric."}
top_contrib_sp <- cbt_sync_troph %>%
  unnest(contrib) %>%
  group_by(station, troph_group) %>%
  mutate(cbt_cv_com_n = cbt_cv_com / sd(cbt_cv_com)) %>%
  group_by(troph_group, species) %>%
  summarise(
    avg_cbt_cv_com_n = mean(cbt_cv_com_n),
    avg_cbt_cv_com = mean(cbt_cv_com),
    avg_cbt_cv_sp = mean(cbt_cv_sp),
    avg_cbt_sync = mean(cbt_sync),
    avg_abs_cbt_cv_com = mean(abs(cbt_cv_com))
    ) %>%
  arrange(desc(abs(avg_cbt_cv_com_n))) %>%
  slice(1:10)

p_top_contrib_sp <- map(c(2, 3), function(x){

  mask <- top_contrib_sp$troph_group == x 
  top_sp <- unique(top_contrib_sp[mask,]$species)

  cbt_sync_troph %>%
    unnest(contrib) %>%
    group_by(station, troph_group) %>%
    mutate(cbt_cv_com_n = cbt_cv_com / sd(cbt_cv_com)) %>%
    filter(species %in% top_sp, troph_group == x) %>%
    gather(comp, contrib, cbt_cv_com_n, cbt_cv_com:cbt_sync) %>%
    ggplot(aes(y = contrib, x = species)) +
    geom_violin() +
    facet_grid(rows = vars(comp), scales = "free_y") +
    labs(title = x)
    })
plot_grid(plotlist = p_top_contrib_sp)
```

The figure \@ref(fig:cbt-top), left panel) shows that for the trophic group 2,
TRF, LOF and GOU were the species that contributes the most to the the CV of the
community and to its components (CVsp and synchrony). For the 3 trophic group
(Figure \@ref(fig:cbt-top), right panel), the TRF, ANG and CHE contribute the
most to stability and its facets. Interestingly, the contribution of the species
to the community CV were quite asymetric toward negative values, meaning that
species which contributes the most tend to stabilize more than destabilize
communities. The reason was that the variance of contribution decreases with
species diversity (Figure \@ref(fig:var-cbt)), meaning that each species
contributes less and less. Two reasons might explain that: (1) the biomass
distribution of communities became more even with the increase of species
number, (2) the population stability converges.  Apparently the eveness of
biomass distribution does not change with species diversity (figure
\@ref(fig:even-sdcv-div), A). And the standard deviation of species CV decreases
with species richness (figure
\@ref(fig:even-sdcv-div), A).


```{r var-cbt, fig.dim = c(10, 7)}
var_cbt <- cbt_sync_troph %>%
  unnest(contrib) %>%
  group_by(troph_group, station) %>%
  summarise(
    var_cbt_cv_com = var(cbt_cv_com),
    var_cbt_cv_sp = var(cbt_cv_sp),
    var_cbt_sync = var(cbt_sync)
    ) %>%
  gather(comp, contrib, var_cbt_cv_com:var_cbt_sync) %>%
  left_join(select(stab_div_basin, station, troph_group, richness_avg),
    by = c("station", "troph_group"))

  var_cbt %<>%
    nest() %>%
    mutate(plot = map2(data, troph_group, function(.data, m_title){
	.data %>%
	ggplot(aes(y = contrib, x = richness_avg)) +
	  geom_point() +
	  scale_x_log10() +
	  facet_grid(rows = vars(comp), scales = "free_y") +
	  labs(title = paste0(m_title))
}
    )
    )
plot_grid(plotlist = var_cbt$plot, ncol = 2)
```

#### Statistical averaging

```{r eveness-div}
pielou <- network_analysis %>%
  select(opcod, composition) %>%
  unnest(composition) %>%
  mutate(species = str_extract(sp_class, "[A-Z]{1,3}")) %>%
  select(-sp_class) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  group_by(opcod, troph_group, species) %>%
  summarise(
    troph_level = sum(troph_level * biomass /sum(biomass)),
    biomass = sum(biomass)
  ) %>%
  group_by(troph_group, opcod) %>%
  mutate(rel_bm = biomass / sum(biomass)) %>%
  summarise(
    richness = n(),
    shannon = vegan::diversity(biomass, index = "shannon"),
    pielou = shannon / log(n())
  )

p_pielou <- pielou %>%
  left_join(select(op_analysis, station, opcod), by = "opcod") %>%
  group_by(station, troph_group) %>%
  summarise(richness_avg = mean(richness), pielou_med = median(pielou)) %>%
  left_join(hab_type, by = c("station")) %>%
  ggplot(aes(x = richness_avg, y = pielou_med, color = hab_type)) +
  #scale_x_log10() +
  geom_point() +
  facet_grid(~troph_group) +
  stat_poly_eq(
    label.x = "right",
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "loess", formula = y ~ x, se = FALSE) +
  labs(x = "Avg species richness", y = "Avagerage evenness of biomass")

p_pielou
```

```{r even-sdcv-div}
var_sp <- sync_troph %>%
  mutate(var_sp = map(var_sp, enframe)) %>%
  unnest(var_sp) %>%
  rename(species = name, var_bm = value) %>% 
  select(station, troph_group, species, var_bm)
avg_sp <- sync_troph %>%
  mutate(avg_sp = map(avg_sp, enframe)) %>%
  unnest(avg_sp) %>%
  rename(species = name, avg_bm = value) %>% 
  group_by(station, troph_group) %>%
  mutate(rel_bm = avg_bm / sum(avg_bm)) %>%
  ungroup() %>%
  select(station, troph_group, species, avg_bm, rel_bm)
cv_bm_sp <- left_join(avg_sp, var_sp, by = c("station", "troph_group", "species")) %>%
  mutate(cv = sqrt(var_bm) / avg_bm, var_bm = NULL) %>%
  rename(bm = avg_bm)

p_cv_sp_div <- map(unique(hab_type$hab_type), function(hab) {
    
var_sp %>%
  left_join(avg_sp, by = c("station", "troph_group", "species")) %>%
  left_join(hab_type, by = c("station")) %>%
  group_by(hab_type) %>%
  filter(rel_bm < .10, hab_type == hab) %>%
  ungroup() %>%
  mutate(cv_sp = sqrt(var_bm) / avg_bm,
    cv_sp_p = cv_sp * rel_bm) %>%
  gather(type, cv_sp, cv_sp, cv_sp_p) %>%
  left_join(select(stab_div_basin, station, troph_group, basin, richness_avg), by = c("station", "troph_group")) %>%
  ggplot(aes(x = richness_avg, y = cv_sp, color = species)) +
  geom_point() +
  #scale_y_log10() +
  facet_grid(cols = vars(troph_group), rows = vars(type), scales = "free_y") +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(x = "Average species richness", y = "Average species CV", title = hab) +
  theme(legend.position = "none")
    })

plot_grid(plotlist = p_cv_sp_div, nrow = 2)
```

```{r}
cv_sp_div_troph <- var_sp %>%
  left_join(avg_sp, by = c("station", "troph_group", "species")) %>%
  left_join(stab_div_basin[, c("station", "troph_group", "richness_avg")], by = c("station", "troph_group")) %>%
  mutate(
    cv_sp = sqrt(var_bm) / avg_bm,
    cv_sp_p = cv_sp * rel_bm
  )

m <- cv_sp_div_troph %>%
  gather(type, cv, rel_bm, cv_sp, cv_sp_p) %>%
  left_join(hab_type, by = c("station")) %>%
  group_by(troph_group, species, type, hab_type) %>%
  nest() %>%
  mutate(
    model = map(data, ~lm(cv ~ richness_avg, data = .x)),
    coeff = map(model, tidy)
  )

coefs <- m %>%
  unnest(coeff)

p_list <- map(unique(coefs$type), function (x) {
  filter(coefs, type == x, term == "richness_avg") %>%
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  facet_grid(cols = vars(hab_type), rows = vars(troph_group), scales = "free_x") + 
  geom_vline(xintercept = 0, color = "grey") +
  #geom_vline(xintercept = mean(estimate), color = "red") +
  labs(title = x)
  })

plot_grid(plotlist = p_list, labels = "AUTO")
```

```{r}
coefs %>%
  filter(term == "richness_avg", type == "rel_bm") %>%
  arrange((estimate))
  
```

```{r}
cv_sp_div_troph %>%
  group_by(station, troph_group) %>%
  summarise(avg_cv = mean(cv_sp), richness_avg = unique(richness_avg)) %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_avg, y = avg_cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type)) +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE)
```

```{r}
cv_sp_div_troph %>%
  left_join(hab_type, by = "station") %>%
  ggplot(aes(x = richness_avg, y = cv_sp_p)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(hab_type))
```



### Some temporal series of biomass

#### Total biomass

```{r, fig.dim = c(10, 7)}
community_metrics %<>% left_join(select(op_analysis, opcod, station, date))
station_high_low_stab <- temporal_community_metrics %>%
  arrange(desc(biomass_stab)) %>%
  slice(c(1:5, (n() - 4):(n() - 0))) %>%
  select(station) %>%
  unlist
names(station_high_low_stab) <- rep(c("high", "low"), each = 5) 
```

```{r tmp-stab, fig.dim = c(10, 7), fig.cap = "The five lowest and highest biomass stability"}
temporal_biomass <- community_metrics %>%
  filter(station %in% station_high_low_stab) %>%
  mutate(stab_status = ifelse(
      station %in% station_high_low_stab[names(station_high_low_stab) == "low"],
      "low", "high")) %>%
  group_by(stab_status, station) %>%
  nest() %>%
  group_by(stab_status) %>%
  mutate(id_stab = seq_along(station)) %>%
  unnest()
ggplot(temporal_biomass, aes(y = biomass, x = date)) +
  geom_line() +
  geom_point() +
  facet_grid(id_stab ~ stab_status, scales = "free_y") +
  labs(y = "Biomass (g)", x = "Date")
```

```{r more-stab-troph, fig.dim = c(10, 21), fig.cap = "The four station with the highest biomass stability. Dashed and solid lines represent respectively trophic species in the group 2 and 3."}

# Get biomass by sp node:
net_sp_troph <- select(network_analysis, opcod, composition) %>%
  unnest(composition)
# Get synchrony and cv sp:
sync_sp_troph <- get_sync_cv_mat(com_analysis = net_sp_troph, op_analysis = op_analysis)
# Get trophic lvl by node
trophic_level %<>%
  rename(species = sp_class) %>%
  mutate(troph_group = get_size_class(trophic_level, NULL, troph_level,
      trophic_class))

plot_stab <- purrr::map(station_high_low_stab, function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = TRUE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab, ncol = 2)
```

```{r less-stab-troph, eval = FALSE, fig.dim = c(10, 7), fig.cap = "The four station with the lowest biomass stability. See caption of Figure for details."}
plot_grid(plotlist = plot_stab[7:10], ncol = 2)
```


```{r mid-stab-troph, eval = FALSE, fig.dim = c(10, 7), fig.cap = "Four stations with medium biomass stability. See caption of Figure for details."}
# Middle station 
plot_stab <- purrr::map(sync_sp_troph$station[209:212], function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = TRUE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab[1:4], ncol = 2)
```


```{r 75-stab-troph, eval = FALSE, fig.dim = c(10, 7), fig.cap = "Four stations with medium/low biomass stability. See caption of Figure for details."}
# Third quater
plot_stab <- purrr::map(sync_sp_troph$station[300:304], function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = FALSE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab[1:4], ncol = 2)
```

```{r 25-stab-troph, eval = FALSE, fig.cap = "Four stations with medium/low biomass stability. See caption of Figure for details."}
# Third quater
plot_stab <- purrr::map(sync_sp_troph$station[104:107], function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = FALSE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab[1:10], ncol = 2)
```

### CV sp

```{r abun-sp, fig.dim = c(10, 7), fig.cap = "Species most abundant by trophic group."}
# Sp the most abundant by group
bm_sp_troph_grp <- net_sp_troph %>%
  filter(!is.na(troph_group) & troph_group != 1) %>%
  group_by(troph_group, sp_class, opcod) %>%
  mutate(rel_biomass = biomass / sum(biomass)) %>%
  group_by(troph_group, sp_class) %>%
  summarise(sum_rel_bm = sum(rel_biomass), biomass = mean(biomass)) %>%
  arrange(desc(sum_rel_bm)) %>%
  slice(1:20)
  
p_bm <- map(c(2, 3), .f = function(x) {
  mylim <- sapply(c(min, max),
    FUN = function(x) x(bm_sp_troph_grp$biomass))

  .data <- bm_sp_troph_grp %>%
    filter(troph_group == x)
  if (x == 2) {
    tmp_title <- paste("Medium trophic group (2)")
  } else {
    tmp_title <- paste("High trophic group (3)")
  }

  ggplot(data = .data, aes(x = sp_class, y = biomass)) +
    geom_point() +
    labs(x = "Trophic species", y = "Biomass (g)", title = tmp_title) +
    ylim(mylim[1], mylim[2]) 

})
plot_grid(plotlist = p_bm, ncol = 2)
```

```{r}
# I need:
# - by species:
#   - CV
#   - Biomass 
# - by Trophic group:
#   - Species richness 
#   - CV
#   - biomass 

# Species 

## Variance by sp and station:
var_sp <- sync_sp_troph %>%
  select(station, var_sp) %>%
  mutate(var_sp = map(var_sp, ~enframe(.x))) %>%
  unnest(var_sp) %>%
  rename(species = name, var_sp = value)
## Average biomass by sp and station:
avg_sp <- sync_sp_troph %>%
  select(station, avg_sp) %>%
  mutate(avg_sp = map(avg_sp, ~enframe(.x))) %>%
  unnest(avg_sp) %>%
  rename(species = name, avg_sp = value)
## CV and biomass by sp and station  
cv_bm_sp <- left_join(avg_sp, var_sp, by = c("station", "species")) %>%
  mutate(cv = sqrt(var_sp) / avg_sp, var_sp = NULL) %>%
  rename(bm = avg_sp)

# By trophic group:

## CV, biomass and div (ALREADY DONE!)
```

#### Diversity is not all

```{r}
library(ade4)
library(factoextra)
myload(habitat_pressure, dir = mypath("report"))
```

```{r}
div_troph_grp <- cv_bm_div_troph_grp %>%
  select(station, troph_group, cv_st) %>%
  spread(key = troph_group, cv_st) %>%
  rename(mid_cv = `2`, high_cv = `3`)

hab_press_div <- left_join(habitat_pressure,
  temporal_community_metrics[, c("station", "richness_med", "biomass_avg","biomass_stab")],
  by = "station") %>%
left_join(div_troph_grp, by = "station")
pca_hab <- dudi.pca(as.data.frame(select(na.omit(hab_press_div), -station)), scannf = FALSE, nf = 3, center = TRUE, scale = TRUE)

eig_plot <- fviz_eig(pca_hab)
pca_plot <- fviz_pca_var(pca_hab,
    axes = c(1, 2),
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
  )

ggdraw(pca_plot) + 
  draw_plot(eig_plot, x = .9, y = .95, hjust = 1, vjust = 1, width = 0.17, height = 0.25)
```

```{r}
m <- cor(as.matrix(select(na.omit(hab_press_div), -station)), method =
  "spearman")
corrplot::corrplot(m, order="hclust")
```

```{r, eval = FALSE}
mod <- lm(high_cv ~ temperature + richness_med:temperature + DBO + lat + insecticides + herbicides + insecticides, hab_press_div)
car::vif(mod)

mod <- lm(mid_cv ~ richness_med + DBO + lat + temperature + insecticides + herbicides + insecticides, hab_press_div)
car::vif(mod)
```

#### CV sp VS CV group

There was a positive relationship between the species CV of the most abundant
species in the high trophic group and the CV of the same high trophic group
(Figure \@ref(fig:cv-sp-grp3), right panel). Interestingly, this relationship
is less clear (however clearly present for some species) for the most abundant
species in the medium trophic group (Figure \@ref(fig:cv-sp-grp2), right panel).

```{r cv-sp-grp3, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the CV of the different trophic groups"}
cv_sp_grp <- left_join(
  select(cv_bm_sp, -bm),
  select(cv_bm_div_troph_grp, -biomass_stab), by = c("station"))


sp_grp3 <- cv_sp_grp %>%
  filter(troph_group == 3) %>%
  arrange(desc(biomass))
  
u_troph <- unique(cv_sp_grp$troph_group) 
p_cv_abun_sp <- map(u_troph, function(x) {
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  filter(troph_group == u_troph) %>%
  ggplot(aes(x = cv_st, y = cv)) +
  geom_point() +
  facet_grid(rows = vars(species)) +
  labs(x = "CV of the trophic group", y = "CV of the species", title = u_troph)
  })
plot_grid(plotlist = p_cv_abun_sp)
```

```{r cv-sp-grp2, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the CV of the different trophic groups"}
sp_grp2 <- bm_sp_troph_grp %>%
  filter(troph_group == 2) %>%
  arrange(desc(biomass))
  
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = cv_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller =
    labeller(troph_group = troph_group_labeller())) +
  labs(x = "CV of the trophic group", y = "CV of the species")
```

#### CVsp versus Biomass by trophic group

```{r cv-sp-bm-grp3, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the biomass of the different trophic groups"}
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = bm_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller()),
    scales = "free_x") +
  labs(x = "Biomass of the trophic group (g)", y = "CV of the species")

```

```{r cv-sp-bm-grp2, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the biomass of the different trophic groups"}
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = bm_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller()),
    scales = "free_x") +
  labs(x = "Biomass of the trophic group (g)", y = "CV of the species")
```

#### CVsp versus diversity by trophic group

```{r cv-sp-div-grp3, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the species richness in the different trophic groups."}

cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = div_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "Species richness of the trophic group", y = "CV of the species")
```

```{r cv-sp-div-grp2, eval = FALSE, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the species richness in the different trophic groups."}
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = div_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "Species richness of the trophic group", y = "CV of the species")
```

#### Temporal dynamics in high diversity community 

```{r}
high_div_station <- temporal_community_metrics %>%
  arrange(desc(richness_med)) %>%
  slice(1: 5) %>%
  select(station) %>%
  unlist
```

```{r tmp-richest, fig.dim = c(10, 7), fig.cap = "The five highest rich community."}
label_stab <- filter(temporal_community_metrics,
  station %in% high_div_station) %>%
mutate(
  x_pos = ymd_hms("2005-01-01T15:00:00"),
  x_pos = as.Date(x_pos),
  y_pos = 50000,
  text = paste0("Stability: ", round(biomass_stab,2)),
)
ggplot(filter(community_metrics, station %in% high_div_station),
  aes(y = biomass, x = date)) +
  geom_line() +
  geom_point() +
  geom_text(data = label_stab, aes(x = x_pos, y = y_pos, label =
      text), size = 6) +
  facet_wrap( ~ station) + 
  labs(y = "Biomass (g)", x = "Date")
```

```{r}
myload(network_analysis, network_metrics, dir = dest_dir)
high_div_troph_group <- network_metrics %>%
  select(opcod, troph_group) %>%
  unnest() %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  left_join(select(op_analysis, opcod, station, date)) %>%
  filter(station %in% high_div_station)
```

```{r, fig.dim = c(10, 7)}
ggplot(high_div_troph_group,
  aes(y = nbnode, x = date, color = troph_group)) +
  geom_line() +
  geom_point() +
  geom_text(data = label_stab,
    x = ymd_hms("2015-01-01T15:00:00"),
    y = 3, aes(label =
      text), size = 6, inherit.aes = FALSE) +
  facet_wrap( ~ station) + 
  labs(title = "The five richest station",
  y = "Fish species richness", x = "Date")
```

```{r}
highest_div_grp_3_station <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group == 3) %>%
  arrange(desc(richness_avg)) %>%
  slice(1:12) %>%
  select(station) %>%
  unlist()
high_div_troph_group_3 <- network_metrics %>%
  select(opcod, troph_group) %>%
  unnest() %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  left_join(select(op_analysis, opcod, station, date)) %>%
  filter(station %in% highest_div_grp_3_station)
```

```{r, fig.dim = c(10, 7)}
ggplot(high_div_troph_group_3,
  aes(y = biomass, x = date, color = troph_group)) +
  geom_line() +
  geom_point() +
  geom_text(data = filter(temporal_community_metrics, station %in% highest_div_grp_3_station),
    x = ymd_hms("2015-01-01T15:00:00"),
    y = 3, aes(label = paste0("Stability: ", round(biomass_stab, 2))),
    size = 6, inherit.aes = FALSE) +
  facet_wrap( ~ station) + 
  labs(title = "The twelve richest station of superior predator",
  y = "Biomass of trophic group (g)", x = "Date")
```

```{r}
ggplot(high_div_troph_group_3,
  aes(y = biomass, x = date, color = troph_group)) +
  geom_line() +
  geom_point() +
  geom_text(data = filter(temporal_community_metrics, station %in% highest_div_grp_3_station),
    x = ymd_hms("2015-01-01T15:00:00"),
    y = 3, aes(label = paste0("Stability: ", round(biomass_stab, 2))),
    size = 6, inherit.aes = FALSE) +
  facet_wrap( ~ station) + 
  labs(title = "The twelve richest station of superior predator",
  y = "Biomass of trophic group (g)", x = "Date")
```


### Map stability

```{r map-stab, fig.cap = "Repartition of average biomass and biomass stability (logged)."}
myload(station_analysis, region_polygon, dir = data_common)
stab <- temporal_community_metrics %>% 
  select(station, biomass_stab, biomass_avg)
station_stab <- left_join(station_analysis, rename(stab, id = station)) %>%
  filter(!is.na(biomass_stab))
map_stab <- ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_stab)), size = 4) +
    scale_color_gradient(low = "red", high = "green") +
    labs(title = "Biomass stability")

map_bm <- ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_avg)), size = 4) +
    scale_color_gradient(low = "red", high = "green") +
    labs(title = "Average biomass (g)")

plot_grid(map_stab, map_bm, ncol = 2)
```

Biomass stability was lower in south-west of France (Figure
\@ref{fig:map-stab}, left panel). Average fish biomass was lower in moutain
region (Pyrénées, Alps, Massif Central; Figure \@ref{fig:map-stab}, right
panel), generally close to the source.


```{r map-st, fig.dim = c(7, 15), fig.cap = "Repartition of the average biomass, biomass stability and species diversity by trophic group, respectively medium and high for the left and right panel. All the metrics were logged."}
tmp <- rename(cv_bm_div_troph_grp, id = station)
station_troph_div <- left_join(station_analysis, tmp, by = "id")

map_st_metrics <- purrr::map(c("bm_st", "div_st", "biomass_stab"), function (metric) {
  station_troph_div[[metric]] <- log10(station_troph_div[[metric]])
  ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_troph_div, aes_(color = as.name(metric)), size = 4) +
    facet_grid(cols = vars(troph_group)) +
    scale_color_gradient(low = "red", high = "green")
  
  })
plot_grid(plotlist = map_st_metrics, ncol = 1)
```

The biomass in both trophic groups were lower in moutain area (Figure
\@ref(map-st)), the same was true for species diversity. For stability, it is
difficult to see a pattern.

### Link biomass stability with community structure


```{r stab-div-mult, fig.dim = c(10, 7), fig.cap = "Link between the stability of biomass and diversity"}
biomass_com <- temporal_community_metrics %>%
  left_join(select(synchrony, station, synchrony, cv_sp)) %>%
  select(biomass_stab, synchrony, cv_sp, richness_cv, richness_med, betadiv) %>%
  gather(diversity, div_value, richness_med, richness_cv, betadiv) %>%
  gather(stability, stab_value, biomass_stab, synchrony, cv_sp)

formula <- y ~ x #needed for stat_poly_eq
qplot(div_value, stab_value, data =  biomass_com, geom = "point") +
  facet_grid(stability ~ diversity, labeller = mylabel(), scales = "free") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(x = "Diversity", y = "Stability component")
```



```{r stab-net, fig.cap = "Link between biomass stability and network structure (median)"}
# plot
avg_network <- temporal_network_metrics %>%
  select_at(vars(dplyr::matches("med|station")))
biomass_stab_station <- temporal_community_metrics %>%
  select(station, biomass_stab)
stab_biomass_net_avg <- left_join(avg_network, biomass_stab_station) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")

# TODO: think about not facetting (list of plots ?)
# Facet label:
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(stab_biomass_net_avg, aes(y = biomass_stab, x = values)) +
  geom_point() +
  facet_wrap(~ metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median of the network indices",
    y = "Biomass stability"
  )
p
```



```{r stab-comp, fig.cap = "Link between biomass stability by trophic group and total species richness (median)"}
net_troph_group <- temporal_network_metrics_classes %>% 
  unnest(troph_group) %>%
  mutate(troph_group = as.factor(troph_group))
net_troph_group %<>%
  select_at(vars(dplyr::matches("_med|stab|station|troph_group"))) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", ""))
p <- ggplot(net_troph_group, aes(y = biomass_stab, x = values, color = troph_group)) +
  geom_point() +
  ggplot2::scale_fill_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  facet_wrap(~metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "network_med",
    y = "biomass_stab"
  )
p
```

The Figure \@ref(fig:stab-comp) showed that medium trophic level part of the
network had a positive stability-diversity relationship with while high
trophic level had a negative one.  
Furthermore, we see that high trophic level compartment had a highest stability
than the medium compartment. In the same vein, the latter pattern is confirmed
when looking at the richness by compartment instead of the total richness
(Figure \@ref(fig:stab-comp2)).  


```{r stab-comp2, fig.dim = c(10, 7), fig.cap = "Link between biomass stability and species richness by trophic group (median). (Classes network)"}
net_troph_group <- temporal_network_metrics_classes %>% 
  select(station, troph_group) %>%
  unnest() %>%
  filter(!is.na(troph_group)) %>%
  mutate(troph_group = as.factor(troph_group))
plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_stab"
  )
plot_stab_richness_troph_group
```
 
One hypothesis to explain this opposite pattern might be a disequilibrium
between the two compartment. We can imagine that each compartment can
destabilize each other according to the part of the total biomass of total
species richness that there are in each of them. The figure
\@ref(fig:stab-comp-ratio) showed that the biomass stability of the medium
compartment decreased with the increase of biomass and species number ratio in
the high compartment and we observed the reverse for the high trophic
compartment. It indicates that a trophic compartment is more stable when their
relative biomass increases. 

We are looking forward to fully understand why we observed this inverse
relationship.

```{r stab-comp-ratio, fig.cap = "Biomass stability and ratio of biomass and species number (top and bottom panel resp.) in the high trophic level (classes network) for the medium and high trophic group (resp. left and right panels)."}
ratio_sp <- net_troph_group %>%
  select(station, troph_group, richness_avg) %>%
  spread(troph_group, richness_avg) %>%
  mutate(sp_h_m = `3` / (`3` + `2`)) %>%
  select(station, sp_h_m)

ratio_bm <- net_troph_group %>%
  select(station, troph_group, biomass_avg) %>%
  spread(troph_group, biomass_avg) %>%
  mutate(bm_h_m = `3` / (`3` + `2`)) %>%
  select(station, bm_h_m)

net_troph_group <- temporal_network_metrics_classes %>%
  left_join(ratio_sp, by = "station") %>%
  left_join(ratio_bm, by = "station") %>%
  select(station, troph_group, sp_h_m, bm_h_m) %>%
  unnest() %>%
  filter(!is.na(troph_group), troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  gather(ratio_troph, value, sp_h_m, bm_h_m)

plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = value)) +
  geom_point(aes(color = richness_avg)) +
  facet_grid(cols = vars(troph_group), rows = vars(ratio_troph), labeller =
    troph_group_labeller()) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    y = "biomass_stab"
  ) + 
    xlab("Ratio of biomass and species nb in high troph compartment compare to total")
plot_stab_richness_troph_group
```

## P1: Habitat and trophic group determine the shape of the stability-diversity relationship

What are the contributions of environment and trophic level on the shape of the stability-diversity relationship?

### Statistical Model

1. Stability total vs div + habitat 
2. Stability by trophic group vs diversity:trophic group:habitat
   - Random effects: catchement & # sampling years
   - Include composition in the analyses as [@sandau_including_2014]
3. SEM:
   - Paths:
     - Total Stability
     - Stability at trophic level 2 & trophic level 3
     - Diversity at trophic level 2 & trophic level 3
     - Altitude or PCA coordinates 
   - Groups: habitat 
   - Replicate for productivity
4. Test for different datasets
   - factorise calcultation of temporal metrics


```{r}
myload(nmds, dir = mypath("report"))

```

## P2: Evt and network structure conjointly drives fonctioning and stability of fish communities


What are the contributions of the the environment and the structure of
the network on the functioning and the stability of the trophic network


```{r}

```

```{r}
mod <- lm(betadiv_bin ~ log(richness_med), data = temporal_community_metrics)
temporal_community_metrics$beta_bin_c <- resid(mod)
```


```{r}
biomass_sem <- temporal_community_metrics %>%
  select(station, biomass_stab, biomass_med, richness_med, pielou_med,
  beta_bin_c) %>%
  left_join(select(synchrony, station, synchrony, cv_sp), by = "station") %>%
  rename(sync = synchrony,
    piel = pielou_med,
    prod = biomass_med 
  )
habitat_sem <- habitat_pressure %>% 
  select(station, lat, alt, width_river_mean, DBO_med, DBO_cv, flow_med, flow_cv,
    temperature_med, temperature_cv) %>%
  rename(width = width_river_mean)
net_sem <- temporal_network_metrics %>%
  select(station, connectance_corrected_med, w_trph_lvl_avg_med) %>%
  rename(c_c = connectance_corrected_med,
    t_lvl = w_trph_lvl_avg_med)
composition_axis <- nmds$points %>%
  as_tibble %>%
  mutate(station = as.integer(dimnames(nmds$points)[[1]]))
  
dsem <- biomass_sem  %>%
  mutate(log_rich = log10(richness_med)) %>%
  left_join(net_sem, by = "station") %>%
  left_join(habitat_sem, by = "station") %>%
  left_join(st_basin, by = "station") %>%
  #left_join(composition_axis, by = "station") %>%
  na.omit()

lav_data <- dsem %>%
  mutate(
    log_sync = log10(sync), 
    log_cv_sp = log10(cv_sp),
    log_stab = log10(biomass_stab)
  )
```

```{r, eval = FALSE}
library(lavaan)
options(width = 100)

#log_stab ~ log_sync + log_cv_sp
lav_formula <- "
  log_sync ~ log_rich + piel + alt + c_c + t_lvl + beta_bin_c
  log_cv_sp ~ log_rich + piel + c_c + t_lvl + beta_bin_c
  log_rich ~ alt + width 
  piel ~ alt + width
  c_c ~ alt + width
  t_lvl ~ alt + width
  beta_bin_c ~ alt + width
  log_cv_sp ~~ log_sync
  "
lav_mod <- sem(lav_formula, lav_data)

standardizedsolution(lav_mod) %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```

```{r, eval = FALSE, fig.dim = c(10, 7), fig.cap = "Lavaan SEM"}
ggsem(lav_mod)
```

### Piecewiese SEM

```{r}
library(lme4)
library(nlme)
library(piecewiseSEM)
```

#### Stability

```{r, fig.cap = "The basic SEM"}
build_stab_sem <- function (evt = NULL, com = NULL, stab_comp = NULL, stab = NULL,  .data = NULL) {

  rs <- map(list(evt = evt, com = com, stab_comp = stab_comp), ~paste(.x, collapse = " + "))
  stab_eq <- paste(stab, rs[["stab_comp"]], sep = " ~ ")
  stab_comp_eq <- map_chr(stab_comp, ~ paste(.x, rs[["com"]], sep = " ~ "))
  com_eq <- map_chr(com, ~paste(.x, rs[["evt"]], sep = " ~ "))


  formulas <- map(c(stab_eq, stab_comp_eq, com_eq), as.formula)

  output <- vector("list", length = length(formulas))

  output[[1]] <- lm(as.formula(stab_eq), data = .data)

  lmer_models <- map(formulas[2:length(formulas)],~lme(fixed = .x, random = ~ 1 | basin, data = .data))
  lmer_models_c <- map2(lmer_models, formulas[2:length(formulas)],
    function (.model, .formula){
      .model$call$fixed <- as.call((.formula))
      return(.model)
  }) 

  output[2:length(output)] <- lmer_models_c
  return(output)

} 

#undebug(build_stab_sem)
corsem <- build_stab_sem(
  evt = c("alt", "width", "DBO_med", "temperature_med"),
  com = c("log_rich", "piel", "c_c", "t_lvl", "beta_bin_c"),
  stab_comp = c("log_sync", "log_cv_sp"),
  stab = c("log_stab"),
  .data = lav_data)

output <- summary(as.psem(corsem), .progressBar = F)
output$coefficients %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")

source(mypath("R", "plot_methods.R"))
ggpiecewisesem(output)
```
```{r}

car::vif(lme(log_sync ~ log_rich + piel + alt + c_c + t_lvl + beta_bin_c, random = ~ 1 | basin, data = lav_data))
car::vif(lme(log_sync ~ alt + width + temperature_med + DBO_med + flow_med, random = ~ 1 | basin, data = lav_data))
```


```{r}
compute_psem <- function(.data) {
  corsem <- psem(
    lme(temperature_med ~ alt, random = ~ 1 | basin, data = .data),
    lme(log_rich ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = .data),
    lme(piel ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = .data),
    lme(c_c ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = .data),
    lme(t_lvl ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = .data),
    lme(beta_bin_c ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = .data),
    lme(log_sync ~ log_rich + piel + alt + c_c + t_lvl + beta_bin_c,
      random = ~ 1 | basin, data = .data),
    lme(log_cv_sp ~ log_rich + piel + c_c + t_lvl +
    beta_bin_c, random = ~ 1 | basin, data = .data),
    lm(log_stab ~ log_cv_sp + log_sync, data = .data)
  )
  output <- summary(corsem, .progressBar = F)

  output
}
test <- compute_psem(lav_data)
ggpiecewisesem(test)
```

- Main results:
  - Richness destabilizes communities 
  - Turnover destabilizes communities, latter increased by enrichment
  - Trophic level decreased CV but increase species synchrony!
  - Connectance!


```{r sensitivity, eval = FALSE}
myload(op_analysis_wo_holes, op_analysis_ov, dir = mypath("data"))

# Compute stability, network metrics, etc with the new datasets

# Compute SEMs
map(list(), compute_psem)

# Plot

```

#### Productivity


```{r, fig.cap = "Biomass"}
prod_sem <- psem(
  lme(temperature_med ~ alt, random = ~ 1 | basin, data = lav_data),
  lme(log_rich ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = lav_data),
  lme(piel ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = lav_data),
  lme(c_c ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = lav_data),
  lme(t_lvl ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = lav_data),
  lme(beta_bin_c ~ alt + width + temperature_med + DBO_med, random = ~ 1 | basin, data = lav_data),
  lme(prod ~ log_rich + piel + c_c + t_lvl + beta_bin_c + DBO_med + temperature_med, random = ~ 1 | basin, data = lav_data)
)
sumup_prod <- summary(prod_sem, .progressBar = F)
sumup_prod$coefficients %>%
  kable() %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```

```{r}
ggpiecewisesem(sumup_prod)
```

```{r colin_prod}
car::vif(lme(prod ~ log_rich + piel + c_c + t_lvl + beta_bin_c + temperature_med + DBO_med, random = ~ 1 | basin, data = lav_data))
```


