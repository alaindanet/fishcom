## Stability of biomass

```{r}
myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
myload(temporal_network_metrics, dir = dest_dir)
myload(temporal_community_metrics, synchrony, op_analysis, dir = data_common)
```


### Some temporal series of biomass

#### Total biomass  

```{r}
myload(community_metrics, dir = data_common)
community_metrics %<>% left_join(select(op_analysis, opcod, station, date))
station_high_low_stab <- temporal_community_metrics %>%
  arrange(desc(biomass_stab)) %>%
  slice(c(1:5, (n() - 4):(n() - 0))) %>%
  select(station) %>%
  unlist
names(station_high_low_stab) <- rep(c("high", "low"), each = 5) 
```

```{r tmp-stab, fig.dim = c(10, 7), fig.cap = "The five lowest and highest biomass stability"}
temporal_biomass <- community_metrics %>%
  filter(station %in% station_high_low_stab) %>%
  mutate(stab_status = ifelse(
      station %in% station_high_low_stab[names(station_high_low_stab) == "low"],
      "low", "high")) %>%
  group_by(stab_status, station) %>%
  nest() %>%
  group_by(stab_status) %>%
  mutate(id_stab = seq_along(station)) %>%
  unnest()
ggplot(temporal_biomass, aes(y = biomass, x = date)) +
  geom_line() +
  geom_point() +
  facet_grid(id_stab ~ stab_status, scales = "free_y") +
  labs(y = "Biomass (g)", x = "Date")
```

```{r more-stab-troph, fig.dim = c(10, 21), fig.cap = "The four station with the highest biomass stability. Dashed and solid lines represent respectively trophic species in the group 2 and 3."}

myload(network_analysis, dir = mypath("data", "classes"))
myload(trophic_level, trophic_class, dir = mypath("data"))
source(mypath("R", "synchrony.R"))
source(mypath("R", "local_network_build.R"))
# Get biomass by sp node:
net_sp_troph <- select(network_analysis, opcod, composition) %>%
  unnest(composition)
# Get synchrony and cv sp:
sync_sp_troph <- get_sync_cv_mat(com_analysis = net_sp_troph, op_analysis = op_analysis) %>%
  arrange(cv_com)
# Get trophic lvl by node
trophic_level %<>%
  rename(species = sp_class) %>%
  mutate( troph_group = get_size_class(trophic_level, NULL, troph_level,
      trophic_class))

plot_stab <- purrr::map(station_high_low_stab, function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = TRUE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab, ncol = 2)
```

```{r less-stab-troph, fig.dim = c(10, 7), fig.cap = "The four station with the lowest biomass stability. See caption of Figure for details."}
plot_grid(plotlist = plot_stab[7:10], ncol = 2)
```


```{r mid-stab-troph, fig.dim = c(10, 7), fig.cap = "Four stations with medium biomass stability. See caption of Figure for details."}
# Middle station 
plot_stab <- purrr::map(sync_sp_troph$station[209:212], function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = TRUE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab[1:4], ncol = 2)
```


```{r 75-stab-troph, fig.dim = c(10, 7), fig.cap = "Four stations with medium/low biomass stability. See caption of Figure for details."}
# Third quater
plot_stab <- purrr::map(sync_sp_troph$station[300:304], function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = FALSE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab[1:4], ncol = 2)
```

```{r 25-stab-troph, fig.cap = "Four stations with medium/low biomass stability. See caption of Figure for details."}
# Third quater
plot_stab <- purrr::map(sync_sp_troph$station[104:107], function (x) {
  p <- plot_dyn_sp_biomass(sync = sync_sp_troph, trophic_level = trophic_level, station = x, .log = FALSE)
  p + theme(legend.position="none") 
})
plot_grid(plotlist = plot_stab[1:10], ncol = 2)
```

### CV sp

```{r abun-sp, fig.dim = c(10, 7), fig.cap = "Species most abundant by trophic group."}
# Sp the most abundant by group
bm_sp_troph_grp <- net_sp_troph %>%
  filter(!is.na(troph_group) & troph_group != 1) %>%
  group_by(troph_group, sp_class, opcod) %>%
  mutate(rel_biomass = biomass / sum(biomass)) %>%
  group_by(troph_group, sp_class) %>%
  summarise(sum_rel_bm = sum(rel_biomass), biomass = mean(biomass)) %>%
  arrange(desc(sum_rel_bm)) %>%
  slice(1:20)
  
p_bm <- map(c(2, 3), .f = function(x) {
  mylim <- sapply(c(min, max),
    FUN = function(x) x(bm_sp_troph_grp$biomass))

  .data <- bm_sp_troph_grp %>%
    filter(troph_group == x)
  if (x == 2) {
    tmp_title <- paste("Medium trophic group (2)")
  } else {
    tmp_title <- paste("High trophic group (3)")
  }

  ggplot(data = .data, aes(x = sp_class, y = biomass)) +
    geom_point() +
    labs(x = "Trophic species", y = "Biomass (g)", title = tmp_title) +
    ylim(mylim[1], mylim[2]) 

})
plot_grid(plotlist = p_bm, ncol = 2)
```

```{r}
# I need:
# - by species:
#   - CV
#   - Biomass 
# - by Trophic group:
#   - Species richness 
#   - CV
#   - biomass 

# Species 

## Variance by sp and station:
var_sp <- sync_sp_troph %>%
  select(station, var_sp) %>%
  mutate(var_sp = map(var_sp, ~enframe(.x))) %>%
  unnest(var_sp) %>%
  rename(species = name, var_sp = value)
## Average biomass by sp and station:
avg_sp <- sync_sp_troph %>%
  select(station, avg_sp) %>%
  mutate(avg_sp = map(avg_sp, ~enframe(.x))) %>%
  unnest(avg_sp) %>%
  rename(species = name, avg_sp = value)
## CV and biomass by sp and station  
cv_bm_sp <- left_join(avg_sp, var_sp, by = c("station", "species")) %>%
  mutate(cv = sqrt(var_sp) / avg_sp, var_sp = NULL) %>%
  rename(bm = avg_sp)

# By trophic group:

## CV, biomass and div (ALREADY DONE!)
cv_bm_div_troph_grp <- temporal_network_metrics_classes %>% 
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(!is.na(troph_group) & troph_group != 1) %>%
  rename(bm_st = biomass_avg, div_st = richness_avg, cv_st = biomass_cv) %>%
  mutate(troph_group = as.factor(troph_group))
```

#### Diversity is not all

```{r}
library(ade4)
library(factoextra)
myload(habitat_pressure, dir = mypath("report"))
```

```{r}
div_troph_grp <- cv_bm_div_troph_grp %>%
  select(station, troph_group, cv_st) %>%
  spread(key = troph_group, cv_st) %>%
  rename(mid_cv = `2`, high_cv = `3`)

hab_press_div <- left_join(habitat_pressure,
  temporal_community_metrics[, c("station", "richness_med", "biomass_avg","biomass_stab")],
  by = "station") %>%
left_join(div_troph_grp, by = "station")
pca_hab <- dudi.pca(as.data.frame(select(na.omit(hab_press_div), -station)), scannf = FALSE, nf = 3, center = TRUE, scale = TRUE)

eig_plot <- fviz_eig(pca_hab)
pca_plot <- fviz_pca_var(pca_hab,
    axes = c(1, 2),
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
  )

ggdraw(pca_plot) + 
  draw_plot(eig_plot, x = .9, y = .95, hjust = 1, vjust = 1, width = 0.17, height = 0.25)
```

```{r}
m <- cor(as.matrix(select(na.omit(hab_press_div), -station)), method =
  "spearman")
corrplot::corrplot(m, order="hclust")
```

```{r, eval = FALSE}
mod <- lm(high_cv ~ temperature + richness_med:temperature + DBO + lat + insecticides + herbicides + insecticides, hab_press_div)
car::vif(mod)

mod <- lm(mid_cv ~ richness_med + DBO + lat + temperature + insecticides + herbicides + insecticides, hab_press_div)
car::vif(mod)
```

#### Assembly rules: richness and biomass distribution 

One missing part was the fact that we do not know the assembly rules of the
trophic group.


```{r}
cv_bm_div_troph_grp %>%
  ggplot(aes(y = cv_st, x = div_st)) +
  geom_point() +
  facet_grid(cols = vars(troph_group))
```

```{r}
sync_com_troph <- net_sp_troph %>%
    rename(species = sp_class) %>%
    filter(troph_group != 1) %>%
    mutate(troph_group = as.factor(troph_group)) %>%
    group_by(troph_group) %>%
    nest() %>%
    mutate(sync = map(data, ~get_sync_cv_mat(com_analysis = .x, op_analysis = op_analysis))) %>%
    unnest(sync) %>%
    mutate(sdt.dev = map_dbl(cov_mat, ~sqrt(sum(.x)))) %>%
    select(troph_group, station, synchrony, cv_sp, cv_com, sdt.dev) %>%
    left_join(cv_bm_div_troph_grp, by = c("station", "troph_group"))
```

```{r sd-avg-div}
form <- y ~ x
form2 <- y ~ Vmax * x / (Km + x)
form3 <- y ~  a + exp(b * x) 
fit <- stat_poly_eq(
  formula = form2,
  eq.with.lhs = "italic(hat(y))~`=`~",
  aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
  parse = TRUE)

ymax <- max(cv_bm_div_troph_grp$bm_st, sync_com_troph$sdt.dev)
ymin <- min(cv_bm_div_troph_grp$bm_st, sync_com_troph$sdt.dev)
p_bm <- cv_bm_div_troph_grp %>%
  ggplot(aes(y = bm_st, x = div_st)) +
  geom_point() +
  geom_smooth(method = 'nls', formula = form3,
   method.args = list(start = c(a = 0, b = 3)), se = F) +
  #fit +
  facet_grid(cols = vars(troph_group)) +
  #scale_y_log10(limits = c(ymin, ymax)) +
  labs(y = "Average biomass (g).", x = "Species richness")

p_sd <- sync_com_troph %>%
  ggplot(aes(x = div_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  fit +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10(limits = c(ymin, ymax)) +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Species richness")

plot_grid(p_sd, p_bm, ncol = 1)
```
It seems that the relationship between the standard deviation and the number of
species saturates for 10 species in medium trophic group while it saturates at 7
for the high trophic group (Figure \@ref(fig:sd-avg-div)).

To get opposite stability-diversity relationships in the different trophic
group, it supposes that for medium trophic group, the avg biomass increases
faster than the biomass standard deviation with increasing species richness. And
the reverse for the high trophic group, i.e. that the standard deviation
increases faster than the average biomass.

A question: What are the determinant of the relationship beween avg/standard
deviation and the number of species?

Part of the solution

```{r}
formula <- y ~ x #needed for stat_poly_eq
sync_com_troph %>%
  ggplot(aes(x = bm_st, y = sdt.dev)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  facet_grid(cols = vars(troph_group)) +
  scale_y_log10() +
  scale_x_log10() +
  labs(y = "Standard deviation of biomass temporal data (g).", x = "Average
      biomass (g)")
```

```{r}

```




#### CV sp VS CV group

There was a positive relationship between the species CV of the most abundant
species in the high trophic group and the CV of the same high trophic group
(Figure \@ref(fig:cv-sp-grp3), right panel). Interestingly, this relationship
is less clear (however clearly present for some species) for the most abundant
species in the medium trophic group (Figure \@ref(fig:cv-sp-grp2), right panel).

```{r cv-sp-grp3, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the CV of the different trophic groups"}
cv_sp_grp <- left_join(select(cv_bm_sp, -bm),
  select(cv_bm_div_troph_grp, -biomass_stab), by = "station")

sp_grp3 <- bm_sp_troph_grp %>%
  filter(troph_group == 3) %>%
  arrange(desc(biomass))
  
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = cv_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "CV of the trophic group", y = "CV of the species")
```

```{r cv-sp-grp2, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the CV of the different trophic groups"}
sp_grp2 <- bm_sp_troph_grp %>%
  filter(troph_group == 2) %>%
  arrange(desc(biomass))
  
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = cv_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller =
    labeller(troph_group = troph_group_labeller())) +
  labs(x = "CV of the trophic group", y = "CV of the species")
```

#### CVsp versus Biomass by trophic group

```{r cv-sp-bm-grp3, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the biomass of the different trophic groups"}
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = bm_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller()),
    scales = "free_x") +
  labs(x = "Biomass of the trophic group (g)", y = "CV of the species")

```

```{r cv-sp-bm-grp2, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the biomass of the different trophic groups"}
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = bm_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller()),
    scales = "free_x") +
  labs(x = "Biomass of the trophic group (g)", y = "CV of the species")
```

#### CVsp versus diversity by trophic group

```{r cv-sp-div-grp3, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the high trophic group versus the species richness in the different trophic groups."}
cv_sp_grp %>%
  filter(species %in% sp_grp3$sp_class[1:10]) %>%
  ggplot(aes(x = div_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "Species richness of the trophic group", y = "CV of the species")
```

```{r cv-sp-div-grp2, fig.dim = c(7, 21), fig.cap = "CV of the most abundant species in the medium trophic group versus the species richness in the different trophic groups."}
cv_sp_grp %>%
  filter(species %in% sp_grp2$sp_class[1:10]) %>%
  ggplot(aes(x = div_st, y = cv)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(species), labeller = labeller(troph_group = troph_group_labeller())) +
  labs(x = "Species richness of the trophic group", y = "CV of the species")
```

#### Temporal dynamics in high diversity community 

```{r}
high_div_station <- temporal_community_metrics %>%
  arrange(desc(richness_med)) %>%
  slice(1: 5) %>%
  select(station) %>%
  unlist
```

```{r tmp-richest, fig.dim = c(10, 7), fig.cap = "The five highest rich community."}
label_stab <- filter(temporal_community_metrics,
  station %in% high_div_station) %>%
mutate(
  x_pos = ymd_hms("2005-01-01T15:00:00"),
  x_pos = as.Date(x_pos),
  y_pos = 50000,
  text = paste0("Stability: ", round(biomass_stab,2)),
)
ggplot(filter(community_metrics, station %in% high_div_station),
  aes(y = biomass, x = date)) +
  geom_line() +
  geom_point() +
  geom_text(data = label_stab, aes(x = x_pos, y = y_pos, label =
      text), size = 6) +
  facet_wrap( ~ station) + 
  labs(y = "Biomass (g)", x = "Date")
```

```{r}
myload(network_analysis, network_metrics, dir = dest_dir)
high_div_troph_group <- network_metrics %>%
  select(opcod, troph_group) %>%
  unnest() %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  left_join(select(op_analysis, opcod, station, date)) %>%
  filter(station %in% high_div_station)
```

```{r, fig.dim = c(10, 7)}
ggplot(high_div_troph_group,
  aes(y = nbnode, x = date, color = troph_group)) +
  geom_line() +
  geom_point() +
  geom_text(data = label_stab,
    x = ymd_hms("2015-01-01T15:00:00"),
    y = 3, aes(label =
      text), size = 6, inherit.aes = FALSE) +
  facet_wrap( ~ station) + 
  labs(title = "The five richest station",
  y = "Fish species richness", x = "Date")
```

```{r}
highest_div_grp_3_station <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group == 3) %>%
  arrange(desc(richness_avg)) %>%
  slice(1:12) %>%
  select(station) %>%
  unlist()
high_div_troph_group_3 <- network_metrics %>%
  select(opcod, troph_group) %>%
  unnest() %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  left_join(select(op_analysis, opcod, station, date)) %>%
  filter(station %in% highest_div_grp_3_station)
```

```{r, fig.dim = c(10, 7)}
ggplot(high_div_troph_group_3,
  aes(y = biomass, x = date, color = troph_group)) +
  geom_line() +
  geom_point() +
  geom_text(data = filter(temporal_community_metrics, station %in% highest_div_grp_3_station),
    x = ymd_hms("2015-01-01T15:00:00"),
    y = 3, aes(label = paste0("Stability: ", round(biomass_stab, 2))),
    size = 6, inherit.aes = FALSE) +
  facet_wrap( ~ station) + 
  labs(title = "The twelve richest station of superior predator",
  y = "Biomass of trophic group (g)", x = "Date")
```

```{r}
ggplot(high_div_troph_group_3,
  aes(y = biomass, x = date, color = troph_group)) +
  geom_line() +
  geom_point() +
  geom_text(data = filter(temporal_community_metrics, station %in% highest_div_grp_3_station),
    x = ymd_hms("2015-01-01T15:00:00"),
    y = 3, aes(label = paste0("Stability: ", round(biomass_stab, 2))),
    size = 6, inherit.aes = FALSE) +
  facet_wrap( ~ station) + 
  labs(title = "The twelve richest station of superior predator",
  y = "Biomass of trophic group (g)", x = "Date")
```


### Map stability

```{r map-stab, fig.cap = "Repartition of average biomass and biomass stability (logged)."}
myload(station_analysis, region_polygon, dir = data_common)
stab <- temporal_community_metrics %>% 
  select(station, biomass_stab, biomass_avg)
station_stab <- left_join(station_analysis, rename(stab, id = station)) %>%
  filter(!is.na(biomass_stab))
map_stab <- ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_stab)), size = 4) +
    scale_color_gradient(low = "red", high = "green") +
    labs(title = "Biomass stability")

map_bm <- ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_avg)), size = 4) +
    scale_color_gradient(low = "red", high = "green") +
    labs(title = "Average biomass (g)")

plot_grid(map_stab, map_bm, ncol = 2)
```

Biomass stability was lower in south-west of France (Figure
\@ref{fig:map-stab}, left panel). Average fish biomass was lower in moutain
region (Pyrénées, Alps, Massif Central; Figure \@ref{fig:map-stab}, right
panel), generally close to the source.


```{r map-st, fig.dim = c(7, 15), fig.cap = "Repartition of the average biomass, biomass stability and species diversity by trophic group, respectively medium and high for the left and right panel. All the metrics were logged."}
tmp <- rename(cv_bm_div_troph_grp, id = station)
station_troph_div <- left_join(station_analysis, tmp, by = "id")

map_st_metrics <- purrr::map(c("bm_st", "div_st", "biomass_stab"), function (metric) {
  station_troph_div[[metric]] <- log10(station_troph_div[[metric]])
  ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_troph_div, aes_(color = as.name(metric)), size = 4) +
    facet_grid(cols = vars(troph_group)) +
    scale_color_gradient(low = "red", high = "green")
  
  })
plot_grid(plotlist = map_st_metrics, ncol = 1)
```

The biomass in both trophic groups were lower in moutain area (Figure
\@ref(map-st)), the same was true for species diversity. For stability, it is
difficult to see a pattern.

### Link biomass stability with community structure


```{r stab-div-mult, fig.dim = c(10, 7), fig.cap = "Link between the stability of biomass and diversity"}
biomass_com <- temporal_community_metrics %>%
  left_join(select(synchrony, station, synchrony, cv_sp)) %>%
  select(biomass_stab, synchrony, cv_sp, richness_cv, richness_med, betadiv) %>%
  gather(diversity, div_value, richness_med, richness_cv, betadiv) %>%
  gather(stability, stab_value, biomass_stab, synchrony, cv_sp)

formula <- y ~ x #needed for stat_poly_eq
qplot(div_value, stab_value, data =  biomass_com, geom = "point") +
  facet_grid(stability ~ diversity, labeller = mylabel(), scales = "free") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(x = "Diversity", y = "Stability component")
```



```{r stab-net, fig.cap = "Link between biomass stability and network structure (median)"}
# plot
avg_network <- temporal_network_metrics %>%
  select_at(vars(dplyr::matches("med|station")))
biomass_stab_station <- temporal_community_metrics %>%
  select(station, biomass_stab)
stab_biomass_net_avg <- left_join(avg_network, biomass_stab_station) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")

# TODO: think about not facetting (list of plots ?)
# Facet label:
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(stab_biomass_net_avg, aes(y = biomass_stab, x = values)) +
  geom_point() +
  facet_wrap(~ metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median of the network indices",
    y = "Biomass stability"
  )
p
```



```{r stab-comp, fig.cap = "Link between biomass stability by trophic group and total species richness (median)"}
net_troph_group <- temporal_network_metrics_classes %>% 
  unnest(troph_group) %>%
  mutate(troph_group = as.factor(troph_group))
net_troph_group %<>%
  select_at(vars(dplyr::matches("_med|stab|station|troph_group"))) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", ""))
p <- ggplot(net_troph_group, aes(y = biomass_stab, x = values, color = troph_group)) +
  geom_point() +
  ggplot2::scale_fill_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  facet_wrap(~metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "network_med",
    y = "biomass_stab"
  )
p
```



The Figure \@ref(fig:stab-comp) showed that medium trophic level part of the
network had a positive stability-diversity relationship with while high
trophic level had a negative one.  
Furthermore, we see that high trophic level compartment had a highest stability
than the medium compartment. In the same vein, the latter pattern is confirmed
when looking at the richness by compartment instead of the total richness
(Figure \@ref(fig:stab-comp2)).  


```{r stab-comp2, fig.dim = c(10, 7), fig.cap = "Link between biomass stability and species richness by trophic group (median). (Classes network)"}
net_troph_group <- temporal_network_metrics_classes %>% 
  select(station, troph_group) %>%
  unnest() %>%
  filter(!is.na(troph_group)) %>%
  mutate(troph_group = as.factor(troph_group))
plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_stab"
  )
plot_stab_richness_troph_group
```
 
One hypothesis to explain this opposite pattern might be a disequilibrium
between the two compartment. We can imagine that each compartment can
destabilize each other according to the part of the total biomass of total
species richness that there are in each of them. The figure
\@ref(fig:stab-comp-ratio) showed that the biomass stability of the medium
compartment decreased with the increase of biomass and species number ratio in
the high compartment and we observed the reverse for the high trophic
compartment. It indicates that a trophic compartment is more stable when their
relative biomass increases. 

We are looking forward to fully understand why we observed this inverse
relationship.

```{r stab-comp-ratio, fig.cap = "Biomass stability and ratio of biomass and species number (top and bottom panel resp.) in the high trophic level (classes network) for the medium and high trophic group (resp. left and right panels)."}
ratio_sp <- net_troph_group %>%
  select(station, troph_group, richness_avg) %>%
  spread(troph_group, richness_avg) %>%
  mutate(sp_h_m = `3` / (`3` + `2`)) %>%
  select(station, sp_h_m)

ratio_bm <- net_troph_group %>%
  select(station, troph_group, biomass_avg) %>%
  spread(troph_group, biomass_avg) %>%
  mutate(bm_h_m = `3` / (`3` + `2`)) %>%
  select(station, bm_h_m)


net_troph_group <- temporal_network_metrics_classes %>%
  left_join(ratio_sp, by = "station") %>%
  left_join(ratio_bm, by = "station") %>%
  select(station, troph_group, sp_h_m, bm_h_m) %>%
  unnest() %>%
  filter(!is.na(troph_group), troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  gather(ratio_troph, value, sp_h_m, bm_h_m)

plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = value)) +
  geom_point(aes(color = richness_avg)) +
  facet_grid(cols = vars(troph_group), rows = vars(ratio_troph), labeller =
    troph_group_labeller()) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    y = "biomass_stab"
  ) + 
    xlab("Ratio of biomass and species nb in high troph compartment compare to total")
plot_stab_richness_troph_group

```
