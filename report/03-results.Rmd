# Results


## Network description 


```{r net-cor-med, fig.cap = "Correlation between network indices (median over the temporal series). "}
# Get network metrics
myload(temporal_network_metrics, dir = dest_dir)
myload(temporal_community_metrics, synchrony, dir = data_common)

cor_avg <- temporal_network_metrics %>%
  select_at(vars(dplyr::matches("med"))) %>%
  cor()
#knitr::kable(cor_avg)
as.data.frame(round(cor_avg,2)) %>%
  mutate_all(funs(cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)
```

```{r net-cor-cv, fig.cap="Correlation between network indices (CV over the temporal series). "}
cor_cv <- temporal_network_metrics %>%
  select_at(vars(dplyr::matches("cv"))) %>%
  cor()
as.data.frame(round(cor_cv,2)) %>%
  mutate_all(funs(cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)
```

```{r}
library(ade4)
library(factoextra)

net_ind <- temporal_network_metrics %>%
  left_join(select(temporal_community_metrics, station, richness_med)) %>%
  select_at(vars(dplyr::matches("med")))

res.pca <- dudi.pca(na.omit(net_ind),
  scannf = FALSE,   # Hide scree plot
  nf = 5            # Number of components kept in the results
)
eig_plot <- fviz_eig(res.pca)
```

```{r}
pca_plot <- lapply(list(c(1,2), c(1, 3), c(3, 2)), function (axes) {
  fviz_pca_var(res.pca,
    axes = axes,
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
  )
})


temp_plot <- plot_grid(plotlist = pca_plot)
plot_grid(temp_plot, eig_plot)
```


### Look at some network temporal series


Let's look at network that have particular network properties. 

```{r}
myload(network_analysis, dir = mypath("data", "species"))
myload(op_analysis, metaweb_analysis, dir = data_common)
meta <- metaweb_analysis; rm(metaweb_analysis)

net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest() %>%
  left_join(., dplyr::select(op_analysis, opcod, station, date)) 
```

```{r}
station_high_low_modularity <- temporal_network_metrics %>%
  arrange(desc(modularity_med)) %>%
  slice(c(1, n())) %>%
  select(station) %>%
  unlist
names(station_high_low_modularity) <- c("high", "low") 
```

```{r tmp-net-h-mod, fig.cap = "Station with the highest modularity (median)."}
# High modularity
net_ex <- filter(net, station == station_high_low_modularity["high"])

my_crap_temporal_network(net = net_ex, metaweb = meta$metaweb, network_data
  = network_analysis)
```
```{r tmp-net-l-mod, fig.cap = "Station with the lowest modularity (median)."}
# Low modularity
net_ex <- filter(net, station == station_high_low_modularity["low"])
my_crap_temporal_network(net = net_ex, metaweb = meta$metaweb, network_data
  = network_analysis)
```

```{r}
station_high_low_nestedness <- temporal_network_metrics %>%
  arrange(desc(nestedness_med)) %>%
  slice(c(1, n())) %>%
  select(station) %>%
  unlist
names(station_high_low_nestedness) <- c("high", "low") 
```
```{r tmp-net-h-nest, fig.cap = "Station with the highest nestedness (median)."}
# high nestedness
net_ex <- filter(net, station == station_high_low_nestedness["high"])
my_crap_temporal_network(net = net_ex, metaweb = meta$metaweb, network_data
  = network_analysis)
```

```{r tmp-net-l-nest, fig.cap = "Station with the lowest nestedness (median)."}
# low nestedness
net_ex <- filter(net, station == station_high_low_nestedness["low"])
my_crap_temporal_network(net = net_ex, metaweb = meta$metaweb, network_data
  = network_analysis)
```

## Productivity



## Stability of biomass


### Some temporal series of biomass

```{r}
myload(community_metrics, dir = data_common)
community_metrics %<>% left_join(select(op_analysis, opcod, station, date))
station_high_low_stab <- temporal_community_metrics %>%
  arrange(desc(biomass_stab)) %>%
  slice(c(1:5, (n() - 4):(n() - 0))) %>%
  select(station) %>%
  unlist
names(station_high_low_stab) <- rep(c("high", "low"), each = 5) 
```

```{r tmp-stab, fig.dim = c(10, 7), fig.cap = "The five lowest and highest biomass stability"}
temporal_biomass <- community_metrics %>%
  filter(station %in% station_high_low_stab) %>%
  mutate(stab_status = ifelse(
      station %in% station_high_low_stab[names(station_high_low_stab) == "low"],
      "low", "high")) %>%
  group_by(stab_status, station) %>%
  nest() %>%
  group_by(stab_status) %>%
  mutate(id_stab = seq_along(station)) %>%
  unnest()
ggplot(temporal_biomass, aes(y = biomass, x = date)) +
  geom_line() +
  geom_point() +
  facet_grid(id_stab ~ stab_status, scales = "free_y") +
  labs(y = "Biomass (g)", x = "Date")
```

### Map stability

```{r}
myload(station_analysis, region_polygon, dir = data_common)
stab <- temporal_community_metrics %>% 
  select(station, biomass_stab)
station_stab <- left_join(station_analysis, rename(stab, id = station)) %>%
  filter(!is.na(biomass_stab))
ggplot(data = region_polygon) +
    geom_sf() +
    geom_sf(data = station_stab, aes(color = log(biomass_stab)), size = 4) +
    scale_color_gradient(low = "red", high = "green")
```

### Link biomass stability with community structure


```{r stab-div-mult, fig.dim = c(10, 7), fig.cap = "Link between the stability of biomass and diversity"}
biomass_com <- temporal_community_metrics %>%
  left_join(select(synchrony, station, synchrony, cv_sp)) %>%
  select(biomass_stab, synchrony, cv_sp, richness_cv, richness_med, betadiv) %>%
  gather(diversity, div_value, richness_med, richness_cv, betadiv) %>%
  gather(stability, stab_value, biomass_stab, synchrony, cv_sp)

formula <- y ~ x #needed for stat_poly_eq
qplot(div_value, stab_value, data =  biomass_com, geom = "point") +
  facet_grid(stability ~ diversity, labeller = mylabel(), scales = "free") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(x = "Diversity", y = "Stability component")
```



```{r stab-net, fig.cap = "Link between biomass stability and network structure (median)"}
# plot
avg_network <- temporal_network_metrics %>%
  select_at(vars(dplyr::matches("med|station")))
biomass_stab_station <- temporal_community_metrics %>%
  select(station, biomass_stab)
stab_biomass_net_avg <- left_join(avg_network, biomass_stab_station) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")

# TODO: think about not facetting (list of plots ?)
# Facet label:
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(stab_biomass_net_avg, aes(y = biomass_stab, x = values)) +
  geom_point() +
  facet_wrap(~ metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median of the network indices",
    y = "Biomass stability"
  )
p
```



```{r stab-comp, fig.cap = "Link between biomass stability by trophic group and total species richness (median)"}
myload(temporal_network_metrics, dir = mypath("data", "classes"))
net_troph_group <- temporal_network_metrics %>% 
  unnest(troph_group) %>%
  mutate(troph_group = as.factor(troph_group))
net_troph_group %<>%
  select_at(vars(dplyr::matches("_med|stab|station|troph_group"))) %>%
  gather(metrics, values, colnames(select_at(., vars((dplyr::matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", ""))
p <- ggplot(net_troph_group, aes(y = biomass_stab, x = values, color = troph_group)) +
  geom_point() +
  ggplot2::scale_fill_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  facet_wrap(~metrics, labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "network_med",
    y = "biomass_stab"
  )
p
```


The Figure \@ref(fig:stab-comp) showed that medium trophic level part of the
network had a positive stability-diversity relationship with while high
trophic level had a negative one.  
Furthermore, we see that high trophic level compartment had a highest stability
than the medium compartment. In the same vein, the latter pattern is confirmed when looking at the richness by compartment instead of the total richness (Figure \@ref(fig:stab-comp2)).  


```{r stab-comp2, fig.dim = c(10, 7), fig.cap = "Link between biomass stability and species richness by trophic group (median)"}
net_troph_group <- temporal_network_metrics %>% 
  select(station, troph_group) %>%
  unnest() %>%
  filter(!is.na(troph_group)) %>%
  mutate(troph_group = as.factor(troph_group))
plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_stab"
  )
plot_stab_richness_troph_group
```
 
One hypothesis to explain this opposite pattern might be a disequilibrium
between the two compartment. We can imagine that each compartment can
destabilize each other according to the part of the total biomass of total
species richness that there are in each of them. The figure
\@ref(fig:stab-comp-ratio) showed that the biomass stability of the medium
compartment decreased with the increase of biomass and species number ratio in
the high compartment and we observed the reverse for the high trophic
compartment.  

We are looking forward to fully understand why we observed this inverse
relationship.

```{r stab-comp-ratio, fig.cap = "Biomass stability and ratio of biomass and species number (top and bottom panel resp.) in the high trophic level"}
ratio_sp <- net_troph_group %>%
  select(station, troph_group, richness_avg) %>%
  spread(troph_group, richness_avg) %>%
  mutate(sp_h_m = `3` / (`3` + `2`)) %>%
  select(station, sp_h_m)

ratio_bm <- net_troph_group %>%
  select(station, troph_group, biomass_avg) %>%
  spread(troph_group, biomass_avg) %>%
  mutate(bm_h_m = `3` / (`3` + `2`)) %>%
  select(station, bm_h_m)

net_troph_group <- temporal_network_metrics %>%
  left_join(ratio_sp, by = "station") %>%
  left_join(ratio_bm, by = "station") %>%
  select(station, troph_group, sp_h_m, bm_h_m) %>%
  unnest() %>%
  filter(!is.na(troph_group), troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  gather(ratio_troph, value, sp_h_m, bm_h_m)

plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = log(biomass_stab), x = value)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(ratio_troph), labeller =
    troph_group_labeller()) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    y = "biomass_stab"
  ) + 
    xlab("Ratio of biomass and species nb in high troph compartment compare to total")
plot_stab_richness_troph_group
```


## Pressure



## SEM 

### All

### By basin
