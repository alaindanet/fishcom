# Methods

We describe our methods in this chapter.

## Data collection


### Fish length

```{r, fig.cap = "Distribution of fish length. Red, green and black respectively locate the median, the mean and the 200mm threshold."}
myload(length_analysis, dir = mypath("data"))
length_analysis %>%
  ggplot(aes(x = length)) +
  geom_histogram() +
  geom_vline(xintercept = median(length_analysis$length, na.rm = TRUE), color = "red") +
  geom_vline(xintercept = mean(length_analysis$length, na.rm = TRUE), color = "green") +
  geom_vline(xintercept = 200, color = "black")
```



## Network building


### Metaweb


```{r metaweb, fig.cap = "Metaweb representation (9 classes by fish species)"}
library(igraph)
library(NetIndices)
myload(metaweb_analysis, dir = data_common)
meta <- metaweb_analysis; rm(metaweb_analysis)

g <- igraph::graph_from_adjacency_matrix(meta$metaweb, mode = "directed")

# Define layout
lay <- layout.fruchterman.reingold(g)
# Compute trophic level
dead_material <- c("det", "biof")
lay[, 2] <- TrophInd(meta$metaweb, Dead = dead_material)$TL
# Plot
par(mar=rep(5, 4))
plot.igraph(g,layout=lay,vertex.label=NA,vertex.size=2,edge.arrow.size=.5,edge.width=.5)
```

### Local networks 

OMG, that is bautiful!

```{r local-net, fig.cap = "An exemple of a local network"}
myload(network_analysis, dir = mypath("data", "species"))
myload(op_analysis, dir = data_common)
net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest() %>%
  left_join(., dplyr::select(op_analysis, opcod, station, date)) 

net_ex <- filter(net, station == unique(net$station) %>% sample(., 1))

net_list <- net_ex %>%
  dplyr::select(date, from, to) %>%
  arrange(date) %>%
  group_by(date) %>%
  nest(.key = "network")

size_analysis <- network_analysis %>%
  dplyr::select(opcod, composition) %>%
  filter(opcod %in% net_ex$opcod) %>%
  unnest() %>%
  left_join(select(net_ex, date, opcod) %>% distinct(opcod, date)) %>%
  dplyr::select(date, biomass, species) %>%
  arrange(date) %>%
  group_by(date) %>%
  nest() %>%
  mutate(biomass = map(data, function(x){
      val <- x$biomass
      names(val) <- x$species 
      val
  }))

net_list %<>%
  left_join(dplyr::select(size_analysis, date, biomass))
#Node position:
node <- net_list$network %>% unlist(., use.names = FALSE) %>% unique
test <- graph_from_adjacency_matrix(meta$metaweb) %>%
  igraph::as_data_frame(.) %>%
  mutate_all(list(~str_extract_all(., "[a-zA-Z]+", simplify = TRUE))) %>%
  distinct(from, to)
node_position <- create_layout(graph_from_data_frame(test), layout = "kk")$x
names(node_position) <- create_layout(graph_from_data_frame(test), layout = "kk")$name
#color:
color <- set_color_species(node_list = node, species_list = NULL,
  resource_list = NULL,
  col_resource = NULL)

## Graph -------------------------
plot_temporal_network(
  data = net_list,
  net_var = network,
  date = date,
  x = node_position,
  y = net_list[["y"]],
  size = net_list[["biomass"]]
)

```

This is super cool to see! =)

## Environmental data 

### Habitat

```{r}
myload(temporal_station_desc, temporal_press_polluants, dir = data_common)
myload(hab_analysis, geo_station, dir = data_common)

habitat <- hab_analysis %>%
  mutate_all(list(as.factor)) %>%
  select(-opcod, -station, -aqua_vg)

lvl <- c("null", "weak", "medium", "high")
lvl_sinuosite <- c("straight", "sinuous", "very_sinuous", "meandering")
lvl_shade <- c("clear", "quite_clear", "quite_covered", "covered")

habitat_station <- hab_analysis %>%
  select(-opcod, -aqua_vg, - shade, - sinuosite) %>%
  mutate_if(is.character, list(~factor(., levels = lvl, ordered = TRUE))) %>%
  left_join(select(hab_analysis, station, shade, sinuosite)) %>%
  mutate(
    shade = factor(shade, levels = lvl_shade, ordered = TRUE),
    sinuosite = factor(sinuosite, levels = lvl_sinuosite, ordered = TRUE)) %>%
  group_by(station) %>%
  summarise_all(list(med = ~median(as.numeric(.), na.rm = TRUE))) %>%
  left_join(select(temporal_station_desc, station, width_river_mean, avg_depth_station_mean, width_river_cv, avg_depth_station_cv))

# Add alt, lat, etc...
habitat_station %<>% 
  left_join(geo_station, by = "station") %>%
  select(-region_csp)
# Add temp and flow
flow_temp <- temporal_press_polluants %>%
  filter(category %in% c("flow", "temperature", "DBO", "herbicides",
      "fungicides", "insecticides", "nitrates", "phosphore")) %>%
  rename(station = id) 
flow_temp_med <- flow_temp %>%
  mutate(category = str_c(category, "_med")) %>%
  select(station, category, press_med) %>%
  spread(category, press_med)
flow_temp_cv <- flow_temp %>%
  mutate(category = str_c(category, "_cv")) %>%
  select(station, category, cv_press) %>%
  spread(category, cv_press)

habitat_station %<>%
  left_join(left_join(flow_temp_med, flow_temp_cv, by = "station"), by = "station")
habitat_pressure <- habitat_station
mysave(habitat_pressure, dir = mypath("report"), overwrite = TRUE)
```


### Relationship between environmental variables

```{r pca-hab, fig.dim = c(7, 21), fig.cap = "PCA over habitat description"}
library(ade4)
library(factoextra)
pca_hab <- dudi.pca(as.data.frame(select(na.omit(habitat_station), -station)), scannf = FALSE, nf = 3, center = TRUE, scale = TRUE)

eig_plot <- fviz_eig(pca_hab)
pca_plot <- fviz_pca_var(pca_hab,
    axes = c(1, 2),
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
  )
pca_plot12 <- ggdraw(pca_plot) +
  draw_plot(eig_plot, x = .7, y = .95, hjust = 1, vjust = 1, width = 0.17, height = 0.25)

pca_plot13 <- fviz_pca_var(pca_hab,
    axes = c(1, 3),
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
  )

pca_plot23 <- fviz_pca_var(pca_hab,
    axes = c(2, 3),
    col.var = "contrib", # Color by contributions to the PC
    gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
    repel = TRUE     # Avoid text overlapping
  )
plot_grid(pca_plot12, pca_plot13, pca_plot23, ncol = 1)
```

The PCA (Fig. \@ref(fig:pca-hab)) showed unsurprisingly that order of strahler, the
depth, width of the river and distance to source and avg flow are closely
linked. Altitude, slope and the amount of rocky shelter are also closely linked.
Station of larger latitude had also higher DBO and phosphorus, higher annual
mean temperature and more vegetation.  The first axis of the PCA (ordinate)
discriminated station located far from the source (which are large, deep, with a
big annual flow and high strahler order) from the shady station, which are
sinuous, with a variety of habitat such as under bank and logjam.
The second axis (abscissa) discriminated station in altitude with high slope,
composed of rocky habitat from the ones that had higher average annual
temperature located in the south, with more enrichment (DBO, nitrates,
phosphorus) and that are more vegetated.

```{r}
dev.off()
m <- cor(as.matrix(select(na.omit(habitat_station), -station)), method = "spearman")
corrplot::corrplot(m, order="hclust", type = "upper", diag = FALSE)
```


#### Distribution of environmental variables

```{r dist-env, fig.cap = "Histogram of the station average environmental values through time."}

dist_env <- habitat_pressure %>%
  select(station, width_river_mean:temperature_cv) %>%
  gather(env_var, value, width_river_mean:temperature_cv) 
med_dist_env <- dist_env %>%
  group_by(env_var) %>%
  summarise(value = median(value, na.rm = TRUE))

dist_env %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  geom_vline(data = med_dist_env, aes(xintercept = value), color = "red", size =
    2) +
  facet_wrap(facets = ~ env_var, ncol = 3, scales = "free")

```


The figure \@ref[fig:dist-env] shows that, taking the environmental values one
by one, there was no apparent bimodality for habitat description such as
altitude, slope, distance from source, strahler order, river width and depth, flow, temperature.
However, variables such as latitude, insecticides, fungicides, herbicides
displayed bimodality. Those bimodalities will be helpful to test relationship
between stability and diversity for different subset of the dataset and so, test
the robustness of the relationship.

```{r split-rivers, fig.dim = c(7, 12)}
hab_type <- habitat_pressure %>%
  mutate(high_bin = ifelse(alt > median(alt), TRUE, FALSE),
  wide_bin = ifelse(width_river_mean > median(width_river_mean), TRUE, FALSE),
  hab_type = map2_chr(high_bin, wide_bin, function(high, wide){
    if (high) {
      if (wide) {
	"high_wide"
      } else {
	"high_narrow"
      }
    } else {
      if (wide) {
	"low_wide"
      } else {
	"low_narrow"
      }
    }
      
      })
  ) %>%
mutate(hab_type = map_chr(high_bin, ~ifelse(.x, "high", "low"))) %>%
select(station, hab_type)

hab_type_pca <- hab_type[hab_type$station %in% na.omit(habitat_station)$station, ]
match_st <- match(hab_type_pca$station, na.omit(habitat_station)$station)
hab_type_pca <- hab_type_pca[order(match_st), ]

pca_cat_river <- fviz_pca_ind(pca_hab, label="none", habillage=hab_type_pca$hab_type,
  , ellipse.type = "convex",
             addEllipses=TRUE, ellipse.level=0.95)
plot_grid(pca_plot, pca_cat_river, ncol = 1)
mysave(hab_type, dir = mypath("report"), overwrite = TRUE)
```



### Pressure


#### Press category


```{r press-units, fig.cap = "All the parameters collected together with their units"}
# Put units to present all the parameters
myload(polluant_units, dir = mypath("data-raw", "polluants", "naiades_data"))
kable(polluant_units) %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```

```{r press-cat, fig.cap = "Molecules of pressure by category together with their toxicity if relevant or available"}
myload(press_cat, dir = mypath("data-raw", "polluants"))
kable(arrange(press_cat, category)) %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "400px")
```


#### Press trough time


```{r press-time, fig.cap = "Average press category over the station through time. The pesticides are expressed in Toxic Unit (TU)."}
myload(press_metrics, dir = mypath("data"))
ggplot(press_metrics, aes(y = press, x = year)) +
  stat_summary(fun.y = "mean", geom = "line") +
  stat_summary(geom="ribbon", fun.data=mean_cl_normal, colour=NA,alpha=0.1)+
  facet_wrap(~category, scales = "free_y")
```

Most of the pressure decreased through time expect notably the nitrates and the
temperature (Fig. \@ref(fig:press-time)). **Be careful, there are certainly a
biais in temperature increase because the number of station that have been
sampled. It would be nice to look at the tendency by station.**


## Analysis

### Community 

Community composition were analyzed thanks to [NMDS](https://jonlefcheck.net/2012/10/24/nmds-tutorial-in-r/). 

```{r}
myload(community_metrics, temporal_community_metrics, synchrony, op_analysis, dir = data_common)
myload(community_analysis, dir = data_common)
myload(network_analysis, dir = mypath("data", "classes"))
myload(habitat_pressure, dir = mypath("report"))
```

```{r}
com <- ungroup(community_analysis) %>%
  select(opcod, species, biomass) %>%
  spread(species, biomass) %>%
  left_join(op_analysis[, c("opcod", "station")], by = "opcod") %>%
  filter(!is.na(station)) %>%
  mutate_all(list(~ ifelse(is.na(.), 0, .))) %>%
  select(-opcod) %>%
  group_by(station) %>%
  summarise_all(list(median))

com_mat <- as.matrix(com[, names(com) != "station"])
rownames(com_mat)  <- com$station 

order_st <- match(temporal_community_metrics$station, com$station) 
tps_com_met <- temporal_community_metrics[order(order_st),] 
 
```

```{r, echo = FALSE}
library(vegan)

nmds <- metaMDS(com_mat, k=3, trymax = 100)
stressplot(nmds)
plot(nmds)
mysave(nmds, dir = mypath("report"), overwrite = TRUE)

bluefunc <- colorRampPalette(c("lightyellow", "darkred"))
ordiplot(nmds,type="n")
orditorp(nmds,display="species",col="gray",air=0.01)
orditorp(nmds, display="sites",
  col= bluefunc(5)[findInterval(tps_com_met$richness_avg, seq(2,6))],
  # cex = scale(tps_com_met$biomass_med, center = FALSE),
  air=0.01, pch = "+")
```

```{r}
# Add habitat
match_st <- match(habitat_pressure$station, com$station)
habitat <- habitat_pressure[order(match_st), ]
match_st_com <- match(temporal_community_metrics$station, com$station)
com_metrics <- temporal_community_metrics[order(match_st_com), ]
```

```{r, fig.dim = c(7, 14)}
hab_var <- c("temperature_med", "temperature_cv", "alt", "lat", "flow_med", "flow_cv", "width_river_mean", "width_river_cv", "DBO_med", "DBO_cv")
par(mfrow = c(5,2))
for (i in seq_along(hab_var)) {
  ordisurf(nmds, habitat[[hab_var[i]]], main = hab_var[i], col = "brown")
}
```

```{r}
com_var <- c("richness_med", "biomass_stab", "biomass_med")
par(mfrow = c(2,2))
for (i in seq_along(com_var)) {
  ordisurf(nmds, com_metrics[[com_var[i]]], main = com_var[i], col =
    "forestgreen")
}
```

```{r basin-st}
station_analysis <- get_basin_station(sf_obj = TRUE)
plot(station_analysis[,"basin"])
# How many station by basin:
nb_st_basin <- station_analysis %>%
  group_by(basin) %>%
  summarise(nobs = n())
```

```{r basin-com}
dev.off()
match_st_basin <- match(station_analysis$station, com$station)
st_basin <- station_analysis[order(match_st_basin), ] %>%
  mutate(basin = ifelse(is.na(basin), "INCONNU", basin))


ordiplot(nmds,type="n")
orditorp(nmds,display="species",col="red",air=0.01)
# See https://www.davidzeleny.net/anadat-r/doku.php/en:ordiagrams_examples
u_basin  <- unique(st_basin[["basin"]])
for (i in seq_along(u_basin)) {
  ordihull(nmds, groups = st_basin[["basin"]],
 show.group = u_basin[i], col = i, draw = 'polygon', label = T)
}
```

```{r}
match_st <- match(hab_type$station, com$station)
hab_type <- hab_type[order(match_st), ]
ordiplot(nmds,type="points", choices = c(1, 2))
orditorp(nmds,display="species",col="red",air=0.01)
u_hab  <- unique(hab_type[["hab_type"]])
for (i in seq_along(u_hab)) {
  ordihull(nmds, groups = hab_type[["hab_type"]], alpha = .1,
 show.group = u_hab[i], col = i, draw = 'polygon', label = T)
}
```

```{r}
st_basin <- get_basin_station() 
myload(region_polygon, dir = mypath("data"))
myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
stab_div_basin <- temporal_network_metrics_classes %>%
  select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group)) %>%
  select(station, troph_group, biomass_stab, richness_avg) %>%
  left_join(st_basin, by = "station") %>%
  filter(!is.na(basin))
stab_div_basin %>%
  left_join(hab_type, by = "station") %>%
  left_join(habitat_pressure[,c("station", "temperature_med", "DBO_med")],
    by = "station") %>%
  gather(variable, value, temperature_med, DBO_med) %>%
  ggplot(aes(x = richness_avg, y = value)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), rows = vars(variable), scales = "free_y") +
  stat_poly_eq(
    formula = y ~ x,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  #scale_y_log10() +
  scale_x_log10() +
  labs(title = "Stability - Div by habitat type",
    x = "Average species richness (log10)", y = "Biomass stability (log10)")
```


### Network

### Stability

#### Species contribution

The species contribution to CV and synchrony have been computed, to identify
which species are driving the relationship between CV and species richness.

Species contribution to a metric can be computed as follow:

$$
C_{k} = X - X_{-k}
$$

It means that a negative $C_k$ correspond to a negative contribution of the
species $k$ to $X$.


### Pressure


### Time series classification


```{r load dataset}
library(jmotif)
myload(community_metrics, op_analysis, dir = mypath("data"))
community_metrics  <-   
  left_join(community_metrics, op_analysis[, c("opcod", "station", "date")], by = "opcod")
```

```{r}
ts_biomass  <- community_metrics %>%
  select(station, date, biomass) %>%
  mutate(station = as.character(station)) %>%
  group_by(station) %>%
  arrange(date) %>%
  nest()

ts_biomass %<>%
  mutate(
    zts = map(data, function(x) znorm(x$biomass, threshold = 0.01)),
    paa = map(zts, ~paa(., 3)),
    sax = map_chr(paa, ~series_to_string(., 3))
  )

biomass_ts_sax <- ts_biomass 
mysave(biomass_ts_sax, dir = mypath("data"), overwrite = TRUE)
```

```{r}
pattern_dist <- ts_biomass %>%
  group_by(sax) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
ggplot(ts_biomass, aes(x = sax)) +
  geom_histogram(stat = "count")
```

```{r}
test <- ts_biomass %>%
  filter(sax %in% c("cba", "bbb", "cab", "abc", "acb", "bca", "bac", "cbb")) %>%
  group_by(sax) %>%
  sample_n(10) %>%
  mutate(
    paa2 = map2(data, zts, function (x, zts) {
      cbind(x[,1], zts)
  }),
    id_sta = as.character(seq(1,n()))

  ) %>%
  unnest(paa2)

ggplot(test, aes(x = date, y = zts)) +
  geom_line(aes(color = id_sta)) +
  facet_wrap(~ sax)

```

```{r}
myload(polluant_units, dir = mypath("data-raw", "polluants", "naiades_data"))

myload(press_metrics, dir = mypath("data"))
press_year <- press_metrics %>%
  filter(category %in% c("fungicides", "herbicides", "insecticides", "DBO", "temperature"))

biomass <- community_metrics %>%
  mutate(
    year = lubridate::year(date),
    category = "biomass",
    press = biomass 
    ) %>%
  select(station, year, category, press)
press_biomass <- press_year %>%
  bind_rows(rename(biomass, id = station)) %>%
  na.omit()
```

```{r}
samp_station <- sample(unique(press_biomass$id), 10)
temp <- press_biomass %>%
  mutate(id = as.character(id)) %>%
  filter(id %in% samp_station)

ggplot(temp, aes(y = press, x = year)) +
  facet_wrap(~category, scales = "free_y") +
  geom_line(aes(color = id))

```
