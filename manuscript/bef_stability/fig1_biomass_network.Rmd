---
title: "New first figure"
---

```{r}
library(tidyverse)
library(magrittr)
library(cowplot)

mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "synchrony.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "local_network_build.R"))
theme_set(theme_cowplot())
.pardefault <- par()
```


```{r}
myload(community_metrics, op_analysis, sem_data, dir = mypath("data"))
community_metrics %<>%
    left_join(select(op_analysis, station, opcod, year))

```

```{r}
get_bm_dyn_year <- function (com = NULL, station = NULL) {

  st <- station
  test <- com %>%
    filter(station == st)

  test %<>%
    mutate(sp_tibble = map(sp_vector, ~tibble(species = names(.x), biomass_sp = .x))) %>%
    unnest(sp_tibble) %>%
    mutate(bm_std_sp = biomass_sp / surface) %>%
    select(station, year, species, bm_std_sp)

  test %<>% 
    pivot_wider(names_from = species, values_from = "bm_std_sp")%>%
    mutate_at(vars(matches("[A-Z]{3}", ignore.case = FALSE)), ~ifelse(is.na(.), 0, .)) %>%
    pivot_longer(cols = matches("[A-Z]{3}", ignore.case = FALSE), names_to = "species", values_to = "bm_std_sp")

  return(test)
}
get_network_summary <- function (com = NULL, station = NULL) {

  st <- station
  tmp <- com %>%
    filter(station == st) %>%
    mutate_if(is.double, ~round(., 2))

  label <- paste(
    "S =", tmp$bm_std_stab, ", ",
    "sync =", tmp$sync, ", ",
    "CVsp =", tmp$cv_sp, ", ",
    "\n",
    "R =", tmp$rich_tot_std, ", ",
    "C =", tmp$ct, ", ",
    "Tlvl= ", tmp$t_lvl
  )

  return(label)

}

plot_dyn_web  <- function (com = NULL, sem_df = NULL, station = NULL, stacked =
  FALSE, .log = FALSE, color_species = NULL) {

  # get bm dynamic 
  com <- get_bm_dyn_year(com = com, station = station)

  # get total biomass 
    total_bm <- com %>%
	  group_by(year) %>%
	  summarise(bm_std_sp = sum(bm_std_sp)) %>%
	  mutate(species = "Total")

  p <- com %>%
    ggplot(aes(x = year, y = bm_std_sp, color = species))

  if (stacked) {
    p <- p + 
      geom_area(aes(fill = species))
  } else {
    p <- p + 
      geom_line() +
      geom_line(data = total_bm, color = "black")
  }

  # Make it professional:
  p <- p +
    labs(y = "Biomass density (g by square meter)", x = "Year")

  if (!is.null(sem_df)) {

    label <- get_network_summary(com = sem_df, station = station) 
    p <- p +
    annotate("text", x = median(total_bm$year),
      y = max(total_bm$bm_std_sp) + max(total_bm$bm_std_sp) * 5/100, label = label)
  }

  if (.log) {
    p <- p + scale_y_log10()
  }

  if (!is.null(color_species)) {
    p %<>%
      scale_fill_manual(values = meta_node_color) +
      scale_color_manual(values = meta_node_color)
  }

  return(p)


}
```


```{r}
plot_dyn_web(com = community_metrics, station = 1755, stacked = TRUE, sem_df = sem_data)
plot_dyn_web(com = community_metrics, sem_df = sem_data, station = 1755)
```

# Network

```{r}
source(mypath("R", "codeWeb.R"))
myload(toy_metaweb, dir = mypath("data"))

TL <- NetIndices::TrophInd(toy_metaweb$metaweb)$TL
PlotWeb(
  TL = TL,
  webTL = toy_metaweb$metaweb,
  colnode = rep("red", length(TL)),
  abund = rnorm(length(TL), 100, 10),
  collink="grey70",
  scale_abun = .2
) 
```


```{r}
get_adj_net_station <- function (net = NULL, station = NULL) {

  st <- station

  net <- net %>%
    filter(station %in% st) %>%
    dplyr::select(station, year, network) %>%
    unnest(cols = c(network))

  ## Compute metrics:
  net %>%
    dplyr::select(year, from, to) %>%
    arrange(year) %>%
    group_by(year) %>%
    nest(network = c(from, to)) %>%
    mutate(
      igraph_obj = map(network, igraph::graph_from_data_frame,
	directed = TRUE),
      adj_mat = map(igraph_obj, igraph::as_adjacency_matrix,
	sparse = FALSE),
      troph = map(adj_mat, ~NetIndices::TrophInd(.x)),
      obs_troph_level_vector = map(troph, function (x) {
	TL <- x$TL
	names(TL) <- rownames(x) 
	return(TL)
	})
    )
}

get_net_biomass <- function (net = NULL, station = NULL) {

  st <- station

  # Get bm
  net <- net %>%
    filter(station %in% st) %>%
    dplyr::select(year, composition) %>%
    unnest(cols = c(composition))  %>%
    select(year, sp_class, bm_std)
    
   # Make list
    net %<>%
      arrange(year) %>%
      group_by(year) %>%
      nest(bm = c(sp_class, bm_std)) %>%
      mutate(bm = map(bm, deframe))
  net
} 

set_color_nodes <- function (
  node_list = NULL,
  color_species_resources = NULL
  ) {

  node_list_sp <- stringr::str_replace_all(node_list, "_\\d", "") 

  colour <- color_species_resources[node_list_sp]
  names(colour) <- node_list
  return(colour)
}

set_node_resources_abun <- function (
  node_list = NULL,
  node_abun = NULL, resource_abun = NULL) {

  abun <- vector("numeric", length(node_list))  
  names(abun) <- node_list 

  if (is.null(resource_abun)) {
    resource_abun <- mean(node_abun)
  }

  abun[names(node_abun)] <- node_abun 
  abun[abun == 0] <- resource_abun 
  return(abun)

}

get_network_temporal_plot <- function (
  net_list = NULL,
  station = NULL,
  selected_years = NULL,
  node_color = NULL,
  scale_node_size = 0.01,
  par_options = par(mar = c(0,0,4,0)),
  add_title = FALSE
  ) {

  net <- get_adj_net_station(net = net_list, station = station)
  bm <- get_net_biomass(net = net_list, station = station)

  if (!is.null(selected_years)) {
    net %<>% filter(year %in% selected_years) 
    bm %<>% filter(year %in% selected_years) 
  }

  if (is.null(node_color)) {
    node_color <- set_color_species(
      node_list = unique(names(unlist(net$obs_troph_level_vector))),
      species_list = NULL, resource_list = NULL, col_resource = NULL)
  }

  list_p <- list()
  index <- seq_along(net$year)


  for (i in index) {
    if(!is.null(par_options)) {
      par_options
    }
    plot.new()
    PlotWeb(
      TL = net$obs_troph_level_vector[[index[i]]],
      webTL = net$adj_mat[[index[i]]],
      colnode = set_color_nodes(
	node_list = names(net$obs_troph_level_vector[[index[i]]]),
	color_species_resources = node_color),
      abund = set_node_resources_abun(
	node_list = names(net$obs_troph_level_vector[[index[i]]]),
	node_abun = bm$bm[[index[i]]],
	resource_abun = 1
	),
      collink="grey70",
      scale_abun = scale_node_size,
      rel_abun = FALSE

    )
    if (add_title) {
     title(main = paste0(net$year[[index[i]]]))
    }

    p <- recordPlot()

    list_p[[i]] <- p 
  }

  gg <- map(list_p, ggdraw)
  gg
}
```


```{r}
myload(network_analysis, dir = mypath("data", "classes"))
network_analysis %<>%
  left_join(dplyr::select(op_analysis, opcod, station, year)) %>%
  filter(!is.na(opcod))


net <- get_adj_net_station(net = network_analysis, station = 1755)
bm <- get_net_biomass(net = network_analysis, station = 1755)


meta_node_color <- set_color_species(node_list = unique(names(unlist(net$obs_troph_level_vector))), species_list = NULL, resource_list = NULL, col_resource = NULL)

PlotWeb(
  TL = net$obs_troph_level_vector[[1]],
  webTL = net$adj_mat[[1]],
  colnode = set_color_nodes(
    node_list = names(net$obs_troph_level_vector[[1]]),
    color_species_resources = meta_node_color),
  abund = set_node_resources_abun(node_list = names(net$obs_troph_level_vector[[1]]), node_abun = bm$bm[[1]]),
  collink="grey70",
  scale_abun = .2
) 
```

# Test fig plot 


```{r, warning = FALSE}
nb <- seq.int(from = 1, to = length(net$adj_mat), length.out = 4)
```

```{r, fig.width = 10}
list_p <- list()
for (i in seq_along(nb)) {
#  par(mar = c(0,0,0,0))
  plot.new()
  PlotWeb(
    TL = net$obs_troph_level_vector[[nb[i]]],
    webTL = net$adj_mat[[nb[i]]],
    colnode = set_color_nodes(
      node_list = names(net$obs_troph_level_vector[[nb[i]]]),
      color_species_resources = meta_node_color),
    abund = set_node_resources_abun(
      node_list = names(net$obs_troph_level_vector[[nb[i]]]),
      node_abun = bm$bm[[nb[i]]],
      resource_abun = 1
      ),
    collink="grey70",
    scale_abun = .01,
    rel_abun = FALSE
    
  )
#  title(paste0(net$year[[nb[i]]]))

  p <- recordPlot()

  list_p[[i]] <- p 
}

gg <- map(list_p, ggdraw)
plot_grid(plotlist = gg, nrow = 2)
```

```{r}
meta_node_color <- set_color_species(node_list = unique(names(unlist(net$obs_troph_level_vector))), species_list = NULL, resource_list = NULL, col_resource = NULL)

p <- get_network_temporal_plot(net_list = network_analysis, station = 1755,
  selected_years = c(1997, 2010, 2018),
  node_color = meta_node_color, scale_node_size = 0.05, par_options = par(mar = c(1,0,1,0)))
```

```{r, fig.width = 10, fig.height = 12, warning = FALSE}
#par(.pardefault)
#par(.pardefault)
test_p <- plot_grid(
  nrow = 2,
  plot_dyn_web(com = community_metrics, sem_df = sem_data, stacked = TRUE, station = 1755) +
    scale_fill_manual(values = meta_node_color) +
    scale_color_manual(values = meta_node_color)
    ,
  plot_grid(plotlist = p, nrow = 1),
  rel_heights = c(1, 1),
  align = "v"
)

test_p
save_plot(
  "figs/test_temporal_plot.png", test_p,
  nrow = 2, 
  ncol = 1,
  base_height = 4,
  base_width = 8)
```

```{r, eval = FALSE}
test2 <- ggdraw(
  plot_dyn_web(com = community_metrics, sem_df = sem_data, stacked = TRUE, station = 1755)) +
   draw_plot(gg[[1]], .45, .45, .5, .5)

save_plot("figs/test_temporal_plot.png", test2)
```


```{r}
sem_data %>%
  arrange(richness_med, desc(biomass_stab)) %>%
  filter(richness_med >= 3)

```

```{r}
st <- 21604
te <- plot_dyn_web(com = community_metrics, sem_df = sem_data, station = st, stacked = TRUE)
ti <- get_adj_net_station(net = network_analysis, station = st)

meta_node_color <- set_color_species(
  node_list = unique(names(unlist(ti$obs_troph_level_vector))), 
  species_list = NULL,
  resource_list = NULL,
  col_resource = NULL)

p <- get_network_temporal_plot(net_list = network_analysis, station = st,
  selected_years = c(2007, 2010, 2016),
  node_color = meta_node_color, scale_node_size = 0.02, par_options = par(mar = c(0,0,0,0)))
plot_grid(plotlist = p)

for (i in seq_along(p)) {
  save_plot(paste0("figs/test_net", i, ".png"), p[[i]], base_height = 4, base_width = 4)
}
```

```{r}
test_inc <- ggdraw(te + theme(plot.margin = margin(0, 0, 3, 0, "cm"))) +
  draw_plot(p[[1]], .15, -.01, .2, .2)

  save_plot(paste0("figs/test_net_inc", ".png"), test_inc, base_height = 4)
```




