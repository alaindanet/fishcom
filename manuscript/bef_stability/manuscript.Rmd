---
title: Species richness destabilizes trophic communities in freshwater ecosystems
author: Alain Danet, Maud Mouchet, Elisa Thébault and Colin Fontaine
date: \today 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
bibliography: references.bib
---

```{r, echo = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7),
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```


# Abstract

# Introduction 

Cf blutghen for CVsp as portfolio and statistical averaging of species.
Synchrony as insurance hypothesis facing environmental variations.

- Research questions:
  - What are the effects of the community structure on total biomass and stability ? 
    1. What are the effects of species richness on total biomass and stability ?
      - effect of species richness
      - effect of trophic group
    2. What are the effects of the community structure on total biomass and stability ?
      - What is the relative effect of the environment relative to the community
	structure ?
      - What is the effect of the community structure on the different
	parts of the stability + total biomass?
	- Effect of horizontal and vertical diversity

# Methods

## Fish data

- OFB
  - French long term protocol
  - standardized

- Electric fishing:
  - stuned fish
  - identification of the fishes
  - fish counted  
  - length of the fishes in mm by lot (4):
    - I: big fishes measured individually
    - S/L: fishes are grouped by species and by size 
      - 30 random fishes were measured in each lot
      - simulate the size of all the fishes of the lot:
	- normal distribution truncated at 95% (?)
	- mean and sd calculted from the sample of the lot 
    - G: little fishes are grouped by species
      - min and max size by lot 
      - simulate the size of all the fishes of the lot:
	- normal distribution truncated at 95% (?)
	- mean computed as ???  
	- se computed as ??? 
    - N:

- Protocols type:
  - complete
    - shallow river
  - partial:
    - deep and large river
    - partial over bank
    - partial by point
    - fusion of the two Protocols when "by point" all the point were done
      over bank

- Fishing operations and station
  - kept one protocol type by station
  - kept one sampling operation per year (of the season the most sampled in the
    time series)
  - remove operations which sampling effort (length of river) superior to average
    plus or minus 30% of sd (by station)
  - kept station that had 10 or more samplings, i.e. followed 10 years or more

- Biomass:
  - infered by allometric law 
  - approximated by $B = 0.01 \times (l^3.03)$

## Network building

- Diet data: 
  - 7? species over 57 had a piscivorous stage
  - 3? species had a strict piscivorous stage
  - ontogenic diet shift based on size

- 7 Resource nodes:
  - based on diet database 

## Community

```{r}
myload(nmds, habitat_pressure, dir = mypath("report"))
st_basin <- get_basin_station(sf_obj = FALSE)
myload(op_analysis, op_analysis_wo_holes, dir = mypath("data"))
myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
op_analysis_wo_holes_bbb <- filter(op_analysis_wo_holes, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)

# Compute stability, network metrics, etc with ;he new datasets
com_data <- compute_community_temporal_analysis(.op = op_analysis_bbb)
# Compute sem dataset 
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]],
  hab_press = habitat_pressure,
  sync = com_data[["sync"]],
  nmds = NULL,
  basin = st_basin
  )

stab_div_troph <- com_data$tps_bm_troph %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group),
    log_rich = log10(richness_med),
    log_rich_tot = log10(richness_tot),
    log_bm = log10(biomass_med),
    log_stab = log10(biomass_stab)) %>%
  dplyr::select(station, troph_group, biomass_stab, richness_med, richness_tot, log_rich, log_rich_tot, log_stab, log_bm, biomass_med, richness_tot) %>%
  dplyr::left_join(st_basin, by = "station")
```

## Habitat and environment

```{r}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_press <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)
```

```{r, fig.show = "hide"}
evt_var_mean <- c("flow_med", "temperature_med", "width_river_mean",
  "avg_depth_station_mean", "slope", "alt", "d_source", "strahler", "DBO_med")
evt_var_cv <- c("flow_cv", "temperature_cv", "width_river_cv",
  "avg_depth_station_cv", "DBO_cv")
pca_pressure <- habitat_press[, names(habitat_press) %in% c(evt_var_mean, evt_var_cv, "station")] %>%
  na.omit

pca_rotated <- compute_rotated_pca(
  .data = pca_pressure[, !names(pca_pressure) %in% "station"],
  naxis = 5 
)

```

## Statistical analysis

```{r get-data, cache = FALSE}
library(nlme)
library(piecewiseSEM)
```


### Relationship between stability and species richness 

$$
\Log_{10}(S_i) = \beta_0 + \beta_R\Log_{10}(x_{Ri}) + \epsilon_{ij}
$$

$$
S_i = 10^(\beta_0 + \beta_R\Log_{10}(x_{Ri}) + \epsilon_{ij})
$$

$$
S_i = 10^(\beta_0) \times 10^(\beta_R\Log(x_{Ri})) \times 10^(\epsilon_{ij})
$$

$$
S_i = 10^(\beta_{0}) \times x_{Ri}10^(\beta_{R}) \times 10^(\epsilon_{ij})
$$

with $i$ being the station $i$.

```{r mod-div-total}
library(lme4)
ctrl <- lmeControl(opt='optim')
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
stab_div_mod <- lmer(
  data = sem_data,
  control = ctrl_lmer,
  formula = log_stab ~ log_rich_tot + (1 | basin)
)
stopifnot(!isSingular(stab_div_mod, tol = 1e-05))
stab_div_boot <- bootMer(stab_div_mod, mySumm2, nsim = 100)
stab_div_ci <- confint(stab_div_boot)
#stab_div_colin <- car::vif(stab_div_mod) not use if one response
stab_div_sum <- piecewiseSEM::rsquared(stab_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(stab_div_mod, terms = c("log_rich_tot"), type = "fe")
stab_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich_tot = x,
    basin = group
  )
stab_div_pred %<>%
  mutate(
    stab = 10^log_stab, # FALSE
    rich = 10^log_rich_tot,
    cl10 =  10^conf.low,
    ch10 =  10^conf.high
  )

#
bm_div_mod <- lmer(data = sem_data,
  formula = log_bm ~ log_rich_tot + (1 | basin)
)
bm_div_boot <- bootMer(bm_div_mod, mySumm2, nsim = 100)
bm_div_ci <- confint(bm_div_boot)
bm_div_sum <- piecewiseSEM::rsquared(bm_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(bm_div_mod, terms = c("log_rich_tot"), type = "fe")
#plot(pred, add.data = TRUE)
bm_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich_tot = x,
    basin = group
  )

# get coeff
coef_div <- map(list(stab = stab_div_mod, bm = bm_div_mod), fixed.effects)
```

```{r mod-div-troph, fig.show = "hide"}
stab_troph_mod <- lmer(data = na.omit(stab_div_troph),
  formula = log_stab ~ log_rich_tot + troph_group + log_rich_tot:troph_group + (1 | basin)
  #control = ctrl
)
stab_troph_boot <- bootMer(stab_troph_mod, mySumm2, nsim = 100)
stab_troph_ci <- confint(stab_troph_boot)

stab_troph_colin <- car::vif(stab_troph_mod)
stab_troph_sum <- piecewiseSEM::rsquared(stab_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(stab_troph_mod, terms = c("log_rich_tot", "troph_group"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
stab_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich_tot = x,
    troph_group = group
  )

# Productivity and troph group

bm_troph_mod <- lmer(data = na.omit(stab_div_troph),
  #fixed = log_bm ~ log_rich_tot * troph_group,
  formula = log_bm ~ log_rich_tot + troph_group + log_rich_tot:troph_group + (1 | basin)
  #random = ~ 1 + log_rich_tot * troph_group | basin,
  #control = ctrl 
)
bm_troph_boot <- bootMer(bm_troph_mod, mySumm2, nsim = 100)
bm_troph_ci <- confint(bm_troph_boot)

bm_troph_sum <- piecewiseSEM::rsquared(bm_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(bm_troph_mod, terms = c("log_rich_tot", "troph_group"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
bm_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich_tot = x,
    troph_group = group
  )

# get coeff
coef_troph <- map(list(stab = stab_troph_mod, bm = bm_troph_mod), fixed.effects)
```

### SEM

We computed Structural Equation Modeling (SEM) to unravel mechanisms underlying link
between environment, community structure and both biomass stability and total
biomass. Why SEM? 

SEM enables to reason in terms of causal relationship between components. The
goal was to understand the mechanisms behind the negative relationship biomass
stability and species richness and the positive relationship between total
biomass and species richness.

We built a metamodel to set up the nodes and the links between the different
compartment of the SEM. Basically, we tested the links between
environmental conditions, community structure and stability. Theory in ecology 
predicts that community structure influences stability. In turn, environment 
influences community structure but also directly stability.

#### Variables

To characterize environment, we retained five axis of PCA on habitat and
climatic variables which represent different types of forcing (constant and
variability). The two first axis (RC1 and RC2) were linked to the physical
structure and position of the river and the altitutinal gradient (+temperature).
The third axis (RC3) was linked to enrichment (Organic Biological Demand) and CV
of annual flow. The fourth and fifth (RC4 and RC5) axis were associated to
environmental variability, respectively to CV of width and depth of the river
and CV of enrichment.

The community structure was characterized by total species richness (TSR),
species turnover (ST), median average weighted trophic level (TLvl) and median connectance.
Total species richness was the number of unique fish species that were observed
at a given station over the whole sampling. Species turnover was computed as average
dissimilarity between the different community composition through time. The
dissimilarity was calculated on species presence/absence with the Bray-Curtis
method implemented in the `vegan` R package (`vegdist` function). Both median
connectance and Tlvl were just computed as the median over the temporal period.
For the details of the computation of the trophic networks, see Network
inference part.

The biomass stability was decomposed in synchrony and weighted average CV
components according to @thibaut_understanding_2013:

$$
CV_{com} = \overline{CV_{sp}} \times \sqrt{\phi}
$$

with $CV_{com}$ being the Coefficient of Variation of the community,
$\overline{CV_{sp}}$ the average coefficient of variation of population
pondered by biomass. $\phi$ is the synchrony, which is the ratio the total
community variance ($\sigma^2_{x_T}$) and the sum of population variance
($\sigma_{x_i}$) [@loreau_species_2008]:

$$
\phi = \frac{\sigma^2_{x_T}}{\sum_i{\sigma_{x_i}}}
$$


#### Causal relationships

---
# Environment to community attributes and stability  
---
We linked environmental variables both to community structure and stability
components. Rooted in assembly theory, environment filters species that can
establish in a community and thus affect community structure. (+ add specific
hypothesis about physical and climate). (1) We hypothesized that enrichment
(characterized by DBO) and mean annual temperature will increase ST
[@friedpetersen_drivers_2020]. (2) We hypothesized environmental forcing can also
decrease biomass stability directly without going by community structure. First,
instability of habitat and environmental factors may in turn drive biomass
instability [@hansen_climate_2013]. Secondly, average environmental conditions
such as enrichment can increase directly CV by increasing species biomass
fluctuations [@tabi_warming_2019]. Increasing temperature was also hypothesized
to decrease stability through starvation resulting from high metabolic activity
[@tabi_warming_2019].

---
# Species richness to community attributes 
---
To reveal the mechanisms behind the relationship between species richness and
biomass stability, causal links were set from species richness to other
community attributes. (4) We hypothesized that TSR increased ST because
increasing species richness because of assembly processes. Species rich
communities are more resistant to invasion and thus increase ST
[@tilman_niche_2004; @shurin_how_2007]. (5) We hypothesized also that TSR
decreased connectance following results from @thebault_stability_2010;
@winemiller_must_1989. But theoretically, some ecological networks can show the
inverse relationship [@winemiller_must_1989]. (6) We hypothesized also that TSR
will modulate average weighted trophic level because of food web assembly
processes. If *TSR increased and that new species are placed at random in the
network, we expected a positive relationship between Tlvl and TSR because
individuals of the higher trophic level have a higher body mass [to think
again]*. Finally, we set up causal relationships from community attributes to
stability components. 

---
#  Community attributes to stability
---
We hypothesized that (7) TSR decreased synchrony between species by portfolio
effects [REF] and increased $\overline{CV_{sp}}$ [@tilman_biodiversity_2006] *to
complete*. We hypothesized that (8) ST increased $\overline{CV_{sp}}$ and that it
decreased synchrony. (9a) We expected that Tlvl had a positive or negative
relationship with synchrony, bottom-up effects should result in positive whereas
top-down in negative relationship. We expected a (9b) negative relationship
between Tlvl and $\overline{CV_{sp}}$ if predators stabilised population
fluctuations or if the increasing part of biomass in the predators decreased
$\overline{CV_{sp}}$ because of their higher body mass (if mean increase faster than
variance). (10a) Connectance was expected to decrease or increase $\overline{CV_{sp}}$
and (10b) synchrony because of top down effects or bottom up effects.


```{r}
# Compute SEMs
stab_sem_rich <- compute_stab_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem_rich <- compute_prod_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

library(ggraph)
p_stab_sem_rich <- ggpiecewisesem(stab_sem_rich)
p_bm_sem_rich <- ggpiecewisesem(bm_sem_rich)

library(DiagrammeR)

p_format <- "png"
p_width <- 700
p_height <- 700

stab_sem_path <- mypath("manuscript", "bef_stability",
  paste0("stab_sem.", p_format))
bm_sem_path <- mypath("manuscript", "bef_stability",
  paste0("bm_sem.", p_format))

graph_stab_sem <- build_diag_from_sem(stab_sem_rich, p_val_thd = 0.05)
render_graph(graph_stab_sem)
export_graph(graph = graph_stab_sem, file_type = p_format,
  file_name = stab_sem_path,
  height = p_height - p_height*20/100,
  width = p_width
)
#source(mypath("R", "plot_methods.R")) 
graph_bm_sem <- build_diag_from_sem(bm_sem_rich, p_val_thd = 0.05)
render_graph(graph_bm_sem)
export_graph(graph = graph_bm_sem, file_type = p_format,
  file_name = bm_sem_path,
  #file_name = "stab_sem.svg",
  height = p_height,
  width = p_width 
)

library(magick)
library(rsvg)
img_stab_sem <- stab_sem_path %>%
  image_read()
p_stab_sem_rich <- ggdraw() +
  draw_image(img_stab_sem)
img_bm_sem <- bm_sem_path %>%
  image_read()
p_bm_sem_rich <- ggdraw() +
  draw_image(img_bm_sem)

```


```{r get-sem-coeff}
source(mypath("R", "statistical_analysis.R"))
debug(compute_stab_sem_indirect)
total_effect_stab_sem <- compute_stab_sem_indirect(sem = stab_sem_rich,
  p_val_thl = 0.05) 

total_effect_bm_sem <- compute_bm_sem_indirect(sem = bm_sem_rich,
  p_val_thl = 0.05) 

coef_stab_sem <- coef(stab_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)

coef_bm_sem <- coef(bm_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)
```

```{r stab-network}
sem_data %>%
  select(sync, cv_sp, ct, t_lvl) %>%
  gather(network, metrics, ct, t_lvl) %>%
  gather(stab_comp, value, sync, cv_sp) %>%
  ggplot(aes(y = value, x = metrics)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(stab_comp ~ network, scales = "free_x")

stab_ct_mod <- lmer(data = sem_data,
  #fixed = log_bm ~ log_rich_tot * troph_group,
  formula = log_stab ~ ct + (1 | basin)
  #random = ~ 1 + log_rich_tot * troph_group | basin,
  #control = ctrl 
)
stab_ct_boot <- bootMer(stab_ct_mod, mySumm2, nsim = 100)
stab_ct_ci <- confint(stab_ct_boot)

stab_ct_sum <- piecewiseSEM::rsquared(stab_ct_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_stab_ct_mod <- ggpredict(stab_ct_mod, terms = c("ct"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
stab_ct_pred <- pred_stab_ct_mod %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich_tot = x,
    troph_group = group
  )

# get coeff
coef_stab_ct <- map(list(stab = stab_ct_mod), fixed.effects)


stab_tlvl_mod <- lmer(data = sem_data,
  #fixed = log_bm ~ log_rich_tot * troph_group,
  formula = log_stab ~ t_lvl + (1 | basin)
  #random = ~ 1 + log_rich_tot * troph_group | basin,
  #control = ctrl 
)
stab_tlvl_boot <- bootMer(stab_tlvl_mod, mySumm2, nsim = 100)
stab_tlvl_ci <- confint(stab_tlvl_boot)

stab_tlvl_sum <- piecewiseSEM::rsquared(stab_tlvl_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_stab_tlvl_mod <- ggpredict(stab_tlvl_mod, terms = c("t_lvl"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
stab_tlvl_pred <- pred_stab_tlvl_mod %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich_tot = x,
    troph_group = group
  )

# get coeff
coef_stab_tlvl <- map(list(stab = stab_tlvl_mod), fixed.effects)

```


# Results

## Contradictory responses of species richness on total biomass and biomass stability

```{r}
richness_lab <- "Total richness (Log 10)"
stab_lab <- "Biomass stability (Log 10)"
bm_lab <- "Total biomass (Log 10)"
```


```{r p-s-div}
lim_log_stab <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_stab")
lim_log_rich_tot <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_rich_tot")
# Plot left  

p_stab_div <- sem_data %>%
  ggplot(aes(x = log_rich_tot, y = log_stab))+
  geom_point() +
  ylim(lim_log_stab) +
  xlim(lim_log_rich_tot) +
  labs(x = richness_lab, y = stab_lab) +
  geom_line(data = stab_div_pred) +
  geom_ribbon(data = stab_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .2) +
  annotate("text", x = 1.0, y = .8, label = make_label_rsq(rsq = stab_div_sum),
    parse = TRUE)

# Right plot
p_stab_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich_tot, y = log_stab, color = troph_group)) +
  geom_point() +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  ylim(lim_log_stab) +
  xlim(lim_log_rich_tot) +
  geom_line(data = stab_troph_pred) +
  geom_ribbon(data = stab_troph_pred,
    aes(ymin = conf.low, ymax = conf.high, color = NULL, group = troph_group),
    alpha = .2) +
  annotate("text", x = 0.8, y = .8, label = make_label_rsq(rsq = stab_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = richness_lab, y = stab_lab)

p_stab <- plot_grid(p_stab_div, p_stab_div_troph,
  ncol = 2, rel_widths = c(.4, .6),
  labels = c("A", "B") 
)
```


```{r p-p-div}
lim_log_bm <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_bm")

p_bm_div <- sem_data %>%
  ggplot(aes(x = log_rich_tot, y = log_bm))+
  geom_point() +
  ylim(lim_log_bm) +
  xlim(lim_log_rich_tot) +
  labs(x = richness_lab, y = bm_lab) +
  geom_line(data = bm_div_pred) +
  geom_ribbon(data = bm_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .2) +
  annotate("text", x = .8, y = 1.5, label = make_label_rsq(rsq = bm_div_sum),
    parse = TRUE)

p_bm_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich_tot, y = log_bm, color = troph_group)) +
  geom_point() +
  ylim(lim_log_bm) +
  xlim(lim_log_rich_tot) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  geom_line(data = bm_troph_pred) +
  geom_ribbon(data = bm_troph_pred,
    aes(ymin = conf.low, ymax = conf.high, color = NULL, group = troph_group),
    alpha = .2) +
  annotate("text", x = 0.8, y = 1.5, label = make_label_rsq(rsq = bm_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = richness_lab, y = bm_lab)

p_bm <- plot_grid(p_bm_div, p_bm_div_troph, ncol = 2, rel_widths = c(.4, .6),
  labels = c("C", "D"))
```

```{r psbm, fig.dim = c(10,5)}
plot_grid(p_stab, p_bm, ncol = 1)

print_coef <- function (vec){
  round(abs(vec)*100)
}
print_ci <- function(.df){
  .df <- round(.df, 3)*100
  
  paste0("[", .df[["2.5 %"]],";",.df[["97.5 %"]] ,"]")
}
```

```{r print-coef-stab}
# Coefficients
s_co_i <- print_coef(coef_div$stab["(Intercept)"])
s_co_r <- print_coef(coef_div$stab["log_rich_tot"])
s_co_t <- print_coef(coef_troph$stab["troph_group3"])
s_co_r_t2 <- print_coef(coef_troph$stab["log_rich_tot"])
s_co_r_t3 <- print_coef(coef_troph$stab["log_rich_tot"]+coef_troph$stab["log_rich_tot:troph_group3"])

s_ci_r <- print_ci(stab_div_ci["beta.log_rich_tot",])
s_ci_t <- print_ci(stab_troph_ci["beta.troph_group3",])
s_ci_r_t2 <- print_ci(stab_troph_ci["beta.log_rich_tot",])
s_ci_r_t3 <- print_ci(coef_troph$stab["log_rich_tot"] + stab_troph_ci["beta.log_rich_tot:troph_group3",])
```

```{r print-coef-bm}
# Coefficients
b_co_i <- print_coef(coef_div$bm["(Intercept)"])
b_co_r <- print_coef(coef_div$bm["log_rich_tot"])
b_co_t <- print_coef(coef_troph$bm["troph_group3"])
b_co_r_t2 <- print_coef(coef_troph$bm["log_rich_tot"])
b_co_r_t3 <- print_coef(coef_troph$bm["log_rich_tot"]+coef_troph$bm["log_rich_tot:troph_group3"])

b_ci_r <- print_ci(bm_div_ci["beta.log_rich_tot",])
b_ci_t <- print_ci(bm_troph_ci["beta.troph_group3",])
b_ci_r_t2 <- print_ci(bm_troph_ci["beta.log_rich_tot",])
b_ci_r_t3 <- print_ci(coef_troph$bm["log_rich_tot"] + bm_troph_ci["beta.log_rich_tot:troph_group3",])
```

---
# Total biomass versus TSR
---
TSR increased total biomass (`r b_co_r`% `r b_ci_r` by 1% TSR increase). Total
biomass was `r b_co_t`% `r b_ci_t` higher in the high than in the low trophic group. However,
the increase of total biomass with the increase of TSR was lower in the high
than the low trophic group (`r b_co_r_t3`% `r b_ci_r_t3` and `r b_co_r_t2`%
`rb_ci_r_t2` respectively,  by 1% TSR increase).
---
# Stability versus TSR
---
However, biomass stability decreased with TSR (`r s_co_r`% `r s_ci_r` by 1%
TSR increase). Biomass stability was overall `r s_co_t`% `r s_ci_t` higher for the high
than the low trophic group. But biomass stability decreased by `r s_co_r_t3`% by
1% increase in TSR in the high trophic group and increased by `r s_co_r_t2`% `r s_ci_r_t2`
in the low trophic group.

## Drivers of total biomass and stability

```{r, fig.show = "hide"}
axis_pair <- list(c(1,2), c(1,3), c(2,3), c(1, 4), c(2, 4), c(3,4), c(4,5))
p_l_rot <- map(axis_pair, 
  function (axis)
    pca_rotated_plot <- plot_rotated_pca(
      pca_rotated = pca_rotated,
      axis = axis 
    )
)
```


```{r sem-plot, fig.dim = c(10,10)}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple
to_plot <- c(1, 6, 7)

plot_grid(
  plot_grid(plotlist = map(p_l_rot[to_plot], ~.x$rotated),
      ncol = length(to_plot), labels = LETTERS[1]),
  plot_grid(p_stab_sem_rich, p_bm_sem_rich, labels = LETTERS[2:3], rel_widths = c(.6, .4)),
  ncol = 1,
  rel_heights = c(.4, .6)
)
```

```{r}
total_effect_bm_sem
total_effect_stab_sem
```


---
# Total biomass
---
We found that the primary drivers of total biomass were the total species
richness (TSR) and the average trophic level (Tlvl) ($r_\delta = 0.35$ and
$r_\delta = 0.40$ resp.) whereas connectance had no significant effect  (Fig.
\@ref{fig:sem-plot} C). The stream size had a direct positive effect on total
biomass ($r_\delta = 0.22$) whereas CV of flow and avg DBO increased total
biomass ($r_\delta = - 0.2$). Avg temperature, CV of river size and CV of DBO
had no direct effects on total biomass.

TSR had also a indirect positive effect on total biomass through Tlvl ($r_\delta
= 0.21$), that is, TSR had a total positive effect of $0.56$ on total biomass.
The stream size had a total effect on total biomass as strong as TSR ($r_\delta
= 0.54$), indirectly through Tlvl ($r_\delta = 0.10$) and TSR ($r_\delta = 0.22$).
The avg temperature of the river had an indirect positive effect on total biomass
($r_\delta = 0.48$), through Tlvl ($r_\delta = 0.11$) and TSR ($r_\delta = 0.33$).
Avg DBO, CV DBO and CV of river size had no or weak indirect effect on total
biomass. 


---
# Biomass stability
---
\overline{CV_{sp}} ($r_\delta = -1.26$) decreased biomass stability more than
synchrony ($r_\delta = -0.55$, Figure \@ref{fig:sem-plot}). TSR had a strong
positive effect on \overline{CV_{sp}} and a strong negative effect on synchrony
whereas Tlvl and connectance had no significant effects on either
\overline{CV_{sp}} nor synchrony. The avg river size had a small positive direct
effect on synchrony ($r_\delta = 0.19$). The other environmental variables had
no significant direct effects on \overline{CV_{sp}} nor synchrony.

Indirectly through synchrony and \overline{CV_{sp}}, TSR had a total negative
effect on biomass stability ($r_\delta = -0.26$). Avg river size and avg
temperature had also a total effect which was negative on biomass stability
(resp. $r_\delta = -0.24$ and $r_\delta = -0.16$), going through richness 
(resp. $r_\delta = -0.10$ and $r_\delta = -0.16$).


- Main outcome:
  - Biomass but stability increased with richness
  - Higher trophic group was more stable that lower one
    - Opposite relationship stability/richness
  - Stability was mainly driven by species richness



# Discussion

We tested for the first time the determinants of temporal biomass stability in a
foodweb with an empirical dataset at such high temporal and spatial scales.

Surprisingly, we found a negative relationship biomass stability and species
richness whereas there was a positive one between total biomass and species
richness. Those relationships followed a power law, meaning that they represent
respectively accelerating and decelerating functions. Overall, it contrasts
with studies in grasslands [@tilman_biodiversity_2006, @zhang_scale_nodate],
mesocosms [@pennekamp_biodiversity_2018] or other animals
[@olivier_independent_nodate] where positive relationships are typically found
between biomass stability and species richness. Even @franssen_annual_2011 found
that species rich communities are more stable than species poor in streams. 

@grace_integrative_2016 found that biomass negatively linked to species richness
in grasslands, notably because of light competition. In freshwater ecosystems,
where resources are based on trophic relationship, TOCOMPLETE.

The total biomass of high and low trophic group trophic groups responded both
positively to species richness but not biomass stability TOREPHRASE. There is a
paradox where the high trophic group is overall more stable than the low but
species richness had a destabilizing effect on the former whereas a stabilizing
on the latter. @shanafelt_david_w._stability_nodate showed in a theoretical
study in trophic chains, the top trophic level is the more stable TOEXPLORE.
The comparison between our study and theoretical studies stays limited because
fishes in our system have a large diet and consume food item of several trophic
level while theoretical studies consider system in which one species of one
trophic level feeds only on the trophic level directly inferior
[@shanafelt_david_w._stability_nodate] ADD REF. 

---
# Effect of synchrony and cv_sp  
---
It was unexpected that the average population CV had a stronger negative effect
on biomass stability than synchrony [@bluthgen_land_2016;
@olivier_independent_nodate] *cf ref in bluthgen*. We see two hypothesis that
can raise this effect. First, the opportunity for diet differentiation can be
low in streams compare to other organisms. Bird species are for example quite
specialized in seed, flying or soil arthropods or mammals which gives
opportunities for independent dynamics. Plants also can achieve independent
dynamics either spatial segregation, niche differentiation. Because fish
species even piscivorous one are quite opportunistic in
their foraging. Secondly, in trophic network, amplitude of species biomass
involved in trophic interactions could covary positively TOTHINKABOUT.


---
# Effect of trophic level and connectance are richness effects:
---
Our path analysis reveled that, although species richness has a strong effect on
connectance and the average trophic level, network structure had itself little
to no effect either on synchrony nor average population stability. This result
contradicts precedent theoretical studies on the relationship
between stability and network structure [@angelis_stability_1975, @may_will_1972], although
they considered different stability metrics (i.e. local stability of equilibrium
point). The reason might be that in our inferred network, network structure is
strongly constraints by assembly processes. Indeed, connectance decreased with
increasing species richness [@thebault_stability_2010], because a small fraction
of links are realized because of food diet constraints. In theoretical studies,
connectance can be tuned from 0 (no links) to 1 (all possible links are
present). SAMEFORTLVL
Finally, the biomass stability of freshwater ecosystems can be derived by
species richness because, through trophic structure constraints, species
richness determine largely network structure.




- Stability versus several studies:
  - [@zhang_scale_nodate]: productivity stability range from [0.4 to 1.4] for
    diversity range [10 to 30]
  - [@tilman_biodiversity_2006] on abundances:
    - stability range: 2 to 12
    - diversity range: 1 to 16

# Appendix

## Model summary and diagnostics 

### Biomass and stability models

```{r tab-coeff-bm, fig.cap = "Coefficient"}
# Replacement rules for term
rp_est <- c(
  "(Intercept)" =     "intercept",
  "sd\\_\\(intercept\\)\\.basin" = "sd intercept basin",
  "log_rich" =     "Median richness (log base 10)",
  "troph_group3" =     "high trophic group",
  "log_rich:troph_group3" =     "Median richness (log10) : high trophic group",
  "sig01.basin" =     "sd intercept basin",
  "sd_Observation.Residual" =     "residuals",
  "sigma" = "residuals"
)
# Replacement rules for group
rp_group <- c(
  "fixed" = "Fixed",
  "basin" = "Random"
)

```

```{r}
coeff_troph <- map2_dfr(list(bm_troph_ci, stab_troph_ci), list(bm_troph_mod, stab_troph_mod),
  clean_summary_mod, term_rp = rp_est, group_rp = rp_group)

kable(coeff_troph) %>%
  pack_rows("Biomass", 1, 6) %>%
  pack_rows("Stab", 7, 12)
```



### SEM 

```{r tab-coeff-stab}

```


## Model residuals

### Biomass and stability models 

```{r}
mod_list <- list(bm_div_mod, bm_troph_mod, stab_div_mod, stab_troph_mod)
plot_res <- map(mod_list, ~ plot(.x))
plot_grid(plotlist = plot_res)
```

### SEM linear relationships


```{r hist-sem-data}
sem_data %>%
  select(prod, log_rich_tot, log_sync, log_stab, log_cv_sp, RC1, RC2, RC3, RC4,
    RC5, t_lvl, ct, log_bm) %>%
  gather(variable, value) %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  facet_wrap(~variable, scales = "free")

```



```{r s-colin-sem, fig.cap = "Variance Inflation factor for each individual model of stability sem"}
#compute_stab_sem_rich(.data = sem_data, get_sem =TRUE)

mod_stab_list <-
  list(
    nlme::lme(log_rich_tot ~ log_RC1 + log_RC2 + log_RC3 + RC4 + RC5,  random = ~ 1 | basin, data = sem_data),
    #nlme::lme(piel ~ log_RC1 + log_RC2 + log_RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(ct ~ log_RC1 + log_RC2 + log_RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(t_lvl ~ log_RC1 + log_RC2 + log_RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    #nlme::lme(beta_bin ~ log_RC1 + log_RC2 + log_RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(log_sync ~ log_rich_tot + ct + t_lvl + log_RC1 + log_RC2 + log_RC3 + RC4 + RC5,
      random = ~ 1 | basin, data = sem_data),
    nlme::lme(log_cv_sp ~ log_rich_tot  + ct + t_lvl
      + RC1 + log_RC2 + log_RC3 + RC4 + RC5, random = ~ 1 | basin, data = sem_data),
    lm(log_stab ~ log_cv_sp + log_sync, data = sem_data)
  )
names(mod_stab_list) <- c("richness", "connectance", "weighted_mean_trophic_lvl", "synchrony", "cv_sp", "stability") 
colin_stab_sem <- map(mod_stab_list, car::vif)

tmp <- map(colin_stab_sem, enframe)
  
# colinearity table
colin_stab_sem <- tibble(vif = tmp, mod = names(mod_stab_list)) %>%
  unnest(vif) %>%
  spread(name, value)

kable(colin_stab_sem)
```

```{r}
plot_residuals <- function (x, y = "Diagnostic") {
  plot.lme(x, main = y, xlab = "Fitted values", ylab = "Residuals")
}
p_resid_stab_sem <- map2(mod_stab_list, names(mod_stab_list) , plot_residuals)
plot_grid(plotlist = p_resid_stab_sem)
```

```{r, eval = FALSE}
mod_tlvl <- nlme::lme(t_lvl ~ scale(RC1) + scale(RC2) + scale(RC3) + scale(RC4) + scale(RC5) + log_rich_tot, random = ~ 1 | basin, data = sem_data)
plot(mod_tlvl)
sem_data %>%
  ggplot(aes(x = log10(richness_tot), y = t_lvl)) +
  geom_point()+
  geom_smooth(method = "lm")
plot(x = log10(sem_data$RC1 + abs(min(sem_data$RC1))), y = sem_data$t_lvl)
sem_data %>%
  ggplot(aes(x = log10(RC1), y = t_lvl)) +
  geom_point()+
  geom_smooth(method = "lm")
plot(nlme::lme(t_lvl ~ I(log10(RC1 + abs(min(RC1)))) + log_rich_tot, random = ~ 1 | basin, data = sem_data))
nlme::lme(t_lvl ~ log_rich_tot, random = ~ 1 | basin, data = sem_data)
semd_test <- sem_data %>%
  mutate(RC1b = RC1 + abs(min(RC1)))
ricker.mixed.fit <- nls(
  t_lvl ~ (Vm*(RC1 + b) / (K + (RC1 + b)) + d),
 #fixed = Vm + K + b + d ~ 1,
 #random = Vm + K + b + d ~ 1|basin,
 start= c(Vm=1, K = 0.1, b = .5, d = 2.5),
 data = semd_test,
 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8) 
)
summary(ricker.mixed.fit)
x <- seq(min(sem_data$RC1), max(sem_data$RC1), length.out = 100)
sem_data$test_pred <- predict(ricker.mixed.fit)

semd_test %>%
  ggplot(aes(x = RC1b, y = t_lvl)) +
  geom_point() +
  geom_line(aes(y = test_pred))
  geom_smooth(method = "lm")
cor(semd_test$piel, semd_test$t_lvl, method = c("spearman"))
```

```{r, eval = FALSE}
library(glmmTMB)
# Gaussian
mod_log_rich <- glmmTMB(
  log_rich_tot ~ log_RC1 + log_RC2 + log_RC3
  + RC4 + RC5 + (1 | basin), family = gaussian, data = sem_data)
summary(mod_log_rich)
plot(y = resid(mod_log_rich), x = fitted(mod_log_rich))

# Poisson 
mod_log_rich_poi <- glmmTMB(
  richness_tot ~ log_RC1 + log_RC2 + log_RC3
  + RC4 + RC5 + (1 | basin), family = poisson, data = sem_data)
summary(mod_log_rich_poi)
plot(y = resid(mod_log_rich_poi), x = fitted(mod_log_rich_poi))

# Truncate 
mod_log_rich_nbinom <- glmmTMB(
  richness_tot ~ log_RC1 + log_RC2 + log_RC3
  + RC4 + RC5 + (1 | basin), family = nbinom1, data = sem_data)
summary(mod_log_rich_nbinom)
plot(y = resid(mod_log_rich_nbinom), x = fitted(mod_log_rich_nbinom))
```

#### Total biomass

```{r}

mod_bm_list <-
  list(
    nlme::lme(log_rich_tot ~ RC1 + RC2 + RC3 + RC4 + RC5,  random = ~ 1 | basin, data = sem_data),
    #nlme::lme(piel ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(ct ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(t_lvl ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    #nlme::lme(beta_bin ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(log_bm ~ log_rich_tot + ct + t_lvl + RC1 + RC2 + RC3 + RC4 + RC5,
      random = ~ 1 | basin, data = sem_data)
  )
names(mod_bm_list) <- c("richness", "connectance", "weighted_mean_trophic_lvl", "total_biomass") 
colin_bm_sem <- map(mod_bm_list, car::vif)

tmp <- map(colin_bm_sem, enframe)
  
# colinearity table
colin_bm_sem <- tibble(vif = tmp, mod = names(mod_bm_list)) %>%
  unnest(vif) %>%
  spread(name, value)

kable(colin_bm_sem)
```


## Relationship at the absolute scale, i.e. not the logarythme scale 

```{r}
ggplot(sem_data, aes(x = richness_med, y = biomass_stab)) +
  geom_point()
test <- tibble(
  richness_med = seq(1,20, length.out = 100),
  biomass_stab =
    10^(fixef(stab_div_mod)[1])*richness_med^fixef(stab_div_mod)[2]
)  
```

```{r save-plot}

save_plot("~/Documents/thesis/talks/fishcom_fig/stab_div.pdf",
  p_stab_div,
  base_height = 3,
  bg = "transparent",
  ncol = 1)

save_plot("~/Documents/thesis/talks/fishcom_fig/stab_div_troph.pdf",
  p_stab_div_troph + theme(legend.position = "bottom"),
  base_height = 3,
  bg = "transparent",
  ncol = 1)

```


# References
