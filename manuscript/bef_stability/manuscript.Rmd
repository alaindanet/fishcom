---
title: Species richness and network structure jointly drive total biomass and its temporal stability in fish communities
author: Alain Danet, Maud Mouchet, Willem Bonnaffe, Elisa Thebault, Colin Fontaine
date: \today 
output:
  bookdown::pdf_document2:
    toc: false 
    fig_caption: true 
    keep_tex: true
fontsize: 12pt
header-includes:
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
geometry: margin=2cm
bibliography: references.bib
---

```{r, echo = FALSE, results = FALSE, message = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE 
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "total_sem_effect.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```

```{r, results = FALSE}
knitr::opts_chunk$set(
  results = TRUE 
)
```

- Author affiliation:
  - Alain Danet: Centre d’Ecologie et des Sciences de la Conservation, UMR 7204
    MNHN-CNRS-Sorbonne Université, Muséum national d’Histoire naturelle de
    Paris, 43 rue Buffon, 75005 Paris, France
  - Maud Mouchet: Centre d’Ecologie et des Sciences de la Conservation, UMR 7204
    MNHN-CNRS-Sorbonne Université, Muséum national d’Histoire naturelle de
    Paris, 43 rue Buffon, 75005 Paris, France
  - Willem Bonnaffe: Ecological and Evolutionary Dynamics Lab. Zoology Research
    and Administration Building, 11a Mansfield Rd, Oxford OX1 3SZ, United
    Kingdom.
  - Elisa Thebault: Sorbonne Université, CNRS, IRD, INRAE, Université Paris Est
    Créteil, Institute of Ecology and Environmental Sciences of Paris
    (iEES-Paris), Paris, France  
  - Colin Fontaine: Centre d’Ecologie et des Sciences de la Conservation, UMR 7204
    MNHN-CNRS-Sorbonne Université, Muséum national d’Histoire naturelle de
    Paris, 43 rue Buffon, 75005 Paris, France

- Author contributions: AD, CF, MM and ET designed the study. WB designed the
  network inference method and collected the food diet data. AD performed the
  data analysis and wrote the first draft of the manuscript. All authors
  contributed substantially to revisions.

- Data accessibility statement: the ONEMA database is available upon request to 
  eddy.cosson@afbiodiversite.fr and thierry.point@afbiodiversite.fr. The code
  used for the analysis and to generate the manuscript is available on github:
  (alaindanet/fishcom.git)

- Article type: Letters

- Number of words:
  - Abstract: 172
  - Main text: 4929

- Number of references: XXX
- Number of figures: 2
- Number of tables: 1
- Number of text boxes: 0 

- Coresponding author:
  - Alain Danet
  - UMR 7204 CESCO, CP 135; 43, rue Buffon, 75005 Paris, France
  - alain.danet@mnhn.fr 
  - +33140798134

# Abstract

Both biodiversity-ecosystem functioning (BEF) and foodweb complexity-stability
relationships have received considerable attention during the last decades.
Still, the BEF relationship remains rarely investigated in the context of food
webs, especially in empirical studies explicitly considering foodweb structures.
Foodweb stability-complexity relationship has been mainly the focus of
theoretical studies with very empirical testing. To fill this gap, we link
species richness, foodweb structure and annual biomass and its temporal
stability using a standardized monitoring of fish communities in French streams
running from 1995 to 2018. We inferred trophic interactions thanks to recorded
body size and diet literature. We reveal that species richness and average
trophic level had a positive relationship with annual biomass of fish
communities while they had respectively a negative and positive effect on its
temporal stability. We also found that the effects of stream size and
temperature on annual biomass and stability are mediated by their effects on
diversity and foodweb structure. Overall, our study opens fruitful perspectives
on the link between species richness, network structure, biomass and its
stability.

# Introduction 

---
#### Biodiversity and ecosystem properties 
---

Current biodiversity losses and further global change has the potential to affect
ecosystems in complex ways [@loreau_biodiversity_2001; @tilman_biodiversity_2014]. Biodiversity has a
tremendous effect on ecosystem properties because it largely determines both the
amount and the distribution of matter and energy fluxes
within and among ecosystems [@loreau_meta-ecosystems:_2003]. Biodiversity thus affects biomass
production [@tilman_productivity_1996; @cardinale_species_2002;
@grace_integrative_2016], distribution [@thebault_relationship_2006] and
stability [@thebault_trophic_2005; @thebault_relationship_2006;
@tilman_biodiversity_2006]. The relationship between biodiversity and
ecosystem properties is a central topic in ecology [@hector_plant_1999;
@loreau_biodiversity_2001; @hooper_effects_2005; @dunne_network_2006;
@duffy_why_2009; @isbell_forest_quantifying_2018] and our understanding of it is 
crucial to better anticipate the impacts of global change. 

---
#### Species richness increases total biomass
---

Species richness promotes higher biomass production in a variety of ecosystems
and taxons. Indeed species richness generally increases primary productivity and
total biomass in experimental plant communities [@tilman_productivity_1996;
@grace_integrative_2016; @hector_plant_1999; @tilman_biodiversity_2014;
@grace_integrative_2016], but also in briophyte communities
[@mulder_physical_2001], stream feeders, [@cardinale_species_2002] and aquatic
bacterial consumers [@pennekamp_biodiversity_2018]. Despite the diversity of
ecosystems and taxons studied, the relationship between diversity and ecosystem
functioning remains traditionally focused on single trophic levels, ignoring the
effects of foodweb structure. Theoretical models have recently moved from
single trophic [@tilman_plant_1997;
@loreau_biodiversity_2001] to multitrophic communities [@thebault_food-web_2003;
@poisot_dissimilarity_2012; @schneider_animal_2016; @wang_biodiversity_2018]. 
These models show that both resource use complementarity and selection effects,
the two main mechanisms previously highlighted in single-trophic studies, are
also important to understand diversity effects in foodwebs
[@thebault_food-web_2003; @poisot_dissimilarity_2012; @schneider_animal_2016].
However, they also reveal new mechanisms such as positive effects of 
the number of trophic levels, i.e. associated with higher trophic levels, on ecosystem
functioning [@wang_biodiversity_2018]. Theoretical studies also showed that food
web properties, such as interaction distribution and strength, affect the
distribution of biomass among adjacent trophic levels
[@thebault_relationship_2006; @schneider_animal_2016; @barbier_pyramids_2019].
Despite these theoretical evidences that structure affects biomass, we are
lacking empirical studies that assess jointly how foodweb structure and species
diversity affect total biomass and its production.   

---
#### Single and multitrophic communities
---

Further than biomass production, many studies showed that species richness
increases temporal stability of communities, i.e. variation through time, often
quantified by the temporal CV of biomass.  Such positive relationship between
species richness and temporal stability of biomass has been reported in
experimental grasslands and aquatic bacterial systems
[@tilman_biodiversity_2006; @pennekamp_biodiversity_2018] as well as in natural
settings, such as stream fish communities [@franssen_annual_2011], bird and
butterfly communities [@olivier_urbanization_2020]. However, this relationship
has been mostly explored in single trophic level systems or without accounting
for foodweb structure, even more so than the relationship between diversity and
biomass production. 

Several theoretical studies considering single trophic level have
clarified which mechanisms generate this positive relationship between species
richness and temporal
stability [@loreau_species_2008; @thibaut_understanding_2013], (1) species
synchrony and (2) species variability. Species synchrony captures to what extent
the fluctuations of abundances or biomasses through time are correlated among
species. A low synchrony in species fluctuations, i.e. asynchrony, is
synonymous of compensatory dynamic, where the decrease in abundance of a species
is compensated by the increase of an other. Asynchrony is generally the main
mechanism which species richness has a stabilizing effect on temporal
stability [@tilman_biodiversity_2006; @olivier_urbanization_2020]. Asynchrony is
expected to raise with the variability of species responses to perturbations. Though most
often positive, the relationship between species diversity and asynchrony has
also been evidenced to be neutral or negative in natural settings
[@tilman_biodiversity_2006; @thibaut_understanding_2013;
@olivier_urbanization_2020; @valencia_synchrony_2020]. 

In addition to diversity,
foodweb structure is expected to strongly affect the stability of communities
and ecosystems, as outlined by the large body of theoretical studies on this
topic [@may_will_1972; @dunne_network_2006; @neutel_reconciling_2007;
@duffy_why_2009; @stouffer_compartmentalization_2011]. In particular, predation
has cascading effects on both species variability and synchrony
[@teng_dynamics_2004; @shanafelt_stability_2018] and it also affects
synchrony between species. 

---
#### Problematic
---



Overall, the evidence suggests that both species richness and network structure
should modulate total biomass and stability of communities. The effects of
species richness and network structure, such as connectance and average trophic
level, are potentially conflicting or synergistic in such a way that they need
to be addressed jointly. Despite the long-standing interest for the links
between foodweb complexity and stability in ecology, we still have very few
evidence of the relationship between network structure and the temporal
stability of multitrophic communities in natural settings.
Although the relationships between diversity, total biomass and its stability
found in experimental and in natural settings can be similar
[e.g., @wu_relationship_2015; @li_relationship_2018], negative or non
significant effects of species richness on total biomass have been found in some
natural communities such as forests [@szwagrzyk_above-ground_2007;
@jacob_productivity_2010; @seidel_relationship_2013]. Some authors suggest that
the lack of resource complementarity or environmental harshness might be
responsible for negligible, or negative effects of species richness
[@loreau_biodiversity_2001; @he_global_2013; @wu_relationship_2015].



---
#### Environment can mitigate community structure and ecosystem properties 
---

When analyzing data from natural communities, the relationships among species
richness, total biomass and species richness might also arise from effects of
the environment on both diversity and ecosystem functions
[@loreau_biodiversity_2001; @he_global_2013;
@grace_integrative_2016]. Environment affects organism performance directly, and
thereby, species abundances, total biomass [@grace_integrative_2016] and temporal
stability [@de_boeck_patterns_2017; @hansen_climate_2013; @bluthgen_land_2016;
@oliver_heterogeneous_2010; @franssen_annual_2011; @friedpetersen_drivers_2020].
For example, larger ecosystem might increase the number of available
resources and thus total biomass [@post_ecosystem_2000; @doi_resource_2009].
@li_relationship_2018 have notably shown that climate moisture has a positive
direct effect on total biomass, but also indirect through a positive effect on
species richness. Accounting for environment also allow for an overall
comparison of the strength of the effects of environment and community structure
on total biomass and its stability.

---
#### Stream fish communities is a good model to study effects of horizontal & vertical diversity
---

Because their trophic interactions are well known, stream fish communities
constitute a good model to study the effects of network structure on total
biomass and its temporal stability. Despite that fish trophic
interactions are difficult to measure in natural conditions, a substantial body
of literature supports that they can be inferred through body size and diet
informations [@gravel_inferring_2013; @jennings_weak_2001;
@brose_predator_2019]. Especially in stream communities, including fishes,
@brose_predator_2019 found that the prediction of predator prey trophic
interactions based on body size ratio was far better in stream ecosystems than
in other aquatic and terrestrial ecosystems. Lastly, most of the
diversity-biomass and diversity-stability relationships, have been assessed in
terrestrial ecosystems while there is a evident need to test such relationships
in a variety of ecosystem types.

Our aim is to document the relationships among species richness, foodweb structure, 
total biomass and its temporal stability in natural communities. To do so, we
used the ONEMA dataset consisting in standardized sampling of fish communities
in French streams [@edeline_ecological_2013]. We selected 99 sites that were sampled for more than 10
years spanning on the 1995-2018 period. We inferred 1496 interaction networks,
based on body size and diet. We question whether species richness, connectance
and average trophic level increase, decrease or are not related to
total biomass and its temporal stability. We further question whether the
species richness, connectance, and average trophic level have antagonistic or
mutual effect on total biomass and its temporal stability. Finally, we
question if ecosystem size and average temperature increase total biomass and
its temporal stability.

# Methods

```{r}
myload(qt_station, dir = mypath("data"))
matmet_cap <- paste0( 
  "Yearly temporal series of networks of two stations having respectively a low
  (A) and high (B) temporal stability of biomass. A and B stations have
  respectively biomass stability the closest to the first and third quartile of
  the distribution of the temporal stability of biomass in the dataset,
  respectively ",
  round(qt_station$bm_std_stab[1],2), " and ", round(qt_station$bm_std_stab[2],
    2),
  ". Point size are proportional to the biomass of the trophic species. (C)
  Observation sites (black dots) were located across France and monitored on the
  period 1995-2018. Red dots being the location of (A) and (B) sites. ",
  "Inner borders draw the limits of the hydrographic basins. ", "(D) The metaweb
  of the study. Each trophic species (N = 412) is represented by a node and each
  color represent a species (S = 45). Resource nodes (7) were drawn in grey. ",
  "The species names corresponding to the three digit codes are found in Table
  SXX.")

```

```{r matmet, fig.cap = matmet_cap, results = "fig.show"}
library(knitr)
include_graphics(path = mypath("manuscript", "bef_stability", "figs", "fig1.pdf"))
```

```{r}
# Basin
st_basin <- get_basin_station(sf_obj = FALSE)

# Select fishing operation 
myload(op_analysis, op_analysis_wo_holes, dir = mypath("data"))
myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
op_analysis_wo_holes_bbb <- filter(op_analysis_wo_holes, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
range_surface <- map_dbl(c(min, max), ~.x(op_analysis_bbb$surface, na.rm =TRUE))
range_surface[1] <- ceiling(range_surface[1] / 10) * 10
range_surface[2] <- ceiling(range_surface[2] / 100) * 100
# quantile(op_analysis_bbb$surface, na.rm =TRUE)
```

## Data preparation and filtering

Fish communities were monitored across stream sections in France on the period
1995-2018 by the French Office of Water and Aquatic Ecosystems (ONEMA) using
electric fishing. Two different standardized protocols were used for small and
large streams (detailed in Supplementary material, part 1.1). For streams
shallower than 0.7m across the entire width, the sampling took place over the
whole width of the streams and was done by foot whereas in streams deeper than
0.7m, the sampling was done over the bank by foot or by boat. The sampling
season spanned from late spring to autumn. One sampling event correspond to a
sampling a given year in a given sampling station. During sampling, all the
fishes caught were identified. For each species, either the body size of all
fish was measured, or a representative sample when the number of fish was high
(Figure S1, supplementary information). The fishes were released at the end of
the sampling. Additionally, the physical characteristics of the stream were 
recorded during sampling event as well as the sampling effort, quantified as the
surface sampled (range `r range_surface[1]`-`r range_surface[2]` square metres).

The stations where the stream was of intermediate size could be sampled
alternatively with one of the two sampling protocols. In this case, we
kept only the most frequently used sampling protocol. Then, we selected the
stations that had been sampled ten years or more. There was low heterogeneity of
the sampling month within stations, with the median sampled month being
mid-August while the median of the standard deviation of the sampled month
within station was $0.7$. As the concept of community variability referred to
variability around an equilibrium, which is rarely observed or difficult to
characterize in natural communities, only stations with no temporal trends
in total biomass were selected (detailed in supplementary methods). However, the
results were robust to the relaxation of this hypothesis (Supplementary
results). These selection steps resulted in 99 stations distributed over seven
hydrographic basins (Figure \@ref(fig:matmet) A).

## Variable computation

### Biomass estimation

The body size of all fish individuals was not recorded when they were too
numerous. The body size of the unmeasured individuals was inferred under the
assumption that species body size followed a normal distribution whose mean and
standard deviation were quantified from the recorded individuals of the sampling
(See supplementary methods, Figure S1). The body mass of each individual was
then estimated using an allometric law $B_i = 0.01 \times l_i^{3.03}$, $B$
with the body mass in grams, $l$ the body size in millimeters, $i$ the
individual and where the coefficients $0.01$ and $3.03$ comes from two
meta-analyses on fishes [@lleonart_removing_2000; @froese_cube_2006]. Species
biomass and total biomass at each sampling event was then calculated by summing
individual body masses. To account for the variation in sampling effort among
sites, species biomass and total biomass have been related to the surface
sampled, i.e. $gm^{-2}$. In the analysis, the total biomass of a
station has been defined as the median of the total biomass across sampling
events.

### Stability measures

Temporal biomass stability was defined as the inverse of biomass variability.
Variability was computed as Coefficient of Variation (CV) of the biomass over
time ($CV_i = \sigma_i \mu_i^{-1}$, with $\sigma_i$ and $\mu_i$ being
respectively the standard deviation and the temporal average of the annual total
biomass of the station $i$). Then, temporal stability was equal to $CV^{-1} =
\mu \sigma^{-1}$.

We described the mechanisms driving the temporal stability of biomass, by
decomposing the $CV$ of total biomass ($CV_{com}$) into a synchrony ($\phi$) and
a weighted average species $CV$ ($\overline{CV_{sp}}$) components according to
@thibaut_understanding_2013:

$$
CV_{com, i} = \overline{CV_{sp, i}} \times \sqrt{\phi_i}
$$

with $CV_{com, i}$ being the Coefficient of Variation of the biomass in the
station $i$, $\overline{CV_{sp, i}}$ the average coefficient of variation of
species in the station $i$ weighted by the biomass of the species, $B_{k,i}$.
Synchrony of the station $i$, $\phi_i$, is the ratio between the variance of
total biomass over time ($\sigma^2_{x_{T,i}}$) and the sum of the variance of
population biomass over time ($\sigma_{x_k}$), $i$ being the station $i$ and $k$
the species $k$ [@loreau_species_2008].

$$
\overline{CV_{sp, i}} = \sum_k{\frac{B_{k,i} {CV}_{k, i}}{\sum_k{B_{k,i}}}}
$$

$$
\phi_i = \frac{\sigma^2_{x_{T,i}}}{(\sum_k{\sqrt{\sigma^2_{x_{k,i}}}})^2}
$$

### Species richness

Species richness was computed as the total number of species present across
sampling events 
in a given station. As for biomass, we controlled species richness for sampling
effort by dividing the total number of species by the total surface sampled in
the given station. Species richness was then expressed in number of species per 
square meter sampled.

### Network inference 

```{r}
myload(metaweb_analysis, dir= mypath("data"))
myload(trophic_class, dir= mypath("data", "classes"))
meta <- metaweb_analysis
#metaweb_analysis$resource
#meta$metaweb[meta$resource, meta$resource]
```

We determined the network structure in two steps: (1) build a metaweb describing the
trophic interactions between all trophic species and the resources (Figure
\@ref(fig:matmet) C), then (2) determine network of a given community by
extracting the metaweb according to the trophic species present at a given
site and sampling event (Figure \@ref(fig:matmet) D).

Trophic interaction network was inferred from body size and ontogenic diet shift
following previous studies [@gravel_inferring_2013; @brose_predator_2019;
@poisot_structure_2016]. The diet of stream fishes, as for many organisms, shifts
throughout an individual's life, and thereby with body size. For example, alvins
feed on plankton while adults may feed on algae and fishes, with bigger individuals
eating bigger
fishes. Each fish species was hence divided in nine body size classes, each
corresponding to a trophic species (Figure S2). Additionally to the fish trophic
species, we added seven resource nodes present in the ontogenic food diet database:
detritus, biofilm, phytoplankton, zooplankton, macrophages, phytobenthos and
zoobenthos (grey nodes in Figure \@ref(fig:matmet) C & D). The fish trophic
species and the resources constituted the 412 nodes of the metaweb, 45 fish
species divided into nine body size classes plus seven resource nodes. The inference
of trophic interactions was shown to be more accurate when considering body size
classes, i.e. trophic species, than species [@jennings_weak_2001].

The feeding interactions of a fish node, i.e. a trophic species, were determined
by both its species identity and its body size. Species identity allowed to
differentiate between piscivorous and non piscivorous species, to know which
resources the trophic species are feeding on and to know the minimum size at
which a piscivorous species begin to feed on fishes. The ontogenic fish diet
database was filled according to fishbase and literature (cf Bonnaffe ref). Each
fish species had two or three life stages which are delimited by a body size
range (Figure S2). The life stage of a fish trophic species was determined with
the center of its body size range, hereafter midpoint (Figure S2).

For a piscivorous trophic species, the fish-fish
trophic links was defined in two steps and based on the body size ratio between
predators and prey. First of all, the predation window of a piscivorous trophic specie was
defined as 3% to 45% of its midpoint [@mittelbach_ontogeny_1998;
@claessen_impact_2002; @hart_handbook_2008]. Then, a trophic link was set
between the piscivorous trophic species and every trophic species whose midpoint
was included in the predation window (Figure S2). The fish-resource trophic
links were set between the trophic species and the resources nodes according the
food diet of their size class, for both the piscivorous and non piscivorous
trophic species. Lastly, the trophic links among resource nodes were set
according to the literature [@allan_stream_2007; @hart_handbook_2008].

### Network structure

For each trophic network, corresponding to a particular site and year, we
computed two of the most commonly used network metrics to characterize food
webs, namely the connectance and mean trophic level. Connectance describes the
level of generalism in the network and is calculated as the actual number of
interactions divided by the maximum number of interactions if all species interact
together ($C = L / N^2$, L and N being resp. the number of links and of trophic
species plus resource nodes). The mean trophic level $\overline{T}$ was computed
as the mean trophic level weighted by the biomass of each trophic species
(excluding resource nodes for which we had no biomass information), so
$\overline{T} = \sum_i^N{B_iT_i \times \sum_i^N{B_i}^{-1}}$, with $T_i$ and
$B_i$ being respectively the trophic level and the biomass of the node $i$. The
trophic level of the nodes was computed as one added to the average trophic
level of its food item. For each site, the median of connectance and average
trophic level over time was used in subsequent analysis.



```{r, fig.show = "hide"}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_press <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)

# Make PCA 
habitat_press %<>% na.omit()
mask <- names(habitat_press) %in% names(get_pca_var_name_replacement())

pca_rotated <- compute_rotated_pca(
  .data = habitat_press[, mask],
  naxis = 2
)
habitat_pressure <- 
  cbind(habitat_press[, c("station", "temperature_med", "alt")], pca_rotated$rotated$score) %>%
  as_tibble
ggplot(habitat_pressure, aes(x = RC2, y = temperature_med)) +
  geom_point()

ggplot(
  pivot_longer(habitat_pressure, cols = c("RC1", "RC2"),
    names_to = "variable", values_to = "value"
  )
  , aes(x = value)) +
geom_histogram() +
facet_grid(cols = vars(variable))

mysave(habitat_press, habitat_pressure, dir = mypath("data"), overwrite = TRUE)

```

```{r}
prop_var_expl_pca <- pca_rotated$rotated$Vaccounted["Proportion Var", ] %>%
  map_dbl(., ~round(.x * 100))
tot_var_expl_pca <- sum(prop_var_expl_pca) 
```

```{r, message = FALSE, results = FALSE}
# Com
com_data <- compute_community_temporal_analysis(.op = op_analysis_bbb,
 type_network_metrics = "classes"
)
# Compute sem dataset
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]],
  hab_press = habitat_pressure,
  sync = com_data[["sync_std"]],
  nmds = NULL,
  basin = st_basin
  )
mysave(sem_data, dir = mypath("data"), overwrite = TRUE)
```


## Environmental variables

We characterised the sites by their altitude, slope, distance from
source, stream width and depth and its strahler order, i.e. its position in the
stream network. From the naiades database
[(www.naiades.eaufrance.fr)](http://www.naiades.eaufrance.fr/), we also
got data on water temperature and flow. As data from the naiades database are
not collected on the same site as our fish sampling sites, we performed an
interpolation with spatial stream networks [@isaak_applications_2014;
@hoef_ssn:_2014]. The interpolation procedure is detailed in supplementary (part
1.2).

We had one environmental variable value for each sampling event, except
for water temperature for which the record began in 2006. Then, we computed the
average and CV values of for water temperature, flow, BOD, river width and
depth. As habitat and environmental variables are often collinear, a principal
component analysis (PCA) was performed on the 14 scaled variables. We kept in
the analysis the two first principal components based on the elbow method, on
the eigen values distribution (Figure S4). The two first principal components
explained `r tot_var_expl_pca`% of the variance (Figure S4). A varimax axis rotation was
performed to maximize the representation of the variables by the principal
components [@kaiser_varimax_1958; @revelle_psych_2019]. The first axis
represented a gradient from small to big streams, characterized by their width
and depth, but also a gradient from stream close to far from the source. The
second axis represented a gradient of increasing average water temperature and
decreasing altitude and slope. Further description of the variables are provided
in supplementary information (part 1.3).

## Statistical analysis 

Structural Equation Modeling enables us to assess multivariate relationships
between variables. It is a promising way to go beyond bivariate relationships
and to investigate complex relationships, direct and
indirect, between variables [@grace_structural_2008; @grace_causal_2014;
@lefcheck_piecewisesem_2016; @grace_integrative_2016]. The structural equation
model explaining the annual total biomass allowed the environment
to affect directly species richness and network structure, as well as annual total
biomass (Figure \@ref(fig:sem-plot) B). We assumed that both species richness
and network structure directly affect total biomass (Figure \@ref(fig:sem-plot)
B) and that species richness affected foodweb structure
[@winemiller_must_1989; @dunne_network_2006; @thebault_stability_2010].  

We used the same model structure for temporal stability of biomass (Figure
\@ref(fig:sem-plot) A). Instead of the annual total biomass, we modelled the
synchrony and population variability which in turn determined the temporal
stability of biomass. The structural equation models used for annual total
biomass and its temporal stability contained respectively 4 and 6 response
variables, 35 and 26 direct paths.

The structural equation models were based on Gaussian linear models, all variables
except the connectance and average trophic level
were logged to fulfill model assumptions (see residual plots and data
transformation in supplementary informations, Table SXX). We set the seven
hydrographic basins as a random effect on the intercept of the linear models to
account for their heterogeneity. We checked for the absence of multicollinearity 
with Variance Inflation Factor (VIF, Table SXX). The slopes reported
in the main text were standardized in order to compare their magnitude ($r_\delta
= \beta \frac{\sigma_x}{\sigma_y}$, $\beta$ being the unstandardized slope,
$\sigma_x$ and $\sigma_y$ being respectively the standard deviation of the
predictive variable $x$ and of the response variable $y$). The paths whose
slope had a $P$ value inferior to $0.05$ were reported in the main text, all the
path values are presented in Table SXX and SXX).

Indirect effects on total biomass and its temporal stability
were computed by multiplying slopes along the path. As an example, if we consider
$A \to B \to C$, the indirect effect of A on C is equal to $r_{AB} \times
r_{BC}$.  Only significant direct slopes were entered in the calculation of
indirect effects. Finally total effects were computed as the sum
of direct and indirect effects.

Environmental variables were interpolated with the `openStars` and `SSN`
R packages [@kattwinkel_openstars_2018; @hoef_ssn:_2014]. Linear models and SEMs
were computed with respectively the `nlme` and `piecewieseSEM` R packages
[@pinheiro_nlme_2020; @lefcheck_piecewisesem_2016]. The code used for the
analysis and the manuscript are accessible on github. The analysis were
performed with R version 3.6.3 [@r_core_team_r_2020].

```{r get-data}
library(piecewiseSEM)
library(lme4)
library(nlme)

#ctrl <- lmeControl(opt='optim')
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
```

```{r}
# Compute SEMs
stab_sem_rich <- compute_stab_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem_rich <- compute_prod_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

def_env_x_pos <- c(from = 0, to = 3)
asp <- 1.6

library(DiagrammeR)
meta_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability","figs", "meta_stab_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  metamodel = TRUE,
  inverse_y_node_pose = TRUE
)
p_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "figs", "stab_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  inverse_y_node_pose = TRUE
)

meta_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "figs", "meta_bm_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  metamodel = TRUE,
  inverse_y_node_pose = TRUE
)
p_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "figs", "bm_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  inverse_y_node_pose = TRUE
)
```


```{r get-sem-coeff}
coef_stab_sem <- coef(stab_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)

coef_bm_sem <- coef(bm_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)
```


```{r}
sem_caption <- paste0(
  "Metamodel of the Structural Equation Models for (A) biomass stability and
  (B) total biomass. ",
  "Results of the Structural Equation Models for (C) the
  determinants of biomass stability and (D) total biomass. Red and green arrows
  represent respectively negative and positive path coefficients. The path
  coefficients are standardized. For convenience, only significant
  paths (i.e. $P < 0.05$) are shown. Rsq: Ajusted $R^2$; Avg:
  Average, CVsp: weighted temporal CV of the population; PCA1 and PCA2: respectively the first and
  second axis of the PCA."
)
```


```{r sem-plot, fig.height = 6, fig.cap = sem_caption}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple

plot_grid(
  meta_bm_sem_rich, p_bm_sem_rich,
  meta_stab_sem_rich, p_stab_sem_rich,
  labels = LETTERS[1:4], nrow = 2,
  rel_widths = c(1, 1)
)
```

```{r get-bm-sem-single-effect}
bm_sem_coef <- filter(coef_bm_sem, P.Value <= 0.05)

rich_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_rich_tot_std")
rich_on_tlvl <- get_clean_sem_coef(sem = bm_sem_coef, resp = "t_lvl", pred = "log_rich_tot_std")
tlvl_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "t_lvl")
ct_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "ct")
RC1_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC1")
RC2_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC2")
```

```{r get-bm-tot-effect-env}
bm_all_params <- get_coefficient_piecewisesem(sem = bm_sem_rich, p_val_thl = NULL)

# effect of env on bm 
env_on_bm <- get_env_on_bm(fit = bm_all_params, p_val_thl = 0.05,
  type = "std")
# rich on bm 
rich_on_bm <- get_rich_on_bm(fit = bm_all_params,
  p_val_thl = 0.05, type = "std")
# direct
ct_on_bm_trick <- list(direct = c(ct = ct_on_bm), total = c(ct = ct_on_bm))
tlvl_on_bm_trick <- list(direct = c(t_lvl = tlvl_on_bm), total = c(t_lvl = tlvl_on_bm))


tmp_bm_indir_table <- map(list(env_on_bm, rich_on_bm, ct_on_bm_trick,
    tlvl_on_bm_trick),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```

```{r}
stab_all_params <- get_coefficient_piecewisesem(sem = stab_sem_rich, p_val_thl = NULL)
# effect of env on stab
env_on_stab <- get_env_on_stab(fit = stab_all_params, p_val_thl = 0.05,
  type = "std")
rich_on_stab <- get_rich_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
ct_on_stab <- get_ct_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
tlvl_on_stab <- get_tlvl_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")

tmp_stab_indir_table <- map(list(env_on_stab, rich_on_stab, ct_on_stab, tlvl_on_stab),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```
```{r get-sem-single-effect}
stab_sem_coef <- filter(coef_stab_sem, P.Value < 0.05)

sync_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_sync")
cv_sp_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_cv_sp")
RC1_on_sync <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_sync", pred = "log_RC1")
tlvl_on_cv_sp <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_cv_sp", pred = "t_lvl")
```

```{r get-sem-tot-effect-env}
# effect of env on sync and cv_sp
env_on_sync <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
env_on_cv_sp <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
# env on stab via network 
env_on_t_lvl <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "t_lvl", type = "std")
env_on_ct <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "ct", type = "std")
env_on_richness <- get_env_on_rich(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
```


# Results

The structural equation models explained a large part of the variation
of connectance, synchrony, $\overline{CV_{sp}}$ and total biomass (resp. $R^2 =
.45$, $.47$, $.49$ and $.38$) but less so for mean trophic level ($R^2 =
.18$, Figure \@ref(fig:sem-plot) C and D). We found that species richness had a
significant negative effect on mean trophic level ($r_\delta = 
`r rich_on_tlvl`$) and connectance ($r_\delta = `r rich_on_stab$total`$, Figure
\@ref(fig:sem-plot) C and D), meaning that a part of the effects of species richness went 
through network structure.

## Species richness and average trophic level are positively correlated to total biomass

```{r get-sem-tot-effect-rich}
rich_on_sync <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
rich_on_cv_sp <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
```

Species richness and mean trophic level had a significant positive direct effect
on total biomass ($r_\delta = `r rich_on_bm$direct`$ and 
$r_\delta = `r tlvl_on_bm`$ resp., Figure \@ref(fig:sem-plot) D, Table
\@ref(tab:indir-sem)),
while connectance had no direct effect on total biomass (Figure
\@ref(fig:sem-plot) D).

The two PCA axis capturing environmental variables had no significant direct effects on total biomass
, but indirect (Table \@ref(tab:indir-sem)). The first axis, PCA1,
related to the stream size was positively linked to total biomass ($r_\delta = 
`r env_on_bm$total["log_RC1"]`$, Table \@ref(tab:indir-sem)),
through both species richness and mean trophic level ($r_\delta = 
`r env_on_bm$via_richness["log_RC1"]`$ and $`r env_on_bm$via_tlvl["log_RC1"]`$
resp., Table \@ref(tab:indir-sem)). The second axis, PCA2, related to the average
annual temperature and inversely to altitude of the sites was positively related
to total biomass ($r_\delta = `r env_on_bm$total["log_RC2"]`$, Table
\@ref(tab:indir-sem)), mainly through species richness ($r_\delta = 
`r env_on_bm$via_richness["log_RC2"]`$, Table \@ref(tab:indir-sem)). The effect
of PCA2 on total biomass was of the same magnitude than the effects on species
richness and mean trophic level.


## Temporal stability of annual biomass

By its effects on synchrony and $\overline{CV_{sp}}$, species richness had a
negative total effect on biomass stability ($r_\delta = `r rich_on_stab$total`$,
Table \@ref(tab:indir-sem)). This effect resulted from two opposite effects. On
the one hand, species richness had a direct negative effect on synchrony
($r_\delta = `r rich_on_sync$direct`$), thereby
increasing stability ($r_\delta = `r rich_on_stab$via_sync`$). On the other
hand, species richness had a positive direct effect on $\overline{CV_{sp}}$
($r_\delta = `r rich_on_cv_sp$direct`$),
thereby decreasing biomass stability ($r_\delta = `r rich_on_stab$via_cv_sp`$, Table
\@ref(tab:indir-sem)). The negative effect of $\overline{CV_{sp}}$ on temporal
stability was twice higher than the negative effect of synchrony (resp.
$r_\delta = `r cv_sp_on_stab`$ and $r_\delta = `r sync_on_stab`$, Figure
\@ref(fig:sem-plot) C).

The total effect of mean trophic level on temporal stability of biomass was of
the same magnitude than the one of species richness (resp.
$`r tlvl_on_stab$total["t_lvl"]`$ and $`r rich_on_stab$total`$, Table
\@ref(tab:indir-sem)).
The mean trophic level had only a direct negative effect on
$\overline{CV_{sp}}$ ($r_\delta = `r tlvl_on_cv_sp`$,
Figure \@ref(fig:sem-plot) C) and thereby had a total positive
effect on temporal stability ($r_\delta = `r tlvl_on_stab$via_cv_sp["t_lvl"]`$,
Table \@ref(tab:indir-sem)). Connectance had no significant direct effect on either
$\overline{CV_{sp}}$ nor synchrony and thus no effect on temporal stability
(Figure \@ref(fig:sem-plot) C, Table \@ref(tab:indir-sem)).
 
The total effect of PCA2, related to average annual temperature and inversely to
altitude, on temporal stability was of higher magnitude than the effects of
species richness and mean trophic level (Table
\@ref(tab:indir-sem)).
The PCA2 had a total negative effect on temporal stability, meaning that higher
temperature results in lower stability
($r_\delta = `r env_on_stab$total["log_RC2"]`$, Table \@ref(tab:indir-sem)). 
PCA2 had an indirect positive effect on temporal stability through a
direct positive effect on $\overline{CV_{sp}}$ ($r_\delta = 
`r env_on_cv_sp$direct["log_RC2"]`$, Table \@ref(tab:indir-sem)) but also a
negative one through species richness but a positive one through
mean trophic level
(resp. $r_\delta = `r env_on_stab$via_richness["log_RC2"]`$ and
$r_\delta = `r env_on_stab$via_tlvl["log_RC2"]`$, Table \@ref(tab:indir-sem)).
This was also true for the PCA1, related to stream size, but effects were weaker
than for PCA2.


```{r indir-stab}
caption_sem <- paste0(
  "Direct, indirect and total effects of environment, species richness,
  connectance and mean trophic level on total biomass
  and its temporal stability. Indirect effects are computed by multiplying the
  path coefficients from the variable predictor to the response variable, here
  biomass stability. Indirect effects are considered as one step from the target
  variable. For exemple, the indirect effect of species richness on
  biomass stability via its effect on CVsp is $-0.62$. Only the
  significant direct effects were retained for the computation of indirect
  effects. ", "As an example, the indirect effect via species richness takes
  into account the direct effect of species richness as well as the effect of
  species richness through connectance and average trophic level.",
 "NA values indicate that the corresponding paths do not exist in the
 specified Structural Equation Model (SEM)."
)

full_table <- bind_rows(
  tmp_bm_indir_table,
  tmp_stab_indir_table
) %>%
mutate(`SEM type` = c(rep("Total annual biomass", 5), rep("Temporal Stability of annual biomass", 5))) %>%
select(`SEM type`, variable, direct, via_richness, via_ct, via_tlvl, via_cv_sp, via_sync, total) %>%
format_table() %>%
select(`SEM type`, everything())


library(kableExtra)
mytable <- kable(full_table,
  format = "latex",
  booktabs = T,
  label = paste0("indir-sem"),
  caption = caption_sem
  ) %>%
#kable_paper() %>%
kable_styling(latex_options =c("scale_down")) %>%
add_header_above(c(" " = 3, "Indirect effects via" = 5)) %>%
column_spec(1:2, width = "3cm") %>%
collapse_rows(columns = 1, valign = "top")
#str_replace(mytable, "\\\\#(.*)", "\\\\label{tab:indir-sem}")
#str_view(mytable, "\\\\#(.*)")
write(mytable, file = mypath("manuscript", "bef_stability", "table.tex"))
```

```{=latex}
\input{table.tex}
```

# Discussion

Overall, its study is unique by its level of integration, from environmental
effects to total biomass and stability, going through species richness and
network structure. It is the first direct assessment of a possible joint effect
of species richness and network structure on both total biomass and its temporal
stability. We found that species richness and mean trophic level had a positive
effect on total biomass. In contrast, species richness had a negative effect on
temporal stability whereas mean trophic level covaried positively. We also found
that the effect of species richness and mean trophic level on total biomass and
its temporal stability were not independant as species richness had a negative
effect on mean trophic level.  Furthermore, we found that connectance had no
significant effect on both total biomass and its temporal stability. Finally, we
found that the magnitude of the effects of average temperature and altitude was
equal or superior to the effects of species richness and mean trophic level. 

## Species richness increased total biomass but decreased its temporal stability 

We found that species richness increased total biomass as found in salt marshes,
grasslands and forests [@hector_plant_1999; @tilman_biodiversity_2014;
@wu_relationship_2015; @li_relationship_2018]. The positive effect of species
richness on total biomass might be due to resource use complementarity
[@carey_determining_2011], which is held by niche differentiation
[@loreau_biodiversity_1998; @loreau_partitioning_2001] or to the higher
probability of getting high biomass species with higher species richness
[@loreau_biodiversity_2001].

Surprisingly, we found a negative relationship between temporal stability and
species richness. Overall, it contrasts with experimental studies in grasslands
[@tilman_biodiversity_2006; @valencia_synchrony_2020]; mesocosms (Pennekamp et al. 2018), in 
natural communities of butterflies [@olivier_urbanization_2020] or even in lotic
fish communities [@franssen_annual_2011] where positive relationships were found
between temporal stability and species richness. However, other studies found an
opposite relationship in natural grassland [@yang_effects_2011] and a marginal
one in natural forests [@declerck_species_2006]. 

The first step to identify the mechanisms behind those contrasting patterns is to
look at the effects of species richness on synchrony and $\overline{CV_{sp}}$.
As most studies on experimental grasslands
[@isbell_biodiversity_2009; @roscher_identifying_2011] and natural communities
of birds, grasslands, bats and butterflies [@bluthgen_land_2016;
@olivier_urbanization_2020], we found that species richness decreases synchrony,
thereby increasing stability [but see @declerck_species_2006;
@valencia_synchrony_2020]. Our study thus extends the evidence that species
richness decreases synchrony to the case of trophic communities in natural
settings. Species richness can reduce synchrony when (i) a given increase in species
richness leads to a decrease of population sizes which raises the role of
demographic stochasticity, when (ii) species have different
responses to environmental variation [@loreau_species_2008].

The positive effect of species richness on
$\overline{CV_{sp}}$, thereby decreasing stability, is more intriguing. While
positive effect of species richness on $\overline{CV_{sp}}$ was reported in
experimental grasslands and natural bird communities [@tilman_biodiversity_2006;
@olivier_urbanization_2020], negative and neutral relationships have been found
in butterfly and bat communities. Our results contrast with a previous
meta-analysis which concludes that species richness had a positive effect on
population stability in multi-trophic aquatic microcosms
[@jiang_different_2009]. In foodwebs, the relationship between temporal
stability of populations and species richness depends on interaction strength
and its distribution [@mccann_reevaluating_1997; @thebault_trophic_2005;
@brose_allometric_2006], high interaction strength inducing a negative
relationship. Therefore, it is possible that our results are due to a high
degree of omnivory in foodwebs, which combined with strong trophic interactions
lead to more fluctuations in population biomass.


---
#@thibaut_understanding_2013 proposed that a
#strongly uneven biomass distribution across populations and that the biomass
#variance of population increases much faster than its mean can generate a
#positive effect of species richness on population ($\overline{CV_{sp}}$)
#stability.
---


## Average trophic level increased total biomass and its temporal stability

The average trophic level was positively linked to total biomass.
Experimental and theoretical work suggested that a higher trophic level is the
result of a stronger top-down effect, meaning higher predation rates and biomass
fluxes to higher trophic levels [@kratina_warming_2012], hence leading to an
increase in total biomass with trophic length. Furthermore,
@wang_biodiversity_2016 have shown that total nutrient uptake might increase
with the length of trophic chains and so results in higher total biomass. 

In contrast, connectance had no effect on total biomass. One might have expected
that an increase in connectance may translate in a higher total nutrient uptake
and so results in higher total biomass in the fish compartment. A reason for
such an absence of an effect might be explained by the fact that our data lack
information about the lower compartments of the community, i.e., the primary
producers, zooplankton and zoobenthos.

Mean trophic level had a positive effect on biomass stability by its negative
effect on $\overline{CV_{sp}}$, thereby increasing average species stability. It
might result from a higher stability of higher trophic level as predicted by
food chain models in the presence of strong top-down control
[@barbier_pyramids_2019; @shanafelt_stability_2018]. But it
might not hold when considering omnivorous species
[@wang_biodiversity_2016]. An alternative explanation is that higher mean
trophic level leads to a stronger top-down control and resource complementarity
and thus reduce biomass fluctuations in lower trophic levels
[@rooney_structural_2006].

We found that connectance had no effect on temporal stability. This result
contradicts previous precedent theoretical studies on the relationship between
stability and network structure [@angelis_stability_1975; @may_will_1972;
@thebault_stability_2010; but see @neutel_reconciling_2007], although they
considered different stability concepts and metrics [@arnoldi_resilience_2016].
However, our measure of connectance does not include the variability of the
lower compartments of the foodweb and further research should examine the effect
of connectance on temporal stability in more complete empirical foodwebs.

## Population stability was the main driver of temporal stability

In contrast with previous studies, we found that the average population
variability ($\overline{CV_{sp}}$) had a stronger negative effect on biomass
stability than synchrony [@tilman_biodiversity_2006;
@olivier_urbanization_2020]. It explains why we observe a negative effect of
species richness on temporal stability of biomass. The lower effect of synchrony
might be explained by the presence of generalist predators in stream
communities, that raise synchrony between prey species that share the
same predator and thus reduces compensatory
population dynamics [@raimondo_interspecific_2004]. Alternatively, it is
possible that, in aquatic foodwebs, the occurrence of large oscillatory dynamics
 leads to a higher contribution of population
variability rather than synchrony to community stability
[@mccann_reevaluating_1997]. How both strengths and the relative contribution of
synchrony and population variaribility to overall stability vary between
foodwebs and single trophic communities is still an open question.

---
#Rough average synchrony in Théophile study: exp(-0.75) = .47 or exp(-0.6) = .54
#This study: sync avg = .69
---


## Environment had an high effect on total biomass and its temporal stability 

We found that the total effect of environmental drivers on total biomass and its
stability was indirect and of the same magnitude order than the effect of
species richness and average trophic level, highlighting that environmental
changes may result in signicant ecosystem responses, through alteration of
both species richness and network structure.

Consistent with research showing that foodwebs in wider streams support more
species and biomass [@allan_stream_2007], we found that the PCA axis related to
stream size had a positive effect on total
biomass through a positive effect on mean trophic level. Greater ecosystem size
might provide a greater diversity of resources through habitat heterogeneity,
and so higher species richness and total biomass by surface unit, through
resource complementarity. Greater diversity of resources can also maintain
more biomass at high trophic level [@post_ecosystem_2000; @doi_resource_2009].
Furthermore, the positive effect of the PCA axis related to temperature on total
biomass was of the magnitude of effects of network structure and species
richness, in line with the mounting body of work reporting important effects of
temperature on the structure and biomass of aquatic system [e.g.
@dossena_warming_2012; @edeline_ecological_2013; @emmrich_geographical_2014;
@hattab_forecasting_2016]. Contrasting with a previous study in experimental
plant communities [@grace_integrative_2016] and in fish communities
[@yvondurocher_warming_2011; @dossena_warming_2012], we found that environmental
drivers overall affect total biomass indirectly rather than directly.

Interestingly, the two PCA axis related to environmental conditions had indirect
effects on stability through two conflicting pathways, either stabilising, via
network structure, or destabilising, via species richness. The first pathway
consists in a positive effect of temperature and stream size on mean
trophic level, in line with the idea that wider streams and warmer conditions
are favourable to mesotrophic predators [@allan_stream_2007;
@emmrich_geographical_2014], which in turn stabilises biomass fluctuations,
possibly due to increased top-down regulation. The second pathway consists in a
positive effect of temperature and stream size on species richness, which itself
has a destabilising effect. This result is interesting in that both
pathways had not been evidenced to jointly play, to the best of our knowledge.
Furthermore, it is unclear which pathway is dominating, and under which circumstances,
opening an interesting avenue for further investigations.


---
## Final thoughts about empirical foodwebs

#It was unexpected that the average population $\overline{CV_{sp}}$
#had a stronger negative effect on biomass stability than synchrony
#[@bluthgen_land_2016; @olivier_urbanization_2020], and explain why we observe a
#negative effect of species on temporal stability of biomass. The lower effect of
#synchrony can be explained by the  presence of generalist predators in stream
#communities, which can raise synchrony between prey species which shares the
#same predator [@raimondo_interspecific_2004]. Uneven population biomass within
#communities also raise synchrony between species [@thibaut_understanding_2013].

#As found in other studies, we found that species richness was negatively related
#to mean trophic level and connectance [@winemiller_must_1989;
#@dunne_network_2006; @thebault_stability_2010]. Species richness had thus a
#consistent destabilising effect on temporal stability of biomass directly and
#through average trophic level, but it has a direct positive effect on total annual
#biomass directly but a negative one through the decrease of average trophic
#level. It highlights the importance to consider several aspects of
#network structure to order to improve our understanding of the drivers of
#community structure and stability.
---

# Conclusion and perspectives 

While theoretical ecology has focused on the effects of network structure on
stability, empirical ecology has focused on species richness but often did not
consider network structure. Furthermore, both fields have largely used
different stability metrics. Our work is hence contributing to bridging the gap
between theoretical and empirical ecology.

Our study extends the assessment of the effect of species richness on total
annual biomass and its temporal stability in natural settings to the case of
foodwebs, while including network structure. Species richness had a direct
positive and negative effect respectively on total biomass and its stability but
mean trophic level had a positive effect on both. Furthermore, we found that
species richness had antagonistic effects on total biomass, through its effect
on mean trophic level. Our study thus highlights the importance of considering both
species richness, network structure and their dependence, though the
mechanisms remain to be elucidated. Finally, we found that
environmental gradient related to temperature and ecosystem size have
antagonistic effects on biomass and its temporal stability, positive through mean
trophic level and negative through species richness. Further research is needed
to find the mechanisms behind those pathways, that are crucial in context of
global changes. 

One limitation of our study is that the use of inferred networks, i.e. not
observed interactions, and the lack of information about the foodwebs outside
fishes. But this approach is a promising way to explore how the architecture of
ecological networks vary along environmental gradients across time. It
constitutes an interesting complement to the real assessment of ecological
interactions. The use of inferred networks also allow to maximise the
information contained from already available long term datasets.

We look forward to see our findings and their interpretation tested by future
experimental and theoretical studies, allowing to unravel the ecological
mechanisms driving the complex relationships among environment, the structure of
ecological networks and ecosystem properties such as productivity and temporal
stability.

 

```{r}
save.image(file = mypath("manuscript", "bef_stability", "result", "workspace.rda"))
```

# References
