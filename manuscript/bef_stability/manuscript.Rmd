---
title: Horizontal and vertical diversity jointly drive total biomass and its temporal stability in fish communities
author: Alain Danet, Maud Mouchet, (Willem Bonnaffe ici?), Elisa Thebault and Colin Fontaine
date: \today 
output:
  bookdown::pdf_document2:
    toc: false 
    fig_caption: true 
    keep_tex: true
fontsize: 12pt
header-includes:
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
geometry: margin=2cm
bibliography: references.bib
---

```{r, echo = FALSE, results = FALSE, message = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE 
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "total_sem_effect.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```

```{r, results = FALSE}
knitr::opts_chunk$set(
  results = TRUE 
)
```

- Author affiliation:
  - Alain Danet:
  - Maud Mouchet:
  - Willem Bonnaffe:
  - Elisa Thebault: 
  - Colin Fontaine:

- Author contributions: AD, CF, MM and ET designed the study. WB designed the
  network inference method and collected the food diet data. AD performed the
  data analysis and wrote the first draft of the manuscript. All authors
  contributed substantially to revisions.  

- Data accessibility statement: the ONEMA database is available upon request to 
  eddy.cosson@afbiodiversite.fr and thierry.point@afbiodiversite.fr. The code
  used for the analysis and to generate the manuscript is available on github:
  (alaindanet/fishcom.git)

- Article type: Letters

- Number of words:
  - Abstract: 194
  - Main text: XXXX 

- Number of references: XXX
- Number of figures: 2
- Number of tables: 2
- Number of text boxes: 0 

- Coresponding author:
  - Alain Danet
  - UMR 7204 CESCO, BP 61; 45, rue Buffon, 75005 Paris, France
  - alain.danet@mnhn.fr 
  - +331XXXXXXXX

# Abstract

The effect of horizontal  and vertical diversity on ecosystem properties has
been central to ecology. It has been at the basis of the predictions of the
effect species richness and  network structure on total biomass, productivity
and stability. However, they have mainly been studied separately.  We used a
dataset of standardized fish sampling in French stream running from 1995 to
2018. We inferred trophic interactions thanks to recorded body size and diet
literature. We then investigate the direct and indirect effects of stream
size and temperature, horizontal and vertical diversity on total biomass and
its temporal stability. We found that horizontal and vertical diversity had
a positive relationship with total biomass while they had respectively a
negative and positive effect on temporal stability. We also found that
horizontal and vertical diversity are not independent and that environment
had an tremendous effect on total biomass and its temporal stability notably
through its effect on horizontal and vertical diversity. We conclude that our
study highlights that the effects horizontal and vertical diversity should not
treated separately and that it opens exciting perspectives on how environment,
horizontal and vertical can jointly determine total biomass in natural
communities.

(194/150 words)

# Introduction 

#### Biodiversity and ecosystem properties 


Current biodiversity losses and global changes affect ecosystems in complex and
unpredictable ways [@bellard_impacts_2012]. Since the seminal of paper of
@may_will_1972, the relationships between biodiversity and ecosystem properties
have received a lot of attention [@hector_plant_1999; @loreau_biodiversity_2001;
@hooper_effects_2005; @dunne_network_2006; @duffy_why_2009;
@isbell_forest_quantifying_2018]. Biodiversity largely determines both the
amount and the distribution of matter and energy fluxes within ecosystems, and
has hence a tremendous effect on ecosystem properties [@duffy_why_2009], such as
its total biomass [@hector_plant_1999; @tilman_biodiversity_2014;
@grace_integrative_2016; @pennekamp_biodiversity_2018], biomass production
[@tilman_productivity_1996;Â @cardinale_species_2002; @grace_integrative_2016]
and the biomass temporal stability [@thebault_trophic_2005;
@thebault_relationship_2006; @tilman_biodiversity_2006;
@olivier_independent_nodate].

#### Horizontal and vertical diversity are two ways to look at biodiversity  

Biodiversity can be quantified in numerous ways: either as the number of species
(i.e.  species richness) and in number of functional groups, which are usually
defined based on the trophic ecology of species, namely the way they acquire
food [@allan_stream_2007]. Those metrics can be organized into (i) "horizontal
diversity", which captures the overall diversity of components (i.e. species)
present in a community, and (ii) "vertical diversity" which captures diversity
of components across functional groups, such as the amount trophic categories,
often termed guilds or levels [@allan_stream_2007; @loreau_populations_2010;
@zhao_horizontal_2019; @wang_biodiversity_2016]. Vertical diversity has been
primarily quantified as food chain length [@loreau_populations_2010;
@zhao_horizontal_2019; @wang_biodiversity_2016] but it can also be characterized
by the food web structure [@wang_biodiversity_2016] such as connectance and
average trophic level. Horizontal and vertical diversity are, however, not
independent from each other. Connectance is known to covary negatively with
species richness [@winemiller_must_1989; @dunne_network_2006;
@thebault_stability_2010]. Species diversity also result in modification of
biomass distribution across the food web [@thebault_relationship_2006;
@duffy_ecosystem_2005; @duffy_functional_2007; @schneider_animal_2016].
Hence, it is crucial to study if horizontal and vertical diversity have synergic
or antagonistic effects and how their interplay modulates ecosystem properties.  

#### horizontal and vertical diversity increase total biomass by common and different mechanisms 

Horizontal diversity has been shown to promote higher biomass production in a
variety of ecosystems. Horizontal diversity, as species richness, has been
reported to increase primary productivity [@cardinale_species_2002,
@tilman_productivity_1996; @grace_integrative_2016]. Two mechanisms have been
proposed to rise this effect [@loreau_partitioning_2001]. The complementarity in
resource use, rising through niche differentiation and interspecific
facilitation, increase the total amount of resource used
[@loreau_biodiversity_1998; @cardinale_species_2002; @loreau_partitioning_2001].
Positive select effect arise when species richness leads to an higher dominance
of the most productive species [@tilman_plant_1997; @loreau_partitioning_2001].
As for total biomass, empirical studies have generally demonstrated positive
relationships with species richness in plant communities [@hector_plant_1999;
@tilman_biodiversity_2014; but see @grace_integrative_2016] and mesocosms
[@pennekamp_biodiversity_2018]. When adding the vertical diversity, e.g.
consumers species, @gamfeldt_species_2005 and @thebault_relationship_2006 have found that total
biomass increased with increasing species diversity at two trophic levels.
But this positive relation seems to strongly depend on the niche differentiation of
the consumer species, i.e. their resource complementarity,
@thebault_relationship_2006. Hence, the total biomass-species richness
relationship seems to be supported by the same mechanisms within consumers and
within plants. @schneider_animal_2016 also showed in a allometric food web model
that species richness should increase total animal biomass.
Vertical diversity also affect total biomass. Theoretical studies showed that food
web properties, such as interaction distribution and strength, affect the
vertical distribution of biomass [@thebault_relationship_2006;
@schneider_animal_2016; @barbier_pyramids_2019], i.e. average trophic level.
More precisely, an increase of animal diversity results in
higher animal biomass as more biomass is transfered from plant to animals
[@schneider_animal_2016; @thebault_food-web_2003]. However, the role of vertical
diversity on the total biomass remains unclear in
natural communities.

#### Horizontal and vertical diversity versus temporal stability

Horizontal and vertical diversity also affects the stability of ecosystem
properties. Experimental studies showed consistently that species richness
increases the temporal stability of biomass in grasslands
[@tilman_biodiversity_2006], and mesocosms [@pennekamp_biodiversity_2018]. The
same relation was found in natural settings for temporal biomass stability in
stream fish communities [@franssen_annual_2011] and temporal abundance stability
of birds and butterflies [@olivier_independent_nodate, but not bats].  Two
mechanisms may govern the temporal stability of communities, (1) species
synchrony and (2) variability [@loreau_species_2008;
@thibaut_understanding_2013]. Species synchrony measures the temporal
covariation of species where low synchrony indicates that species temporal
variation compensate each other at the community level, thereby increasing
temporal stability. Species richness was found to decrease
synchrony between species [@loreau_species_2008; @thibaut_understanding_2013;
@bluthgen_land_2016; @olivier_independent_nodate; but @declerck_species_2006].
The species variability is measured as a average coefficient
of variation of abundance/biomass, weighted by species abundance/biomass. Higher species
temporal variability should thus result in lower temporal stability. Positive
[@tilman_biodiversity_2006], neutral [@jiang_different_2009;
@olivier_independent_nodate] and negative [@franssen_annual_2011;
@olivier_independent_nodate] relationships between species variability and
species richness have been found. This conflicting patterns are dependent on
various mechanisms [see @thibaut_understanding_2013]. Species synchrony has been found to be
the main driver of temporal stability [@tilman_biodiversity_2006;
@olivier_independent_nodate] and responsible for the positive relationship
between horizontal diversity and temporal stability of biomass and abundance.

Vertical diversity, captured by network structure, has been at the heart of the
diversity-stability debate and largely explored by theoretical ecology
[@may_will_1972; @angelis_stability_1975; @dunne_network_2006;
@stouffer_compartmentalization_2011; @thebault_stability_2010;
@barbier_pyramids_2019; @shanafelt_david_w._stability_nodate]. As species
interactions introduce inter-dependencies in species dynamics, they have a
substantial impact on stability. In particular, the strength of predation and
degree of omnivory in food webs have been shown to favor stability
[@neutel_reconciling_2007]. Furthermore, competition strength and niche breath of
consumers, can lead to negative or positive temporal stability-species richness
relationships [@thebault_trophic_2005] depending on the food web configuration
[@neutel_reconciling_2007].  However, it is important to note that theoretical ecology
generally defines stability based on community equilibrium and its stability to
small independent perturbations [@may_will_1972; @angelis_stability_1975;
@barbier_pyramids_2019; @shanafelt_david_w._stability_nodate] or to the amount
of secondary extinctions following species removal [@duffy_why_2009]. In
practice, these stability metrics hardly relate to empirical temporal stability
[@arnoldi_resilience_2016].

#### Problematic 

Overall, the evidence suggests that both a higher horizontal and vertical
diversity should lead to a greater total biomass and stability in communities.
The effects of horizontal and vertical diversity are potentially conflicting and
interacting, as they rely on inter-dependent mechanisms, in such a way that
they need to be addressed jointly. Yet, there is no direct empirical evidence to
date for an interaction between effects of horizontal and vertical diversity on
total biomass and stability in natural communities.

#### Environment can mitigate community structure and ecosystem properties 

The environment affects organism performance directly, and thereby, species
abundances and total biomass [@grace_integrative_2016] and
temporal stability [@de_boeck_patterns_2017; @hansen_climate_2013;
@bluthgen_land_2016; @oliver_heterogeneous_2010; @friedpetersen_drivers_2020].
For instance, the hydrology of streams determines the composition of fish
communities, and is also related to fish population temporal stability
[@franssen_annual_2011]. Ecosystem size can also increase habitat heterogeneity
and so the number of different resource available, which in turn might increase
resource complementary between species and increase total biomass
[@post_ecosystem_2000; @doi_resource_2009]. Temperature has potentially
conflicting effects on horizontal and vertical diversity, as higher temperature
favour primary production and fluxes of biomass [@dossena_warming_2012;
@ogorman_chapter_2012], thus potentially supporting more species and trophic
levels [@arim_relationship_2007; @stegen_evolving_2012], but selects against
larger body sized individuals [@dossena_warming_2012; @edeline_ecological_2013;
@hattab_forecasting_2016], and thereby should reduce trophic diversity
[@hattab_forecasting_2016]. It is thus unclear whether these temperature effects
translate indirectly into changes in total standing biomass and stability in
natural food webs. The relative strength of direct and indirect effects of
environment on total biomass and its temporal stability remains an open
question.


#### Research questions 

Overall, the joint effects of horizontal and vertical diversity on total biomass
and its temporal stability remains poorly documented, especially in natural
communities. In this study, we identified (1) the effects of horizontal
diversity and (2) vertical diversity on total biomass and temporal stability
(Figure \@ref(fig:matmet) A).  Considering both direct & indirect effects, (3)
we quantify if the magnitude of environmental effects on total biomass and its
temporal stability and compare them to that of horizontal and vertical
diversities.  (4) We identify the pathway for the effects of environment,
horizontal and vertical diversities on total biomass and its temporal stability.
(4a) Whether environmental effects operate mainly (i) directly, indirectly (ii)
through horizontal diversity, (iii) through horizontal and vertical diversities
or (iv) indirectly through vertical diversity only? (4b) Whether effects of
horizontal diversity arise (i) directly, or (ii) indirectly through vertical
diversity? Finally, (4c) whether environmental variables, horizontal and
vertical diversities affect species synchrony and species variability ?

We used the ONEMA dataset consisting in standardized sampling of fish
communities in french streams [@edeline_ecological_2013]. 99 sites were sampled for more
than 10 years spanning on the 1995-2018 period. We inferred
1496 interaction networks, based on body size and food diet.
Horizontal diversity was quantified as species richness while vertical diversity
was as connectance and average trophic level. Environment was characterized by
the stream size, altitude, slope, and the temperature, flow and enrichment. Finally total
biomass was measured as median total biomass over the sampling period while its
temporal stability was quantified as the inverse of the CV.

#### Stream fish communities is a good model to study effects of horizontal & vertical diversity

Stream fish community constitutes a good model to study the joint effects of
horizontal & vertical diversity on total biomass and its temporal stability.
Despite that fish trophic interactions are difficult to assess in nature, a consequent
body of literature supports that they can be inferred through body size and diet
informations [@gravel_inferring_2013; @jennings_weak_2001;
@brose_predator_2019]. Most of the biomass-diversity and stability-diversity
relationships have been assessed in terrestrial ecosystems while there is a
evident need to test such relationships in a variety of ecosystem types. Stream
ecosystems are characterized by the flowing water and depends for a large part
from the input of terrestrial ecosystems. Furthermore, the biotic activity in
stream ecosystems determines for a large part the water quality
[@cummins_structure_1974] and thus are crucial to maintain stream ecosystem
properties.

We show that TODO

# Methods

```{r}
matmet_cap <- paste0(
  "(A) Conceptual model of the hypothesized relationships between environment,
  species richness, network metrics and total biomass / biomass stability. ",
  "Solid and dashed arrows represent respectively direct and indirect effects.
  ",
  "The blue, green and blue/green dashed arrows being respectively indirect
  effects going through species richness, network metrics and through both
  species richness and network metrics.",
  "(B) Observation sites (black dots) were located across France and monitored
  on the period 1995-2018. ", "Grey shades highlighted elevalation variation. ",
  "Inner borders draw the limits of the hydrographic basins. ",
  "(C) The metaweb. Each trophic species (N = 412) is represented by a node and
  each color represent a species (S = ). Resource nodes (7) were drawn in grey. ",
  "(D) Subset over network variation through time."
)
```

```{r matmet, fig.cap = matmet_cap}
myload(p_st,temporal_network, dir = mypath("manuscript/bef_stability/figs"))

# Network inference
net_method_path <- mypath("manuscript/bef_stability/figs",
  "hypothesis.pdf")
metaweb_path <- mypath("manuscript/bef_stability/figs",
  "metaweb.png")
library(magick)

p_net_method <- cowplot::ggdraw() +
  cowplot::draw_image(magick::image_read_pdf(net_method_path))
p_metaweb <- cowplot::ggdraw() +
  cowplot::draw_image(magick::image_read(metaweb_path))

top <- plot_grid(p_net_method, p_st, ncol = 2, rel_widths = c(1, 1), labels =
  "AUTO")
bottom <- plot_grid(p_metaweb, temporal_network, ncol = 2,
  rel_widths = c(1, 1), labels = c("C", "D"))

p_method <- plot_grid(top, bottom, nrow = 2, rel_heights = c(1, 1),
  labels = c("", "C"))
save_plot(
  filename = mypath("manuscript/bef_stability/figs",
    "method_fig.pdf"),
  p_method, nrow = 2, ncol =2,
  base_width = 7/2.54,
  base_asp = 0.3
)
p_method
```


## Data collection

#### Protocol

Fish communities were monitored across stream sections in France on the period 1995-2018
by the French Office French Office of Water and Aquatic Ecosystems (ONEMA) using
electric fishing, resulting in over XX individual fish sampled [see
@edeline_ecological_2013]. Two different standardized protocols were used for little and
big streams (detailed in Supplementary methods). For streams shallower than (XX
m), the sampling takes place over the whole width of the streams and is done by
foot whereas in streams deeper than (XX m), the sampling was done over the bank
only and by foot or by boat. The sampling took place either in late spring and/or Autumn
and temporal series were checked to reduce sampling heterogeneity within
stations (detailed in Supplementary methods). Each station have been followed
ten years or more. The temporal stability of biomass, computed as inverse of the
CV, can cover very different dynamics such as decreasing, stable or increasing.
However, the concept of community variability referred to variability around an
equilibrium, which is rarely observed or difficult to characterize in natural
communities. We finally kept only the 99 stations (Figure \@ref(fig:matmet) B)
which had no trends in biomass (method detailed in Supplementary methods).
However, the results were robust to the relaxation of this hypothesis
(Supplementary results).

##### Total biomass and its temporal stability 

To characterize communities variability, abundance or biomass are generally
used. When the body size and therefore body mass vary by several orders of
magnitude inside a community, one downside of using abundance is that we mix
individuals that have potentially really different contributions in terms of ecosystem
properties such as total biomass and biomass repartition. We estimated
the body mass following an allometric law ($B_i = 0.01 \times
l_i^{3.03}$, $B$ being the body mass in grams, $l$ the body size in millimeters
and $i$ the individual) [@lleonart_removing_2000; @froese_cube_2006].

The species and total biomass were then computed for each sampling event.
As the sampling effort, reported as the surface sampled during the sampling event,
varied across protocol type and sampling event, biomass was divided by the
surface sampled (in $m^{2}$). So that, community and species biomass were expressed
in $gm^{-2}$.

In the analysis, the total biomass of a given station was characterized as the
median of the total biomass over time. Temporal biomass stability was defined as
the inverse of biomass variability. Variability was computed as Coefficient of
Variation (CV) of the biomass over time ($CV_i = \sigma_i \mu_i^{-1}$, with $\sigma_i$ and
$\mu_i$ being respectively the standard deviation and the temporal average of
the biomass of the station $i$). Then, temporal stability was equal to $CV^{-1}
= \mu \sigma^{-1}$.

To characterize the mechanisms driving temporal stability of communities, we
decomposed the community CV in synchrony and weighted average species CV
components according to @thibaut_understanding_2013:

$$
CV_{com, i} = \overline{CV_{sp, i}} \times \sqrt{\phi_i}
$$

with $CV_{com, i}$ being the Coefficient of Variation of the community in the
station $i$, $\overline{CV_{sp, i}}$ the average coefficient of variation of
population in the station $i$ pondered by the biomass of each population.
Synchrony of the station $i$, $\phi_i$, is the ratio between the variance of
total biomass over time ($\sigma^2_{x_T}$) and the sum of the variance of
population biomass over time ($\sigma_{x_k}$) [@loreau_species_2008]. $i$ being
the station $i$ and $k$ the species $k$.

$$
\overline{CV_{sp, i}} = \sum_k{\frac{B_k {CV}_i}{\sum_k{B_k}}}
$$

$$
\phi_i = \frac{\sigma^2_{x_T}}{(\sum_k{\sqrt{\sigma^2_{x_k}}})^2}
$$

## Horizontal & vertical diversity

### Horizontal diversity

####  Species richness

Species richness was computed as the total number of species present over time in a given
station. As for biomass, we controlled species richness for sampling effort by
dividing the total number of species by the total surface sampled in the given
station. Species richness was then expressed in number of species by square meter sampled.

### Vertical diversity

#### Trophic network inference 

```{r}
myload(metaweb_analysis, dir= mypath("data"))
myload(trophic_class, dir= mypath("data", "classes"))
meta <- metaweb_analysis
#metaweb_analysis$resource
#meta$metaweb[meta$resource, meta$resource]
```

Trophic interaction network was inferred from body size and ontogenic diet.
Body size is a reasonable approximation widely used to infer trophic
interactions [@gravel_inferring_2013; @brose_predator_2019;
@poisot_structure_2016]. The diet of stream fishes, as many organisms, shifts
over lifespan. For example, alvins feed on plankton while adults may feed on
algae or fishes. Accordingly,  each fish species was divided in nine body size
classes. Each body size class constituting a trophic species. A high congruence
has been found at trophic species scale between inferred interactions and
measured trophic interactions, but not at the species
scale [@jennings_weak_2001]. We then inferred trophic interactions between the trophic species (Figure
\@ref(fig:matmet) C).  We determined network structure in two steps: (1) build a
metaweb describing the trophic interactions between all trophic
species (Figure \@ref(fig:matmet) C), then (2) determine network of a given
community by subtracting the metaweb according to the trophic species present in
a given community (Figure \@ref(fig:matmet) D). We added to each network seven
resource nodes present in food diet database: detritus, biofilm, phytoplankton,
zooplankton, macrophages, phytobenthos and zoobenthos (grey nodes in Figure
\@ref(fig:matmet) C & D). The trophic network inference procedure is detailed in
supplementary informations.

#### Trophic network structure

For each trophic network, corresponding to a particular community at a given
time and location, we computed two of the most communly used network metrics to
characterize network structure, namely the connectance and average trophic
level. Connectance describes the number of interactions compared to the number
of possible links, computed as ($C = L / N^2$, L and N being resp. the number of
links and of trophic species plus resource nodes). The average trophic level was
computed as the mean trophic level of the nodes that the predator nodes consumes
to which is added one, obtained recursively by setting the trophic level of
basal nodes to 1, and was further weighted by the biomass of each trophic
species (excluding resource nodes for which we had no biomass information)
($\overline{T} = \sum_i^N{B_iT_i \times \sum_i^N{B_i}^{-1}}$, $T_i$ and $B_i$
being resp. the trophic level and the biomass of the node $i$). In resume, we
infered trophic networks at the scale of trophic species (i.e. nodes being body
size classes) to take in account ontogenic diet shifts and that fish-fish
trophic interaction depends on body size ratio between prey and predator. On the
other side, the community metrics were defined at the species level, (i.e.
species richness, average species CV and synchrony).



```{r}
# Basin
st_basin <- get_basin_station(sf_obj = FALSE)

# Select fishing operation 
myload(op_analysis, op_analysis_wo_holes, dir = mypath("data"))
myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
op_analysis_wo_holes_bbb <- filter(op_analysis_wo_holes, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)

```

```{r, fig.show = "hide"}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_press <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)

# Make PCA 
habitat_press %<>% na.omit()
mask <- names(habitat_press) %in% names(get_pca_var_name_replacement())

pca_rotated <- compute_rotated_pca(
  .data = habitat_press[, mask],
  naxis = 2
)
habitat_pressure <- 
  cbind(habitat_press[, c("station", "temperature_med", "alt")], pca_rotated$rotated$score) %>%
  as_tibble
ggplot(habitat_pressure, aes(x = RC2, y = temperature_med)) +
  geom_point()

ggplot(
  pivot_longer(habitat_pressure, cols = c("RC1", "RC2"),
    names_to = "variable", values_to = "value"
  )
  , aes(x = value)) +
geom_histogram() +
facet_grid(cols = vars(variable))

```

```{r}
prop_var_expl_pca <- pca_rotated$rotated$Vaccounted["Proportion Var", ] %>%
  map_dbl(., ~round(.x * 100))
tot_var_expl_pca <- sum(prop_var_expl_pca) 
```

```{r, message = FALSE, results = FALSE}
# Com
com_data <- compute_community_temporal_analysis(.op = op_analysis_bbb,
 type_network_metrics = "classes"
)
# Compute sem dataset
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]],
  hab_press = habitat_pressure,
  sync = com_data[["sync_std"]],
  nmds = NULL,
  basin = st_basin
  )

```


## Environment

Habitat description, obtained from fish sampling data, describing the ecosystem
size namely the stream width, depth and position (altitude and
slope). Physico-chemical variables were obtained from
naiades web portal [http://www.naiades.eaufrance.fr/](http://www.naiades.eaufrance.fr/).
We chose flow and temperature to describe streams as flow
impose swimming constraints which filters fish species that can establish
[@rolls_scaling_2018; @tonkin_flow_2018; @gutierrez-canovas_contrasting_2013].
Water temperature is linked to physiological constraints namely thermal
tolerance and oxygen concentration tolerance [REF] since the level of water
saturation in oxygen is inversely linked to water temperature. We took 
Biochemical Oxygen Demand (BOD) for a proxy of enrichment in the ecosystem [REF].
BOD is also inversely linked to oxygen concentration in water and so, BOD is
also linked to physiological stress of fishes. As physico-chemical variables
were not recorded at the same place than fish communities, they were
interpolated with spatial stream networks [@isaak_applications_2014;
@hoef_ssn:_2014]. The interpolation procedure is detailed in supplementary
methods. 

For each fish station, environmental variables were matched with the year of
fish sampling (except for water temperature for which the record began in 2006).
Then, the average temperature, flow, BOD, river width and depth were computed as
well as coefficient of variation ($CV = \sigma \mu^{-1}$). As habitat and
environmental variables are often collinear, a principal component analysis (PCA)
was performed on the scaled variables. We kept in the analysis the two first
principal components based on eigen values distribution (Fig. SXX).
The PCA explained `r tot_var_expl_pca`%
of the variance. An varimax axis rotation was performed to maximize the representation
of the variables by the principal components (Fig. \@ref(fig:pca-rotated)).
The two first principal components were used in the analysis, representing respectively
the (1) river size (river width & depth), (2) altitude, slope and decreasing
average temperature. Further informations about data transformation and
filtering are detailed in supplementary information.

## Statistical analysis 

#### Summarise SEM statistical framework 

Structural Equation Modeling are able to assess multivariate relationships,
directs and indirects between variables. It is one promising way to go beyond
bivariate relationships and to investigate complex relationships, direct and
indirect, between variables [@grace_structural_2008; @grace_causal_2014;
@lefcheck_piecewisesem_2016; @grace_integrative_2016]. SEM makes possible to set
causal relationships between variables. This step can be critical, as the
estimated parameters can be determined by both the choice of the variables and
the links between them. Therefore, the set of variables and links should be
supported by theory and literature. We built a metamodel which present the set
of variables and the links between them (Figure \@ref(fig:matmet) A,
\@ref(fig:sem-plot) A & B). Basically, we tested the links between environmental
conditions, horizontal & vertical diversity and both total biomass and its
temporal stability (Figure \@ref(fig:matmet) A). We considered that environment
can directly affect horizontal and vertical diversity, as well as total biomass
and its temporal stability. Horizontal diversity, measured as species richness
directly affects vertical diversity, total biomass and its temporal stability.
Food web structure was shown to be constrained by species richness. In turn,
vertical diversity affects total biomass and its temporal stability (Figure
\@ref(fig:matmet) A). The metamodel describes how variables are interrelated
(Figure \@ref(fig:matmet) A). We built separated structural equation model for
total biomass and its temporal variability (Figure \@ref(fig:sem-plot) A & B).

Structural equation models were based on Gaussian linear models, some variables
were logged to fulfill model assumptions (see residual plots and data
transformation in supplementary informations). To account for heterogeneity of
hydrographic basin, we set it as random effect on the intercept. Moreover, each
statistical model was checked for the presence of multicollinearity
(Supplementary information). The slopes reported in the main
text are standardized in order to compare their magnitude ($r_\delta = \beta
\frac{\sigma_x}{\sigma_y}$, $\beta$ being the unstandardized slope, $\sigma_x$
and $\sigma_y$ being respectively the standard deviation of the predictive
variable $x$ and of the response variable $y$). In the main text, only the
slopes which had $P$ value inferior to $0.05$ were reported (but see Table SXX).
The structural equation models used for total biomass and its temporal stability
contains respectively 4 and 6 response variables, 35 and 26 direct paths.
The indirect effects of variables on total biomass and its temporal stability
was computed by multiplying slopes along the path. As an example, if we consider
$A \to B \to C$, the indirect effect of A on C is equal to $r_{AB} \times r_{BC}$.
Only significant direct slopes were entered in the calculation of
indirect effects. Finally total effects were computed as the sum of direct and
indirect effects.

Environmental variables were interpolated with the `openStars` and `SSN`
packages. Linear models and SEMs were computed with respectively the `nlme` and
`piecewieseSEM` R packages. The code used for the analysis and the Rmarkdown
used to generate this document are accessible on github.

```{r get-data, cache = FALSE}
library(piecewiseSEM)
library(lme4)
library(nlme)

#ctrl <- lmeControl(opt='optim')
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
```

```{r}
# Compute SEMs
stab_sem_rich <- compute_stab_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem_rich <- compute_prod_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

def_env_x_pos <- c(from = 0, to = 3)
asp <- 1.6

library(DiagrammeR)
meta_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "meta_stab_sem"),
  format = "png",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  metamodel = TRUE
)
p_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "stab_sem"),
  format = "png",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2")
)

meta_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "meta_bm_sem"),
  format = "png",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  metamodel = TRUE
)
p_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "bm_sem"),
  format = "png",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2")
)
```


```{r get-sem-coeff}
coef_stab_sem <- coef(stab_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)

coef_bm_sem <- coef(bm_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)
```

# Results

```{r}
sem_caption <- paste0(
  "Metamodel of the Structural Equation Models for (A) biomass stability and
  (B) total biomass. ",
  "Results of the Structural Equation Models for (C) the
  determinants of biomass stability and (D) total biomass. Red and green
  represent respectively negative and positive path coefficients. The path
  coefficients are standardized coeffients. For convenience, only significant
  paths (i.e, *P < 0.05*) are shown."

)
```


```{r sem-plot, fig.height = 7, fig.cap = sem_caption}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple

plot_grid(
  meta_stab_sem_rich, meta_bm_sem_rich,
  p_stab_sem_rich, p_bm_sem_rich,
  labels = LETTERS[1:4], nrow = 2,
  rel_widths = c(1, 1)
)
```

```{r get-bm-sem-single-effect}
bm_sem_coef <- filter(coef_bm_sem, P.Value <= 0.05)

rich_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_rich_tot_std")
rich_on_tlvl <- get_clean_sem_coef(sem = bm_sem_coef, resp = "t_lvl", pred = "log_rich_tot_std")
tlvl_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "t_lvl")
RC1_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC1")
RC2_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC2")
```

```{r get-bm-tot-effect-env}
bm_all_params <- get_coefficient_piecewisesem(sem = bm_sem_rich, p_val_thl = NULL)

#Â effect of env on bm 
env_on_bm <- get_env_on_bm(fit = bm_all_params, p_val_thl = 0.05,
  type = "std")
# rich on bm 
rich_on_bm <- get_rich_on_bm(fit = bm_all_params,
  p_val_thl = 0.05, type = "std")

tmp_bm_indir_table <- map(list(env_on_bm, rich_on_bm),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```
```{r}
caption_indir_stab_sem <- paste0(
  "Indirect and total effect of variables on biomass stability from the
  structural equation model. Indirect effects are computed by multiplying the
  path coefficients from the variable predictor to the response variable, here
  biomass stability. Indirect effects are considered as one step from the target
  variable. For exemple, the indirect effect of species richness on
  biomass stability via its effect on CVsp is -0.61. To compute indirect
  effect, only the significant direct effects were taken into account. ",
  "Network structure being the indirect effect that went through both avg trophic
  level and connectance and Species richness_Network structure being the
  indirect effect that went through (i) species richness and from (ii) species
  richness to network structure."
)

caption_indir_bm_sem <- paste0(
  "Indirect and total effect of variables on total biomass from the
  structural equation model. See the table 1 for details about computation and
  meaning." 
)
```

```{r}
stab_all_params <- get_coefficient_piecewisesem(sem = stab_sem_rich, p_val_thl = NULL)
#Â effect of env on stab
env_on_stab <- get_env_on_stab(fit = stab_all_params, p_val_thl = 0.05,
  type = "std")
rich_on_stab <- get_rich_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
com_on_stab <- get_com_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")

tmp_stab_indir_table <- map(list(env_on_stab, rich_on_stab, com_on_stab),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```



```{r indir-bm}
kable(format_table(tmp_bm_indir_table),
  format = "latex",
  booktabs = T,
  label = paste0("indir-bm"),
  caption = caption_indir_bm_sem
  ) %>%
kable_styling(latex_options =c("striped", "scale_down"))
```

```{r get-sem-single-effect}
stab_sem_coef <- filter(coef_stab_sem, P.Value < 0.05)

sync_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_sync")
cv_sp_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_cv_sp")
RC1_on_sync <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_sync", pred = "log_RC1")
tlvl_on_cv_sp <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_cv_sp", pred = "t_lvl")
```

```{r get-sem-tot-effect-env}
# effect of env on sync and cv_sp
env_on_sync <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
env_on_cv_sp <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
# env on stab via network 
env_on_t_lvl <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "t_lvl", type = "std")
env_on_ct <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "ct", type = "std")
env_on_richness <- get_env_on_rich(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
```

```{r indir-stab}
kable(format_table(tmp_stab_indir_table),
  format = "latex",
  booktabs = T,
  label = paste0("indir-stab"),
  caption = caption_indir_stab_sem 
  ) %>%
kable_styling(latex_options =c("striped", "scale_down"))
```

Overall, the structural equation models explained a large part of the variation
of connectance, synchrony, $\overline{CV_{sp}}$ and total biomass (resp. $R^2 =
.45$, $.47$, $.49$ and $.38$) but not of average trophic level ($R^2 =
.18$, Figure \@ref(fig:sem-plot) C and D).

## Horizontal diversity increased total biomass but decreased its temporal stability 

```{r get-sem-tot-effect-rich}
rich_on_sync <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
rich_on_cv_sp <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
```

Species richness had a significant positive direct effect on total biomass
$r_\delta = `r rich_on_bm$direct`$ (Figure \@ref(fig:sem-plot) D, Table
\@ref(tab:indir-bm)). However, species richness had a negative total effect
on biomass stability ($r_\delta = `r rich_on_stab$total`$, Table
\@ref(tab:indir-stab)). On the one hand, species richness had a direct negative effect on synchrony
($r_\delta = `r rich_on_sync$direct`$), thereby increasing stability ($r_\delta
= `r rich_on_stab$via_sync`$). On the other hand, species richness had a
positive direct effect on $\overline{CV_{sp}}$ ($r_\delta = `r rich_on_cv_sp$direct`$),
thereby decreasing biomass stability ($r_\delta = `r rich_on_stab$via_cv_sp`$, Table
\@ref(tab:indir-stab)). Finally, it was surprising that the negative
effect of $\overline{CV_{sp}}$ on temporal stability was twice higher than the
negative effect of synchrony (resp. $r_\delta = `r cv_sp_on_stab`$ and $r_\delta
= `r sync_on_stab`$, Figure \@ref(fig:sem-plot) C).

## Vertical diversity increased total biomass and its temporal stability

Average trophic level had a direct positive effect on total biomass ($r_\delta
= `r tlvl_on_bm`$) but connectance had no direct nor indirect significant effect (Figure
\@ref(fig:sem-plot) D) on total biomass. However, the average trophic level had
a direct negative effect on $\overline{CV_{sp}}$ ($r_\delta = `r tlvl_on_cv_sp`$,
Figure \@ref(fig:sem-plot) C) and thereby had a total positive
effect on temporal stability ($r_\delta = `r com_on_stab$via_cv_sp["t_lvl"]`$,
Table \@ref(tab:indir-stab)). The average trophic level had no significant
effect on synchrony and connectance had no significant direct, nor indirect
effect on temporal stability (Figure \@ref(fig:sem-plot) C, Table SXX).

## Horizontal and vertical diversity had opposite and independant effect on total biomass and its temporal stability 

We described above that species richess had respectively a positive and a negative 
on total biomass and its temporal stability whereas average trophic level had a
positive effect on both (Table \@ref(tab:indir-bm) and \@ref(tab:indir-stab)).
The total effect of average trophic level on total biomass was of the same
magnitude than the one of species richness (resp. $`r tlvl_on_bm`$ and
$`r rich_on_bm$total`$, Table
\@ref(tab:indir-bm)). It was also true for temporal stability (resp.
$`r com_on_stab$total["t_lvl"]`$ and
$`r rich_on_stab$total`$, Table \@ref(tab:indir-stab)). Average trophic level was
dependent of species richness because species richness had a significant
negative effect on average trophic level ($r_\delta = `r rich_on_tlvl`$). 
Species richness had also a strong negative effect on connectance ($r_\delta =
`r rich_on_stab$total`$, Figure \@ref(fig:sem-plot) C and D).  But, in turn,
connectance had no significant effect on either total biomass nor
its temporal stability.

## Environment had an high effect on total biomass and its temporal stability 

The environmental variables had no significant direct effects on total biomass
(Table SXX), but indirect (Table \@ref(tab:indir-bm)). Average temperature and
altitude respectively increased and decreased total biomass ($r_\delta =
`r env_on_bm$direct["log_RC2"]`$, Table \@ref(tab:indir-bm)), mainly through
species richness ($r_\delta = `r env_on_bm$via_richness["log_RC2"]`$, Table
\@ref(tab:indir-bm)).  Average stream size had a positive effect on total
biomass ($r_\delta = `r env_on_bm$total["log_RC1"]`$, Table \@ref(tab:indir-bm)),
equally through species richness and average trophic level 
($r_\delta = `r env_on_bm$via_richness["log_RC1"]`$ and
$`r env_on_bm$via_com["log_RC1"]`$ resp., Table \@ref(tab:indir-bm)). Average
temperature and altitude effects on total biomass were of the same magnitude
than the effects on species richness and average trophic level.

Average temperature and altitude had a negative and a positive effect on
temporal stability ($r_\delta = `r env_on_stab$total["log_RC2"]`$, Table \@ref(tab:indir-stab)) mainly
through a direct positive effect on $\overline{CV_{sp}}$
($r_\delta = `r env_on_cv_sp$direct["log_RC2"]`$, Table \@ref(tab:indir-stab)).
Interestingly, average temperature (and opposite of altitude) had also a negative
effect on temporal stability through species richness but a positive one through
average trophic level 
(resp. $r_\delta = `r env_on_stab$via_richness["log_RC2"]`$ and
$r_\delta = `r env_on_stab$via_com["log_RC2"]`$, Table \@ref(tab:indir-stab)).
This was also true for average river size but effects were weak. Finally, the
effect of average temperature on temporal stability was of higher magnitude than
the effects of species richness and average trophic level (Table
\@ref(tab:indir-stab)).
  
# Discussion

---
# Chapeau
---

#### Hat

Our aim was to clarify respective importance and nature of direct and indirect
effects of environmental drivers, horizontal and vertical diversity, captured by
species richness and trophic network structure (connectance and average trophic
level), on total biomass and its temporal stability in aquatic foodwebs. To do
this we quantified interactive effects of habitat properties, species richness,
and trophic structure, on the biomass and stability of fish communities, from
the ONEMA fish dataset, containing over X million individual fish samples,
across 99 locations France spanning the period 1995 to 2018. We infered trophic
interactions networks based on body size-dependency in food diet from the
literature and prey/predator body size ratio for piscivory. We used SEM to
disantangle direct and indirect effects of environmental drivers, horizontal and
vertical diversity on both total biomass and biomass stability. We found that
species richness and average trophic level had a positive effect on total
biomass. In contrast, species richness had a negative effect on temporal
stability whereas average trophic level covaried positively.  Futhermore, we
found that the effect of species richness and average trophic level on total
biomass and its temporal stability were not independant as species richness had
a positive effect on average trophic level.  Finally, we found that the
magnitude of the effects of average temperature and altitude was equal or
superior to the effects of species richness and average trophic level. Overall,
our study is unique by its level of integration, from environmental effects to
total biomass and stability, going through horizontal and vertical diversity,
and the fist direct assessment of a possible interaction between effects of
horizontal and vertical diversity.

## Horizontal diversity increased total biomass but decreased its temporal stability 

We found that species richness increased total biomass as found in salt marshes,
grasslands and
forests [@hector_plant_1999; @tilman_biodiversity_2014; @wu_relationship_2015;
@li_relationship_2018]. The positive effect of species richness on total biomass
might be due to resource use complementarity, which is held by niche
differentiation and interspecific facilitation [@loreau_biodiversity_1998;
@loreau_partitioning_2001; @cardinale_species_2002] or might be due to positive
select effect which takes place through the dominance of the
most productive species [@tilman_plant_1997; @loreau_partitioning_2001].
Previous research seems to indicate that resource complementarity might be the
main driver in fish communities [@carey_determining_2011]. 

Surprisingly found a negative relationship between temporal stability and
species richness. Overall, it contrasts with experimental studies in
grasslands [@tilman_biodiversity_2006]; mesocosms [@pennekamp_biodiversity_2018]
and even in natural communities [@olivier_independent_nodate] where positive
relationships are typically found between temporal stability and species
richness. In streams as well, @franssen_annual_2011 found that species richness
increased temporal stability. However other studies found a opposite relationship
in natural grassland [@yang_effects_2011] or a marginal one
[@declerck_species_2006] in natural forests. Further investigations are needed
to identify the mechanisms behind those contrasting patterns.

Species richness decreased synchrony and increased $\overline{CV_{sp}}$. Species
richness can reduce synchrony through decrease of population size, thus raising
the role of demographic stochasticity [@loreau_species_2008] but also in the
case where species have different responses to environmental variation
[@loreau_species_2008]. While the effect of species richness on synchrony is
well understood, its effect on $\overline{CV_{sp}}$ is more complex [see
@thibaut_understanding_2013]. However a negative effect of species richness of
both population ($\overline{CV_{sp}}$) and community stability can arise the
biomass distribution across population is strongly uneven and that the biomass
variance of population increases much faster than its mean
[@thibaut_understanding_2013].

In turn, we found that synchrony and $\overline{CV_{sp}}$ both decreased biomass
stability, as predicted by the formulation of stability based on the CV
[@thibaut_understanding_2013]. However, it was unexpected that the average
population $\overline{CV_{sp}}$ had a stronger negative effect on biomass
stability than synchrony [@bluthgen_land_2016; @olivier_independent_nodate]. We
can advance two hypothesis that can raise this effect. First, the opportunity
for diet differentiation can be low in streams compare to other organisms.
Secondly, in trophic communities, species directly affect each other through
feeding interactions, and so could raise synchrony between species
[@raimondo_interspecific_2004] more than in systems where interactions happen
more in the form of competitive exploitation.

- But @thebault_relationship_2006 with the same mecanisms on vertical and
  horizontal diversity

## Vertical diversity increased total biomass and its temporal stability

The average trophic level was positively linked to total biomass. This result is
straightforward. As feeding interactions were partly determined by body size and
that body mass increase with body size, it is expected that the more the average
biomass is located at higher trophic level, the more the total biomass
increase. A mechanism, suggested by experimental and theoretical work, can
be that a higher trophic level is the result of a stronger top-down effect,
meaning higher predation rates and biomass fluxes to higher trophic levels
[@thebault_relationship_2006; @kratina_warming_2012], hence leading to an
increase in total biomass with vertical diversity. Furthermore,
@wang_biodiversity_2016 have shown that total nutrient uptake might increases
with the length of trophic chain and so results in higher total biomass. 
In contrast, connectance had no effect on total biomass. One might have expected
that an increase in connectance should translate in higher resource transfer
efficiency between prey and predators and so results in higher total biomass in
the fish compartment. A reason for such an absence of an effect might be the
little resolution that we have about interactions in non fish compartment (Fig.
\@ref(fig:methods) C, D). A consequence can be that our connectance measurement
contains few too informations.

Average trophic level had a positive effect on biomass stability by its negative
effect on CVsp (i.e. positive effect on average species stability). It means
that species at higher trophic level are more stable than the species at lower
trophic levels. @shanafelt_david_w._stability_nodate and @barbier_pyramids_2019
found the same pattern with pure trophic chain models. They have shown that
strong top-down control can generate this pattern but it is not
clear if this theoretical prediction holds when considering omnivorous species
(i.e not a pure food chain) [@wang_biodiversity_2016] and if other mechanisms
can generate the same pattern [@thibaut_understanding_2013].
Another explanation is that the fishes at higher trophic levels are not more
stable themselves, but rather allow for stronger top-down control and resource
complementarity and thus reduce biomass fluctuations [@rooney_structural_2006;
@neutel_reconciling_2007]. However, the ontogenic nature of the trophic
networks complicate the interpretation from the network to population
perspective. Over its life span, a given fish will change of diet and thus move
upward in the trophic chain. The dynamic of a given species composed
of several trophic species can thus be a mix of the dynamics of several trophic
levels, plus the oscillatory dynamics of the cohorts [@townsend_population_1989;
@medvinsky_modelling_2015]. Then, there is a clear need for a better
understanding of how the dynamics of pure food chain models would be affected by
inclusion of omnivory and ontogeny.

We found that connectance had no effect on temporal stability. This result
contradicts precedent theoretical studies on the relationship between stability
and network structure [@angelis_stability_1975; @may_will_1972;
@thebault_stability_2010], although they considered different stability concepts
and metrics [@arnoldi_resilience_2016]. Once again, it is possible that
that connectance from our networks contains too few information. Furthermore, a
crucial missing ingredient to go further is the interaction strength. Indeed,
@may_will_1972 has demonstrated theoretically the fundamental interplay between
connectance, species richness and average interaction strength
[@angelis_stability_1975; @dunne_network_2006].An alternative explanation can be
that connectance increases inhomogeneously in the food web, for instance a
higher connectance in lower trophic levels will not have the stabilising effects
conferred by higher predation and omnivory in higher trophic levels. Further
investigations on this effect is needed. 


## Horizontal and vertical diversity had common, opposite and dependent effects on total biomass and its temporal stability 

We found that species richness had a positive and a negative effect on
respectively total biomass and its temporal stability whereas average trophic
level had a positive effect on both. It confirms that more investigation is
needed to understand the mechanisms leading to common and opposite effects of
horizontal and vertical diversity. We found that connectance covaries
negatively with species richness [@winemiller_must_1989; @dunne_network_2006;
@thebault_stability_2010], connectance had itself no effects on both total
biomass and its temporal stability. On the other side, we found species richness
was negatively related to average trophic level and average trophic level
covariated positively with total biomass and its temporal stability. Hence,
horizontal diversity had a direct positive and negative effect respectively on
total biomass and its stability but a negative and positive effect through
vertical diversity.  Theoretical work have shown that species richness can be
linked to allocation of biomass toward higher trophic level
[@thebault_relationship_2006; @schneider_animal_2016; @wang_biodiversity_2016].
It indicates the importance to consider both horizontal, vertical diversity and
their dependence. Moreover, it calls for further investigations on how species
diversity variation translates in network structure.


@thibaut_understanding_2013 have theoretically shown that a highly positive
relationship between species variance and mean together with a positive
relationship between mean species abundance (i.e. dominance) and species
richness should drive to a negative temporal stability-species richness
relationship. @thebault_relationship_2006 have also shown in a bi-trophic
foodweb that a negative temporal stability-species richness appears in case of a
plant species is highly dominant through low consumption by consumers but in the
same time highly variable because of low competitive ability. Then, common
mechanisms might be at play for both horizontal and vertical diversity while
having same or opposite effects on total biomass and its temporal stability.
Overall our results confirm that more investigation is needed to understand the
mechanisms leading to common and opposite effects of horizontal and vertical
diversity.

## Environment had an high effect on total biomass and its temporal stability 

We find that environmental drivers overall affect total biomass indirectly,
through changes in vertical and horizontal diversity. This contrasts with
research in plant communities that showed that total biomass was primarily
driven by environmental factors [@grace_integrative_2016], and in particular by
warming, which has contrasted effects on biomass in aquatic communities
[@yvondurocher_warming_2011; @dossena_warming_2012]. Average temperature,
inverse altitude, and average stream size had indirect positive effects on total
biomass, through a positive direct effect on species richness. These effects are
well known in freshwater communities and are explained by a gain in species
along thermal gradients, from smaller and colder streams, which support small
food webs dominated by salmonids [@ogorman_chapter_2012; @emmrich_geographical_2014],
to wider and warmer sections of river networks, which contain larger food webs
dominated by mesotrophic preators such as percids [@allan_stream_2007;
@emmrich_geographical_2014]. Further in line with this pattern, we find that average stream
size had a positive effect on total biomass through
a positive effect on average trophic level, consistent with the fact that food
webs in wider streams, with a greater amount of running waters, are also larger,
and hence support more species and biomass [@allan_stream_2007]. Greater ecosystem
size might be linked to a greater diversity of resources through habitat
heterogeneity, on so higher species richness and total biomass by surface unit,
through resource complementarity. Greater diversity of resources might also
allow to maintain higher biomass in high trophic level [@post_ecosystem_2000;
@doi_resource_2009]. Overall, our results indicate that environmental effects on
total biomass operate primarily through changes in community structure.
Furthermore, the positive effect of temperature on total biomass was of the
magnitude of effects of horizontal and vertical diversity, and thereby of
changes in community structure. This adds to the mounting body of work reporting
important effects of temperature on the structure and biomass of aquatic system
[e.g. @dossena_warming_2012; @edeline_ecological_2013;
@emmrich_geographical_2014; @hattab_forecasting_2016].

Interestingly, stream flow and size, inverse altitude, and temperature had
indirect effects on stability through two conflicting pathways, either
stabilising, involving vertical diversity, or destabilising, involving
horizontal diversity. The first pathway consists in a positive effect of
temperature and stream properties on average trophic level, in line with the idea
that wider streams and warmer conditions are favourable to mesotrophic predators
[@allan_stream_2007; @emmrich_geographical_2014], which in turn stabilises
biomass fluctuations, possibly due to increased top-down regulation (as
discussed above). The second pathway consists in a positive effect of
temperature and stream properties (width, flow, inverse altitude) on species
richness, which itself has a destabilising effect (see discussion on horizontal
diversity). This result is interesting in that though both pathways had not been
evidenced to be at jointly play, as far as we know. Furthermore, it is unclear
as to which pathway is dominating, and under which circumstance, opening an
interesting avenue for further investigations. Overall our study highlights
that environmental factors should not be ignored in natural communities studies
and that its effects can be mainly indirect and in this case, path analysis
should more relevant than bivariate relationships
[@grace_causal_2014; @grace_integrative_2016].

# Conclusion and perspectives 

We aimed to assess the effect of horizontal & vertical diversity on empirical
trophic communities. While theoretical ecology has focused on the effects of
network structure on stability, empirical ecology has focused on species richness
and ignored network structure. Furthermore, both fields have largely used
different stability metrics. We showed that horizontal and vertical diversity
can have independent and sometimes opposite effects on total biomass and its
temporal stability. It opens a promising way for the understanding on how
species interactions, of different types, can affect both synchrony and CVsp in
different ecosystems. The reconstruction of ecological networks based on trait
can be a first approach to document such relationships, however it will not
compensate for close evaluation of measured interaction strength. We also
believe that SEM methods are particularly helpful to assess complex relationship
between environment, community structure and ecosystem properties in empirical
data which necessitate to move from simple bivariate relationships
[@grace_integrative_2016]. We believe that the integration of network structure
and species interaction will improve our understanding of the mechanisms driving
ecosystem properties.


```{r}
save.image(file = mypath("manuscript", "bef_stability", "result", "workspace.rda"))
```

# References
