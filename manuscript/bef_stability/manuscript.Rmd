---
title: Complex mecanisms linking biomass stability and total biomass with species richness and network structure in stream ecosystems 
author: Alain Danet, Maud Mouchet, Elisa Thebault and Colin Fontaine
date: \today 
output:
  bookdown::pdf_document2:
    fig_caption: true 
    keep_tex: true
fontsize: 12pt
header-includes:
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
geometry: margin=2cm
bibliography: references.bib
---

```{r, echo = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "total_sem_effect.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```


# Abstract

# Introduction 

#### Biodiversity and ecosystem functioning

Biodiversity is essential to determine and maintain ecosytem properties.
Current biodiversity losses question the ability of how ecosystems will be
affected in turn.

The relationship between biodiversity and ecosystem functioning has been a
central research topic in ecology [@may_will_1972; @hector_plant_1999;
@loreau_biodiversity_2001; @hooper_effects_2005; @duffy_why_2009;
@isbell_forest_quantifying_2018]. 

Studies in
Bioversity-Ecosystem
Functioning (BEF) usually quantify species diversity as species richness (i.e
number of species) while ecosystem functioning is quantified as total biomass,
productivity (biomass produced by unit of time) or stability which is quantified
in more diverse ways such as the variability of species abundance, the
resilience to perturbation, or resistance to perturbation
[@donohue_navigating_2016].

#### Shape of BEF: total biomass

Species richness has been reported to increase productivity
[@tilman_productivity_1996; @grace_integrative_2016] through complementarity
between species in resource exploitation and selection effects
[@loreau_partitioning_2001; @cardinale_species_2002; @fargione_selection_2007].
Empirical assessment of the effect of species richness on total biomass showed
negative [@grace_integrative_2016] and positive relationships
[@hector_plant_1999; @tilman_biodiversity_2014]. @grace_integrative_2016 showed
that the results depend on the refinement of the mecanisms involved in the
analysis.

#### Shape of BEF: stability 

The relationship between species richness and stability is even more complex
partly because of the inherent multidimensionality of stability
[@donohue_dimensionality_2013; @donohue_navigating_2016] and because of the
different metrics of stability privileged in theoretical (stability of local
equilibrium, robustness to primary extinction) and empirical work (variability
of abundance or biomass through time). Empirical studies showed consistently
that species richness decreased community variability in grasslands
[@tilman_biodiversity_2006], mesocosms [@pennekamp_biodiversity_2018] and
vertebrates [@olivier_independent_nodate; @franssen_annual_2011]. Two mecanisms
are involved into community variability, (1) species variability and (2) the
species synchrony [@loreau_species_2008; @thibaut_understanding_2013].  Positive
[@tilman_biodiversity_2006], neutral [@jiang_different_2009;
@olivier_independent_nodate] and negative [@franssen_annual_2011;
@olivier_independent_nodate] relationships between species variability and
species richness have been found. On the other side, studies consistently found
that species richness decreased synchrony between species [@loreau_species_2008;
@thibaut_understanding_2013; @bluthgen_land_2016; @olivier_independent_nodate].
Beyond species richness, species interactions, which modifies species abondance
and biomass and make species dynamics interdependant, have been largely ignored
in empirical assessment.


#### BEF: Theoretical ecology

Conversely, theoretical ecology display an extensive literature about the
effects of network structure on stability [@may_will_1972;
@angelis_stability_1975; @stouffer_compartmentalization_2011;
@thebault_stability_2010; @barbier_pyramids_2019;
@shanafelt_david_w._stability_nodate].  Theoretical ecology generally uses
stability definitions related to community equilibrium and its stability to
small perturbations.  Connectance (i.e. proportion of realized links in a
network) can decrease [@angelis_stability_1975; @thebault_stability_2010] or
increase resilience of trophic network depending on the functioning of networks
[@angelis_stability_1975].  The number of trophic levels, the vertical position
in the trophic network as well as the strength of their biomass regulation (i.e.
top-down and bottom-up) can determine biomass and stability at equilibrium
[@hurd_stability_1971; @shanafelt_david_w._stability_nodate;
@zhao_horizontal_2019; @barbier_pyramids_2019].

A large inconsistency remains between theoretical and empirical assessments of
the relationship between community structure and ecosystem properties.
Theoretical studies have ignored temporal variability and then the relative
contribution of synchrony and species variability on community variability while
empirical studies about temporal variability and total biomass in natural
communities have ignored the contribution of network structure.

Our goal was to assess the mecanisms determining temporal variability and total
biomass in natural communities while integrating both species richness and
network structure. We combined together the effect of vertical and horizontal
diversity and thus aimed to bridge the current gap between theoretical and
empirical studies. We used an standardized monitoring of fish communities in
french streams. More than three hundreds sites were followed more than 10 years
on the 1995-2018 period. We inferred four thousands potential interaction
networks corresponding to each sampling event, based on trait matching.

We investigated the effects of the community structure on total biomass and
community variability, which in turn determine community variability. We have
also included the effect of environmental drivers [@grace_integrative_2016]
which can directly affect community variability or indirectly via community
structure.

- Q1: diversity-stability, diversity-biomass in aquatic systems
- Q2: Effect of horizontal and vertical diversity on total biomass and stablity
- Q3:  


# Methods

```{r}
matmet_cap <- paste0(
  "(A) Conceptual model of the hypothesized relationships between environment,
  species richness, network metrics and total biomass / biomass stability. ",
  "Solid and dashed arrows represent respectively direct and indirect effects.
  ",
  "The blue, green and blue/green dashed arrows being respectively indirect
  effects going through species richness, network metrics and through both
  species richness and network metrics.",
  "(B) Observation sites (black dots) were located across France and monitored
  on the period 1995-2018. ", "Grey shades highlighted elevalation variation. ",
  "Inner borders draw the limits of the hydrographic basins. ",
  "(C) The metaweb. Each trophic species (N = 412) is represented by a node and
  each color represent a species (S = ). Resource nodes (7) were drawn in grey. ",
  "(D) Subset over network variation through time."
)
```

```{r matmet, fig.cap = matmet_cap}
myload(p_st,temporal_network, dir = mypath("manuscript/bef_stability/figs"))

# Network inference
net_method_path <- mypath("manuscript/bef_stability/figs",
  "hypothesis.pdf")
metaweb_path <- mypath("manuscript/bef_stability/figs",
  "metaweb.png")
library(magick)

p_net_method <- cowplot::ggdraw() +
  cowplot::draw_image(magick::image_read_pdf(net_method_path))
p_metaweb <- cowplot::ggdraw() +
  cowplot::draw_image(magick::image_read(metaweb_path))

top <- plot_grid(p_net_method, p_st, ncol = 2, rel_widths = c(1, 1), labels =
  "AUTO")
bottom <- plot_grid(p_metaweb, temporal_network, ncol = 2,
  rel_widths = c(1, 1), labels = c("C", "D"))

p_method <- plot_grid(top, bottom, nrow = 2, rel_heights = c(1, 1),
  labels = c("", "C"))
save_plot(
  filename = mypath("manuscript/bef_stability/figs",
    "method_fig.pdf"),
  p_method, nrow = 2, ncol =2,
  base_width = 7/2.54,
  base_asp = 0.3
)
p_method
```


## Community variability 

#### Protocol

Fish communities were monitored across streams of France on the period
1995-2018 by a French governmental agency (OFB, previously AFB and ONEMA). We
kept only standardized protocols: complete and partial methods for respectively
little and big streams (detailed in Supplementary methods). In the complete
protocol, the sampling takes place over the whole width of the river and is done
by foot whereas in the partial protocol, the sampling is done over the bank only
and by boat. The sampling took place either in late spring and/or Autumn.
Heterogeneity in the sampling time may introduce variability that is not related
to ecological processes such as the presence of juveniles. In order to reduce
heterogeneity in sampling time, we select only one sampling per year if there
was two in a given year. Most of the fish sampling occurred in September
(Median: mid-August) and within station the median standard deviation of the
sampling month was inferior to one (0.7). Additionally, we removed sampling
events, in a given station, which the length of the stream sampled was outside
the median length sampled more or less 30%. The number of sampling events is
critical in order to estimate a meaningful variability of the community. We kept
only station that have been followed ten years or more (i.e 10 sampling events
or more), which sums to 403 stations.

The sampling itself was performed by electric fishing. All the stunned fish
species were identified and the individuals counted.

##### Biomass  

To characterize communities variability, abundance or biomass are generally
used. When the body size and therefore body mass vary by several orders of
magnitude, one downside of abundance is that we mix individual that have
potentially really different meaning in terms of ecosystem properties such as
biomass. We therefore estimated the body mass of fish individuals according to
their body size. During sampling, the fishes were classified in batch according
to species and size class. Depending on the batches, the body size of all
individuals were measured or only a subsample. Only the body size big fishes was
measured individually. The body size of individual fishes in subsampled batches
was inferred under normality distribution assumption (detailed in Supplementary
material). The body mass of individual fishes were then estimated with an
allometric law ($B_i = 0.01 \times l_i^3.03$, $B$ being the body mass in grams,
$l$ the body size in millimeters and $i$ the individual).

The species and community biomass were then computed for each sampling event.
As sampling effort varied across protocol type and sampling event, biomass
was reported to the surface sampled (in $m^{2}$). Community and species biomass
were then expressed in $gm^{-2}$.

Total biomass was characterized as the median total biomass over time. Community
stability was defined as the inverse of biomass variability. Variability was
computed as Coefficient of Variation (CV) of the biomass ($CV_i = \sigma_i \mu_i^{-1}$,
with $\sigma_i$ and $\mu_i$ being respectively the standard deviation and the
average of the biomass of the station $i$). Then, biomass stability was equal to
$CV^{-1} = \mu \sigma^{-1}$.

The CV of community biomass can represent very different dynamics such as
decreasing, stable or increasing. However, the concept of community variability
refered to variability around an equilibrium, which is rarely observed or
difficult to characterize in natural communities. 
We However used SAX (Symbolic Aggregate Approximation) method to caracterize
rougly biomass dynamics over time (details in Supplementary information). We
finally kept only the stations which the biomass had no trends, remaining 99
stations.
 
To characterize the mecanisms driving biomass stability, we decomposed
the community CV in synchrony and weighted average species CV
components according to @thibaut_understanding_2013:

$$
CV_{com} = \overline{CV_{sp}} \times \sqrt{\phi}
$$

with $CV_{com}$ being the Coefficient of Variation of the community,
$\overline{CV_{sp}}$ the average coefficient of variation of population
pondered by biomass. $\phi$ is the synchrony, which is the ratio the total
community variance ($\sigma^2_{x_T}$) and the sum of population variance
($\sigma_{x_i}$) [@loreau_species_2008]:

$$
\phi = \frac{\sigma^2_{x_T}}{\sum_i{\sigma_{x_i}}}
$$

Species richness was computed as the total species richness over time in a given
station. To normalize by sampling effort, we reported species richness to
the sum of surface sampled over the time period, it was expressed in number of
species by square meter.


## Network building

```{r}
myload(metaweb_analysis, dir= mypath("data"))
meta <- metaweb_analysis
#metaweb_analysis$resource
#meta$metaweb[meta$resource, meta$resource]
```

To obtain the network structure of the communities, we needed to infer
ecological interactions between the components of the communities and thus build
the ecological network. As the interactions were not measured, we used trait
matching method to infer the presence or absence of an interaction. This method is
widely used to infer trophic interactions
[@brose_predator_2019; @poisot_structure_2016; @schneider_body_2012]. Indeed;
the existence of an trophic interaction between two species have been reported
to be largely dependant on their body size ratio
[cascade model; @cohen_stochastic_1985; @warren_invertebrate_1987; @brose_predator_2019].

Additionally to body size, we used food diet data to infer trophic
interactions. The diet of stream fishes, as many organisms, shifts over lifespan.
For example, alvins feeds on plankton while adults may feed on algae or fishes.
As we got body size of each fish individuals (cf Biomass inference methods and
supplementary material), we are able to define trophic interactions beyond
species level. We thus divided each fish species into nine body size classes,
each class having the same body size range (percentile method). Each body size
class constituting a trophic species. We then infered trophic interactions
between the trophic species. At this stage, it is important to make clear that
we infered potential trophic interactions and not actual measured interactions.
We determined network structure in two steps: (1) build a metaweb decribing the
trophic interactions between all the possible trophic species, then (2)
determine network of a given community by subtracting the metaweb according to
the trophic species present in a given community. 
 
### Metaweb

#### Ontogenic diet

Diet information were obtained from database and literature [REF edeline?]. The
diet information contained from two to three life stages by species, the life
stages being defined by the body size of the fishes. Over the 57 fish species,
only seven had a piscivorous life stage and only three had as strict piscivorous
life stage. Fish species were largely omnivorous.

#### Define trophic interactions  

The metaweb described the potential trophic interactions between the $`r 57*9`$
($57\times9$) trophic species. We had seven resource nodes which were present
in the diet of the trophic species namely detritus, biofilm, phytoplankton,
zooplankton, macrophages, phytobenthos and zoobenthos.

A trophic species belonged to a life stage if the median of its body size range
fell in the range of the life stage. In turn, this trophic species has feeding
interactions with the resource nodes of its life stage. Interactions between
resource nodes were determined by literature. For example, phytobenthos fed on
detritus, while zooplankton fed on zooplankton and phytoplankton. Fish-fish
trophic interactions between a predator and a prey were determined by body size
ratio as in many studies
[@brose_predator_2019; @poisot_structure_2016; @schneider_body_2012].
For a given trophic species, we first determined if its size class end up in a
life stage containing piscivorous diet, i.e. if there was an overlap between
them. We were more liberal for piscivory determination to not miss potential
fish-fish trophic interactions which were the main interactions in our
community. If the trophic species was piscivorous, we determined its prey size range
from 3% to 45% of the median of its size range. A trophic interaction was set
for each trophic species whose median of its size class fell into the prey range
of the predator trophic species. To sum up, the metaweb was obtained with
allometric feeding interactions (1) between trophic species, (2) between trophic
species and resource nodes and (3) between resource nodes.

#### Obtain network of a community 

The trophic network of a community (i.e. one network for each fish community
sampling) was obtained by determining the trophic species of each fish
individual in the community and interactions were set according to the metaweb.
All the resource nodes were assumed to be present in each local network.
Finally, the structure of the local networks varied according the presence of
the trophic species. The inferred interactions represent potential interactions
(i.e. not measured interactions) and are binary (i.e. presence or absence of
feeding interactions).

#### Network structure

In each network, we computed two network metrics that have been commonly used to
characterize network structure. Connectance which describes the number of
interactions compared to the number of possible links,
 computed as ($C = L / N^2$, L and N being resp. the number of
links and of nodes). We then computed the average trophic level, the
average trophic level was weighted by the biomass of each trophic species
(excluding resource nodes for which we had no biomass) ($\overline{T} =
\sum_i^N{B_iT_i \times \sum_i^N{B_i}^{-1}}$, $T_i$ and $B_i$ being resp. the
trophic level and the biomass of the node $i$).

To sum up, we infered binary trophic networks at the scale of trophic species
(i.e. body size classes by species) to take in account ontogenic diet shifts and
that fish-fish trophic interaction depends on body size ratio. On the other
side, the community metrics were defined at the species level, (i.e. species
richness, average species CV and synchrony).


```{r}
myload(nmds, habitat_pressure, dir = mypath("report"))
st_basin <- get_basin_station(sf_obj = FALSE)
myload(op_analysis, op_analysis_wo_holes, dir = mypath("data"))
myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
op_analysis_wo_holes_bbb <- filter(op_analysis_wo_holes, station %in%
  biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)

# Compute stability, network metrics, etc with ;he new datasets
##myload(network_metrics, dir = mypath("data", "classes"))
#network_metrics %>%
  #left_join(op_analysis, by = "opcod") %>%
  #select(opcod, station, composition) %>%
  #unnest(composition) %>%
  #group_by(station, troph_group) %>%
  #summarise(richness_tot = length(unique(species)))
com_data <- compute_community_temporal_analysis(.op = op_analysis_bbb,
 type_network_metrics = "classes" 
)
# Compute sem dataset 
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]],
  hab_press = habitat_pressure,
  sync = com_data[["sync_std"]],
  nmds = NULL,
  basin = st_basin
  )

```

```{r, eval = FALSE}
stab_div_troph <- com_data$tps_bm_troph %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group),
    log_rich = log10(richness_med),
    log_rich_std = log10(rich_std_med),
    log_rich_tot = log10(richness_tot),
    log_rich_tot_std = log10(rich_tot_std),
    log_bm = log10(biomass_med),
    log_bm_std = log10(bm_std_med),
    log_stab = log10(biomass_stab),
    log_stab_std = log10(bm_std_stab)
    ) %>%
  dplyr::select(station, troph_group, biomass_stab, richness_med, richness_tot, log_rich, log_rich_std, log_rich_tot, log_rich_tot_std, log_stab, log_stab_std, log_bm, log_bm_std, biomass_med, bm_std_med, richness_tot, rich_tot_std) %>%
  dplyr::left_join(st_basin, by = "station")
```


## Habitat and environment

```{r}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_press <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)
```

```{r, fig.show = "hide"}
evt_var_mean <- c("flow_med", "temperature_med", "width_river_mean",
  "avg_depth_station_mean", "slope", "alt", "d_source", "strahler", "DBO_med")
evt_var_cv <- c("flow_cv", "temperature_cv", "width_river_cv",
  "avg_depth_station_cv", "DBO_cv")
pca_pressure <- habitat_press[, names(habitat_press) %in% c(evt_var_mean, evt_var_cv, "station")] %>%
  na.omit

pca_rotated <- compute_rotated_pca(
  .data = pca_pressure[, !names(pca_pressure) %in% "station"],
  naxis = 5 
)

prop_var_expl_pca <- pca_rotated$rotated$Vaccounted["Proportion Var", ] %>%
  map_dbl(., ~round(.x * 100))

tot_var_expl_pca <- round(sum(pca_rotated$rotated$Vaccounted["Proportion Var", ]) * 100) 
```


Habitat description were obtained from fish sampling data. We kept variables
describing the ecosystem size namely the stream width, depth and the ecosystem
position (altitude and slope). Physico-chemical variables were obtained from
naiades web portal [http://www.naiades.eaufrance.fr/](http://www.naiades.eaufrance.fr/).
We chose flow and temperature as physical variables to describe streams as flow
impose swimming constraints which filters fish species that can establish
[@rolls_scaling_2018; @tonkin_flow_2018; @gutierrez-canovas_contrasting_2013].
Water temperature is linked to physiological constraints namely thermal
tolerance and oxygen concentration tolerance [REF] since the level of water
saturation in oxygen is inversely linked to water temperature. We took 
Biochemical Oxygen Demand (BOD) for a proxy of enrichment in the ecosystem [REF].
BOD is also inversely linked to oxygen concentration in water.
The time resolution was heterogeneous according to the variable considered
(hourly, daily and monthly for temperature, flow and BOD resp.). For each recording
station, we applied a moving window averaging (more details in supplementary
material) to get rid of seasonal effects and took the annual mean (i.e. one
value by year and by station. As the environmental recording stations were not
located at the same place than the fish stations, we interpolated environmental
data with spatial statistical network model [@isaak_applications_2014]
implemented in the `SSN` R package [@hoef_ssn:_2014]. The interpolation
procedure is detailed in supplementary material. For each fish station,
environmental variables were matched with the year of fish sampling (except for
water temperature for which the record began in 2006). Then, the average
temperature, flow, BOD, river width and depth were computed as well as
coefficient of variation ($CV = \sigma \mu^{-1}$). As habitat and environmental
variables are often colinear, a principal component analysis (PCA) was performed
on the scaled variables. The PCA explained `r tot_var_expl_pca`% of the
variance. An axis rotation was performed to maximize the representation of the
variables by the principal components (Fig. \@ref(fig:pca-rotated)). We kept
five axis, representing respectively the (1) river size (river width & depth),
(2) the altitude, slope and decreasing average temperature, (3) average
enrichment (BOD) and CV of flow, (4) river size CV (CV of river width and depth)
and (5) CV of enrichment (CV of BOD). Additionally, we logged the axis one, two
and three to normalize their distribution and we reversed the third axis to get
increasing average temperature with increasing values of the axis.


## Statistical analysis


```{r get-data, cache = FALSE}
library(piecewiseSEM)
library(lme4)
library(nlme)

#ctrl <- lmeControl(opt='optim')
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
```

```{r mod-div-total, eval = FALSE}
stab_div_mod <- lmer(
  data = sem_data,
  control = ctrl_lmer,
  formula = log_stab_std ~ log_rich_tot_std + (1 | basin)
)
stopifnot(!isSingular(stab_div_mod, tol = 1e-05))
stab_div_boot <- bootMer(stab_div_mod, mySumm2, nsim = 100)
stab_div_ci <- confint(stab_div_boot)
#stab_div_colin <- car::vif(stab_div_mod) not use if one response
stab_div_sum <- piecewiseSEM::rsquared(stab_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(stab_div_mod, terms = c("log_rich_tot_std"), type = "fe")
stab_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_stab_std = predicted,
    log_rich_tot_std = x,
    basin = group
  )
stab_div_pred %<>%
  mutate(
    stab = 10^log_stab_std, # FALSE
    rich = 10^log_rich_tot_std,
    cl10 =  10^conf.low,
    ch10 =  10^conf.high
  )

#
bm_div_mod <- lmer(data = sem_data,
  formula = log_bm_std ~ log_rich_tot_std + (1 | basin)
)
bm_div_boot <- bootMer(bm_div_mod, mySumm2, nsim = 100)
bm_div_ci <- confint(bm_div_boot)
bm_div_sum <- piecewiseSEM::rsquared(bm_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(bm_div_mod, terms = c("log_rich_tot_std"), type = "fe")
#plot(pred, add.data = TRUE)
bm_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_bm_std = predicted,
    log_rich_tot_std = x,
    basin = group
  )

# get coeff
coef_div <- map(list(stab = stab_div_mod, bm = bm_div_mod), fixef)
```

```{r mod-div-troph, fig.show = "hide", eval = FALSE}
stab_troph_mod <- lmer(data = na.omit(stab_div_troph),
  formula = log_stab_std ~ log_rich_tot_std + troph_group + log_rich_tot_std:troph_group + (1 | basin)
  #control = ctrl
)

stab_troph_mod <- lmer(data = na.omit(stab_div_troph),
  formula = log_stab_std ~  troph_group + (1 | basin)
  #control = ctrl
)


stab_troph_boot <- bootMer(stab_troph_mod, mySumm2, nsim = 100)
stab_troph_ci <- confint(stab_troph_boot)

#stab_troph_colin <- car::vif(stab_troph_mod)
stab_troph_sum <- piecewiseSEM::rsquared(stab_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

#pred_troph_mod <- ggpredict(stab_troph_mod, terms = c("log_rich_tot_std", "troph_group"), type = "fe")
##plot(pred_troph_mod, add.data = TRUE)
#stab_troph_pred <- pred_troph_mod %>%
  #as_tibble() %>%
  #rename(
    #log_stab_std = predicted,
    #log_rich_tot_std = x,
    #troph_group = group
  #)

## Productivity and troph group

#bm_troph_mod <- lmer(data = na.omit(stab_div_troph),
  ##fixed = log_bm ~ log_rich_tot * troph_group,
  #formula = log_bm_std ~ log_rich_tot_std + troph_group + log_rich_tot_std:troph_group + (1 | basin)
  ##random = ~ 1 + log_rich_tot * troph_group | basin,
  ##control = ctrl 
#)
#bm_troph_boot <- bootMer(bm_troph_mod, mySumm2, nsim = 100)
#bm_troph_ci <- confint(bm_troph_boot)

#bm_troph_sum <- piecewiseSEM::rsquared(bm_troph_mod, method = "nagelkerke") %>%
  #mutate_at(vars(Conditional, Marginal), ~round(., 2))

#pred_troph_mod <- ggpredict(bm_troph_mod, terms = c("log_rich_tot_std", "troph_group"), type = "fe")
##plot(pred_troph_mod, add.data = TRUE)
#bm_troph_pred <- pred_troph_mod %>%
  #as_tibble() %>%
  #rename(
    #log_bm_std = predicted,
    #log_rich_tot_std = x,
    #troph_group = group
  #)

## get coeff
#coef_troph <- map(list(stab = stab_troph_mod, bm = bm_troph_mod), fixed.effects)
```
```{r stab-div-troph, eval = FALSE}
stab_div_by_troph <- compute_stat_troph_rich(
  .data = stab_div_troph,
  resp = "log_stab_std"
)

bm_div_by_troph <- compute_stat_troph_rich(
  .data = stab_div_troph,
  resp = "log_bm_std"
)
troph_perm_test <- map(c(stab = "log_stab_std", bm = "log_bm_std"),
  ~test_troph(.data = stab_div_troph, var = .x)
  )
troph_perm_test$bm$obs
troph_perm_test$stab$obs
troph_perm_test$bm$p_val
troph_perm_test$stab$p_val
```


### SEM

We seeked to disantangle the unravel the links between
environment and community structure on both biomass stability and total biomass.
To investigate complex relationships, direct and indirect, between variables,
Structural Equation Modeling (SEM) is one promising way  
[@grace_structural_2008; @grace_causal_2014; @lefcheck_piecewisesem_2016;
@grace_integrative_2016]. SEM makes possible to set causal relationships between
variables. This step can be critical, as the estimated parameters can be
determined by both the choice of the variables and the links between them.
Therefore, the set of variables and links shoud be supported by theory and
litterature.

We built a metamodel (set of variables and links between them). Basically, we
tested the links between environmental conditions, community structure and
ecosystem properties namely biomass stability on total biomass. Theory in
ecology predicts that community structure influences stability. In turn,
environment influences community structure but also directly stability.

#### Variables

To characterize environment, we retained five axis of PCA on habitat and
climatic variables which represent different types of forcing (constant and
variability). The two first axis (RC1 and RC2) were linked to the physical
structure and position of the river and the altitutinal gradient (+temperature).
The third axis (RC3) was linked to enrichment (Biological Demand in Oxygen) and
CV of annual flow. The fourth and fifth (RC4 and RC5) axis were associated to
environmental variability, respectively to CV of width and depth of the river
and CV of enrichment.

The community structure was characterized by total species richness, median
average weighted trophic level and median connectance. Total species richness
was the number of unique fish species that were observed at a given station over
the whole sampling. Both median connectance and average trophic level were just
computed as the median over the time series. For the details of the
computation of the trophic networks, see Network inference part.

#### Causal relationships

We linked environmental variables both to community structure and stability
components. Rooted in assembly theory, environment filters species that can
establish in a community and thus affect community structure. (+ add specific
hypothesis about physical and climate). (1) We hypothesized that enrichment
(characterized by DBO) and mean annual temperature will increase species turnover
[@friedpetersen_drivers_2020]. (2) We hypothesized environmental forcing can also
decrease biomass stability directly without going by community structure. First,
instability of habitat and environmental factors may in turn drive biomass
instability [@hansen_climate_2013]. Secondly, average environmental conditions
such as enrichment can increase directly CV by increasing species biomass
fluctuations [@tabi_warming_2019]. Increasing temperature was also hypothesized
to decrease stability through starvation resulting from high metabolic activity
[@tabi_warming_2019].

---
# Species richness to community attributes 
---
To reveal the mechanisms behind the relationship between species richness and
biomass stability, causal links were set from species richness to other
community attributes. In particular, species richness decreased connectance
following results from @thebault_stability_2010; @winemiller_must_1989. But
theoretically, some ecological networks can show the inverse relationship
[@winemiller_must_1989]. (6) We hypothesized also that species richness will
modulate average weighted trophic level because of food web assembly processes.
A community with more fish species can support higher trophic level. Finally, we
set up causal relationships from community attributes to stability components. 

---
#  Community attributes to stability
---
We hypothesized that (7) species richness decreased synchrony between species
[@loreau_species_2008] and increased $\overline{CV_{sp}}$
[@tilman_biodiversity_2006]. (8a) We expected that average trophic level had a
positive or negative relationship with synchrony, bottom-up effects should
result in positive whereas top-down in negative relationships. We expected a (8b)
negative relationship between average trophic level and $\overline{CV_{sp}}$ if
predators stabilised prey fluctuations or if the increasing part of
biomass in the predators decreased $\overline{CV_{sp}}$ because of their higher
body mass (if mean increase faster than variance). (9a) Connectance was expected
to decrease or increase $\overline{CV_{sp}}$ and (9b) synchrony because of top
down effects or bottom up effects.


```{r}
# Compute SEMs
stab_sem_rich <- compute_stab_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem_rich <- compute_prod_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

library(DiagrammeR)
meta_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "meta_stab_sem"),
  format = "png",
  width = 700*2,
  height = 900*2  - 900*2*30/100,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = c(from = 0, to = 7.5),
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("RC4", "log_RC3", "RC5", "log_RC1", "log_RC2"),
  metamodel = TRUE
)
p_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "stab_sem"),
  format = "png",
  width = 700*2,
  height = 900*2  - 900*2*30/100,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = c(from = 0, to = 7.5),
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("RC4", "log_RC3", "RC5", "log_RC1", "log_RC2")
)

meta_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "meta_bm_sem"),
  format = "png",
  width = 700*2,
  height = 900*2  - 900*2*45/100,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = c(from = 0, to = 7.5),
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("RC4", "log_RC3", "RC5", "log_RC1", "log_RC2"),
  metamodel = TRUE
)
p_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "bm_sem"),
  format = "png",
  width = 700*2,
  height = 900*2  - 900*2*45/100,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = c(from = 0, to = 7.5),
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("RC4", "log_RC3", "RC5", "log_RC1", "log_RC2")
)
```


```{r get-sem-coeff}
coef_stab_sem <- coef(stab_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)

coef_bm_sem <- coef(bm_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)
```

```{r stab-network, fig.show = "hide"}
sem_data %>%
  select(sync, cv_sp, ct, t_lvl) %>%
  gather(network, metrics, ct, t_lvl) %>%
  gather(stab_comp, value, sync, cv_sp) %>%
  ggplot(aes(y = value, x = metrics)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(stab_comp ~ network, scales = "free_x")

stab_ct_mod <- lmer(data = sem_data,
  #fixed = log_bm ~ log_rich_tot * troph_group,
  formula = log_stab_std ~ ct + (1 | basin)
  #random = ~ 1 + log_rich_tot * troph_group | basin,
  #control = ctrl 
)
stab_ct_boot <- bootMer(stab_ct_mod, mySumm2, nsim = 100)
stab_ct_ci <- confint(stab_ct_boot)

stab_ct_sum <- piecewiseSEM::rsquared(stab_ct_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_stab_ct_mod <- ggpredict(stab_ct_mod, terms = c("ct"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
stab_ct_pred <- pred_stab_ct_mod %>%
  as_tibble() %>%
  rename(
    log_stab_std = predicted,
    log_rich_tot_std = x,
    troph_group = group
  )

# get coeff
coef_stab_ct <- map(list(stab = stab_ct_mod), fixed.effects)


stab_tlvl_mod <- lmer(data = sem_data,
  #fixed = log_bm ~ log_rich_tot * troph_group,
  formula = log_stab_std ~ t_lvl + (1 | basin)
  #random = ~ 1 + log_rich_tot * troph_group | basin,
  #control = ctrl 
)
stab_tlvl_boot <- bootMer(stab_tlvl_mod, mySumm2, nsim = 100)
stab_tlvl_ci <- confint(stab_tlvl_boot)

stab_tlvl_sum <- piecewiseSEM::rsquared(stab_tlvl_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_stab_tlvl_mod <- ggpredict(stab_tlvl_mod, terms = c("t_lvl"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
stab_tlvl_pred <- pred_stab_tlvl_mod %>%
  as_tibble() %>%
  rename(
    log_stab_std = predicted,
    log_rich_tot_std = x,
    troph_group = group
  )

# get coeff
coef_stab_tlvl <- map(list(stab = stab_tlvl_mod), fixed.effects)
```

# Results


```{r}
sem_caption <- paste0(
  "Metamodel of the Structural Equation Models for (A) biomass stability and
  (B) total biomass. ",
  "Results of the Structural Equation Models for (C) the
  determinants of biomass stability and (D) total biomass. Red and green
  represent respectively negative and positive path coefficients. The path
  coefficients are standardized coeffients. For convenience, only significant
  paths (i.e, *P < 0.05*) are shown."

)
```


```{r sem-plot, fig.cap = sem_caption}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple

plot_grid(
  meta_stab_sem_rich, meta_bm_sem_rich,
  p_stab_sem_rich, p_bm_sem_rich,
  labels = LETTERS[1:4], nrow = 2,
  rel_widths = c(1, .8)
)
```

```{r get-bm-sem-single-effect}
bm_sem_coef <- filter(coef_bm_sem, P.Value <= 0.05)

rich_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_rich_tot_std")
tlvl_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "t_lvl")
RC1_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC1")
RC2_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC2")
```

```{r get-bm-tot-effect-env}
bm_all_params <- get_coefficient_piecewisesem(sem = bm_sem_rich, p_val_thl = NULL)

# effect of env on bm 
env_on_bm <- get_env_on_bm(fit = bm_all_params, p_val_thl = 0.05,
  type = "std")
# rich on bm 
rich_on_bm <- get_rich_on_bm(fit = bm_all_params,
  p_val_thl = 0.05, type = "std")

tmp_bm_indir_table <- map(list(env_on_bm, rich_on_bm),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```
```{r}
caption_indir_stab_sem <- paste0(
  "Indirect and total effect of variables on biomass stability from the
  structural equation model. Indirect effects are computed by multiplying the
  path coefficients from the variable predictor to the response variable, here
  biomass stability. Indirect effects are considered as one step from the target
  variable. For exemple, the indirect effect of species richness on
  biomass stability via its effect on CVsp is $-0.61$. To compute indirect
  effect, only the significant direct effects were taken into account. ",
  "Network structure being the indirect effect that went through both avg trophic
  level and connectance and Species richness_Network structure being the
  indirect effect that went through (i) species richness and from (ii) species
  richness to network structure."

)

caption_indir_bm_sem <- paste0(
  "Indirect and total effect of variables on total biomass from the
  structural equation model. See the table (X) for details about computation and
  meaning." 

)
```


```{r indir-bm, fig.cap = "Indirect effect from SEM"}
format_table <- function (x = tmp_stab_indir_table) {
  x <- x[, c("variable", names(x)[!names(x) %in% "variable"])]

  rm_n <- str_remove_all(get_sem_var_name_replacement(), pattern = "\n")
  names(rm_n) <- names(get_sem_var_name_replacement()) 
  x$variable <- str_replace_all(x$variable, rm_n)

  colnames(x) %<>% str_remove_all(., pattern = "via_")

  col_replacement <- c(
    variable = "Variable",
    cv_sp = "CVsp",
    sync = "Synchrony",
    richness = "Horizontal diversity",
    com = "Vertical diversity",
    richness_com = "Horizontal & vertical diversity",
    total = "Total effect"
  )
  colnames(x) %<>% str_replace_all(., col_replacement)

  x
}

kable(format_table(tmp_bm_indir_table),
  "latex",
  booktabs = T,
  caption = caption_indir_bm_sem
  ) %>%
kable_styling(latex_options =c("striped", "scale_down"))

```

```{r}
stab_all_params <- get_coefficient_piecewisesem(sem = stab_sem_rich, p_val_thl = NULL)
# effect of env on stab
env_on_stab <- get_env_on_stab(fit = stab_all_params, p_val_thl = 0.05,
  type = "std")
rich_on_stab <- get_rich_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
com_on_stab <- get_com_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")

tmp_stab_indir_table <- map(list(env_on_stab, rich_on_stab, com_on_stab),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```

```{r indir-stab}
kable(format_table(tmp_stab_indir_table),
  "latex",
  booktabs = T,
  caption = caption_indir_stab_sem 
  ) %>%
kable_styling(latex_options =c("striped", "scale_down"))
```


## Drivers of total biomass

---
# Total biomass
---

#### Direct effect
Species richness and average trophic level had a significant positive direct
effects on total biomass (resp. $r_\delta = `r rich_on_bm$direct`$ and $r_\delta
= `r tlvl_on_bm`$) whereas connectance had no significant direct effects (Fig.
\@ref(fig:sem-plot) B). CV of enrichment had a direct negative effect on total
while the other environmental variables had no significant direct
effect.

##### Indirect effect
Avg river size, avg temperature and avg enrichment had however indirect positive
effects on total biomass through species richness or/and average trophic level
(Table XX & Fig.  \@ref(fig:sem-plot) B). Those indirect effects went
independently by species richness and avg trophic level because species richness
had no significant effect on avg trophic level. 

```{r get-sem-single-effect}
stab_sem_coef <- filter(coef_stab_sem, P.Value < 0.05)
get_clean_sem_coef <- function(sem = NULL, resp = NULL, pred = NULL) {
  out <- sem[sem$Response == resp & sem$Predictor == pred, ]$Std.Estimate
  out <- ifelse(length(out) == 0, 0, out)
  round(out, 2)
}

sync_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_sync")
cv_sp_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_cv_sp")
RC1_on_sync <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_sync", pred = "log_RC1")
```

```{r get-sem-tot-effect-env}
# effect of env on sync and cv_sp
env_on_sync <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
env_on_cv_sp <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
# env on stab via network 
env_on_t_lvl <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "t_lvl", type = "std")
env_on_ct <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "ct", type = "std")
env_on_richness <- get_env_on_rich(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
```

```{r get-sem-tot-effect-rich}
rich_on_sync <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
rich_on_cv_sp <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
```


## Biomass stability

#### Direct effects 
$\overline{CV_{sp}}$ ($r_\delta = `r cv_sp_on_stab`$) decreased biomass
stability more than synchrony ($r_\delta = `r sync_on_stab`$, Figure
\@ref(fig:sem-plot)). Species richness had a strong opposite direct effect on
$\overline{CV_{sp}}$ and synchrony, positive on $\overline{CV_{sp}}$ ($r_\delta
= `r cv_sp_on_stab`$) and  negative on synchrony. Average trophic level had a
negative direct effect on $\overline{CV_{sp}}$ and connectance had no
significant direct effect on either $\overline{CV_{sp}}$ nor synchrony. Avg
enrichment had a direct positive effect on $\overline{CV_{sp}}$. The other
environmental variables had no significant direct effects on either
$\overline{CV_{sp}}$ nor synchrony.

#### Indirect effects
Indirectly through synchrony ($r_\delta = `r rich_on_stab$via_sync`$) and
$\overline{CV_{sp}}$ ($r_\delta = `r rich_on_stab$via_cv_sp`$), species richness
had a total negative effect on biomass stability
($r_\delta = `r rich_on_stab$total`$). Avg trophic level had a positive indirect
effect on
biomass stability through $\overline{CV_{sp}}$
($r_\delta = `r com_on_stab$via_cv_sp["t_lvl"]`$).

Avg temperature had an indirect negative effect on biomass stability through
$\overline{CV_{sp}}$ ($r_\delta = `r env_on_stab$via_cv_sp["log_RC2"]`$) and
through species richness ($r_\delta = `r env_on_stab$via_richness["log_RC2"]`$)
but weakly positive through avg trophic level ($r_\delta = `r env_on_stab$via_com["log_RC2"]`$).
In sum, avg temperature had a the highest total negative effect  
on biomass stability ($r_\delta = `r env_on_stab$total["log_RC2"]`$).

# Discussion

---
# Chapeau
---

#### Hat

With the aim to find out the determinants of total biomass and temporal
biomass variability in trophic communities, we analysis a standardized dataset
at France scale going on from 1995 to 2018. We infer network structure with
trait matching method and used SEM to disantangle direct and indirect effects of
environment, community and network structure on both total biomass and biomass
stability. We fund that species richness increased total biomass but 
decreased biomass stability. Suprisingly, we found that $\overline{CV_{sp}}$ had
an negative effect twice higher than synchrony on biomass stability.
Furthermore, we found that the effects of species richness on stability and
biomass were independent from the effects of network structure.

#### Richness on stability and biomass 

We found a negative relationship biomass stability and species
richness whereas there was a positive one between total biomass and species
richness. Overall, it contrasts with studies in grasslands
[@tilman_biodiversity_2006; @zhang_scale_nodate]; mesocosms
[@pennekamp_biodiversity_2018] or other animals [@olivier_independent_nodate]
where positive relationships are typically found between biomass stability
and species richness. In streams as well, @franssen_annual_2011
found that species richness increased biomass stability. However other studies
found a opposite relationship [@yang_effects_2011] or a marginal one
[@declerck_species_2006]. We found that species richness increased total biomass
as found in salt marshes, forests
[@wu_relationship_2015;@li_relationship_2018]. The positive effect
of species richness on total biomass might be due to resource use
complementarity [@cardinale_species_2002]. But opposite relation has been found
in richness in grasslands
[@grace_integrative_2016].

#### connectance on stability and biomass
Our path analysis revealed that, although species richness has a strong effect on
connectance, connectance itself had little to no effect either on stability nor
total biomass. This result contradicts precedent theoretical studies on the
relationship between stability and network structure [@angelis_stability_1975;
@may_will_1972], although they considered different stability metrics (i.e.
local stability of equilibrium point). The reason might be that in our inferred
network, network structure is strongly constraints by assembly processes.
Indeed, connectance generally decreased with increasing species richness
[@winemiller_must_1989; @thebault_stability_2010]. It is an effect important to
consider the link between connectance and ecosystem properties, as this direct
relationship can be misleading if species richness is not taken into account. 

##### Trophic level on stability and biomass 
We also found that richness had no effect on average trophic level but average
trophic level was positively linked to total biomass and biomass stability.
It means that the effects of richness and avg trophic level are
independent. Then, it underlied the importance to consider facets of community
structure related to biological interactions. The positive relation between
average trophic level and biomass is straitforward. As feeding interactions were
partly determined by body size and that body mass increase with body size, we
expected that the more the average biomass is located at higher trophic level,
the more the total biomass increase. Average trophic level had a positive effect
on biomass stability by its negative effect on average species CV (i.e. positive
effect on average species stability). It means that species at higher trophic
level are more stable than the species at lower trophic levels. But, the
relations between trophic position and stability more complex
[@shanafelt_david_w._stability_nodate], even more if we take in account the
repartition of the biomass across trophic level [@barbier_pyramids_2019].
Further investigation are needed to understand the interplay between trophic
level number, their biomass repartition and stability. 

##### Environment on biomass and stability

Precedent researches in plant communities showed that the total biomass was
primary driven by environmental drivers [@grace_integrative_2016]. We found that
environmental drivers in general did not directly affect either total biomass
nor synchrony and CVsp except avg temperature and CV of enrichment which were
respectively positively linked to CVsp and negatively linked to total biomass.
It indicates that the effect of environment primary drive community structure
which in turn affect total biomass and biomass stability. Our results also
showed that avg temperature had the biggest effect on biomass stability while Cv
of enrichment had the second biggest impact on total biomass.


#### Synchrony and CVsp 
Species richness decreased synchrony and increased $\overline{CV_{sp}}$. Species
richness can reduce synchrony through decrease of population size, thus raising
the role of demographic stochasticity [@loreau_species_2008] but also in the
case where species have different responses to environmental variation
[@loreau_species_2008]. While the effect of species richness on synchrony is
well understood, its effect on $\overline{CV_{sp}}$ is more complex. 
In turn, we found that synchrony and $\overline{CV_{sp}}$ both decreased biomass
stability, as predicted by the formulation of stability based on the CV
[@thibaut_understanding_2013]. However, it was unexpected that the average
population $\overline{CV_{sp}}$ had a stronger negative effect on biomass
stability than synchrony [@bluthgen_land_2016; @olivier_independent_nodate]. We
can advance two hypothesis that can raise this effect. First, the opportunity
for diet differentiation can be low in streams compare to other organisms. Bird
species are for example quite specialized in seed size, flying or soil arthropods or
mammals which gives opportunities for independent dynamics. Plants also can
achieve independent dynamics either spatial segregation or niche
differentiation. Because fish species even piscivorous one are quite
opportunistic in their foraging.  Secondly, in trophic communities, species
directly affect each other through feeding interactions, and so could raise
synchrony between species [@raimondo_interspecific_2004] more than in systems
where interactions happen more in the form of competitive exploitation.

#### Ending paragraph
This work aims to facilitate the rapprochement between theoretical ecology and
empirical ecology. While theoretical ecology has focused on the effects of
network structure on stability and biomass distribution, empirical ecology
ignored network structure. Furthermore, both fields have largely used different
stability metrics. We tried to move forward by including network structure in
the explanation of both total biomass and biomass stability. We showed that
species richness and network structure can have independent effects on ecosystem
properties. It opens a promising way for the understanding on how species
interactions, of different types, can affect both synchrony and CVsp in
different ecosystems. The reconstruction of ecological network with trait
matching methods can be a first approach to document such relationship, however
it will not compensate for close evaluation of measured interaction strength.
We also believe that SEM methods are particularly helpful to assess complex
relationship between environment, community structure and ecosystem properties
in empirical data which necessitate to move from simple bivariate relationships
[@grace_integrative_2016]. We believe that the integration of network structure
and species interaction in general will improve our understanding of the
mechanisms which determines ecosystem properties.
   


```{r}
save.image(file = mypath("manuscript", "bef_stability", "result", "workspace.rda"))
```

# References
