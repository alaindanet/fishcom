---
title: Species richness destabilizes trophic communities in freshwater ecosystems
author: Alain Danet, Maud Mouchet, Elisa Thébault and Colin Fontaine
date: \today 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
bibliography: references.bib
---

```{r, echo = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7),
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```


# Abstract

# Introduction 

- Research questions:
  - What are the effects of the community structure on total biomass and stability ? 
    1. What are the effects of species richness on total biomass and stability ?
      - effect of species richness
      - effect of trophic group
    2. What are the effects of the community structure on total biomass and stability ?
      - What is the relative effect of the environment relative to the community
	structure ?
      - What is the effect of the community structure on the different
	parts of the stability + total biomass?
	- Effect of horizontal and vertical diversity

# Methods

## Fish data

- OFB
  - French long term protocol
  - standardized

- Electric fishing:
  - stuned fish
  - identification of the fishes
  - fish counted  
  - length of the fishes in mm by lot (4):
    - I: big fishes measured individually
    - S/L: fishes are grouped by species and by size 
      - 30 random fishes were measured in each lot
      - simulate the size of all the fishes of the lot:
	- normal distribution truncated at 95% (?)
	- mean and sd calculted from the sample of the lot 
    - G: little fishes are grouped by species
      - min and max size by lot 
      - simulate the size of all the fishes of the lot:
	- normal distribution truncated at 95% (?)
	- mean computed as ???  
	- se computed as ??? 
    - N:

- Protocols type:
  - complete
    - shallow river
  - partial:
    - deep and large river
    - partial over bank
    - partial by point
    - fusion of the two Protocols when "by point" all the point were done
      over bank

- Fishing operations and station
  - kept one protocol type by station
  - kept one sampling operation per year (of the season the most sampled in the
    time series)
  - remove operations which sampling effort (length of river) superior to average
    plus or minus 30% of sd (by station)
  - kept station that had 10 or more samplings, i.e. followed 10 years or more

- Biomass:
  - infered by allometric law 
  - approximated by $B = 0.01 \times (l^3.03)$

## Network building

- Diet data: 
  - 7? species over 57 had a piscivorous stage
  - 3? species had a strict piscivorous stage
  - ontogenic diet shift based on size

- 7 Resource nodes:
  - based on diet database 

## Community

```{r}
myload(temporal_community_metrics, dir = mypath("data"))
myload(synchrony, dir = mypath("data"))
st_basin <- get_basin_station(sf_obj = FALSE)

myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
myload(temporal_network_metrics, dir = mypath("data", "species"))

stab_div_troph <- temporal_network_metrics_classes %>%
  dplyr::select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group),
    log_rich = log10(richness_med),
    log_rich_tot = log10(richness_tot),
    log_bm = log10(biomass_med),
    log_stab = log10(biomass_stab)) %>%
  dplyr::select(station, troph_group, biomass_stab, richness_med, richness_tot, log_rich, log_rich_tot, log_stab, log_bm, biomass_med, richness_tot) %>%
  dplyr::left_join(st_basin, by = "station")
```

## Habitat and environment

```{r}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_pressure <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)
```

```{r, fig.show = "hide"}
evt_var_mean <- c("flow_med", "temperature_med", "width_river_mean",
  "avg_depth_station_mean", "slope", "alt", "d_source", "strahler", "DBO_med")
evt_var_cv <- c("flow_cv", "temperature_cv", "width_river_cv",
  "avg_depth_station_cv", "DBO_cv")
pca_pressure <- habitat_pressure[, names(habitat_pressure) %in% c(evt_var_mean, evt_var_cv, "station")] %>%
  na.omit

pca_rotated <- compute_rotated_pca(
  .data = pca_pressure[, !names(pca_pressure) %in% "station"],
  naxis = 5 
)

```

## Statistical analysis

```{r get-data, cache = FALSE}
library(nlme)
library(piecewiseSEM)

myload(nmds, habitat_pressure, dir = mypath("report"))
myload(op_analysis, dir = mypath("data"))

# Compute stability, network metrics, etc with ;he new datasets
com_data <- compute_community_temporal_analysis(.op = op_analysis, dest_dir = mypath("data", "species"))

# Compute sem dataset 
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]], 
  hab_press = habitat_pressure, 
  sync = com_data[["sync"]],
  nmds = NULL,
  basin = st_basin 
  )
```


### Relationship between stability and species richness 

$$
\Log_{10}(S_i) = \beta_0 + \beta_R\Log_{10}(x_{Ri}) + \epsilon_{ij}
$$

$$
S_i = 10^(\beta_0 + \beta_R\Log_{10}(x_{Ri}) + \epsilon_{ij})
$$

$$
S_i = 10^(\beta_0) \times 10^(\beta_R\Log(x_{Ri})) \times 10^(\epsilon_{ij})
$$

$$
S_i = 10^(\beta_{0}) \times x_{Ri}10^(\beta_{R}) \times 10^(\epsilon_{ij})
$$

with $i$ being the station $i$.

```{r mod-div-total}
library(lme4)
ctrl <- lmeControl(opt='optim')
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
stab_div_mod <- lmer(
  data = sem_data,
  control = ctrl_lmer,
  formula = log_stab ~ log_rich_tot + (1 | basin)
)
stopifnot(!isSingular(stab_div_mod, tol = 1e-05))
stab_div_boot <- bootMer(stab_div_mod, mySumm2, nsim = 100)
stab_div_ci <- confint(stab_div_boot)
#stab_div_colin <- car::vif(stab_div_mod) not use if one response
stab_div_sum <- piecewiseSEM::rsquared(stab_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(stab_div_mod, terms = c("log_rich_tot"), type = "fe")
stab_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich_tot = x,
    basin = group
  )
stab_div_pred %<>%
  mutate(
    stab = 10^log_stab, # FALSE
    rich = 10^log_rich_tot,
    cl10 =  10^conf.low,
    ch10 =  10^conf.high
  )

#
bm_div_mod <- lmer(data = sem_data,
  formula = log_bm ~ log_rich_tot + (1 | basin)
)
bm_div_boot <- bootMer(bm_div_mod, mySumm2, nsim = 100)
bm_div_ci <- confint(bm_div_boot)
bm_div_sum <- piecewiseSEM::rsquared(bm_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(bm_div_mod, terms = c("log_rich_tot"), type = "fe")
#plot(pred, add.data = TRUE)
bm_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich_tot = x,
    basin = group
  )

# get coeff
coef_div <- map(list(stab = stab_div_mod, bm = bm_div_mod), fixed.effects)
```

```{r mod-div-troph, fig.show = "hide"}
stab_troph_mod <- lmer(data = na.omit(stab_div_troph),
  formula = log_stab ~ log_rich_tot + troph_group + log_rich_tot:troph_group + (1 | basin)
  #control = ctrl
)
stab_troph_boot <- bootMer(stab_troph_mod, mySumm2, nsim = 100)
stab_troph_ci <- confint(stab_troph_boot)

stab_troph_colin <- car::vif(stab_troph_mod)
stab_troph_sum <- piecewiseSEM::rsquared(stab_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(stab_troph_mod, terms = c("log_rich_tot", "troph_group"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
stab_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich_tot = x,
    troph_group = group
  )

# Productivity and troph group

bm_troph_mod <- lmer(data = na.omit(stab_div_troph),
  #fixed = log_bm ~ log_rich_tot * troph_group,
  formula = log_bm ~ log_rich_tot + troph_group + log_rich_tot:troph_group + (1 | basin)
  #random = ~ 1 + log_rich_tot * troph_group | basin,
  #control = ctrl 
)
bm_troph_boot <- bootMer(bm_troph_mod, mySumm2, nsim = 100)
bm_troph_ci <- confint(bm_troph_boot)

bm_troph_sum <- piecewiseSEM::rsquared(bm_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(bm_troph_mod, terms = c("log_rich_tot", "troph_group"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
bm_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich_tot = x,
    troph_group = group
  )

# get coeff
coef_troph <- map(list(stab = stab_troph_mod, bm = bm_troph_mod), fixed.effects)
```

### SEM

We computed Structural Equation Modeling (SEM) to unravel mechanisms underlying link
between environment, community structure and both biomass stability and total
biomass. Why SEM? 

SEM enables to reason in terms of causal relationship between components. The
goal was to understand the mechanisms behind the negative relationship biomass
stability and species richness and the positive relationship between total
biomass and species richness.

We built a metamodel to set up the nodes and the links between the different
compartment of the SEM. Basically, we wanted to test the links between
environmental conditions, community structure and stability. Theory in ecology 
predicts that community structure influences stability. In turn, environment 
influences community structure but also directly stability.

To characterize environment, we retained five axis of PCA on habitat and
climatic variables which represent different types of forcing (constant and
variability). The two first axis (RC1 and RC2) were mainly linked the physical
structure and position of the river and the altitutinal gradient (+temperature).
The third axis (RC3) was linked to enrichment (Organic Biological Demand) and CV
of annual flow. The fourth and fifth (RC4 and RC5) axis were associated to
environmental variability, respectively to CV of width and depth of the river
and CV of enrichment.

- Community structure:
  - species richness:
  - avg trophic level:
  - connectance:
  - beta diversity:

- Stability:
  - 2 components synchrony and $CV_{sp}$

The stream physical structure (RC1 axis) and its altitutinal position (RC2 axis)
was linked to species richness [REF].


```{r}
# Compute SEMs
stab_sem_rich_beta <- compute_stab_sem_rich_beta(.data = sem_data,
  random_effect = as.formula("~1|basin"))
stab_sem_meta <- compute_stab_sem_meta(.data = sem_data,
  random_effect = as.formula("~1|basin"))
stab_sem <- compute_stab_sem(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem <- compute_prod_sem(.data = sem_data,
  random_effect = as.formula("~1|basin"))
bm_sem_rich_beta <- compute_prod_sem_rich_beta(.data = sem_data,
  random_effect = as.formula("~1|basin"))

library(ggraph)
p_stab_sem_rich_beta <- ggpiecewisesem(stab_sem_rich_beta)
p_stab_sem_meta <- ggpiecewisesem(stab_sem_meta, p_val_thd = 1)
p_stab_sem <- ggpiecewisesem(stab_sem)
p_bm_sem_rich_beta <- ggpiecewisesem(bm_sem_rich_beta)
p_bm_sem <- ggpiecewisesem(bm_sem)
plot_grid(
  p_stab_sem,
  p_stab_sem_rich_beta,
  p_bm_sem,
  p_bm_sem_rich_beta
)
```


```{r get-sem-coeff}
coef_stab_sem_sum <- coef(stab_sem) %>%
  group_by(Response) %>%
  nest() %>%
  mutate(sum_c = map_dbl(data, ~ sum(.x$Std.Estimate)))

coef_stab_sem <- coef(stab_sem_rich_beta) %>%
  select(- 9) %>%
  filter(P.Value < 0.05)

#cor_mat <- cor(sem_data[, !names(sem_data) %in% c("station", "basin")])
```


# Results

## Species richness has a destabilizing effect on community  

```{r}
richness_lab <- "Total richness (Log 10)"
stab_lab <- "Biomass stability (Log 10)"
bm_lab <- "Total biomass (Log 10)"
```


```{r p-s-div}
lim_log_stab <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_stab")
lim_log_rich_tot <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_rich_tot")
# Plot left  

p_stab_div <- sem_data %>%
  ggplot(aes(x = log_rich_tot, y = log_stab))+
  geom_point() +
  ylim(lim_log_stab) +
  xlim(lim_log_rich_tot) +
  #scale_y_log10() +
  #scale_x_log10() +
  labs(x = richness_lab, y = stab_lab) +
  geom_line(data = stab_div_pred) +
  geom_ribbon(data = stab_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .2) +
  annotate("text", x = 1.0, y = .8, label = make_label_rsq(rsq = stab_div_sum),
    parse = TRUE)

# Right plot
p_stab_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich_tot, y = log_stab, color = troph_group)) +
  geom_point() +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  ylim(lim_log_stab) +
  xlim(lim_log_rich_tot) +
  geom_line(data = stab_troph_pred) +
  geom_ribbon(data = stab_troph_pred,
    aes(ymin = conf.low, ymax = conf.high, color = NULL, group = troph_group),
    alpha = .2) +
  annotate("text", x = 0.8, y = .8, label = make_label_rsq(rsq = stab_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = richness_lab, y = stab_lab)

p_stab <- plot_grid(p_stab_div, p_stab_div_troph, ncol = 2, rel_widths = c(.4, .6))
```

```{r p-p-div}
lim_log_bm <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_bm")

p_bm_div <- sem_data %>%
  ggplot(aes(x = log_rich_tot, y = log_bm))+
  geom_point() +
  ylim(lim_log_bm) +
  xlim(lim_log_rich_tot) +
  labs(x = richness_lab, y = bm_lab) +
  geom_line(data = bm_div_pred) +
  geom_ribbon(data = bm_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .2) +
  annotate("text", x = .8, y = 1.5, label = make_label_rsq(rsq = bm_div_sum),
    parse = TRUE)

p_bm_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich_tot, y = log_bm, color = troph_group)) +
  geom_point() +
  ylim(lim_log_bm) +
  xlim(lim_log_rich_tot) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  geom_line(data = bm_troph_pred) +
  geom_ribbon(data = bm_troph_pred,
    aes(ymin = conf.low, ymax = conf.high, color = NULL, group = troph_group),
    alpha = .2) +
  annotate("text", x = 0.8, y = 1.5, label = make_label_rsq(rsq = bm_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = richness_lab, y = bm_lab)

p_bm <- plot_grid(p_bm_div, p_bm_div_troph, ncol = 2, rel_widths = c(.4, .6))
```

```{r psbm, fig.dim = c(10,5)}
plot_grid(p_stab, p_bm, ncol = 1)

print_coef <- function (vec){
  round(abs(vec)*100)
}
print_ci <- function(.df){
  .df <- round(.df, 3)*100
  
  paste0("[", .df[["2.5 %"]],";",.df[["97.5 %"]] ,"]")
}
```

```{r print-coef-stab}
# Coefficients
s_co_i <- print_coef(coef_div$stab["(Intercept)"])
s_co_r <- print_coef(coef_div$stab["log_rich_tot"])
s_co_t <- print_coef(coef_troph$stab["troph_group3"])
s_co_r_t2 <- print_coef(coef_troph$stab["log_rich_tot"])
s_co_r_t3 <- print_coef(coef_troph$stab["log_rich_tot"]+coef_troph$stab["log_rich_tot:troph_group3"])

s_ci_r <- print_ci(stab_div_ci["beta.log_rich_tot",])
s_ci_t <- print_ci(stab_troph_ci["beta.troph_group3",])
s_ci_r_t2 <- print_ci(stab_troph_ci["beta.log_rich_tot",])
s_ci_r_t3 <- print_ci(coef_troph$stab["log_rich_tot"] + stab_troph_ci["beta.log_rich_tot:troph_group3",])
```

```{r print-coef-bm}
# Coefficients
b_co_i <- print_coef(coef_div$bm["(Intercept)"])
b_co_r <- print_coef(coef_div$bm["log_rich_tot"])
b_co_t <- print_coef(coef_troph$bm["troph_group3"])
b_co_r_t2 <- print_coef(coef_troph$bm["log_rich_tot"])
b_co_r_t3 <- print_coef(coef_troph$bm["log_rich_tot"]+coef_troph$bm["log_rich_tot:troph_group3"])

b_ci_r <- print_ci(bm_div_ci["beta.log_rich_tot",])
b_ci_t <- print_ci(bm_troph_ci["beta.troph_group3",])
b_ci_r_t2 <- print_ci(bm_troph_ci["beta.log_rich_tot",])
b_ci_r_t3 <- print_ci(coef_troph$bm["log_rich_tot"] + bm_troph_ci["beta.log_rich_tot:troph_group3",])
```


- Stability:
  - decreases globally with total species richness (TSR)
    - An increase of 1% of TSR decreased biomass stability by
      `r s_co_r`% (`r s_ci_r`)
  - was `r s_co_t`% (`r s_ci_t`) higher for higher trophic group
  - increased by `r s_co_r_t2`% (`r s_ci_r_t2`) and decreased by `r s_co_r_t3`
    (`r s_ci_r_t3`) with 1% increase in TSR for the lower and higher trophic
    group respectively

- Biomass:
  - increases with TSR 
    - An increase of 1% of TSR increased total biomass by
      `r b_co_r` % `r b_ci_r`
  - was `r b_co_t`% `r b_ci_t` higher for higher trophic group
  - increased by `r b_co_r_t2`% `r b_ci_r_t2` and decreased by `r b_co_r_t3`
    (`r b_ci_r_t3`) with 1% increase in TSR for the lower and higher trophic
    group respectively

## Drivers of total biomass and stability

```{r, fig.show = "hide"}
axis_pair <- list(c(1,2), c(1,3), c(2,3), c(1, 4), c(2, 4), c(3,4), c(4,5))
p_l_rot <- map(axis_pair, 
  function (axis)
    pca_rotated_plot <- plot_rotated_pca(
      pca_rotated = pca_rotated,
      axis = axis 
    )
)
```


```{r sem-plot, fig.dim = c(10,10)}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple
to_plot <- c(1, 6, 7)
plot_grid(
  plot_grid(plotlist = map(p_l_rot[to_plot], ~.x$rotated),
      ncol = length(to_plot), labels = LETTERS[1]),
  plot_grid(p_stab_sem_rich_beta, p_bm_sem_rich_beta, labels = LETTERS[2:3]),
  ncol = 1,
  rel_heights = c(.4, .6)
)
```

- Habitat: (+ / -)
  - RC 1: width & depth & flow med, d source, strahler 	/
  - RC 2: T°C med 					/ slope, alt 
  - RC 3: 						/ flow CV, DBO med
  - RC 4: river width med, depth med 			/
  - RC 5: DBO CV 					/

- Stability:
  - Stability component:
    - CV is the main driver of stability:
  - Community structure: 
    - Species richness had no direct effects on CV but on synchrony!  
    - Evenness of biomass dist increased CV but decreased synchrony
    - Trophic level decreased CV
    - Betadiv increases CV
  - Habitat/Env:
    - few direct effect on stability
      - direct: CV_sp dec with increasing RC3, cad enrichment and flow_cv decrease.  
      - direct: CV_sp inc with increasing RC2, cad temperature_med.  
    - indirectly affect stability by modulating community structure,
      particularly richness

- Total biomass:
  - Community structure:
    - Richness increased total biomass / had the bigger effect
    - Even community deceased total biomass
    - Species turnover decreased total biomass  
    - Connectance increased biomass
  - Habitat/Env:
    - very weak to no direct effect on total biomass 
    - Effect of environment is thus mediated by the community structure

- Main outcome:
  - Biomass but stability increased with richness
  - Higher trophic group was more stable that lower one
    - Opposite relationship stability/richness
  - Stability was mainly driven by species richness

The effect of richness on biomass stability follows a power law with a negative
coefficient, meaning that it's a decelerating function.

- Latex:
  - csv:
    - https://tex.stackexchange.com/questions/178904/use-datatool-to-read-a-row-from-a-csv-file-then-use-the-variables-in-the-docume
    - https://tex.stackexchange.com/questions/40901/datatool-getting-a-specific-value-given-the-value-of-another-column
  - path: 
- Reporting:
  - equations: https://stats.stackexchange.com/questions/169115/reporting-the-actual-formula-equation-of-an-lme-model-with-factors-used-in-r
  - log-log results:
    - https://dev.to/rokaandy/logarithmic-transformation-in-linear-regression-models-why-when-3a7c
    - https://stats.stackexchange.com/questions/18480/interpretation-of-log-transformed-predictor-and-or-response

# Discussion


# Appendix

## Model summary and diagnostics 

### Biomass and stability models

```{r tab-coeff-bm, fig.cap = "Coefficient"}
# Replacement rules for term
rp_est <- c(
  "(Intercept)" =     "intercept",
  "sd\\_\\(intercept\\)\\.basin" = "sd intercept basin",
  "log_rich" =     "Median richness (log base 10)",
  "troph_group3" =     "high trophic group",
  "log_rich:troph_group3" =     "Median richness (log10) : high trophic group",
  "sig01.basin" =     "sd intercept basin",
  "sd_Observation.Residual" =     "residuals",
  "sigma" = "residuals"
)
# Replacement rules for group
rp_group <- c(
  "fixed" = "Fixed",
  "basin" = "Random"
)

```

```{r}
coeff_troph <- map2_dfr(list(bm_troph_ci, stab_troph_ci), list(bm_troph_mod, stab_troph_mod),
  clean_summary_mod, term_rp = rp_est, group_rp = rp_group)

kable(coeff_troph) %>%
  pack_rows("Biomass", 1, 6) %>%
  pack_rows("Stab", 7, 12)
```



### SEM 

```{r tab-coeff-stab}

```


## Model residuals

### Biomass and stability models 

```{r}
mod_list <- list(bm_div_mod, bm_troph_mod, stab_div_mod, stab_troph_mod)
plot_res <- map(mod_list, ~ plot(.x))
plot_grid(plotlist = plot_res)
```

### SEM linear relationship 

```{r s-colin-sem, fig.cap = "Variance Inflation factor for each individual model of stability sem"}
#compute_stab_sem_rich(.data = sem_data, get_sem =TRUE)

mod_stab_list <-
  list(
    nlme::lme(log_rich_tot ~ RC1 + RC2 + RC3 + RC4 + RC5,  random = ~ 1 | basin, data = sem_data),
    nlme::lme(piel ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(ct ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(t_lvl ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(beta_bin ~ RC1 + RC2 + RC3 + RC4 + RC5 + log_rich_tot, random = ~ 1 | basin, data = sem_data),
    nlme::lme(log_sync ~ log_rich_tot + piel + ct + t_lvl + RC1 + RC2 + RC3 + RC4 + RC5,
      random = ~ 1 | basin, data = sem_data),
    nlme::lme(log_cv_sp ~ log_rich_tot + piel + ct + t_lvl
      + RC1 + RC2 + RC3 + RC4 + RC5, random = ~ 1 | basin, data = sem_data),
    lm(log_stab ~ log_cv_sp + log_sync, data = sem_data)
  )
names(mod_stab_list) <- c("richness", "pielou", "connectance", "weighted_mean_trophic_lvl", "beta", "synchrony", "cv_sp", "stability") 
colin_stab_sem <- map(mod_stab_list, car::vif)

tmp <- map(colin_stab_sem, enframe)
  
# colinearity table
colin_stab_sem <- tibble(vif = tmp, mod = names(mod_stab_list)) %>%
  unnest(vif) %>%
  spread(name, value)

#formulas <- list(
  #"log_rich ~ RC1 + RC2 + RC3 + RC4 + RC5",
  #"piel ~ RC1 + RC2 + RC3 + RC4 + RC5"
#)
#test <- map(formulas, function(x, y, random_effect) {
  #lmer(as.formula(x), random= as.formula(random_effect), data = y)

#}, y =sem_data, random_effect = "~ 1 |basin")

kable(colin_stab_sem)
```

```{r}
plot_residuals <- function (x, y = "Diagnostic") {
  plot.lme(x, main = y, xlab = "Fitted values", ylab = "Residuals")
}
p_resid_stab_sem <- map2(mod_stab_list, names(mod_stab_list) , plot_residuals)
plot_grid(plotlist = p_resid_stab_sem)
```

```{r, eval = FALSE}
mod_tlvl <- nlme::lme(t_lvl ~ scale(RC1) + scale(RC2) + scale(RC3) + scale(RC4) + scale(RC5) + log_rich_tot, random = ~ 1 | basin, data = sem_data)
plot(mod_tlvl)
sem_data %>%
  ggplot(aes(x = log10(richness_tot), y = t_lvl)) +
  geom_point()+
  geom_smooth(method = "lm")

sem_data %>%
  ggplot(aes(x = RC1, y = t_lvl)) +
  geom_point()+
  geom_smooth(method = "lm")
plot(nlme::lme(t_lvl ~ I(log10(RC1 + abs(min(RC1)))) + log_rich_tot, random = ~ 1 | basin, data = sem_data))
nlme::lme(t_lvl ~ log_rich_tot, random = ~ 1 | basin, data = sem_data)
semd_test <- sem_data %>%
  mutate(RC1b = RC1 + abs(min(RC1)))
ricker.mixed.fit <- nls(
  t_lvl ~ (Vm*(RC1 + b) / (K + (RC1 + b)) + d),
 #fixed = Vm + K + b + d ~ 1,
 #random = Vm + K + b + d ~ 1|basin,
 start= c(Vm=1, K = 0.1, b = .5, d = 2.5),
 data = semd_test,
 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8) 
)
summary(ricker.mixed.fit)
x <- seq(min(sem_data$RC1), max(sem_data$RC1), length.out = 100)
sem_data$test_pred <- predict(ricker.mixed.fit)

semd_test %>%
  ggplot(aes(x = RC1b, y = t_lvl)) +
  geom_point() +
  geom_line(aes(y = test_pred))
  geom_smooth(method = "lm")
cor(semd_test$piel, semd_test$t_lvl, method = c("spearman"))
```

## Relationship at the absolute scale, i.e. not the logarythme scale 

```{r}
ggplot(sem_data, aes(x = richness_med, y = biomass_stab)) +
  geom_point()
test <- tibble(
  richness_med = seq(1,20, length.out = 100),
  biomass_stab =
    10^(fixef(stab_div_mod)[1])*richness_med^fixef(stab_div_mod)[2]
)  
```


# References
