---
title: Species richness and food-web structure jointly drive community biomass and its temporal stability in fish assemblages 
author: Alain Danet, Maud Mouchet, Willem Bonnaffé, Elisa Thébault, Colin Fontaine
date: \today 
output:
  bookdown::pdf_document2:
    toc: false 
    fig_caption: true 
    keep_tex: true
fontsize: 12pt
header-includes:
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
geometry: margin=2cm
bibliography: references.bib
csl: ecology-letters.csl
---

```{r, echo = FALSE, results = FALSE, message = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE 
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "total_sem_effect.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```

```{r, results = FALSE}
knitr::opts_chunk$set(
  results = TRUE 
)
```

- Author affiliation:
  - Alain Danet: Centre d’Ecologie et des Sciences de la Conservation, UMR 7204
    MNHN-CNRS-Sorbonne Université, Muséum national d’Histoire naturelle de
    Paris, 43 rue Buffon, 75005 Paris, France
  - Maud Mouchet: Centre d’Ecologie et des Sciences de la Conservation, UMR 7204
    MNHN-CNRS-Sorbonne Université, Muséum national d’Histoire naturelle de
    Paris, 43 rue Buffon, 75005 Paris, France
  - Willem Bonnaffé: Ecological and Evolutionary Dynamics Lab. Zoology Research
    and Administration Building, 11a Mansfield Rd, Oxford OX1 3SZ, United
    Kingdom.
  - Elisa Thébault: Sorbonne Université, CNRS, IRD, INRAE, Université Paris Est
    Créteil, Institute of Ecology and Environmental Sciences of Paris
    (iEES-Paris), Paris, France  
  - Colin Fontaine: Centre d’Ecologie et des Sciences de la Conservation, UMR 7204
    MNHN-CNRS-Sorbonne Université, Muséum national d’Histoire naturelle de
    Paris, 43 rue Buffon, 75005 Paris, France

- Author contributions: AD, CF, MM and ET designed the study. WB designed the
  network inference method and collected the food diet data. AD performed the
  data analysis and wrote the first draft of the manuscript. All authors
  contributed substantially to revisions.

- Data accessibility statement: Upon acceptance of the paper, we confirmed that
  the data supporting the results will be archived in an appropriate public
  repository and that the data DOI will be included at the
  end of the article. The code used for the analysis and to generate the
  manuscript is available on github: (alaindanet/fishcom.git). The raw fish
  database is public and available upon request to eddy.cosson@afbiodiversite.fr and
  thierry.point@afbiodiversite.fr. The raw data of water temperature, flow and
  Biological Oxygen Demand are available on http://www.naiades.eaufrance.fr/. 

- Article type: Letters

- Running title: food-web structure, biomass and stability

- Number of words:
  - Abstract: 149
  - Main text: 4930 

- Number of references: 92
- Number of figures: 2
- Number of tables: 1
- Number of text boxes: 0 

- Coresponding author:
  - Alain Danet
  - UMR 7204 CESCO, CP 135; 43, rue Buffon, 75005 Paris, France
  - alain.danet@mnhn.fr 
  - +33140798134

# Abstract

Biodiversity-ecosystem functioning (BEF) and food-web complexity-stability
relationships are central to ecology. However, they remain largely untested in
natural context. Here we study the links among environmental conditions,
richness, food-web structure, annual biomass and its temporal stability using a
standardized monitoring dataset of 99 stream fish communities spanning from 1995
to 2018. We first reveal that both richness and average trophic level are
positively related to annual biomass, with effects of similar strength. Second,
we show that food-web structure affects community stability, with a positive
effect of mean trophic level, and contrary to expectation, a destabilizing
effect of species richness. Finally, we find that environmental conditions
affect both biomass and its stability via effects on richness and network
structure. Strikingly, effects on stability are mediated by population stability
rather than synchrony, which contrasts with results from single-trophic
communities and might be characteristic of multi-trophic communities.

# Introduction 

---
#### Biodiversity and ecosystem properties 
---

Current biodiversity losses and further global change have the potential to
affect ecosystems in complex ways [@loreau_biodiversity_2001;
@tilman_biodiversity_2014]. Biodiversity has indeed a major effect on
ecosystem functions and their stability in response to perturbations
[@hector_plant_1999; @loreau_biodiversity_2001; @hooper_effects_2005;
@dunne_network_2006; @duffy_why_2009], because it largely determines the
amount and the distribution of matter and energy fluxes within and among
ecosystems [@loreau_meta-ecosystems:_2003]. Understanding the relationship
between biodiversity and ecosystem properties is thus crucial to better
anticipate the impacts of global change. 

---
#### Species richness increases total biomass
---


Species richness has been found to increase primary productivity, community biomass
and its temporal stability in a diversity of ecosystems and taxa both
empirically and experimentally [@tilman_productivity_1996;
@cardinale_species_2002; @tilman_biodiversity_2006; @franssen_annual_2011;
@grace_integrative_2016; @pennekamp_biodiversity_2018; @houlahan_negative_2018;
@olivier_urbanization_2020]. However, the relationship between
diversity and ecosystem functioning remains mostly focused on single trophic
levels, generally the primary producers, ignoring the effects of food-web
structure. This gap is even more striking for the relationship between diversity
and temporal stability, in spite of long-standing interest for the links between
food-web complexity and stability in theoretical ecology [e.g.  @may_will_1972;
@dunne_network_2006; @neutel_reconciling_2007; @duffy_why_2009;
@stouffer_compartmentalization_2011].

Overall, the evidence from theoretical models suggests that both species
richness and food-web structure should modulate ecosystem properties such as
community biomass and its stability. Complementarity in the use of
resources is important to understand the effects of species richness on
productivity in food-webs [@thebault_food-web_2003; @poisot_trophic_2013;
@schneider_animal_2016], but it also depends on food-webs connectance, i.e. its
level of generalism [@thebault_food-web_2003; @thebault_cascading_2007]. In
addition, the presence of species at higher trophic levels may increase total
primary production, through possibly through the selection of primary producers
which are larger and more complementary [@wang_biodiversity_2018].

As classically found in studies considering a single trophic level,
[@tilman_biodiversity_2006; @loreau_species_2008; @olivier_urbanization_2020],
asynchrony in population temporal variations also explains a significant part
of the stabilizing effects of species richness on community biomass in food-webs
[@thebault_trophic_2005]. Indeed, a low synchrony in population fluctuations,
i.e. asynchrony, is synonymous of compensatory dynamics, where the decrease in
abundance of a population is compensated by the increase of another. However,
higher food-web connectance can counterbalance the positive effects of species
richness on temporal stability of community biomass, because it may increase
competition between consumers and then leads to a positive relationship between
species richness and population temporal variability
[@thebault_trophic_2005]. The addition of predators has
also cascading effects on both population variability and
synchrony at lower trophic levels [@teng_dynamics_2004;
@shanafelt_stability_2018]. Overall, these theoretical studies show that the
effects of species richness and food-web structure, such as connectance and
average trophic level, are potentially conflicting or synergistic in such a way
that they need to be addressed jointly.

The lack of studies that consider jointly effects of diversity and food-web
structure on ecosystem functions can be explained by the challenges associated
with manipulating both species richness and food-web complexity in an
experimental context [e.g. @sander_ecological_2017] and by the fact that
describing trophic interactions between species is highly labour intensive.
These challenges are even more acute for the study of the stability of ecosystem
properties, which additionally requires longer-term perspectives. In this
context, recent developments to predict species trophic interactions
[@beckerman_foraging_2006; @gravel_inferring_2013; @portalier_mechanics_2019],
combined with observational long-term surveys of ecological communities, can
offer the opportunity to investigate the links between diversity, food-web
structure and the stability of total community biomass in natural settings.

The joint study of the effects of diversity and food web structure on total
biomass and its stability is even more important in the context of environmental
changes. Recent studies on natural communities have shown that environment may
alter community biomass [@grace_integrative_2016; @woods_testing_2020] and its
temporal stability [@oliver_heterogeneous_2010; @franssen_annual_2011;
@hansen_climate_2013; @bluthgen_land_2016; @de_boeck_patterns_2017;
@friedpetersen_drivers_2020]. For example, larger ecosystem might increase the
number of available resources and thus community biomass [@post_ecosystem_2000;
@doi_resource_2009] while temperature affects ecosystem respiration and biomass
distribution [@yvondurocher_warming_2011; @schwarz_warming_2017;
@tabi_warming_2019]. Environment also directly affect species richness and
food-web structure, as larger ecosystems host food-webs with higher diversity
and trophic levels [@mchugh_dual_2010] whereas temperature can affect food-web
diversity and structure in contrasted ways depending on the ecosystem studied
[@ogorman_unexpected_2017; @gauzens_biodiversity_2020]. In natural communities,
the relationships among species richness, community biomass and its temporal
stability might also arise from effects of the environment on both diversity and
ecosystem functions [@loreau_biodiversity_2001; @he_global_2013;
@grace_integrative_2016]. Thus, the effect of environment on ecosystem
functioning might arise from direct effects or indirectly through effects on
species richness or food-web structure.

---
#### Stream fish communities is a good model to study effects of horizontal & vertical diversity
---

Because their trophic interactions are well known, stream fish communities
constitute a good model to study the effects of network structure on total
biomass and its temporal stability. A substantial body of literature
supports that trophic interactions can be inferred through body size and diet
informations [@jennings_weak_2001; @beckerman_foraging_2006;
@gravel_inferring_2013; @brose_predator_2019; @portalier_mechanics_2019].

Our aim is to document the relationships among species richness, food-web
structure, community biomass and its temporal stability in natural communities. To
do so, we used a standardized sampling of fish
communities in French streams [@edeline_ecological_2013]. We selected 99 sites
that have been sampled for more than 10 years. We inferred 1496 interaction
networks, based on body size and diet. We question whether species richness,
food-web connectance and average trophic level are related to community biomass and its
temporal stability. We further assess how ecosystem size and temperature
mediated this relationship.

# Methods

```{r, fig.show = "hide"}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_press <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)

# Make PCA 
habitat_press %<>% na.omit()
mask <- names(habitat_press) %in% names(get_pca_var_name_replacement())

pca_rotated <- compute_rotated_pca(
  .data = habitat_press[, mask],
  naxis = 2
)
habitat_pressure <- 
  cbind(habitat_press[, c("station", "temperature_med", "alt")], pca_rotated$rotated$score) %>%
  as_tibble

mysave(habitat_press, habitat_pressure, dir = mypath("data"), overwrite = TRUE)
```

```{r}
prop_var_expl_pca <- pca_rotated$rotated$Vaccounted["Proportion Var", ] %>%
  map_dbl(., ~round(.x * 100))
tot_var_expl_pca <- sum(prop_var_expl_pca) 
```



```{r}
# Basin
st_basin <- get_basin_station(sf_obj = FALSE)

# Select fishing operation 
myload(op_analysis, op_analysis_wo_holes, dir = mypath("data"))
myload(biomass_ts_sax, dir = mypath("data"))
op_analysis_bbb <- filter(op_analysis, station %in%
biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
op_analysis_wo_holes_bbb <- filter(op_analysis_wo_holes, station %in%
biomass_ts_sax[biomass_ts_sax$sax == "bbb",]$station)
range_surface <- map_dbl(c(min, max), ~.x(op_analysis_bbb$surface, na.rm =TRUE))
range_surface[1] <- ceiling(range_surface[1] / 10) * 10
range_surface[2] <- ceiling(range_surface[2] / 100) * 100
# quantile(op_analysis_bbb$surface, na.rm =TRUE)
```

## Data preparation and filtering

Fish communities were monitored across stream sections in France on the period
1995-2018 by the French Office of Water and Aquatic Ecosystems (ONEMA) using
electrofishing. Two different standardized protocols were used for small and
large streams (detailed in appendix B, part 1.1). In the case where a stream was
sampled alternatively with one of the two sampling protocols, we only included
data derived from the most frequently used sampling method. The sampling season
spanned from late spring to autumn.  There was low heterogeneity of the sampling
month within stations, with the median sampling month being mid-August where the
median standard deviation of the sampling month was $0.7$ month, i.e. three weeks.

We selected the stations that had been sampled ten years or more. As the concept
of community stability often refersred to the variability around an equilibrium
point [@donohue_navigating_2016], which is rarely observed or difficult to
characterize in natural communities. Then, we selected the stations that did not
show temporal trends in community biomass (detailed in appendix B, part 2).
However, the results were robust to the relaxation of this hypothesis (Fig. S7).
We selected the stations that had been sampled ten years or more. As the concept
of community stability referred to variability around an equilibrium, which is
rarely observed or difficult to characterize in natural communities, only those
stations that did not show temporal trends in community biomass were selected
(detailed in appendix B, part 2). However, the results were robust to the
relaxation of this hypothesis (Fig. S7). These selection steps resulted in 99
stations distributed over seven hydrographic basins (Fig. \@ref(fig:matmet)A).

## Community biomass and its temporal stability

### Biomass estimation

The body size of all fish individuals from a given species was not recorded when they were too
numerous (Fig. S1, appendix B, part 1.1). The body size of the unmeasured
individuals was inferred under the assumption that species body size followed a
normal distribution (Fig. S1, appendix B, part 1.2). The body mass of each
individual was then estimated following the results of two meta-analyses on
fishes [@lleonart_removing_2000; @froese_cube_2006], using an allometric law
$B_i = 0.01 \times l_i^{3.03}$, with $B$ the body mass in grams, $l$ the body
size in millimeters and $i$ the individual. Population biomass and community biomass at
each sampling event were then calculated by summing individual body masses. To
account for the variation in sampling effort among sites, population biomass and
community biomass were corrected by the surface sampled (range `r range_surface[1]` -
`r range_surface[2]` square metres), and expressed in grams per square meter
($gm^{-2}$). In the analysis, the community biomass of a site was defined as
the median of the community biomass across sampling years.


### Stability measures

Temporal biomass stability was defined as the inverse of biomass variability.
Variability was computed as Coefficient of Variation (CV) of the community biomass over
time ($CV_i = \sigma_i \mu_i^{-1}$, with $\sigma_i$ and $\mu_i$ being
respectively the standard deviation and the temporal average of the annual
community biomass of the station $i$). Then, temporal stability ($S_i$) was
equal to $CV_i^{-1} = \mu_i \sigma_i^{-1}$.

The variability of community biomass ($CV_{com, i}$) can be decomposed 
into a
synchrony ($\phi$) component and a weighted average population variability
($\overline{CV_{sp, i}}$) component according to @thibaut_understanding_2013:

\begin{equation} 
  CV_{com, i} = \overline{CV_{sp, i}} \times \sqrt{\phi_i}
  (\#eq:cvcom)
\end{equation}

To assess the mechanisms driving stability of community biomass, we thus in addition measure
the synchrony and the weighted average population variability $\overline{CV_{sp,
i}}$, the average CV at the species-level in the station $i$, weighted by the
relative biomass of the species, $B_{k,i}$.

Synchrony of the station $i$, $\phi_i$, is the ratio between the variance of
community biomass over time ($\sigma^2_{x_{T,i}}$) and the sum of the variance of
population biomass over time ($\sigma_{x_{k,i}}$), $i$ being the station $i$ and $k$
the species $k$ [@loreau_species_2008].

\begin{equation} 
\overline{CV_{sp, i}} = \sum_k{\frac{B_{k,i} {CV}_{k, i}}{\sum_k{B_{k,i}}}}
(\#eq:cvsp)
\end{equation} 

\begin{equation} 
\phi_i = \frac{\sigma^2_{x_{T,i}}}{(\sum_k{\sqrt{\sigma^2_{x_{k,i}}}})^2} = \frac{\sigma^2_{x_{T,i}}}{(\sum_k{\sigma_{x_{k,i}}})^2}
(\#eq:phi)
\end{equation} 


## Species richness and food-web structure

### Species richness

Species richness in a given site was defined as the total number of species present across
all the sampling events. We controlled species richness for sampling effort by
dividing the total number of species by the total surface sampled in the given
station. Species richness was then expressed in number of species per square
meter sampled.

### Network inference 

```{r}
myload(metaweb_analysis, dir= mypath("data"))
myload(trophic_class, dir= mypath("data", "classes"))
meta <- metaweb_analysis
#metaweb_analysis$resource
#meta$metaweb[meta$resource, meta$resource]
```

We determined the network structure in two steps: (1) build a metaweb describing the
trophic interactions between all fishes and the resources (Fig.
SXX), then (2) determine network of a given community by
extracting the metaweb according to the fishes present at a given
site and sampling event (Fig. \@ref(fig:matmet)C and D).

The trophic interaction network was inferred from body size and ontogenic diet
shift following previous studies [@edeline_ecological_2013;
@gravel_inferring_2013; @poisot_structure_2016; @brose_predator_2019]. The diet
of stream fishes, as for many organisms, shifts throughout an individual's life,
and thereby with body size. For example, larvae and small juveniles feed on plankton while adults
may feed on algae and fishes, with bigger individuals eating bigger fishes. Each
fish species was hence divided in nine body size classes, each corresponding to
a trophic species (appendix B, Fig. S2). Additionally to the trophic species, we added
seven resource nodes present in the ontogenic food diet database: detritus,
biofilm, phytoplankton, zooplankton, macrophages, phytobenthos and zoobenthos
(grey nodes in Fig. \@ref(fig:matmet)C & D). The trophic species and the
resources constituted the 412 nodes of the metaweb, i.e. 45 fish species divided
into nine body size classes plus seven resource nodes. The inference of trophic
interactions was shown to be more accurate when considering body size classes,
i.e. trophic species, than species [@jennings_weak_2001].

The feeding interactions of a fish node, i.e. a trophic species, were determined
by both its species identity and its body size. The ontogenic fish diet
database was filled according to fishbase and literature (appendix A, Table S2). Each
fish species had two or three life stages which are delimited by its body size
range (appendix B, Fig. S2). The life stage of a fish trophic species was determined by 
the center of its body size range, hereafter midpoint (appendix B, Fig. S2).

For a piscivorous trophic species, the fish-fish trophic links were defined in
two steps and based on the body size ratio between predators and prey. First of
all, the predation window of a piscivorous trophic species was defined as 3% to
45% of its midpoint [@mittelbach_ontogeny_1998; @claessen_impact_2002;
@hart_handbook_2008]. Then, a trophic link was set between the piscivorous
trophic species and every trophic species whose midpoint in bodysize range was
included in the predation window (appendix B, Fig. S2). The fish-resource trophic links were
set between the trophic species and the resources nodes according the food items
of their size class.  Lastly, the trophic links among resource nodes were set
according to the literature [@allan_stream_2007; @hart_handbook_2008].

### Network structure

For each food-web, corresponding to a particular site and year, we computed the
connectance and mean trophic level. Connectance describes the level of
generalism in the network and is calculated as the actual number of interactions
divided by the number of interactions if all species interact ($C = L / N^2$, L
and N being resp. the number of links and of nodes).  The trophic level of the
nodes was computed as one added to the average trophic level of its food item.
The average trophic level $\overline{T}$ was computed as the average trophic
level of the trophic species weighted by their biomass (excluding resource nodes
for which we had no biomass information), so $\overline{T} = \sum_i^N{B_iT_i
\times (\sum_i^N{B_i})^{-1}}$, with $T_i$ and $B_i$ being respectively the
trophic level and the biomass of the node $i$. For each site, the median of
connectance and average trophic level over time was used in subsequent analysis
(Fig. \@ref(fig:matmet)C & D).


```{r, message = FALSE, results = FALSE}
# Com
com_data <- compute_community_temporal_analysis(.op = op_analysis_bbb,
 type_network_metrics = "classes"
)
# Compute sem dataset
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]],
  hab_press = habitat_pressure,
  sync = com_data[["sync_std"]],
  nmds = NULL,
  basin = st_basin
  )
mysave(sem_data, dir = mypath("data"), overwrite = TRUE)
```


## Environmental variables

We characterised the sites by their altitude, slope, distance from
source, stream width, depth and strahler order, i.e. its position in the
stream network hierarchy. We obtained data on water temperature, flow and Biological Oxygen
Demand (BOD) from the naiades
database
[(www.naiades.eaufrance.fr)](http://www.naiades.eaufrance.fr/). As data from naiades are
not collected on the same site as our fish sampling sites, we performed an
interpolation of the water temperature and flow based on the spatial stream
network models [@isaak_applications_2014; @hoef_ssn:_2014]. The interpolation procedure
is detailed in appendix B (part 1.4).

We had one environmental variable value for each sampling event, except
for water temperature for which the record began in 2006. Then, we computed the
average and temporal CV values of water temperature, flow, BOD, river width and
depth. As habitat and environmental variables are often collinear, a principal
component analysis (PCA) was performed on the 14 scaled variables. We kept in
the analysis the two first principal components based on the elbow method, on
the eigenvalues distribution (appendix B, Fig. SXX). The two first principal components
explained `r tot_var_expl_pca`% of the variance (Fig. \@ref(fig:matmet)B). A varimax axis rotation was
performed to maximize the representation of the environmental variables by the principal
components [@kaiser_varimax_1958; @revelle_psych_2019]. The first axis
represented a gradient from small to big streams, characterized by their width
and depth, but also a gradient from stream close to far from the source. We
reversed the values of the second axis, such as it represented a gradient of
increasing average water temperature, average BOD and decreasing altitude and slope.
Further description of the variables are provided in appendix B (part 1.4).

## Statistical analysis 

We analyzed the relationships among environment, species richness, food-web
structure, community biomass and its temporal stability with structural equation
models as they enable the assessment of potential indirect and direct causal
relationships among multiple variables [@grace_structural_2008;
@grace_causal_2014; @lefcheck_piecewisesem_2016; @grace_integrative_2016].  We
defined a structural equation model explaining the median annual community
biomass as a function of the two synthetic environmental variables, species
richness and food-web structure [@maureaud_biodiversityecosystem_2019;
@woods_testing_2020]. We assumed that both species richness and food-web
structure directly affect community biomass (Fig. \@ref(fig:sem-bm)A) and that
species richness affected food-web structure [@winemiller_must_1989;
@dunne_network_2006; @thebault_stability_2010].  

We used the same model structure to assess the drivers of temporal stability
of community biomass (Fig.  \@ref(fig:sem-stab)A). Instead of the
annual community biomass, we modelled the synchrony and $\overline{CV_{sp}}$ which
in turn determined the temporal stability of community biomass. We linearized
the mathematical relationship linking temporal stability to $\overline{CV_{sp,
i}}$ and $\phi$ by taking the log of
temporal stability such as 

\begin{equation} 
    \log S_i = - \log \overline{CV_{sp, i}} - \frac{1}{2} \log \phi_i
  (\#eq:stab)
\end{equation} 

The structural equation models were based on Gaussian linear mixed-effects models. All variables
except the connectance and average trophic level
were log-transformed to fulfill model assumptions (see residual plots and data
transformation in Fig. S5 and S6, Table S5, appendix B). We set the seven
hydrographic basins as a random effect on the intercept to
account for their heterogeneity. We checked for the absence of multicollinearity 
with Variance Inflation Factor (VIF, Table S6, appendix B). The slopes reported
in the main text were standardized in order to compare their magnitude ($r_\delta
= \beta \frac{\sigma_x}{\sigma_y}$, $\beta$ being the unstandardized slope,
$\sigma_x$ and $\sigma_y$ being respectively the standard deviation of the
predictive variable $x$ and of the response variable $y$). Therefore, the
standardized coefficients expressed the variation of $x$ and $y$ in standard
deviation units. According to the equation (\@ref(eq:stab)), the unstandardized
coefficients of synchrony and $\overline{CV_{sp}}$ determining temporal
stability of biomass are respectively $-0.5$ and $1.0$. When standardized, a 
comparaison of those coefficients comes down to a comparaison of the standard
deviation of these two variables. The paths whose slope had a $P$ value inferior
or equal to $0.05$ were reported in the main text, all the path values are
presented in Table S7 and S8.

Indirect effects on community biomass and its temporal stability were computed
by multiplying slopes along the path. Only significant direct slopes were
included in the calculation of indirect effects. Total effects were computed as
the sum of direct and indirect effects.

Environmental variables were interpolated with the `openStars` and `SSN`
R packages [@kattwinkel_openstars_2018; @hoef_ssn:_2014]. Linear models and SEMs
were computed with respectively the `nlme` and `piecewieseSEM` R packages
[@pinheiro_nlme_2020; @lefcheck_piecewisesem_2016]. The code used for the
analysis and to generate the manuscript are accessible on github
(alaindanet/fishcom). The analyses were performed with R version 3.6.3
[@r_core_team_r_2020].

```{r get-data}
library(piecewiseSEM)
library(lme4)
library(nlme)

#ctrl <- lmeControl(opt='optim' relative)
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
```

```{r}
# Compute SEMs
stab_sem_rich <- compute_stab_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem_rich <- compute_prod_sem_rich(.data = sem_data,
  random_effect = as.formula("~1|basin"))

def_env_x_pos <- c(from = 0, to = 3)
asp <- 1.6

library(DiagrammeR)
meta_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability","figs", "meta_stab_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  metamodel = TRUE,
  inverse_y_node_pose = TRUE
)
p_stab_sem_rich <- export_diagram(
  fit = stab_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "figs", "stab_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  inverse_y_node_pose = TRUE
)

meta_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "figs", "meta_bm_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  metamodel = TRUE,
  inverse_y_node_pose = TRUE
)
p_bm_sem_rich <- export_diagram(
  fit = bm_sem_rich,
  file_path = mypath("manuscript", "bef_stability", "figs", "bm_sem"),
  format = "pdf",
  width = 700*2,
  height = 700*2 * asp,
  arrows = "ortho",
  val_thd = 0.05,
  env_x_pos_range = def_env_x_pos,
  env_y_pos = 0,
  env_y_sep = 1.5,
  order_env_node = c("log_RC1", "log_RC2"),
  inverse_y_node_pose = TRUE
)
```


```{r get-sem-coeff}
coef_stab_sem <- coef(stab_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value <= 0.05)

coef_bm_sem <- coef(bm_sem_rich) %>%
  select(- 9) %>%
  filter(P.Value <= 0.05)
```


```{r, cache = FALSE}
sem_caption <- paste0(
  "Metamodel of the Structural Equation Models for the (A) median of annual
  community biomass (in grams by square meter) and (C) its temporal stability.",
  "Results of the Structural Equation Models for
  (B) the median of annual community biomass and (D) its temporal stability. Red and black
  arrows represent respectively negative and positive path coefficients. The
  path coefficients are standardized. For convenience, only significant
  paths (i.e. $P < 0.05$) are shown. Rsq: Adjusted $R^2$; Avg:
  Average, CVsp: weighted temporal CV of the population; PCA1 and PCA2: respectively the first and
  second axis of the PCA performed on environmental variables (see methods)."
)
```



```{r get-bm-sem-single-effect}
bm_sem_coef <- filter(coef_bm_sem, P.Value <= 0.05)

rich_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_rich_tot_std")
rich_on_tlvl <- get_clean_sem_coef(sem = bm_sem_coef, resp = "t_lvl", pred = "log_rich_tot_std")
rich_on_ct <- get_clean_sem_coef(sem = bm_sem_coef, resp = "ct", pred = "log_rich_tot_std")
tlvl_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "t_lvl")
ct_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "ct")
RC1_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC1")
RC2_on_bm <- get_clean_sem_coef(sem = bm_sem_coef, resp = "log_bm_std", pred = "log_RC2")
```

```{r get-bm-tot-effect-env}
bm_all_params <- get_coefficient_piecewisesem(sem = bm_sem_rich, p_val_thl = NULL)

# effect of env on bm 
env_on_bm <- get_env_on_bm(fit = bm_all_params, p_val_thl = 0.05,
  type = "std")
# rich on bm 
rich_on_bm <- get_rich_on_bm(fit = bm_all_params,
  p_val_thl = 0.05, type = "std")
# direct
ct_on_bm_trick <- list(direct = c(ct = ct_on_bm), total = c(ct = ct_on_bm))
tlvl_on_bm_trick <- list(direct = c(t_lvl = tlvl_on_bm), total = c(t_lvl = tlvl_on_bm))


tmp_bm_indir_table <- map(list(env_on_bm, rich_on_bm, ct_on_bm_trick,
    tlvl_on_bm_trick),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```

```{r}
stab_all_params <- get_coefficient_piecewisesem(sem = stab_sem_rich, p_val_thl = NULL)
# effect of env on stab
env_on_stab <- get_env_on_stab(fit = stab_all_params, p_val_thl = 0.05,
  type = "std")
rich_on_stab <- get_rich_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
ct_on_stab <- get_ct_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
tlvl_on_stab <- get_tlvl_on_stab(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")

tmp_stab_indir_table <- map(list(env_on_stab, rich_on_stab, ct_on_stab, tlvl_on_stab),
  ~as_tibble(c(.x, list(variable = names(.x[[1]]))))
  ) %>%
bind_rows()
```
```{r get-sem-single-effect}
stab_sem_coef <- filter(coef_stab_sem, P.Value < 0.05)

sync_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_sync")
cv_sp_on_stab <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_stab_std", pred = "log_cv_sp")
RC1_on_sync <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_sync", pred = "log_RC1")
tlvl_on_cv_sp <- get_clean_sem_coef(sem = stab_sem_coef, resp = "log_cv_sp", pred = "t_lvl")
```

```{r get-sem-tot-effect-env}
# effect of env on sync and cv_sp
env_on_sync <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
env_on_cv_sp <- get_env_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
# env on stab via network 
env_on_t_lvl <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "t_lvl", type = "std")
env_on_ct <- get_env_on_com(fit = stab_all_params,
  p_val_thl = 0.05,
  com = "ct", type = "std")
env_on_richness <- get_env_on_rich(fit = stab_all_params,
  p_val_thl = 0.05, type = "std")
```


# Results

The structural equation models explained a large part of the variation
of species richness, connectance, synchrony, $\overline{CV_{sp}}$ and total
biomass (resp. $R^2 = .43$, $.38$, $.46$, $.47$ and $.32$) but less so for mean
trophic level ($R^2 = .11$, Fig. \@ref(fig:sem-bm)A and \@ref(fig:sem-stab)A). We found a
negative relationship between species richness and mean trophic level ($r_\delta
= `r rich_on_tlvl`$, $r_\delta$ meaning standardized slope) and connectance
($r_\delta = `r rich_on_ct`$, Fig.  \@ref(fig:sem-bm)A and \@ref(fig:sem-stab)A), meaning that a
part of the effects of species richness on community biomass and its temporal
stability went through food-web structure.

## Species richness and average trophic level are positively correlated with community biomass

```{r get-sem-tot-effect-rich}
rich_on_sync <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_sync", type = "std")
rich_on_cv_sp <- get_rich_on_stab_comp(fit = stab_all_params,
  p_val_thl = 0.05,
  stab_comp = "log_cv_sp", type = "std")
```

Species richness and mean trophic level had a significant positive direct effect
on community biomass ($r_\delta = `r rich_on_bm$direct`$ and 
$r_\delta = `r tlvl_on_bm`$ resp., Fig. \@ref(fig:sem-bm)A, Table
\@ref(tab:indir-sem)), while connectance had no direct effect.

The two PCA axes synthesising environmental variables had no significant direct
effects on community biomass, but indirect (Table \@ref(tab:indir-sem)). The first
axis, related to the stream size, was positively linked to community biomass
($r_\delta = `r env_on_bm$total["log_RC1"]`$, Table \@ref(tab:indir-sem)),
through both species richness and mean trophic level ($r_\delta = 
`r env_on_bm$via_richness["log_RC1"]`$ and $`r env_on_bm$via_tlvl["log_RC1"]`$
resp., Table \@ref(tab:indir-sem)). The second axis, related to the average
annual temperature was positively related
to community biomass ($r_\delta = `r env_on_bm$total["log_RC2"]`$, Table
\@ref(tab:indir-sem)), mainly through species richness ($r_\delta = 
`r env_on_bm$via_richness["log_RC2"]`$, Table \@ref(tab:indir-sem)). Streams
with higher temperature and BOD contained more species, indirectly increasing
community biomass. The total effect of PCA1, PCA2 and species richness on
community biomass were of the same magnitude.


## Temporal stability of annual community biomass

By its effects on synchrony and population variability ($\overline{CV_{sp}}$), species richness had a
negative total effect on biomass stability ($r_\delta = `r rich_on_stab$total`$,
Table \@ref(tab:indir-sem)). This effect resulted from two opposite effects. On
the one hand, species richness had a direct negative effect on synchrony
($r_\delta = `r rich_on_sync$direct`$), thereby
increasing stability ($r_\delta = `r rich_on_stab$via_sync`$). On the other
hand, species richness had a positive direct effect on $\overline{CV_{sp}}$
($r_\delta = `r rich_on_cv_sp$direct`$),
thereby decreasing biomass stability ($r_\delta = `r rich_on_stab$via_cv_sp`$, Table
\@ref(tab:indir-sem)), which outweighted the decreasing effect of species
richness on synchrony. The
negative effect of $\overline{CV_{sp}}$ on temporal stability was twice higher
than the negative effect of synchrony (resp.
$r_\delta = `r cv_sp_on_stab`$ and $r_\delta = `r sync_on_stab`$, Fig.
\@ref(fig:sem-stab)A).

The total effect of mean trophic level and species richness on temporal
stability of biomass were of the same magnitude (resp.
$`r tlvl_on_stab$total["t_lvl"]`$ and $`r rich_on_stab$total`$, Table
\@ref(tab:indir-sem)).
The mean trophic level had only a direct negative effect on
$\overline{CV_{sp}}$ ($r_\delta = `r tlvl_on_cv_sp`$,
Fig. \@ref(fig:sem-stab)A) and thereby had a total positive
effect on temporal stability ($r_\delta = `r tlvl_on_stab$via_cv_sp["t_lvl"]`$,
Table \@ref(tab:indir-sem)). Food webs in which community biomass is located on
average at higher trophic levels thus tend to have higher population and
community stability. Connectance had no significant direct effect on either
$\overline{CV_{sp}}$ nor synchrony and thus no effect on temporal stability
(Fig. \@ref(fig:sem-stab)A, Table \@ref(tab:indir-sem)).
 
The total effect of PCA2, related to average annual temperature and BOD, on temporal
stability was of higher magnitude than the effects of species richness and mean
trophic level (Table \@ref(tab:indir-sem)).
The PCA2 had a total negative effect on temporal stability, meaning that higher
temperature and BOD results in lower stability
($r_\delta = `r env_on_stab$total["log_RC2"]`$, Table \@ref(tab:indir-sem)). 
PCA2 had an indirect positive effect on temporal stability through a
direct positive effect on mean trophic level ($r_\delta = 
`r env_on_stab$via_tlvl["log_RC2"]`$, Table \@ref(tab:indir-sem)). However, PCA2
had a negative effect on temporal stability through a direct positive effect on 
$\overline{CV_{sp}}$ and species richness (resp.  $r_\delta = 
`r env_on_cv_sp$direct["log_RC2"]`$ and $r_\delta = `r env_on_stab$via_richness["log_RC2"]`$,
Table \@ref(tab:indir-sem)). This was also true for the PCA1, related to stream
size, with a resulting very slight positive effect of PCA1 on temporal stability
($r_\delta = `r env_on_stab$total["log_RC1"]`$, Table \@ref(tab:indir-sem)).
Warmer and larger streams thus tend to have more species and more variability in
population biomass, then have a lower stability of community biomass.

```{r, cache = FALSE}
cap_sem <- paste0(
  "Direct, indirect and total effects of environment, species richness,
  connectance and mean trophic level on community biomass
  and its temporal stability. Indirect effects are computed by multiplying the
  path coefficients from the variable predictor to the response variable.
  Indirect effects are considered as one step from the target variable. For
  exemple, the indirect effect of species richness on
  biomass stability via its effect on CVsp is $-0.62$. Only the
  significant direct effects were retained for the computation of indirect
  effects. ", "As an example, the indirect effect via species richness takes
  into account the direct effect of species richness as well as the effect of
  species richness through connectance and average trophic level. ",
 "NA values indicate that the corresponding paths do not exist in the
 specified Structural Equation Model (SEM). ", "NS: statistically non-significant."
)
```

```{r indir-stab, cache = FALSE}

full_table <- bind_rows(
  tmp_bm_indir_table,
  tmp_stab_indir_table
) %>%
mutate(`SEM type` = c(rep("Total annual biomass", 5), rep("Temporal Stability of annual biomass", 5))) %>%
select(`SEM type`, variable, direct, via_richness, via_ct, via_tlvl, via_cv_sp, via_sync, total) %>%
format_table() %>%
select(`SEM type`, everything())

full_table %<>%
  mutate(Direct = ifelse(Direct == 0, "NS", Direct)) %>%
  mutate_if(is.numeric, format, digits = 2, nsmall = 2)

library(kableExtra)
mytable <- kable(full_table,
  format = "latex",
  booktabs = T,
  label = paste0("indir-sem"),
  caption = cap_sem
  ) %>%
kable_styling(latex_options =c("scale_down")) %>%
add_header_above(c(" " = 3, "Indirect effects via" = 5)) %>%
column_spec(1:2, width = "3cm") %>%
collapse_rows(columns = 1, valign = "top")
#write(mytable, file = mypath("manuscript", "bef_stability", "table.tex"))
```


# Discussion

---
#This study is unique by its level of integration, from environmental
#effects to total biomass and its stability, going through species richness and
#food-web structure. It is the first direct assessment of a possible joint effect
#of species richness and network structure on both total biomass and its temporal
#stability. We found that species richness and mean trophic level had a positive
#effect on total biomass. In contrast, species richness had a negative effect on
#temporal stability whereas mean trophic level covaried positively. We also found
#that the effect of species richness and mean trophic level on total biomass and
#its temporal stability were not independent as species richness had a negative
#effect on mean trophic level. Furthermore, we found that connectance had no
#significant effect on both total biomass and its temporal stability. The results
#shows that temporal stability was mediated by changes in species variability 
#rather than synchrony. Finally, we found that the magnitude of the effects of
#average temperature and altitude was equal or superior to the effects of species
#richness and mean trophic level. 
---

## Species richness increased community biomass but decreased its temporal stability 

We found that species richness increased community biomass as already
found in plant and tree communities [@hector_plant_1999;
@tilman_biodiversity_2014; @wu_relationship_2015; @li_relationship_2018] as well
as in fish communities [@maureaud_biodiversityecosystem_2019;
@woods_testing_2020]. The positive effect of species richness on community biomass
might be due to resource use complementarity [@carey_determining_2011], which is
driven by niche differentiation [@loreau_biodiversity_1998;
@loreau_partitioning_2001] or to the higher probability to include high biomass
species with higher species richness [@loreau_biodiversity_2001]. Our results
are also in agreement with a model predicting a positive relationship between
animal diversity and total consumer biomass in size-structured food-web
[@schneider_animal_2016].

Surprisingly, we found a negative relationship between temporal stability and
species richness. It contrasts with experimental studies in grasslands
[@tilman_biodiversity_2006; @valencia_synchrony_2020], mesocosms
[@pennekamp_biodiversity_2018] with studies on natural communities such as
butterflies  or lotic fishes [@olivier_urbanization_2020; @franssen_annual_2011
], where positive relationships were found between temporal community
stability and species richness. However, some other studies also found a
negative relationship, for instance in natural grasslands [@yang_effects_2011]
or a marginal relationship in natural forests [@declerck_species_2006]. 

As most studies on experimental grasslands [@isbell_biodiversity_2009;
@roscher_identifying_2011] and natural communities of birds, grasslands, bats
and butterflies [@bluthgen_land_2016; @olivier_urbanization_2020], we found that
species richness decreases synchrony, thereby increasing stability [but see
@declerck_species_2006; @valencia_synchrony_2020]. Our study thus extends the
evidence that species richness decreases synchrony to the case of multi-trophic
communities. Species richness can reduce synchrony when (i) a given increase in species
richness raises demographic stochasticity by decreasing population
sizes, or when (ii) species have different responses to environmental variation
[@loreau_species_2008].

The positive effect of species richness on
$\overline{CV_{sp}}$, thereby decreasing stability, is more intriguing. While
studies focusing on single-trophic communities have reported mixed effects of
species richness on $\overline{CV_{sp}}$, with destabilising effects of species
richness at population level in grasslands [@jiang_different_2009;
@gross_species_2014], a previous meta-analysis suggested that species richness had
often a positive effect on population stability in multi-trophic communities
[@jiang_different_2009].
In food-webs, theoretical models predict that the relationship between temporal
stability of populations and species richness depends on interaction strength
and its distribution [@mccann_reevaluating_1997; @thebault_trophic_2005;
@downing_temporal_2020], with stronger interactions promoting a negative
relationship between species richness and stability. Therefore, it is possible
that our results are due to strong trophic interactions, leading to more
fluctuations in population biomass, but this hypothese was not testable with the
available dataset.  Alternatively, our results might be explain by the effect of
increasing species richness which can increase demographic stochasticity.

---
#@thibaut_understanding_2013 proposed that a
#strongly uneven biomass distribution across populations and that the biomass
#variance of population increases much faster than its mean can generate a
#positive effect of species richness on population ($\overline{CV_{sp}}$)
#stability.
---


## Average trophic level increased community biomass and its temporal stability while connectance had no effect

The average trophic level was positively linked to community biomass.
@wang_biodiversity_2018 have shown that total nutrient uptake might increase
with the length of trophic chains and so results in higher community biomass. While
the predictions of @wang_biodiversity_2018 were restricted to food chains, and
thus might not hold in more complex food-webs with omnivory, our
results are in agreement with their model predictions and highlight the
importance of food chain length as a determinant of community biomass in food-webs.
In addition, mean trophic level had a positive effect on biomass stability by
its negative effect on $\overline{CV_{sp}}$, thereby increasing average
population 
stability. This effect might result from a higher stability of population of higher
trophic level as predicted by food chain models in the presence of strong
top-down control [@shanafelt_stability_2018; @barbier_pyramids_2019]. An
alternative explanation is that higher mean trophic level complexify the biomass
fluxes through the food-webs, which might reduce biomass fluctuations in lower
trophic levels [@mccann_diversitystability_2000].

In contrast, connectance had no effect on community biomass. One might have expected
that an increase in connectance may translate in a higher total nutrient uptake
and so results in higher community biomass in the fish compartment. 
However, some studies suggest that a greater connectance should decrease
complementarity in resource use between species, which is expected to
lower community biomass [@thebault_food-web_2003; @poisot_trophic_2013].

Regarding temporal stability, our results contrast with numerous previous
theoretical studies on the relationship between
connectance and stability [e.g., @angelis_stability_1975; @may_will_1972;
@thebault_stability_2010; but see @neutel_reconciling_2007], although they
considered different stability concepts and metrics [@arnoldi_resilience_2016].
The lack of effect of connectance on the temporal stability of community biomass
might be related to the fact that our measure of connectance does not take into
account the distribution of interaction strengths in the food-webs. Indeed,
food-web connectance is expected to have different consequences on the temporal
stability of community biomass depending on the strength of trophic interactions
[@thebault_trophic_2005]. However, our food-webs lack information about the lower
compartments of the community, i.e. primary producers, decomposers and the benthic
part of the food-web. Further research should examine the effects of connectance
on community biomass and its temporal stability in more complete empirical food-webs. 

One limitation of our study is indeed the use of inferred networks, i.e. not
observed interactions. However, this approach is a promising way to explore how the
architecture of ecological networks vary along environmental gradients and across
time. It constitutes an interesting complement to the real assessment of
ecological interactions because it allows to extract most
of the information contained from already available long term datasets.

## Population stability was the main driver of community temporal stability

The population variability and synchrony are mathematically linked to the
stability of community biomass (see Methods), so the comparaison of their effect
reflected that the the comparaison of their variability. In contrast with
previous studies, we found that the average population variability
($\overline{CV_{sp}}$) had a stronger negative effect on the stability of
community biomass than synchrony [@olivier_urbanization_2020], meaning that the
variability of synchrony was equivalent the one of population variability. It
explains why we observe a negative effect of species richness on temporal
stability of community biomass whereas species richness had a strong negative
effect of synchrony. The lower variability of synchrony might be explained by
the presence of generalist predators in stream communities, which can promote
synchrony between prey species that share the same predator and thus reduces
compensatory population dynamics [@raimondo_interspecific_2004]. Alternatively,
it is possible that, in aquatic food-webs, the occurrence of large oscillatory
dynamics leads to a higher variability of population variability rather than
synchrony to community stability [@mccann_reevaluating_1997]. How both strengths
of interactions and the relative contribution of synchrony and population
variability to overall stability vary between food-webs and single trophic
communities is still an open question.

Our results raise the question of the fundamental differences between single and
multi-trophic communities. Some mechanisms are transferable from the first to
the second such higher connectance which might translate in higher competition
between consumers and thus destabilise populations [@thebault_trophic_2005].
However, the existence of top-down and bottom-up effects are obviously typical
to multi-trophic communities. The population at the top of a food-web are
limited by the growth of its prey (bottom-up effects) while the lower trophic
levels are limited by both their predators (top-down effect) and their preys
(bottom-up effects). We can conjecture that the stability of food-webs mainly
controlled by bottom-up effects will display higher synchrony while the
food-webs mainly controlled by top-down effects will display higher population
variability. In sum, average synchrony and population variability might be
characteristic of communities more or less controlled by top-down or bottom-up
effects.

---
#Rough average synchrony in Théophile study: exp(-0.75) = .47 or exp(-0.6) = .54
#This study: sync avg = .69
---


## Environment had an strong effect on community biomass and its temporal stability 

We found that environmental drivers affect community biomass mostly indirectly
[@woods_testing_2020] rather than directly, contrasting with previous studies
[@yvondurocher_warming_2011; @dossena_warming_2012; @grace_integrative_2016;
@maureaud_biodiversityecosystem_2019]. First, consistent with research showing
that food-webs in wider streams support more species and biomass
[@allan_stream_2007], we found that the PCA axis related to stream size had a
positive effect on community biomass through a positive effect on mean trophic level
and species richness. Greater ecosystem size might provide a higher diversity
of resources through habitat heterogeneity, and so higher species richness and
community biomass by surface unit, through complementarity in resource use. Greater
diversity of resources can also maintain more biomass at high trophic level
[@post_ecosystem_2000; @doi_resource_2009]. Second, the positive effect of the
PCA axis related to temperature on community biomass was of the magnitude of the
effects of food-web structure and species richness, in line with the mounting
body of work reporting important effects of temperature on the structure and
biomass of aquatic systems [e.g.  @dossena_warming_2012;
@edeline_ecological_2013; @emmrich_geographical_2014; @hattab_forecasting_2016;
@woods_testing_2020]. We found that warmer streams
supported higher diversity as well as higher average trophic level and total
biomass, which is in agreement with recent findings on streams.

While the PCA axis related to stream size had only a weak effect on the temporal
stability of community biomass, the PCA axis related to temperature had a
negative effect on temporal stability through a direct destabilizing effect on
populations and through indirect effects. Temperature can have both stabilizing
and destabilizing effects in resource-consumer models depending on the thermal
niche of the species and on how nutrient supply varies with temperature
[@uszko_effects_2017]. The observed increased variability of populations might
also relate with ecosystem enrichment [@ogorman_unexpected_2017] because average
Biological Oxygen Demand covaries with the PCA axis related to average
temperature (Fig. \ref{fig:matmet}B). Enrichment can increase CV by increasing
population biomass fluctuations while higher temperature might decrease
stability through starvation resulting from high metabolic activity
[@tabi_warming_2019].

---
#Interestingly, the two PCA axes related to environmental conditions had indirect
#effects on stability through two conflicting pathways, either stabilising, via
#network structure, or destabilising, via species richness. The first pathway
#consists in a positive effect of temperature and stream size on mean
#trophic level, in line with the idea that wider streams and warmer conditions
#are favourable to mesotrophic predators [@allan_stream_2007;
#@emmrich_geographical_2014], which in turn stabilises biomass fluctuations,
#possibly due to increased top-down regulation. The second pathway consists in a
#positive effect of temperature and stream size on species richness, which itself
#has a destabilising effect. This result is interesting in that both
#pathways had not been evidenced to jointly play, to the best of our knowledge.
#Furthermore, it is unclear which pathway is dominating, and under which circumstances,
#opening an interesting avenue for further investigations.
---

---
## Final thoughts about empirical food-webs

#It was unexpected that the average population $\overline{CV_{sp}}$
#had a stronger negative effect on biomass stability than synchrony
#[@bluthgen_land_2016; @olivier_urbanization_2020], and explain why we observe a
#negative effect of species on temporal stability of biomass. The lower effect of
#synchrony can be explained by the  presence of generalist predators in stream
#communities, which can raise synchrony between prey species which shares the
#same predator [@raimondo_interspecific_2004]. Uneven population biomass within
#communities also raise synchrony between species [@thibaut_understanding_2013].

#As found in other studies, we found that species richness was negatively related
#to mean trophic level and connectance [@winemiller_must_1989;
#@dunne_network_2006; @thebault_stability_2010]. Species richness had thus a
#consistent destabilising effect on temporal stability of biomass directly and
#through average trophic level, but it has a direct positive effect on total annual
#biomass directly but a negative one through the decrease of average trophic
#level. It highlights the importance to consider several aspects of
#network structure to order to improve our understanding of the drivers of
#community structure and stability.
---

# Conclusion

Our work contributes to bridging the gap between theoretical, experimental and
empirical findings on the functioning and stability of communities. Our study
extends the assessment of the effect of species richness on community biomass and
its temporal stability to the case of food-webs in natural settings and
highlights the need to consider species richness, food-web structure and their
dependence to understand both functioning and stability of communities. Further,
we found that the effects of environmental gradient related to temperature and
ecosystem size are largely mediated by their impact on richness and average
trophic level. Finally, our results highlight population variability as key in
transmitting effects of richness, network structure and environmental gradients
on community stability. This contrast with previous results found in single
trophic communities, mostly plants, that mainly focus on synchrony and, although
further confirmation are needed, might be characteristic of animal and/or
multi-trophic communities. Food-web reconstruction methods enable to confront
theory and experiment to empirical data. With the increasing availability of
long-term empirical data, we believe that those methods have a great potential
to increase our understanding of the role of food-web structure on ecosystem
functioning.



```{r}
save.image(file = mypath("manuscript", "bef_stability", "result", "workspace.rda"))
```

# References {-}

<div id="refs"></div>

\clearpage

# Figures and Table {-}


```{=latex}
\input{table.tex}
```

\clearpage

```{r, cache = FALSE}
pca_caption <- paste0(
  "(B) Rotated axis of PCA on environmental variables. The five components
  explained, ", tot_var_expl_pca, "% of the variance (",
  paste0(names(prop_var_expl_pca), ":", prop_var_expl_pca, "%"), ").",
  " Axis 1 was positively related to the stream size, axis 2 was related to
  the stream slope and altitude and negatively related to average water temperature and
  BOD. For simplicity, we reversed the second axis of the PCA in the structural equation
  models, so that the second axis covaries with average water temperature and
  BOD."
  )

matmet_cap <- paste0( 
  "(A) Observation sites (black dots) were located across France and monitored
  on the period 1995-2018. The red dots show the location of (C) and (D) sites.
  ", " Inner borders draw the limits of the hydrographic basins. ", pca_caption,
  " (C) and (D) The temporal dynamic of population biomass with three networks
  of years 1997, 1999 and 2002. Each trophic species is represented
  by a node and each color represents a species. The node size are proportional to
  the biomass of the trophic species. The seven resource nodes are drawn in grey. ",
  "The species names corresponding to the three digit codes are found in Table
  S1.")

```

```{r matmet, cache = FALSE, fig.cap = matmet_cap, results = "fig.show", out.height="80%"}
library(knitr)
include_graphics(path = mypath("manuscript", "bef_stability", "figs", "fig1_modif.pdf"))
```

\clearpage

```{r, cache = FALSE}
sem_caption <- paste0(
  "Structural Equation Models for the median of annual
  community biomass (in grams by square meter) and (C) its temporal stability.",
  " Results of the Structural Equation Models for
  (B) the median of annual community biomass and (D) its temporal stability. Red and black
  arrows represent respectively negative and positive path coefficients. The
  path coefficients are standardized. For convenience, only significant
  paths (i.e. $P < 0.05$) are shown. Rsq: Adjusted $R^2$; Avg:
  Average, CVsp: weighted temporal CV of the population; PCA1 and PCA2: respectively the first and
  second axis of the PCA performed on environmental variables (see methods)."
)
```

```{r}

sem_bm_caption <- paste0( "Species richness and average trophic level are
  positively linked to community biomass. (A) Structural Equation Model for the
  median of annual community biomass (in grams by square meter). Dotted and
  solid arrows represent respectively negative and positive path coefficients.
  Non significant paths are shown in grey. The path coefficients are
  standardized. The $R^2$ are the adjusted $R^2$; Avg: Average, CVsp: weighted
  temporal CV of the population biomass; PCA1 and PCA2: respectively the first
  and second axis of the PCA performed on environmental variables (see methods).
  (B) to (G): significant bivariate relationships between variables of the
  structural equation model. The solid lines show the predictions of the
  statiscal model.")

```


```{r sem-bm, out.width="\\maxwidth", fig.cap = sem_bm_caption, results = "fig.show", cache = FALSE}
#out.height="120%",
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple

#plot_grid(
  #meta_bm_sem_rich, p_bm_sem_rich,
  #meta_stab_sem_rich, p_stab_sem_rich,
  #labels = LETTERS[1:4], nrow = 2,
  #rel_widths = c(1, 1)
#)
# Put the panel of Colin
arrow_dir <- mypath("manuscript", "bef_stability","fleches", "figure_sem2")
filename <- list.files(arrow_dir, full.names = TRUE)
mask <- str_match(filename, "\\.svg")[, 1] %>% is.na %>% !.
#filename[mask]
type <- c("bm", "meta_bm", "meta_stab", "stab")
sem_list <- map(filename[mask], function (x) {
  w <- 2400
  img <- magick::image_read_svg(
    path = x, width = w, height=w*1.618)#, density = 600
  p_sem <- cowplot::ggdraw() +
    cowplot::draw_image(img)#, scale = 1.0
  return(p_sem)
})
sem_list %<>% map(., ~.x + theme(plot.margin = unit(x = rep(0, 4), units = "pt")))
names(sem_list) <- type
sem_plot <- plot_grid(
  plotlist = sem_list[c("meta_bm", "bm", "meta_stab", "stab")],
  labels = "AUTO" 
  )
save_plot(
  filename = mypath("manuscript", "bef_stability", "figs",
    "sem_colin.pdf"),
  plot = sem_plot, ncol = 2, nrow = 2,
  base_width = 2.71, base_asp = 1.2 
)
#sem_plot
knitr::include_graphics(mypath("manuscript", "bef_stability", "figs", "fig2.pdf"))
```

\clearpage

```{r}

sem_stab_caption <- paste0("Relationships among environment, species richness,
  food-web structure, stability decomposition and the temporal stability of community biomass. (A)
    Structural Equation Model for the temporal stability of community biomass.
  Dotted and solid arrows represent respectively
  negative and positive path coefficients. Non significant paths are shown in
  grey. The path coefficients are standardized. The $R^2$ are the adjusted
  $R^2$; Avg: Average, CVsp: weighted temporal CV of the population biomass;
  PCA1 and PCA2: respectively the first and second axis of the PCA performed on
  environmental variables (see methods). (B) to (I): significant bivariate
  relationships between variables of the structural equation model. The solid
  lines show the predictions of the statistical model.")
```

```{r sem-stab, out.width="\\maxwidth", fig.cap = sem_stab_caption, results = "fig.show", cache = FALSE}
knitr::include_graphics(mypath("manuscript", "bef_stability", "figs", "fig3.pdf"))
```


