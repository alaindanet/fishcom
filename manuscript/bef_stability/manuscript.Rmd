---
title: Species richness destabilizes trophic communities in freshwater ecosystems
author: Alain Danet, Maud Mouchet, Elisa Thébault and Colin Fontaine
date: \today 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
---

```{r, echo = FALSE}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7),
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = FALSE
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```


# Abstract

# Introduction 

- Research questions:
  - What are the effects of the community structure on total biomass and stability ? 
    1. What are the effects of species richness on total biomass and stability ?
      - effect of species richness
      - effect of trophic group
    2. What are the effects of the community structure on total biomass and stability ?
      - What is the relative effect of the environment relative to the community
	structure ?
      - What is the effect of the community structure on the different
	parts of the stability + total biomass?
	- Effect of horizontal and vertical diversity

# Methods

## Community

```{r}
myload(temporal_community_metrics, dir = mypath("data"))
st_basin <- get_basin_station(sf_obj = FALSE)

myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
myload(temporal_network_metrics, dir = mypath("data", "species"))

stab_div_troph <- temporal_network_metrics_classes %>%
  dplyr::select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group),
    log_rich = log10(richness_med),
    log_bm = log10(biomass_med),
    log_stab = log10(biomass_stab)) %>%
  dplyr::select(station, troph_group, biomass_stab, richness_med, log_rich, log_stab, log_bm, biomass_med) %>%
  dplyr::left_join(st_basin, by = "station")
```

## Habitat and environment

```{r}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_pressure <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)
```

```{r, fig.show = "hide"}
evt_var_mean <- c("flow_med", "temperature_med", "width_river_mean",
  "avg_depth_station_mean", "slope", "alt", "d_source", "strahler", "DBO_med")
evt_var_cv <- c("flow_cv", "temperature_cv", "width_river_cv",
  "avg_depth_station_cv", "DBO_cv")
pca_pressure <- habitat_pressure[, names(habitat_pressure) %in% c(evt_var_mean, evt_var_cv, "station")] %>%
  na.omit

pca_rotated <- compute_rotated_pca(
  .data = pca_pressure[, !names(pca_pressure) %in% "station"],
  naxis = 5 
)

```

## Statistical analysis

```{r get-data, cache = TRUE}
library(nlme)
library(piecewiseSEM)

myload(nmds, habitat_pressure, dir = mypath("report"))
myload(op_analysis, dir = mypath("data"))

# Compute stability, network metrics, etc with ;he new datasets
com_data <- compute_community_temporal_analysis(.op = op_analysis, dest_dir = mypath("data", "species"))

# Compute sem dataset 
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]], 
  hab_press = habitat_pressure, 
  sync = com_data[["sync"]],
  nmds = NULL,
  basin = st_basin 
  )

```


### Relationship between stability and species richness 

$$
\Log_{10}(S_i) = \beta_0 + \beta_R\Log_{10}(x_{Ri}) + \epsilon_{ij}
$$

$$
S_i = 10^(\beta_0 + \beta_R\Log_{10}(x_{Ri}) + \epsilon_{ij})
$$

$$
S_i = 10^(\beta_0) \times 10^(\beta_R\Log(x_{Ri})) * 10^(\epsilon_{ij})
$$

with $i$ being the station $i$.

```{r mod-div-total}
library(lme4)
ctrl <- lmeControl(opt='optim')
ctrl_lmer <- lmerControl(optCtrl = list(method = 'optimx'))
#If we want that the model converges with basin as random slope,
# we have to remove basin with low data
sem_data %>% group_by(basin) %>% summarise(n())
stab_div_mod <- lmer(
  data = sem_data,
  control = ctrl_lmer,
  formula = log_stab ~ log_rich + (1 | basin)
)

stopifnot(!isSingular(stab_div_mod, tol = 1e-05))
#stab_div_colin <- car::vif(stab_div_mod) not use if one response
stab_div_sum <- piecewiseSEM::rsquared(stab_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(stab_div_mod, terms = c("log_rich"), type = "fe")
stab_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich = x,
    basin = group
  )

#
bm_div_mod <- lmer(data = sem_data,
  formula = log_bm ~ log_rich + (1 | basin)
)
bm_div_sum <- piecewiseSEM::rsquared(bm_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(bm_div_mod, terms = c("log_rich"), type = "fe")
#plot(pred, add.data = TRUE)
bm_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich = x,
    basin = group
  )
```

```{r mod-div-troph, fig.show = "hide"}
stab_troph_mod <- lmer(data = na.omit(stab_div_troph),
  formula = log_stab ~ log_rich + troph_group + log_rich:troph_group + (1 | basin)
  #control = ctrl
)
mySumm2 <- function(.) {
  c(beta=fixef(.),sigma=sigma(.), sig01=sqrt(unlist(VarCorr(.))))
}
stab_troph_boot <- bootMer(stab_troph_mod, mySumm2, nsim = 100)
#plot(test,index=2)
stab_troph_ci <- confint(test)

stab_troph_colin <- car::vif(stab_troph_mod)
stab_troph_sum <- piecewiseSEM::rsquared(stab_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(stab_troph_mod, terms = c("log_rich", "troph_group"), type = "fe")
plot(pred_troph_mod, add.data = TRUE)
stab_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich = x,
    troph_group = group
  )

# Productivity and troph group

bm_troph_mod <- lme(data = na.omit(stab_div_troph),
  fixed = log_bm ~ log_rich * troph_group,
  random = ~ 1 + log_rich * troph_group | basin,
  control = ctrl 
)

bm_troph_sum <- piecewiseSEM::rsquared(bm_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(bm_troph_mod, terms = c("log_rich", "troph_group"), type = "fe")
#plot(pred_troph_mod, add.data = TRUE)
bm_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_bm = predicted,
    log_rich = x,
    troph_group = group
  )
```

### SEM

```{r}

# Compute SEMs
stab_sem <- compute_stab_sem(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem <- compute_prod_sem(.data = sem_data,
  random_effect = as.formula("~1|basin"))

library(ggraph)
p_stab_sem <- ggpiecewisesem(stab_sem)
p_bm_sem <- ggpiecewisesem(bm_sem)
```


```{r get-sem-coeff}
coef_stab_sem <- coef(stab_sem) %>%
  group_by(Response) %>%
  nest() %>%
  mutate(sum_c = map_dbl(data, ~ sum(.x$Std.Estimate)))

#cor_mat <- cor(sem_data[, !names(sem_data) %in% c("station", "basin")])
```


# Results

## Species richness has a destabilizing effect on community  

```{r p-s-div}
lim_log_stab <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_stab")
lim_log_rich <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_rich")
# Plot left  
p_stab_div <- sem_data %>%
  ggplot(aes(x = log_rich, y = log_stab))+
  geom_point() +
  ylim(lim_log_stab) +
  xlim(lim_log_rich) +
  labs(x = "Median species richness (Log 10)", y = " Biomass stability (Log 10)") +
  geom_line(data = stab_div_pred) +
  geom_ribbon(data = stab_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .2) +
  annotate("text", x = 1.0, y = .8, label = make_label_rsq(rsq = stab_div_sum),
    parse = TRUE)

# Right plot
p_stab_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich, y = log_stab, color = troph_group)) +
  geom_point() +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  ylim(lim_log_stab) +
  xlim(lim_log_rich) +
  geom_line(data = stab_troph_pred) +
  geom_ribbon(data = stab_troph_pred,
    aes(ymin = conf.low, ymax = conf.high, color = NULL, group = troph_group),
    alpha = .2) +
  annotate("text", x = 0.8, y = .8, label = make_label_rsq(rsq = stab_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = "Median species richness (Log 10)", y = " Biomass stability (Log 10)")

p_stab <- plot_grid(p_stab_div, p_stab_div_troph, ncol = 2, rel_widths = c(.4, .6))
```

```{r p-p-div}
lim_log_bm <- get_min_max(list(sem_data, stab_div_troph), var_chr = "log_bm")

p_bm_div <- sem_data %>%
  ggplot(aes(x = log_rich, y = log_bm))+
  geom_point() +
  ylim(lim_log_bm) +
  xlim(lim_log_rich) +
  labs(x = "Median species richness (Log 10)", y = " Total biomass(Log 10)") +
  geom_line(data = bm_div_pred) +
  geom_ribbon(data = bm_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .2) +
  annotate("text", x = 1.0, y = 5, label = make_label_rsq(rsq = bm_div_sum),
    parse = TRUE)

p_bm_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich, y = log_bm, color = troph_group)) +
  geom_point() +
  ylim(lim_log_bm) +
  xlim(lim_log_rich) +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  geom_line(data = bm_troph_pred) +
  geom_ribbon(data = bm_troph_pred,
    aes(ymin = conf.low, ymax = conf.high, color = NULL, group = troph_group),
    alpha = .2) +
  annotate("text", x = 0.8, y = 5, label = make_label_rsq(rsq = bm_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = "Median species richness (Log 10)", y = "Total biomass (Log 10)")

p_bm <- plot_grid(p_bm_div, p_bm_div_troph, ncol = 2, rel_widths = c(.4, .6))
```

```{r psbm, fig.dim = c(10,5)}
plot_grid(p_stab, p_bm, ncol = 1)
```

- Stability:
  - decreases with richness
  - is higher for higher trophic group
  - increases and decreases with richness for the lower and higher trophic group
    respectively

- richness on stab:
  - globally negative
  -  

## Drivers of total biomass and stability

```{r, fig.show = "hide"}
axis_pair <- list(c(1,2), c(1,3), c(2,3), c(1, 4), c(2, 4), c(3,4), c(4,5))
p_l_rot <- map(axis_pair, 
  function (axis)
    pca_rotated_plot <- plot_rotated_pca(
      pca_rotated = pca_rotated,
      axis = axis 
    )
)
```


```{r sem-plot, fig.dim = c(10,10)}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple
to_plot <- c(1, 6, 7)
plot_grid(
  plot_grid(plotlist = map(p_l_rot[to_plot], ~.x$rotated),
      ncol = length(to_plot), labels = LETTERS[1]),
  plot_grid(p_stab_sem, p_bm_sem, labels = LETTERS[2:3]),
  ncol = 1,
  rel_heights = c(.4, .6)
)
```

- Habitat: (+ / -)
  - RC 1: width & depth & flow med, d source, strahler 	/
  - RC 2: T°C med 					/ slope, alt 
  - RC 3: 						/ flow CV, DBO med
  - RC 4: river width med, depth med 			/
  - RC 5: DBO CV 					/

- Stability:
  - Stability component:
    - CV is the main driver of stability:
  - Community structure: 
    - Richness decreases synchrony but increases CV
    - Trophic level increases synchrony but decreases CV
    - Betadiv increases CV
  - Habitat/Env:
    - very weak to no direct effect on stability
      - direct: CV_sp dec with increasing RC3, cad enrichment and flow_cv decrease.  
    - indirectly affect stability by modulating community structure

- Total biomass:
  - Community structure:
    - Richness increased total biomass / had the bigger effect
    - Even community deceased total biomass
    - Species turnover decreased total biomass  
    - Connectance increased biomass
  - Habitat/Env:
    - very weak to no direct effect on total biomass 
    - Effect of environment is thus mediated by the community structure

- Main outcome:

The effect of richness on biomass stability follows a power law with a negative
coefficient, meaning that it's a decelerating function.

- Latex:
  - csv:
    - https://tex.stackexchange.com/questions/178904/use-datatool-to-read-a-row-from-a-csv-file-then-use-the-variables-in-the-docume
    - https://tex.stackexchange.com/questions/40901/datatool-getting-a-specific-value-given-the-value-of-another-column
  - path: 

# Discussion


# Appendix

```{r}
mod_list <- list(bm_div_mod, bm_troph_mod, stab_div_mod, stab_troph_mod)
plot_res <- map(mod_list, ~ plot(.x))
plot_grid(plotlist = plot_res)
```


# References
