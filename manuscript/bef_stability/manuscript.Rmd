---
title: Species richness destabilizes trophic communities in freshwater ecosystems
author: Alain Danet, Maud Mouchet, Elisa Thébault and Colin Fontaine
date: \today 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")

knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7),
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
source(mypath("R", "community_analysis.R"))
source(mypath("R", "community_methods.R"))
source(mypath("R", "statistical_analysis.R"))
source(mypath("R", "press_methods.R"))
source(mypath("R", "geo_methods.R"))
source(mypath("R", "synchrony.R"))

theme_set(theme_alain())
```


# Abstract

# Introduction 

- Research questions:
  - What are the effects of the community structure on total biomass and stability ? 
    1. What are the effects of species richness on total biomass and stability ?
      - effect of species richness
      - effect of trophic group
    2. What are the effects of the community structure on total biomass and stability ?
      - What is the relative effect of the environment relative to the community
	structure ?
      - What is the effect of the community structure on the different
	parts of the stability + total biomass?
	- Effect of horizontal and vertical diversity

# Methods

## Community

```{r}
myload(temporal_community_metrics, dir = mypath("data"))
st_basin <- get_basin_station(sf_obj = FALSE)

myload(temporal_network_metrics, dir = mypath("data", "classes"))
temporal_network_metrics_classes <- temporal_network_metrics
myload(temporal_network_metrics, dir = mypath("data", "species"))

stab_div_troph <- temporal_network_metrics %>%
  dplyr::select(station, troph_group) %>%
  unnest(troph_group) %>%
  filter(troph_group != 1) %>%
  mutate(troph_group = as.factor(troph_group),
    log_rich = log10(richness_med),
    log_stab = log10(biomass_stab)) %>%
  dplyr::select(station, troph_group, biomass_stab, richness_med, log_rich, log_stab) %>%
  dplyr::left_join(st_basin, by = "station")
```

## Habitat and environment

```{r}
myload(
  hab_analysis,
  temporal_station_desc,
  temporal_press_polluants,
  geo_station,
  dir = mypath("data")
)
habitat_pressure <- build_habitat_pressure_dataset(
  .habitat_analysis = hab_analysis,
  .tmp_press = temporal_press_polluants,
  .tmp_st_desc = temporal_station_desc,
  .geo_st = geo_station 
)
```

```{r, fig.show = "hide"}
evt_var_mean <- c("flow_med", "temperature_med", "width_river_mean",
  "avg_depth_station_mean", "slope", "alt", "d_source", "strahler", "DBO_med")
evt_var_cv <- c("flow_cv", "temperature_cv", "width_river_cv",
  "avg_depth_station_cv", "DBO_cv")
pca_pressure <- habitat_pressure[, names(habitat_pressure) %in% c(evt_var_mean, evt_var_cv, "station")] %>%
  na.omit

pca_rotated <- compute_rotated_pca(
  .data = pca_pressure[, !names(pca_pressure) %in% "station"],
  naxis = 5 
)

```

## Statistical analysis

```{r get-data}
library(nlme)
library(piecewiseSEM)

myload(nmds, habitat_pressure, dir = mypath("report"))
myload(op_analysis, dir = mypath("data"))

# Compute stability, network metrics, etc with ;he new datasets
com_data <- compute_community_temporal_analysis(.op = op_analysis, dest_dir = mypath("data", "species"))

# Compute sem dataset 
sem_data <- compute_sem_dataset(
  com = com_data[["tps_com"]],
  network = com_data[["tps_net"]], 
  hab_press = habitat_pressure, 
  sync = com_data[["sync"]],
  nmds = NULL,
  basin = st_basin 
  )
```


### Relationship between stability and species richness 

$$
S_i = \beta_0 + \beta_Rx_{Ri} + \epsilon_{ij}
$$

with $i$ being the station $i$.

```{r mod-div-total}
ctrl <- lmeControl(opt='optim')
stab_div_mod <- lme(data = sem_data,
  fixed = log_stab ~ log_rich,
  random = ~ 1 + log_rich | basin,
  control = ctrl 
)
#stab_div_colin <- car::vif(stab_div_mod) not use if one response
stab_div_sum <- piecewiseSEM::rsquared(stab_div_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred <- ggpredict(stab_div_mod, terms = c("log_rich"), type = "fe")
stab_div_pred <- pred %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich = x,
    basin = group
  )
```

```{r mod-div-troph}
stab_troph_mod <- lme(data = na.omit(stab_div_troph),
  fixed = log_stab ~ log_rich * troph_group,
  random = ~ 1 + log_rich * troph_group | basin,
  control = ctrl 
)

#stab_div_colin <- car::vif(stab_troph_mod) not use if one response
stab_troph_sum <- piecewiseSEM::rsquared(stab_troph_mod, method = "nagelkerke") %>%
  mutate_at(vars(Conditional, Marginal), ~round(., 2))

pred_troph_mod <- ggpredict(stab_troph_mod, terms = c("log_rich", "troph_group"), type = "fe")
stab_troph_pred <- pred_troph_mod %>%
  as_tibble() %>%
  rename(
    log_stab = predicted,
    log_rich = x,
    troph_group = group
  )

```



### SEM

```{r}

# Compute SEMs
stab_sem <- compute_stab_sem(.data = sem_data,
  random_effect = as.formula("~1|basin"))

bm_sem <- compute_prod_sem(.data = sem_data,
  random_effect = as.formula("~1|basin"))

library(ggraph)
p_stab_sem <- ggpiecewisesem(stab_sem)
p_bm_sem <- ggpiecewisesem(bm_sem)
```



# Results

## Species richness has a destabilizing effect on community  

```{r s-div, fig.dim = c(10,5)}
# Plot left  
p_stab_div <- sem_data %>%
  ggplot(aes(x = log_rich, y = log_stab))+
  geom_point() +
  #scale_x_log10() + scale_y_log10() +
  labs(x = "Median species richness (Log 10)", y = " Biomass stability (Log 10)") +
  geom_line(data = stab_div_pred) +
  geom_ribbon(data = stab_div_pred, aes(ymin = conf.low, ymax = conf.high), fill
  = "grey20", alpha = .5) +
  annotate("text", x = 1.0, y = .8, label = make_label_rsq(rsq = stab_div_sum),
    parse = TRUE)

# Right plot
p_stab_div_troph <- stab_div_troph %>%
  ggplot(aes(x = log_rich, y = log_stab, color = troph_group)) +
  geom_point() +
  ggplot2::scale_color_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic group"
  ) +
  geom_line(data = stab_troph_pred) +
  geom_ribbon(data = stab_troph_pred,
    aes(ymin = conf.low, ymax = conf.high),
    alpha = .5) +
  annotate("text", x = 0.8, y = .8, label = make_label_rsq(rsq = stab_troph_sum),
    parse = TRUE) +
  #scale_x_log10() + scale_y_log10() +
  labs(x = "Median species richness", y = "Biomass stability")

plot_grid(p_stab_div, p_stab_div_troph, ncol = 2, rel_widths = c(.4, .6))
```

## Drivers of total biomass and stability

```{r, fig.show = "hide"}
axis_pair <- list(c(1,2), c(1,3), c(2,3), c(1, 4), c(2, 4), c(3,4), c(4,5))
p_l_rot <- map(axis_pair, 
  function (axis)
    pca_rotated_plot <- plot_rotated_pca(
      pca_rotated = pca_rotated,
      axis = axis 
    )
)
```


```{r sem-plot, fig.dim = c(10,10)}
#https://tex.stackexchange.com/questions/20496/drawing-different-tikz-shapes-parameterized-by-data-from-a-file?rq=1
#https://tex.stackexchange.com/questions/83888/how-to-plot-data-from-a-csv-file-using-tikz-and-csvsimple
to_plot <- c(1, 6, 7)
plot_grid(
  plot_grid(plotlist = map(p_l_rot[to_plot], ~.x$rotated),
      ncol = length(to_plot), labels = LETTERS[1]),
  plot_grid(p_stab_sem, p_bm_sem, labels = LETTERS[2:3]),
  ncol = 1,
  rel_heights = c(.4, .6)
)
```

- Habitat: (+ / -)
  - RC 1: width & depth & flow med, d source, strahler 	/
  - RC 2: T°C med 					/ slope, alt 
  - RC 3: 						/ flow CV, DBO med
  - RC 4: river width med, depth med 			/
  - RC 5: DBO CV 					/

- Community structure: 
  - Richness decreases synchrony but increases CV
  - Trophic level increases synchrony but decreases CV
  - Betadiv increases CV

- Stability component:
  - CV is the main driver of stability 

# Discussion

# References
