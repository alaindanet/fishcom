---
title: "Synchrony"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Synchrony}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data-raw", "polluants")
dest_dir <- mypath("data", "species")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(10, 10),
  echo = FALSE
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(kableExtra)
library(magrittr)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
#devtools::load_all()
theme_set(theme_alain())
```

```{r load dataset, include = FALSE}
myload(yearly_press_interp, dir = data_common)
```

```{r test for success by variable}
eff_interp <- yearly_press_interp %>%
  group_by(parameter) %>%
  summarise(frac_obs = sum(!is.na(value)) / n())
hist(eff_interp$frac_obs)
```

```{r which paramater has been badly interpolated}
kable(filter(eff_interp, frac_obs < .80))
# remove them:
yearly_press_interp %<>%
  filter(!parameter %in% unique(eff_interp[which(eff_interp$frac_obs < .80), ]$parameter))
```

# Plot some series

```{r}
test <- yearly_press_interp %>%
  filter(id %in% sample(id, 5), parameter %in% sample(parameter, 12))
ggplot(test, aes(x = year, y = value)) +
  geom_line(aes(color = as.factor(id))) +
  facet_wrap(~parameter, scales = "free_y")
```

```{r}
# Filter values < 0 expect temperature 
# Filter saturation in 02 
# Filter abberant values: filter according to min-max observed in data 



```




```{r synchrony and diversity}
sync <- synchrony %>% 
  select(station, synchrony) %>%
  left_join(select(temporal_community_metrics, station, richness_med),
    by = "station")

sync_plot <- ggplot(sync, aes(y = synchrony, x = richness_med)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = formula) +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(x = "Median richness", y = "Synchrony")
```

```{r}
cv <- synchrony %>% 
  select(station, cv_sp, stab_com) %>%
  left_join(select(temporal_community_metrics, station, richness_med,
      biomass_stab),
    by = "station") %>%
  gather(cv, value, cv_sp, stab_com, biomass_stab)
cv_plot <- ggplot(cv, aes(y = value, x = richness_med)) +
  geom_point() +
  facet_wrap(~ cv, scales = "free_y") +
  geom_smooth(method = 'lm', formula = formula) +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(x = "Median richness", y = "Coefficient of Variation")
```

```{r}
plot_grid(sync_plot, cv_plot, ncol = 1)
```



