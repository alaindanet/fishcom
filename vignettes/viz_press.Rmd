---
title: "Pressure visualisation"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pressure visualisation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data-raw", "polluants")
dest_dir <- mypath("data", "species")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(10, 10),
  echo = FALSE
)
library(tidyverse)
library(sf)
library(lubridate)
library(ggpmisc)
library(cowplot)
library(kableExtra)
library(magrittr)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
#devtools::load_all()
theme_set(theme_alain())
```

```{r load dataset, include = FALSE}
myload(synchrony, temporal_press_polluants, press_metrics,
  temporal_community_metrics, yearly_press_interp_mv_avg_cleaned, dir =
    mypath("data"))

```

```{r test for success by variable}
eff_interp <- yearly_press_interp_mv_avg %>%
  group_by(parameter) %>%
  summarise(frac_obs = sum(!is.na(value)) / n())
```

```{r which paramater has been badly interpolated}
kable(filter(eff_interp, frac_obs < .80))
```

# Plot some series

## Polluants

```{r}
test <- yearly_press_interp_mv_avg %>%
  filter(id %in% sample(id, 5), parameter %in% sample(parameter, 12))
ggplot(test, aes(x = year, y = value_corrected)) +
  geom_line(aes(color = as.factor(id))) +
  facet_wrap(~parameter, scales = "free_y")
```



# Plot some press

```{r enrichment}
myload(station_analysis, region_polygon, dir = mypath("data"))
station <- select(station_analysis, id)
station_press <- left_join(station, temporal_press_polluants)
parameter <- c("DBO", "nitrates", "phosphore", "ph", "disolved_oxygen")

g <- purrr::map(parameter,
           function(x) {
	     ggplot(data = region_polygon) +
	       geom_sf() +
	       geom_sf(data = filter(station_press, category == x),
		 aes(color = press), size = 2) +
	       scale_color_gradient(low = "green", high = "red") +
	       ggtitle(x)
	   }
)

g2 <- cowplot::plot_grid(plotlist = g)
g2
```

```{r pesticides, eval = FALSE}
parameter <- c("atrazine", "glyphosate", "atrazine_desethyl", "carbofuran",
  "aldicarbe", "mancozebe", "fenpropimorphe"
)

g <- purrr::map(parameter,
           function(x) {
	     ggplot(data = region_polygon) +
	       geom_sf() +
	       geom_sf(data = filter(station_press, parameter == x),
		 aes(color = press), size = 2) +
	       scale_color_gradient(low = "green", high = "red") +
	       ggtitle(x)
	   }
)

g2 <- cowplot::plot_grid(plotlist = g)
g2

```

```{r vigne, eval = FALSE}
parameter <- c("cymoxanil", "captane", "folpel", "diuron",
  "aldicarbe", "mancozebe", "fenpropimorphe"
)

g <- purrr::map(parameter,
           function(x) {
	     ggplot(data = region_polygon) +
	       geom_sf() +
	       geom_sf(data = filter(station_press, parameter == x),
		 aes(color = press), size = 2) +
	       scale_color_gradient(low = "green", high = "red") +
	       ggtitle(x)
	   }
)

g2 <- cowplot::plot_grid(plotlist = g)
g2
```

# Press category

```{r}
press_year <- press_metrics %>%
  group_by(category, year) %>%
  summarise(press = mean(press))
```

## Viz press

```{r}
library(Hmisc)
ggplot(press_metrics, aes(y = press, x = year)) +
  stat_summary(mapping = aes(group = category), geom="ribbon", fun.data="mean_cl_normal", conf.int=.95, na.rm=TRUE, alpha = .1)+
  stat_summary(geom="point", fun.y=mean) +
  stat_summary(geom="line", fun.y = mean) +
  facet_wrap(~category, scales = "free_y")
```

##

```{r biocides}
ld_cat <- c(
  "herbicides",
  "insecticides",
  "fungicides",
  "pcb",
  "hap",
  "micropolluants mineraux",
  "micropolluants organiques")
press_biocides <- yearly_press_interp_mv_avg_cleaned %>%
  filter(category %in% ld_cat) %>%
  #group_by(parameter) %>%
  #mutate(z = scale(press)) %>%
  group_by(category, id, year) %>%
  summarise(med = median(press, na.rm = TRUE))
  #summarise(z_sum = median(z, na.rm = TRUE))

ggplot(press_biocides, aes(y = med, x = year)) +
  stat_summary(mapping = aes(group = category), geom="ribbon", fun.data="mean_cl_normal", conf.int=.95, na.rm=TRUE, alpha = .1) +
  stat_summary(geom="point", fun.y=mean) +
  stat_summary(geom="line", fun.y = mean) +
  facet_wrap(~category, scales = "free_y")
```


## Dynamics of press and stability 

```{r}
stab_cat_press <- synchrony %>%
  arrange(cv_com) %>%
  slice(c(10:15, (n() - 15):(n() - 10))) %>%
  left_join(rename(press_metrics, station = id)) %>%
  mutate(stab_cat = ifelse(cv_com < .5, "low", "high"),
    station = as.character(station)
  )

ggplot(stab_cat_press, aes(x = year, y = press)) +
  geom_point(aes(color = station)) +
  geom_line(aes(color = station)) +
  facet_wrap(category~stab_cat, scales = "free_y")
  labs(x = "Year", y = "CV of the community")
```

```{r}
```

