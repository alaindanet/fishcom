---
title: "Visualize flow data"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualize flow data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data-raw", "polluants")
dest_dir <- mypath("data", "species")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(10, 10),
  echo = FALSE
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(kableExtra)
library(magrittr)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
#devtools::load_all()
theme_set(theme_alain())
```

```{r load dataset, include = FALSE}
myload(sample_flow_data, dir = mypath("data-raw", "flow_quality"))
```
```{r}
test <- sample_flow_data %>%
  filter(code %in% sample(unique(sample_flow_data$code), 12)) %>%
  gather(method, value, moving_avg, value)

ggplot(test, aes(x = meas_date, y = value)) +
  geom_line(aes(color = method)) +
  facet_wrap(~code)
```

```{r}
test <- sample_flow_data %>%
  filter(code %in% sample(unique(sample_flow_data$code), 12))

ggplot(test, aes(x = meas_date, y = value - moving_avg)) +
  geom_line() +
  facet_wrap(~code)
```

```{r}
ggplot(test, aes(x = meas_date, y = value - moving_avg)) +
  geom_line() +
  facet_wrap(~code, scales = "free_y")

```


##Â show quantiles

```{r}
ggplot(test, aes(sample = value - moving_avg)) +
  stat_qq() +
  facet_wrap(~code, scales = "free_y")
```

## Compute quantiles by station

```{r}
quant_seq <- c(0.01, 0.05, 0.95, 0.99)
test <- sample_flow_data %>%
  group_by(code) %>%
  summarise(quant = list(quantile(value - moving_avg, probs = quant_seq, na.rm = TRUE))) %>%
  mutate(quant = map(quant, function(x){
      names(x) <- quant_seq
      return(x)
}))
test %>%
  unnest(quant)
  filter(code %in% sample(unique(sample_flow_data$code), 12))
```

