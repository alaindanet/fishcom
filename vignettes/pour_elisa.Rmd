---
title: "Ecosystem functioning and network structure"
subtitle: "Preliminary results"
author: "Alain Danet"
date: "`r Sys.Date()`"
notitlebreak: true
output:
  bookdown::pdf_document2:
    fig_caption: yes 
    template: my-latex.template
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7),
  echo = FALSE
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(magrittr)
library(igraph)
library(NetIndices)
library(tidygraph)
library(ggraph)
library(lubridate)
devtools::load_all()
theme_set(theme_alain())
```

Those are really Preliminary results. Only 250 stations are considered and do
not take in account the spatial dependence between stations. However, the
sampling method is the same in all the selected stations. Each selected station
contains at least ten years of data collection.

# Metaweb

The Figure \@ref(fig:metaweb) shows the metaweb which is constituted of 50 fish species and 7 resources. 
Each species has been divided in 9 size classes, constituting as much nodes in
the metaweb. In the following graphical representation, I have considered that
the detritus and biofilm resources node as dead matters. Together with the
phytoplankton, they constitute the three basal nodes of the networks.

```{r metaweb, fig.cap = "The metaweb"}
data(metaweb_analysis)
meta <- metaweb_analysis; rm(metaweb_analysis)

g <- igraph::graph_from_adjacency_matrix(meta$metaweb, mode = "directed")

# Define layout
lay <- layout.fruchterman.reingold(g)
# Compute trophic level
#meta$resource
dead_material <- c("det", "biof")
lay[, 2] <- TrophInd(meta$metaweb, Dead = dead_material)$TL - 1
# Plot
par(mar=rep(5, 4))
plot.igraph(g,layout=lay,vertex.label=NA,vertex.size=2,edge.arrow.size=.5,edge.width=.5)

```

# Local networks

```{r}
data(network_analysis)
net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest() %>%
  left_join(., dplyr::select(op_analysis, opcod, station, year), by = "opcod") %>%
 dplyr::select(from, to, everything())
rm(network_analysis)

# Get a station
net_ex <- filter(net, station == unique(net$station) %>% sample(., 1))
## Graph -------------------------
net_graph <- graph_from_data_frame(net_ex, directed = TRUE)
 
## Layout --------------------------------
lay <- create_layout(graph_from_adjacency_matrix(meta$metaweb, mode = "directed"), layout = "kk")
node_pos <- TrophInd(meta$metaweb,
  Dead = dead_material)$TL - 1
lay$y <- node_pos
lay$species <- stringr::str_extract_all(lay$name,
    "[A-Za-z]+", simplify = TRUE) %>%
  as.vector

net_graph <- select(net_ex, from, to, year) %>%
  arrange(year) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    net_graph = pmap(list(net = data, title = year), 
    set_layout_graph, glay = lay, color_scale = NULL)#set_color_species(lay)
  )
#plot_grid(plotlist = net_graph$net_graph)
```

## Biomass variation and network structure

We explored the link between ecosystem functioning, here represented as the
fish biomass, and the structure of the network that we characterized by the
connectance and number of nodes.
More precisely, we investigated the link between the temporal variability of
the biomass and the structure of the network (See Figure \@ref(fig:bionet)).  

For each station (i.e. site), we computed the Coefficient of Variation of the
biomass and the network metrics.

$$
CV = \frac{\sigma_x}{ \mu_x}
$$


```{r bionet,  fig.cap = "Temporal variation of biomass and network structure"}
# Get network metrics
data(biomass_analysis)
cv <- left_join(network_metrics, biomass_analysis, by = "opcod") %>%
  gather(metrics, values, connectance, richness, biomass) %>%
  group_by(station, metrics) %>%
  summarise(
    cv = sd(values) / mean(values),
    avg = mean(values)
  )
rm(biomass_analysis)

# plot
faceted_cv <- dplyr::select(cv, - avg) %>%
  spread(metrics, cv) %>%
  gather(network_metrics, values, connectance, richness)
# Facet label:
label <- as_labeller(c(
    connectance = "Connectance",
    richness = "Number of nodes"
    ))
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(faceted_cv, aes(y = biomass, x = values)) +
  geom_point() +
  facet_grid(cols = vars(network_metrics), labeller = label) +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "CV of the network indices",
    y = "CV of the community biomass"
  )
faceted_cv_avg <- gather(cv, mesurements, values, cv, avg) %>%
  filter(
    metrics == "biomass" & mesurements == "cv" |
    metrics %in% c("connectance", "richness") & mesurements == "avg"
  )
faceted_cv_avg <- left_join(
  filter(faceted_cv_avg, metrics == "biomass") %>%
    spread(mesurements, values) %>% spread(metrics, cv),
  filter(faceted_cv_avg, metrics != "biomass") %>%
    spread(mesurements, values) %>% spread(metrics, avg),
  by = "station"
) %>%
  gather(network_metrics, values, connectance, richness)
formula <- y ~ x #needed for stat_poly_eq
p2 <- ggplot(faceted_cv_avg,
  aes(y = biomass, x = values)) +
  geom_point() +
  facet_grid(cols = vars(network_metrics), labeller = label, scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Average of the network indices",
    y = "CV of the community biomass"
  )

plot_grid(p, p2, ncol = 1, labels = "AUTO")
```

## Example of local networks


Here we show two extreme examples from the above graphs. The Figure
\@ref(fig:lclb) shows the temporal variation of a network that has a high 
biomass variation and a low average connectance. The Figure \@ref(fig:hchb)
shows the temporal variation of a network with opposite characteristics: low 
biomass variation and high average connectance.

```{r lclb, fig.dim = c(10, 10), fig.cap = "Low connectance (.102) and high biomass CV (.888). "}
biomass_connectance <- filter(faceted_cv_avg, network_metrics == "connectance") %>%
  spread(network_metrics, values) %>%
  arrange(connectance, biomass)

## get station number
station_id <- slice(ungroup(biomass_connectance), 6) %>%
  select(station) %>% unlist
test <- network_analysis %>%
  dplyr::select(opcod, data) %>%
  unnest() %>%
  left_join(., dplyr::select(op_analysis, opcod, station, year), by = c("opcod", "year", "station")) %>%
  filter(station == station_id) %>%
  group_by(year, species) %>%
  summarise(nb_ind = n())

tps_graph <- plot_temporal_network(filter(net, station == station_id), meta = meta, dead =
  dead_material)

plot_grid(plotlist = tps_graph$net_graph)
```

```{r hchb, fig.dim = c(10,10), fig.cap = "High connectance (.222) and low biomass CV (.236). This community is only composed of two size classes of Truites (TRF)"}
## get station number
station_id <- dplyr::slice(ungroup(biomass_connectance), n() - 5) %>%
  select(station) %>% unlist

tps_graph <- plot_temporal_network(filter(net, station == station_id), meta = meta, dead =
  dead_material)

plot_grid(plotlist = tps_graph$net_graph)
```
