---
title: "Build dataset from ASPE database"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Build dataset from ASPE database}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE
)
default::default(unlist) <- list(use.names = FALSE)
mypath <- rprojroot::find_package_root_file
dest_dir <- mypath("data-raw", "fishing_op_build")

if (!dir.exists(dest_dir)) {
  dir.create(dest_dir)
}
```
```{r library}
library(tidyverse)
library(magrittr)
library(dbplyr)
library(lubridate)
library(ggplot2)
```


This document groups all the questions and remarks that I have regarding the
ASPE database. Those questionings will be addressed to Thierry Point and Eddy
Cosson.  

The procedure to build my database is in `data-raw/01_clean_fish_op_data.R`.

```{r}
# Set up the connection with the database
con <- DBI::dbConnect(RPostgres::Postgres(), dbname = "afb_fish", port = 5434)
```


# Fishing operation 

```{r fish operation dataset}
db_op <- tbl(con, in_schema("aspe", "operation"))
db_op %<>%
  rename_all(list(~ gsub("ope_", "", make.names(colnames(db_op)))))
```


## Fishing objectives 

In the fishing operation objectives, we can find the following:
```{r}
obj_id <- tbl(con, in_schema("aspe", "ref_objectif"))
obj_id
```

Here is the distribution of the objectives by year:

```{r}
obj_time <- tbl(con, in_schema("aspe", "operation_objectif")) %>%
  collect() %>%
  rename(id = opo_ope_id, obj_id = opo_obj_id) %>%
  left_join(., collect(db_op)) %>%
  left_join(., collect(obj_id) %>% select(obj_id, obj_libelle)) %>%
  mutate(year = year(date)) %>%
  select(obj_libelle, year) %>%
  group_by(year, obj_libelle) %>%
  summarise(n = n())
obj_time
ggplot(obj_time, aes(x = year, y = n)) +
  geom_line(aes(color = obj_libelle))
```

I am not really sure of my choice. For intance, I keep the following objectives:

```{r}
obj_to_keep <- "RHP|DCE|RRP|RCS|CO|restauration|RNSORMCE|Étude"
obj_kept <- tbl(con, in_schema("aspe", "ref_objectif")) %>%
  collect() %>%
  filter(str_detect(obj_libelle, obj_to_keep))
obj_kept$obj_libelle
```

```{r}
# Keep the op id corresponding to the objectives:
objective_op_id <- tbl(con, in_schema("aspe", "operation_objectif")) %>%
  collect %>%
  filter(opo_obj_id %in% obj_kept$obj_id) %>%
  select(opo_ope_id) %>% unlist
```


## Levels of qualification 

There are different levels of qualification in the database.  
Those levels allow to filter and correct bugs (I guess). For example, if you enter the bad
units, introduce letters in numeric fields, etc... 

```{r}
qualif_lvl <- tbl(con, in_schema("aspe", "ref_niveau_qualification")) %>%
  collect() 
qualif_lvl
```
Here is the repartition of the qualification levels:

```{r}
qualif_time <- collect(db_op) %>%
  #rename(id = opo_ope_id, obj_id = opo_obj_id) %>%
  left_join(., qualif_lvl) %>%
  mutate(year = year(date)) %>%
  select(niq_libelle, year) %>%
  group_by(year, niq_libelle) %>%
  summarise(n = n())
ggplot(qualif_time, aes(x = year, y = n)) +
  geom_line(aes(color = niq_libelle))
```

We keep everything because a huge part of the operations has not a good
qualification level, which is strange.

```{r}
# we keep everything:
qualif_to_keep <- "[a-z]"#"Correct|Incertaine|Non renseignée"
qualif_kept <- qualif_lvl %>%
  collect() %>%
  filter(str_detect(niq_libelle, qualif_to_keep))
qualif_kept$niq_libelle
```

## Fishing protocol

There are seven fish protocols:

```{r}
protocols <- tbl(con, in_schema("aspe", "ref_protocole")) %>%
  collect() %>%
  select(-pro_acronyme, -pro_ordre_affichage)
protocols
```
Here their distribution:

```{r}
protocol_time <- collect(db_op) %>%
  #rename(id = opo_ope_id, obj_id = opo_obj_id) %>%
  left_join(., protocols) %>%
  mutate(year = year(date)) %>%
  select(pro_libelle, year) %>%
  group_by(year, pro_libelle) %>%
  summarise(n = n())
ggplot(protocol_time, aes(x = year, y = n)) +
  geom_line(aes(color = pro_libelle))

```

We keep the "complete" one which is the most homogeneous protocol and typical of
small rivers because the fishing is done by foot overall the river.

We also keep the "partial" protocols for the big rivers.

```{r}
protocol_to_keep <- "complète|partielle"
protocol_kept <- protocols %>%
  collect() %>%
  filter(str_detect(pro_libelle, protocol_to_keep))
protocol_replacement <- c(
"Pêche complète à un ou plusieurs passages" = "complete",
"Pêche partielle par points \\(grand milieu\\)" = "partial_by_point",
"Pêche partielle sur berge" = "partial_over_bank"
)
protocol_kept$pro_libelle %<>% str_replace_all(., protocol_replacement)
```

## Build the dataset

```{r}
# Selected ids 
col_to_keep <- c("id", "date", "pop_id", "pro_id", "pente_ligne_eau", "section_mouillee",
  "durete_totale", "temp_max_moyenne_eau", "temp_air_bassin_versant",
  "precipitation_bassin_versant", "amplitude_thermique_air_station",
  "temperature_air_station", "surface_calculee", "espece_ciblee", "niq_id",
  "eta_id", "commentaire")

op <- db_op %>%
  select(col_to_keep) %>%
  collect() %>%
  filter(niq_id %in% qualif_kept$niq_id) %>% # Select qualification
  filter(id %in% objective_op_id) %>% #operation objectives
  filter(espece_ciblee == FALSE) %>% # Do not keep those specific operations
  filter(pro_id %in% protocol_kept$pro_id) %>% #operation prospection methods 
  filter(date > lubridate::ymd("1995-01-01")) %>% # Because it is the time of protocol standardization
  arrange(date)

```

## Get names instead of id

```{r}
protocol_kept %<>%
  rename(protocol = pro_libelle) %>%
  select(pro_id, protocol)
# TODO: same with qualif, objective, prospection method 
op %<>%
  left_join(., protocol_kept) %>% select(-pro_id)

op %<>% select(id, date, station, protocol, everything())
save(op, file = mypath("data-raw", "fishing_op_build", "op.rda"))
```

# Description of the fishing conditions

```{r}
# Collect débit, largeur, longueur, etc
# and them accordingly to fishing operation env and general
# HERE
op_desc <- tbl(con, in_schema("aspe", "operation_description_peche")) %>%
  filter(odp_ope_id %in% op$id) %>%
  collect()
colnames(op_desc)
desc_op_col <-c(
"odp_ope_id", "odp_mop_id", "odp_duree_peche",
"odp_surface_eq_radier_rapide_troncon",
"odp_observations_generales", "odp_longueur",
"odp_largeur_lame_eau", "odp_iso_id_aval", "odp_iso_id_amont",
"odp_largeur_rive_gauche", "odp_longueur_rive_gauche",
"odp_largeur_rive_droite", "odp_longueur_rive_droite",
"odp_temperature_instantanee", "odp_conductivite",
"odp_ted_id", "odp_tur_id", "odp_coh_id",
"odp_debit_moyen_journalier", "odp_debit_moyen_horaire"
)

op_desc %<>% select(desc_op_col)
# simplify naming:
op_desc %<>% rename_all(
  list(~ gsub("odp_", "", make.names(colnames(op_desc)))))
desc_col_replacement <- c(
 "mop_id"                  = "method_id"            ,
 "duree_peche"             = "time_fishing"      ,
 "iso_id_aval"             = "isolation_down_id"    ,
 "iso_id_amont"            = "isolation_up_id"      ,
 "largeur_lame_eau"        = "width_river"        ,
 "largeur_rive_gauche"     = "width_left_shore"   ,
 "longueur_rive_gauche"    = "length_left_shore"  ,
 "largeur_rive_droite"     = "width_right_shore"  ,
 "longueur_rive_droite"    = "length_right_shore" ,
 "longueur"                = "length_sourced"    ,
 "temperature_instantanee" = "instant_temperature",
 "conductivite"            = "conductivity"       ,
 "ted_id"                  = "flow_trend_id"         ,
 "tur_id"                  = "turbidity_id"          ,
 "coh_id"                  = "hydro_condition_id"    ,
 "debit_moyen_journalier"  = "avg_daily_flow"     ,
 "debit_moyen_horaire"     = "avg_hourly_flow",
 "observations_generales"  = "general_observations"
)
colnames(op_desc) <- str_replace_all(colnames(op_desc), desc_col_replacement)
```

## Replace ids by strings 

```{r}
ref_method <- tbl(con, in_schema("aspe", "ref_moyen_prospection")) %>%
  collect() %>%
  rename(
    "method_id" = "mop_id",
    "method" = "mop_libelle"
  ) %>%
  select(method_id, method)
# Translate in english:
method_replacement <- c(
  "A pied" = "by_foot",
  "En bateau" = "by_boat",
  "Mixte" = "mixed",
  "Non renseigné" = "unknown"
)
ref_method$method %<>% str_replace_all(., method_replacement)
```

```{r}
ref_turbidity <- tbl(con, in_schema("aspe", "ref_turbidite")) %>%
  collect() %>%
  rename(
    "turbidity_id" = "tur_id",
    "turbidity" = "tur_libelle"
  ) %>%
  select(turbidity_id, turbidity)
# Translate in english:
turbidity_replacement <- c(
  "Nulle"   = "null",
  "Faible"  = "weak",
  "Moyenne" = "medium",
  "Forte"   = "strong"
)
ref_turbidity$turbidity %<>% str_replace_all(., turbidity_replacement)
```

```{r}
ref_isolation <- tbl(con, in_schema("aspe", "ref_isolement")) %>%
  collect() %>%
  rename(
    "isolation_id" = "iso_id",
    "isolation" = "iso_libelle"
  ) %>%
  select(isolation_id, isolation)

# Translate in english:
isolation_replacement <- c(
 "Pas d’isolement"                   = "no",
 "Seuil partiellement franchissable" = "partly_crossable",
 "Obstacle infranchissable"          = "obstable_uncrossable",
 "Filet"                             = "net",
 "Barrage électrique"                = "electric_dam",
 "Autres"                            = "others"
)
ref_isolation$isolation %<>% str_replace_all(., isolation_replacement)
ref_isolation_up <- ref_isolation %>%
  mutate(
    isolation_up_id = isolation_id,
    isolation_up = isolation
  ) %>%
  select(isolation_up_id, isolation_up)
ref_isolation_down <- ref_isolation %>%
  mutate(
    isolation_down_id = isolation_id,
    isolation_down = isolation
  ) %>%
  select(isolation_down_id, isolation_down)
```

```{r}
ref_hydro_condition <- tbl(con, in_schema("aspe", "ref_condition_hydrologique")) %>%
  collect() %>%
  rename(
    "hydro_condition_id" = "coh_id",
    "hydro_condition" = "coh_libelle"
  ) %>%
  select(hydro_condition_id, hydro_condition)
# Translate in english:
hydro_condition_replacement <- c(
 "Basses eaux"   = "low_water",
 "Eaux moyennes" = "medium_water",
 "Hautes eaux"   = "high_water"
)
ref_hydro_condition$hydro_condition %<>% str_replace_all(., hydro_condition_replacement)
```

```{r}
ref_flow_trend <- tbl(con, in_schema("aspe", "ref_tendance_debit")) %>%
  collect() %>%
  rename(
    "flow_trend_id" = "ted_id",
    "flow_trend" = "ted_libelle"
  ) %>%
  select(flow_trend_id, flow_trend)

# Translate in english:
flow_trend_replacement <- c(
 "Augmentation \\(en crue\\)" = "flooding",
 "Diminution \\(en décrue\\)" = "decline",
 "Stabilité"              = "stability",
 "Irrégularité"          = "irregularity"
)
ref_flow_trend$flow_trend %<>% str_replace_all(., flow_trend_replacement)
```

```{r}
op_desc %<>%
  left_join(., ref_flow_trend) %>%
  left_join(., ref_hydro_condition) %>%
  left_join(., ref_turbidity) %>%
  left_join(., ref_method) %>%
  left_join(., ref_isolation_up) %>%
  left_join(., ref_isolation_down) 

col_to_rm <- tidyselect::vars_select(names(op_desc), ends_with("id"))

op_desc %<>%
  select(- one_of(col_to_rm[col_to_rm != "ope_id"]))
save(op_desc, file = mypath("data-raw", "fishing_op_build", "op_desc.rda"))
```

# Environmental data of the fishing operation

```{r}
op_env <- tbl(con, in_schema("aspe", "operation_donnees_environnementales")) %>%
  filter(ode_ope_id %in% op$id) %>%
  collect()
colnames(op_env)
env_op_col <- c(
"ode_ope_id", "ode_lo3_id_secteur_debit_reserve",
"ode_lo3_id_secteur_soumis_ecluse", "ode_lo3_id_soutien_etiage",
"ode_observations_hydrologie", "ode_profondeur_moyenne_station",
"ode_observation_vegetation", "ode_observation_colmatage",
"ode_hab_id", "ode_haa_id",
"ode_omb_id", "ode_col_id",
"ode_gra_id_granulometrie_dominante", "ode_gra_id_granulometrie_accessoire",
"ode_observations_station", "ode_rep_id",
"ode_observations_repeuplement", "ode_lo3_id_station_canalisee",
"ode_lo3_id_station_naviguee", "ode_lo3_id_frequentation_sports_nautiques",
"ode_lo3_id_curage", "ode_faucardage",
"ode_lo4_id_deboisement_total", "ode_lo4_id_modification_morphologie",
"ode_lo4_id_extraction_granulats", "ode_observations_lits_rives"
)

op_env %<>% rename_all(
  list(~ gsub("ode_", "", make.names(colnames(op_env)))))
```

```{r}
ref_logique_3 <- tbl(con, in_schema("aspe", "ref_logique_3")) %>%
  collect()
logique_3_replacement <- c(
  "Renseignement inconnu" = "unknown",
  "Oui" = "yes",
  "Non" = "no"
)
ref_logique_3 %<>% 
  mutate(lo3_libelle = str_replace_all(lo3_libelle, logique_3_replacement))

replacement_lo3 <- ref_logique_3$lo3_libelle
names(replacement_lo3) <- ref_logique_3$lo3_id
```
```{r}
ref_logique_4 <- tbl(con, in_schema("aspe", "ref_logique_4")) %>%
  collect()
logique_4_replacement <- c(
  "Renseignement inconnu" = "unknown",
  "Oui \\(récent - depuis la dernière opération\\)" = "recent",
  "Oui \\(ancien\\)" = "ancient",
  "Non" = "no"                                
)
ref_logique_4 %<>% 
  mutate(lo4_libelle = str_replace_all(lo4_libelle, logique_4_replacement))

replacement_lo4 <- ref_logique_4$lo4_libelle
names(replacement_lo4) <- ref_logique_4$lo4_id
```

```{r}
ref_ombrage <- tbl(con, in_schema("aspe", "ref_ombrage")) %>%
  collect()
ombrage_replacement <- c(
  "Très Ombragé" = "very_shady",
  "Ombragé" = "shady",
  "Peu Ombragé" = "little_shade",
  "Éclairé" = "lit",
  "Très Eclairé" = "very_lit"
)
ref_ombrage %<>% 
  mutate(omb_libelle = str_replace_all(omb_libelle, ombrage_replacement))

replacement_ombrage <- ref_ombrage$omb_libelle 
names(replacement_ombrage) <- ref_ombrage$omb_id
```

```{r}
ref_colmatage <- tbl(con, in_schema("aspe", "ref_colmatage")) %>%
  collect()
colmatage_replacement <- c(
 "Pas de colmatage"     = "no",
 "Très léger colmatage" = "very_light",
 "Léger colmatage"      = "light",
 "Colmatage moyen"      = "medium",
 "Colmatage important"  = "important",
 "Colmatage complet"   = "full"
)
ref_colmatage %<>%
  mutate(col_libelle = str_replace_all(col_libelle, colmatage_replacement))
replacement_colmatage <- ref_colmatage$col_libelle
names(replacement_colmatage) <- ref_colmatage$col_id
```

```{r}
ref_repeuplement <- tbl(con, in_schema("aspe", "ref_repeuplement")) %>%
  collect()
repeuplement_replacement <- c(
 "Oui"            = "yes",
 "Non"            = "no",
 "Pas disponible" = "not_available"
)
ref_repeuplement %<>%
  mutate(rep_libelle = str_replace_all(rep_libelle, repeuplement_replacement))
replacement_repeuplement <- ref_repeuplement$rep_libelle
names(replacement_repeuplement) <- ref_repeuplement$rep_id
```

```{r}
op_env %<>%
  mutate_at(vars(contains("lo3")), list(~str_replace_all(., replacement_lo3))) %>%
  mutate_at(vars(contains("lo4")), list(~str_replace_all(., replacement_lo4))) %>%
  mutate(
    col_id = str_replace_all(col_id, replacement_colmatage),
    rep_id = str_replace_all(rep_id, replacement_repeuplement),
    omb_id = str_replace_all(omb_id, replacement_ombrage)
    )
replacement_env_op_col <- c(
  "lo3_id_secteur_debit_reserve"          = "instream_flow",
  "lo3_id_secteur_soumis_ecluse"          = "artificial_flow_variation",
  "lo3_id_soutien_etiage"                 = "replenishment_flow",
  "observations_hydrologie"               = "hydro_observations",
  "profondeur_moyenne_station"            = "avg_depth_station",
  "observation_vegetation"                = "vegetation_observations",
  "observation_colmatage"                 = "clogging_observations",
  "hab_id"                                = "habitat_id",
  "haa_id"                                = "eel_habitat_id",
  "omb_id"                                = "shade",
  "col_id"                                = "clogging",
  #"gra_id_granulometrie_dominante",
  #"gra_id_granulometrie_accessoire",
  "observations_station"                  = "station_observations",
  "rep_id"                                = "resettlement",
  "observations_repeuplement"             = "resettlement_observations",
  "lo3_id_station_canalisee"              = "chanelled_station",
  "lo3_id_station_naviguee"               = "sailed_station",
  "lo3_id_frequentation_sports_nautiques" = "nautical_sports",
  "lo3_id_curage"                         = "dredging",
  "faucardage"                            = "weed_cutting",
  "lo4_id_deboisement_total"              = "total_deforestation",
  "lo4_id_modification_morphologie"       = "artificial_morpho_modification",
  "lo4_id_extraction_granulats"           = "aggregates_extraction",
  "observations_lits_rives"               = "bank_bed_observations"
)

colnames(op_env) %<>% str_replace_all(., replacement_env_op_col)
save(op_env, file = mypath("data-raw", "fishing_op_build", "op_env.rda"))
```

```{r}
env_op_col <- c("id", "pente_ligne_eau", "section_mouillee",
  "durete_totale", "temp_max_moyenne_eau", "temp_air_bassin_versant",
  "precipitation_bassin_versant", "amplitude_thermique_air_station",
  "temperature_air_station", "commentaire")
op_env <- select(op, env_op_col)
save(op_env, file = mypath("data-raw", "fishing_op_build", "op_env.rda"))
```

# Station

## Sampling point 

```{r}
sampling_point <- tbl(con, in_schema("aspe", "point_prelevement")) %>%
  filter(pop_id %in% op$pop_id) %>%
  collect()
sampling_point %<>% rename_all(
  list(~ gsub("pop_", "", make.names(colnames(sampling_point)))))
sampling_point_col <- c(
  "id", "sta_id",
  "geometrie", "typ_id", "coordonnees_x", "coordonnees_y",
  "lieu_dit", "localisation_precise", "distance_mer",
  "distance_maree_dynamique", "nom_bassin", "fog_id",
  "ocs_id", "zoh_id", "cap_id", "largeur_lit_mineur",
  "unh_id", "distance_source", "altitude", "pente_ign_cours_eau",
  "surface_bassin_versant_amont", "temperature_moyenne_janvier",
  "temperature_moyenne_juillet") 
sampling_point %<>% select(sampling_point_col)
```

## Station

```{r}
station <- tbl(con, in_schema("aspe", "station")) %>%
  filter(sta_id %in% sampling_point$sta_id) %>%
  collect()
station %<>% rename_all(
  list(~ gsub("sta_", "", make.names(colnames(station)))))
```

### References projection type

```{r}
ref_type_proj <- tbl(con, in_schema("aspe", "ref_type_projection")) %>%
  collect()
ref_type_proj %<>%
  select(typ_id, typ_libelle) %>%
  rename(proj_type = typ_libelle)
```
```{r}
station %<>%
  left_join(., ref_type_proj) %>%
  select(-typ_id)
unique(station$proj_type)
```

### Save station 

```{r}
save(station, file = mypath("data-raw","fishing_op_build", "station.rda"))
```

## Add station id to fishing operation 

```{r}
station_id <- select(sampling_point, id, sta_id) %>%
  rename(pop_id = id, station = sta_id)
op %<>%
  left_join(., station_id) %>%
  select(-pop_id)
```


### Exploration

Let's check the number of operation by year: 
```{r}
op_time <- op %>%
  mutate(year = year(date)) %>% 
  group_by(year) %>%
  summarise(n = n())
ggplot(op_time, aes(x = year, y = n)) +
  geom_line() +
  geom_point() +
  ylim(0, NA)
```

## Point prelevement 

```{r}
pre_ele <- tbl(con, in_schema("aspe", "prelevement_elementaire"))
pre_ele
```

```{r}
ref_pre_ele <- tbl(con, in_schema("aspe", "ref_type_prelevement_elementaire"))
ref_pre_ele %<>%
  rename(
    pre_tpe_id = tpe_id,
    type_prelevement = tpe_libelle) %>%
  select(-tpe_ordre_affichage)
```

We do not want to keep ambiance sampling:

```{r}
pre_ele <- left_join(pre_ele, ref_pre_ele) %>%
  select(-pre_tpe_id, -pre_duree) %>%
  filter(type_prelevement != "Ambiance")
```

### Passage

The number of passage:

```{r}
ref_pas <- tbl(con, in_schema("aspe", "passage")) %>%
  rename(pre_id = pas_id)
ref_pas
```

```{r}
# Join with pre_ele
pre_ele %<>% left_join(., ref_pas) %>%
  rename(passage_nb = pas_numero)
```

From Camille Rivière, operators are now doing fishing only once, so we keep only the
first passage of all the dataset: (I could check myself!)

```{r}
pre_ele %<>%
  filter(is.na(passage_nb)|passage_nb == 1)
```

### Point groups

```{r}
point_group <- tbl(con, in_schema("aspe", "groupe_points")) 
ref_point_group <- tbl(con, in_schema("aspe", "ref_type_groupe_points")) %>%
  rename(grp_tgp_id = tgp_id, point_type = tgp_libelle) %>%
  select(grp_tgp_id, point_type) %>%
  mutate(point_type = str_replace_all(point_type, "Points ", ""))
point_group %<>%
  left_join(., ref_point_group) %>%
  select(-grp_tgp_id) %>%
  select(grp_id, point_type, everything()) %>%
  rename_all(list(~ gsub("grp_nombre_points_", "nb_pt_", make.names(colnames(point_group)))))
point_group
```

I am not sure about what is the meaning of the points. I guess that that it is
the fishing protocol "partial by points". If I want to merge it with "partial
over bank", I have to select standard points in which 100 points were done in
bank.  

```{r}
point_group %<>%
  filter(grp_tgp_id == "standards" & nb_pt_berge == 100)
```

### Filter elementary prelevement

We exclude all the prelevements that are not coming from standard point or that
are not in which all the points were not coming from the berge

```{r}
pre_ele %<>%
  filter(! (type_prelevement == "Groupe de points" & !(pre_id %in% collect(point_group)$grp_id)))
```

## Species 

```{r}
ref_espece <- tbl(con, in_schema("aspe", "ref_espece"))
ref_espece %<>%
  rename(lop_esp_id = esp_id, species = esp_code_alternatif) %>%
  select(lop_esp_id, species)
```
To join with lot

## Fish lot

```{r}
lot_poissons <- tbl(con, in_schema("aspe", "lot_poissons"))
lot_poissons

```

```{r}
ref_type_lot <- tbl(con, in_schema("aspe", "ref_type_lot"))
ref_type_lot %<>%
  rename(
    lop_tyl_id = tyl_id,
    type_lot = tyl_libelle) %>%
  select(-tyl_ordre_affichage)
```

```{r add species name}
lot_poissons <- left_join(lot_poissons, ref_type_lot) %>%
  left_join(., ref_espece) %>%
  select(- lop_tyl_id,- lop_esp_id) %>%
  select(lop_id, lop_pre_id, type_lot, species, everything()) 
lot_poissons
```

```{r, echo = FALSE, include = FALSE}
lot_testing <- purrr::map(collect(ref_type_lot)$type_lot, function (lot, data) {
  temp <- filter(data, type_lot == lot)
  sample_n(collect(temp), 1000)
    }, data = lot_poissons
  ) %>%
  do.call(rbind, .)

save(lot_testing, file = mypath("data-raw","fishing_op_build",
    "lot_testing.rda"))
```

### Individual measurements

```{r}
ind_measure <- tbl(con, in_schema("aspe", "mesure_individuelle"))
arrange(ind_measure, mei_lop_id)
ref_type_lot %<>%
  rename(
    lop_tyl_id = tyl_id,
    type_lot = tyl_libelle) %>%
  select(-tyl_ordre_affichage)
```

```{r echo = FALSE, include = FALSE}
ind_measure_testing <-
  filter(ind_measure, mei_lop_id %in% lot_testing$lop_id) %>%
  collect()
save(ind_measure_testing, file = mypath("data-raw","fishing_op_build",
    "ind_measure_testing.rda"))

filter(lot_poissons, type_lot == "N") %>%
  select(lop_id, lop_effectif) %>%
  collect() %>%
  slice(10)
filter(ind_measure, mei_lop_id == 3558592) %>% collect()
```

### Filter relevant lot and measurement

We select the lots that are in relevant elementary prevelement and in belonging
the operation that we select above.

```{r}
# All the relevant prelevement which are in the selected op:
pre_id_ok <- pre_ele %>%
  filter(pre_ope_id %in% op$id) %>%
  select(pre_id) %>%
  collect() %>% unlist
# filter: 
fish_lot <- lot_poissons %>%
  filter(lop_pre_id %in% pre_id_ok) %>%
  collect()

save(fish_lot, file = mypath("data-raw","fishing_op_build", "fish_lot.rda"))

# The measurement that are in the relevant lot:
lot_measure <- ind_measure %>%
  filter(mei_lop_id %in% fish_lot$lop_id) %>%
  collect()

save(lot_measure, file = mypath("data-raw","fishing_op_build", "lot_measure.rda"))
rm(fish_lot)
rm(lot_measure)
```


### Generate fish

All the fishes are measured in lot "N" and "I", but not in the other 
- lot S/L
- lot G
We have to build their size according to samples and assuming a normal
distribution.

It makes a very long time to run, so it is better to parallelize and to send to
cluster.
TODO: write the files as .rda, set up parallel, set script to run and send files to the cluster

```{r, eval = FALSE}
lot_poissons %<>%
  collect() %>%
  mutate(
      fish = purrr::pmap(
	list(
	  id = lop_id,
	  type = type_lot,
	  min_size = lop_longueur_specimens_taille_mini,
	  max_size = lop_longueur_specimens_taille_maxi,
	  nb = lop_effectif
	  ),
	gen_fish_from_lot, # Arguments from ind_measure:
	ind_measure = collect(ind_measure),
	ind_size = mei_taille,
	ind_id = mei_lop_id,
	verbose = TRUE)
      ) %>%
  select(lop_id, lop_pre_id, species, fish)
## HERE: Erreur : Evaluation error: argument a is greater than or equal to b.
pb_id <- 518228
filter(lot_poissons, lop_id == pb_id)
filter(lot_poissons, type_lot == "S/L")
filter(ind_measure, mei_lop_id == pb_id)
lot <- ind_measure %>% dplyr::filter(mei_lop_id == pb_id) %>%
  collect() %>%
  dplyr::select(mei_taille) %>%
  unlist(., use.names = FALSE)
```

