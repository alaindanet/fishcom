---
title: "Exploration of fish operation data"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7)
)
library(tidyverse)
library(magrittr)
library(cowplot)
library(sf)
library(rgdal)
library(raster)
library(lubridate)
devtools::load_all()
theme_set(theme_alain())
```

```{r data_prep}
data(operation_data)
op <- dplyr::select(operation_data, opcod:year, count)
rm(operation_data)
```

There was `r nb_op <- length(unique(op$opcod)); nb_op` fishing operations from
`r min(op$year)` to `r max(op$year)`. The sampling was distributed over `r nb_st <- length(unique(op$station)); nb_st` stations. It represents a average effort of `r round(nb_op/nb_st, 1)` (# visit/station).

# Sampling

## Distribution of sampling effort

```{r sampling effort} 
op_sampling <- op %>%
  group_by(opcod, station, year, month) %>%
  summarise(
    nb_ind = sum(count),
    nb_sp  = n()
    )

op_hist <- op_sampling %>%
  group_by(station) %>%
  summarise(freq = n()) %>%
  arrange(desc(freq)) %>%
  mutate(station = fct_inorder(as.factor(station)))

cdf_op <- ggplot(op_hist, aes(x=freq)) + stat_ecdf() +
  labs(x = "Number of sampling by station",
    y = "Frequency",
    title = "Cumulative distribution function") +
  scale_x_continuous(breaks = seq(0, 30, by = 5)) 
hist_op <- ggplot(op_hist, aes(x = freq)) +
  geom_bar() +
  labs(x = "Number of sampling by station",
    y = "Frequency",
    title = "Frequency distribution") +
  scale_x_continuous(breaks = seq(0, 30, by = 5))

plot_grid(cdf_op, hist_op, nrow = 2) 
``` 

Overall, the sampling effort by station is low and unevenly distributed. More
than 50% of the station had been visited one time and only 10% had been visited
more than 10 times. But we have no information about the spatial distribution of
the station. Some of them are surely really close from each other.

## Sampling effort by year 

```{r}
op_year <- op_sampling %>% group_by(year) %>%
  summarise(freq = n()) %>%
  arrange(desc(freq)) 

year_op <- ggplot(op_year, aes(y = freq, x = year)) +
  geom_line() +
  geom_point() +
  labs(y = "Number of sampling events",
    x = "Year",
    title = "")
plot_grid(year_op) 
```

We see that the sampling effort increase around 1992 from nearly 250 to 1000
sampled stations by year.

## Sampling area

### Where are the station best followed?

```{r, fig.dim = c(4, 4)}
# good station names
good_station <- op_hist %>% 
  dplyr::filter(freq >= 10) %>%
  dplyr::select(station) %>%
  unlist(., use.names = FALSE)

# get their localisation
station <- read_delim("../data-raw/fishing_station_localisation_wsg84.csv",
  delim = ";", locale = locale("fr", decimal_mark = "."),
  col_types = cols(ST_CODECSP = col_character()))
xy_station <- dplyr::select(station, XCOORD, YCOORD)
station <- SpatialPointsDataFrame(coords = xy_station, data = station,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
station <- st_as_sf(station)
loc_good_station <- dplyr::filter(station, ST_ID %in% good_station)

# France map
region_fr <- raster::shapefile("../data-raw/france_region_shp/regions-20180101.shp")
##Get only metropolitan areas:
region_fr <- st_as_sf(region_fr) #easier to manipulate
region_to_filter <- c("La Réunion", "Martinique", "Guadeloupe", "Mayotte",
  "Guyane", "Corse")
region_fr <- filter(region_fr, !(nom %in% region_to_filter))
region_fr <- region_fr[, c("nom", "geometry")]

plot(st_geometry(region_fr), lwd = 1.5, col = "grey85")
plot(loc_good_station, pch = 20, col = "red", add = T)
```

They are `r length(good_station)` that has 10 or more sampling points. The good
stations are well distributed over France, this is suprising and super nice.
There is may be a deficit in the south east and east.

#### Number of individuals and species by sampling operation 

```{r}
good_station_sampling <- op_sampling %>%
  dplyr::filter(station %in% good_station)
filter(good_station_sampling, nb_sp ==0)

hist_good_station <- good_station_sampling %>%
  ungroup() %>%
  mutate(station = fct_inorder(as.factor(station)))

hist_ind <- ggplot(hist_good_station, aes(x = nb_ind)) +
  geom_histogram(bins = 35) +
  labs(x = "Number of individuals by fish operation",
    y = "Frequency",
    title = "Frequency distribution") +
  scale_x_log10()
hist_sp <- ggplot(hist_good_station, aes(x = nb_sp)) +
  geom_histogram(bins = 32) +
  labs(x = "Number of species by fish operation",
    y = "Frequency",
    title = "Frequency distribution")
plot_grid(hist_ind, hist_sp, ncol = 2)
```

#### Regularity of monitoring

```{r}
time_sampling <- good_station_sampling %>%
  ungroup() %>%
  unite(year_month, year, month, sep = "-") %>%
  mutate(times = ymd(paste0(year_month, "-01"))) %>%
  dplyr::select(-year_month)

time_sampling %<>%
  group_by(station) %>%
  arrange(times) %>%
  mutate(
    point = seq(1, length(station)),
    sample_sep = c(NA, times[-1] - times[-length(station)])
  )
hist_time_int <- time_sampling %>%
  summarise(mean_sep = mean(sample_sep, na.rm =TRUE))

global_sep <- ggplot(time_sampling, aes(x = sample_sep)) +
  geom_histogram() +
  geom_vline(aes(xintercept=mean(sample_sep, na.rm = TRUE)),
            color="blue", linetype="dashed", size=1) +
  labs(title = "Frequency distribution",
  x = "Number of days between two sampling points") +
scale_x_continuous(breaks = c(0, 300, 600, 1000, 2000))

average_sep <- ggplot(hist_time_int, aes(x = mean_sep)) +
  geom_histogram() +
  geom_vline(aes(xintercept = mean(mean_sep)),
            color="blue", linetype="dashed", size=1) +
  labs(title = "Frequency distribution",
  x = "Average number of days between two sampling points by station") +
scale_x_continuous(breaks = c(0, 300, 600, 1000, 2000))

plot_grid(global_sep, average_sep, ncol = 2)

#HERE compute number of month separating two sampling by station
#see zoo

filter(time_sampling, sample_sep < 10) %>%
  ungroup() %>%
  arrange(station)
filter(time_sampling, station ==  140) # When the fishing operation was bad, they went again the same say!

filter(time_sampling, station ==  186) # HERE, I do not why they did two!
filter(time_sampling, station ==  244) # HERE, I do not why they did two!
filter(time_sampling, station ==  472) # Too low first time!
#To generalize...
# Are the methods constant for each station?
# Are the strategy constant for each station?
# Correlation strategy/methods/nb_pass vs nb_ind/station
```

