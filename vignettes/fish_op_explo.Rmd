---
title: "Exploration of fish operation data"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(4, 4)
)
library(tidyverse)
library(magrittr)
library(cowplot)
library(sf)
library(rgdal)
library(raster)
library(lubridate)
devtools::load_all()
theme_set(theme_alain())
```

```{r data_prep}
data(operation_data)
op <- dplyr::select(operation_data, opcod:year, count)
rm(operation_data)
```

There was `r nb_op <- length(unique(op$opcod)); nb_op` fishing operations from
`r min(op$year)` to `r max(op$year)`. The sampling was distributed over `r nb_st <- length(unique(op$station)); nb_st` stations. It represents a average effort of `r round(nb_op/nb_st, 1)` (# visit/station).

# Sampling

## Distribution of sampling effort

```{r sampling effort, fig.width = 7}
op_sampling <- op %>%
  group_by(opcod, station, year, month) %>%
  summarise(
    nb_ind = sum(count),
    nb_sp  = n()
    )

op_hist <- op_sampling %>%
  group_by(station) %>%
  summarise(freq = n()) %>%
  arrange(desc(freq)) %>%
  mutate(station = fct_inorder(as.factor(station)))

cdf_op <- ggplot(op_hist, aes(x=freq)) + stat_ecdf() +
  labs(x = "Number of sampling by station",
    y = "Frequency",
    title = "Cumulative distribution function") +
  scale_x_continuous(breaks = seq(0, 30, by = 5)) 
hist_op <- ggplot(op_hist, aes(x = freq)) +
  geom_bar() +
  labs(x = "Number of sampling by station",
    y = "Frequency",
    title = "Frequency distribution") +
  scale_x_continuous(breaks = seq(0, 30, by = 5))

plot_grid(cdf_op, hist_op, ncol = 2) 
``` 

Overall, the sampling effort by station is low and unevenly distributed. More
than 50% of the station had been visited one time and only 10% had been visited
more than 10 times. But we have no information about the spatial distribution of
the station. Some of them are surely really close from each other.

## Sampling effort by year 

```{r, fig.dim = c(4, 4)}
op_year <- op_sampling %>% group_by(year) %>%
  summarise(freq = n()) %>%
  arrange(desc(freq)) 

year_op <- ggplot(op_year, aes(y = freq, x = year)) +
  geom_line() +
  geom_point() +
  labs(y = "Number of sampling events",
    x = "Year",
    title = "")
plot_grid(year_op)
```

We see that the sampling effort increase around 1992 from nearly 250 to 1000
sampled stations by year.

## Sampling area

### Where are the station best followed?

```{r, fig.dim = c(4, 4)}
# good station names
good_station <- op_hist %>% 
  dplyr::filter(freq >= 10) %>%
  dplyr::select(station) %>%
  unlist(., use.names = FALSE)

# get their localisation
station <- read_delim("../data-raw/fishing_station_localisation_wsg84.csv",
  delim = ";", locale = locale("fr", decimal_mark = "."),
  col_types = cols(ST_CODECSP = col_character()))
xy_station <- dplyr::select(station, XCOORD, YCOORD)
station <- SpatialPointsDataFrame(coords = xy_station, data = station,
                               proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
station <- st_as_sf(station)
loc_good_station <- dplyr::filter(station, ST_ID %in% good_station)

# France map
region_fr <- raster::shapefile("../data-raw/france_region_shp/regions-20180101.shp")
##Get only metropolitan areas:
region_fr <- st_as_sf(region_fr) #easier to manipulate
region_to_filter <- c("La Réunion", "Martinique", "Guadeloupe", "Mayotte",
  "Guyane", "Corse")
region_fr <- filter(region_fr, !(nom %in% region_to_filter))
region_fr <- region_fr[, c("nom", "geometry")]

plot(st_geometry(region_fr), lwd = 1.5, col = "grey85")
plot(loc_good_station, pch = 20, col = "red", add = T)
```

They are `r length(good_station)` that has 10 or more sampling points. The good
stations are well distributed over France, this is surprising and super nice.
There is may be a deficit in the south east and east.

#### Number of individuals and species by sampling operation 

```{r, fig.width = 7}
good_station_sampling <- op_sampling %>%
  dplyr::filter(station %in% good_station)
filter(good_station_sampling, nb_sp ==0)

hist_good_station <- good_station_sampling %>%
  ungroup() %>%
  mutate(station = fct_inorder(as.factor(station)))

hist_ind <- ggplot(hist_good_station, aes(x = nb_ind)) +
  geom_histogram(bins = 35) +
  labs(x = "Number of individuals by fish operation",
    y = "Frequency",
    title = "Frequency distribution") +
  scale_x_log10()
hist_sp <- ggplot(hist_good_station, aes(x = nb_sp)) +
  geom_histogram(bins = 32) +
  labs(x = "Number of species by fish operation",
    y = "Frequency",
    title = "Frequency distribution")
plot_grid(hist_ind, hist_sp, ncol = 2)
```

#### Regularity of monitoring

```{r, fig.width = 7}
time_sampling <- good_station_sampling %>%
  ungroup() %>%
  unite(year_month, year, month, sep = "-") %>%
  mutate(times = ymd(paste0(year_month, "-01"))) %>%
  dplyr::select(-year_month)

time_sampling %<>%
  group_by(station) %>%
  arrange(times) %>%
  mutate(
    point = seq(1, length(station)),
    sample_sep = c(NA, times[-1] - times[-length(station)])
  )
hist_time_int <- time_sampling %>%
  summarise(mean_sep = mean(sample_sep, na.rm =TRUE))

global_sep <- ggplot(time_sampling, aes(x = sample_sep)) +
  geom_histogram() +
  geom_vline(aes(xintercept=mean(sample_sep, na.rm = TRUE)),
            color="blue", linetype="dashed", size=1) +
  labs(title = "Frequency distribution",
  x = "Number of days between two sampling points") +
scale_x_continuous(breaks = c(0, 300, 600, 1000, 2000))

average_sep <- ggplot(hist_time_int, aes(x = mean_sep)) +
  geom_histogram() +
  geom_vline(aes(xintercept = mean(mean_sep)),
            color="blue", linetype="dashed", size=1) +
  labs(title = "Frequency distribution",
  x = "Average number of days between two sampling points by station") +
scale_x_continuous(breaks = c(0, 300, 600, 1000, 2000))

plot_grid(global_sep, average_sep, ncol = 2)

# Are the methods constant for each station?
# Are the strategy constant for each station?
# Correlation strategy/methods/nb_pass vs nb_ind/station
```

The fishing operations (FO) resulted in the collect of several
hundreds of fish (`r mean(hist_good_station$nb_ind)` fishes in average) which is
quite impressive. The delay between two fishing operations by station was of
 `r mean(hist_time_int$mean_sep) %>% round` days, iow 1 year which is great! However, the 
FO that have been spaced by less than one month (30 days), have been taken place
the same day! It concerns `r n_l_samp <- nrow(low_fo_int); n_l_samp` stations,
`r round(n_l_samp / length(good_station) * 100)`% of the good stations. 

```{r}
low_fo_int <- filter(time_sampling, sample_sep < 30 & nb_ind > 100) %>%
  ungroup() %>%
  arrange(station)
# Those FO took place the same day:
summarise(low_fo_int, mean = mean(sample_sep))

# Sometimes the first FO was not successful:
filter(time_sampling, station ==  140, point %in% c(9, 10)) 
filter(time_sampling, station ==  472, point %in% c(6, 7))

# But sometimes, no: 
filter(time_sampling, station ==  186, point %in% c(4, 5)) 
filter(time_sampling, station ==  244, point %in% c(15, 16))
# Is it because of differences of sampling methods?
#To generalize...
```

#### Sampling method regularity

```{r}
# Get operation data
data(operation_data)
operation_data %<>% distinct(opcod, .keep_all = TRUE) %>%
  dplyr::select(-species, -station, -count, -year, -month)
st_method <- left_join(good_station_sampling, operation_data,
  by = c("opcod"))
```

We want to see if the good stations had the same sampling methods across time. 

```{r, fig.width = 7}
## Global distribution of the methods and fishing strategies:
p_met <- ggplot(st_method, aes(method, fill = strategy)) + 
  geom_bar() +
  labs(x = "Sampling Methods",
    y = "Frequency",
    title = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_met

## Distribution of sampling methods/strategies by station
distri_samp <- st_method %>%
  group_by(station) %>%
  summarise(
    method = length(unique(method)),
    strategy = length(unique(strategy))
  )
p_samp <- ggplot(gather(distri_samp, samp, uniq, method, strategy), aes(x = uniq)) +
  geom_bar() +
  labs(x = "# of different methods/strategies by station",
  y = "Frequency") +
  facet_grid(cols = vars(samp))
p_samp
```

Most of the FO has been realized with the "on foot" strategy. It is probable
that boat has been used in case which the river was too deep.
It is more complicated for the methods. We see hopefully that the methods the
most frequently used was "complete". However, when looking at the number of
different methods used for each station, we see that in general, 1 to 3 methods
are used inside a station.

When there are 2 sampling events at the same station, do they belong to methods
different from complete ? If so, can we merge them ? If not, are they separated
by less than one year ? If not, we should delete them I guess.

- TODO:
  - Correlation between method and nb ind & sp
  - Correlation nb_pass & surf vs nb ind & sp
