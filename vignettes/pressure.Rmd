---
title: "Stability and pressure"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stability and pressure}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(10, 10),
  echo = FALSE
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(kableExtra)
library(magrittr)
library(igraph)
library(NetIndices)
library(tidygraph)
library(sf)
library(ggraph)
library(lubridate)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
#devtools::load_all()
theme_set(theme_alain())
```

```{r load dataset, include = FALSE}
myload(yearly_press_interp_mv_avg, dir = mypath("data-raw", "polluants"))
myload(synchrony, press_polluants, temporal_evt_press, temporal_community_metrics, dir = mypath("data"))
```

```{r add flow and temperature}
myload(press_temperature, dir = mypath("data-raw", "naiades_temperatures"))
myload(press_flow, dir = mypath("data-raw", "flow"))
press_temperature %<>%
  mutate(category = "temperature") %>%
  rename(press = temperature, cv_press = cv_temperature)
press_flow %<>%
  mutate(category = "flow") %>%
  rename(press = flow, cv_press = cv_flow)

press_polluants  <-  bind_rows(press_polluants, press_temperature, press_flow)
```


# Raw data

```{r}
# Put units to present all the parameters
myload(polluant_units, dir = mypath("data-raw", "polluants", "naiades_data"))
kable(polluant_units)
```



## Between press correlation

```{r, eval = FALSE}
var_values <-  press_polluants %>%
  select(-cv_press) %>%
  spread(category, press) 

m <- cor(na.omit(select(var_values, -id)))

as.data.frame(round(m, 2)) %>%
  mutate_all(list(~cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)
```

I can delete some redondant variables 

```{r}
#unique(press_polluants$category)
#unique(press_polluants$station)
press_polluants %<>%
  filter(!category %in% c(
      "matieres azotees", "other", "matieres phosphorees", "matieres
      organiques"))
```


# Press and stability

```{r}
biomass_com <- temporal_community_metrics %>%
  select(station, biomass_stab, richness_med, betadiv)
biomass_com %<>%
  left_join(rename(press_polluants, station = id), by = "station")
biomass_com %<>% na.omit()
```

```{r}
p1 <- ggplot(biomass_com, aes(x = press, y = log(biomass_stab))) +
  geom_point() +
  facet_wrap(~ category, scales = "free_x") +
  labs(x = "Scaled press", y = "Biomass stability")
p1
```


## Model

### Biomass stability

```{r}
mod_press_data <- biomass_com %>%
  select(-betadiv, - cv_press) %>%
  #filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, press)

model <- lm(biomass_stab ~ .*richness_med,
  select(mod_press_data, -station)) 
summary(model)
par(mfrow = c(2,2))
plot(model)
```

#### Spatial model

```{r}
library(SSN)
myload(ssn, dir = mypath("data-raw", "fish_station_ssn"))
ssn@obspoints@SSNPoints[[1]]@point.data <- left_join(
  ssn@obspoints@SSNPoints[[1]]@point.data,
  mod_press_data
)

ssn <- SSN::importSSN(mypath("data-raw", "fish_station_ssn", "fish_station.ssn"), o.write = TRUE)
# Compute the weight of each streams lines when they merged:
ssn <- SSN::additive.function(ssn, "H2OArea",
  "afv_area")
# create distance matrix between pred and obs:
SSN::createDistMat(ssn, o.write = TRUE)
mysave(ssn, dir = mypath("data-raw", "fish_station_ssn"), overwrite = TRUE)

formula <-  as.formula(
  paste0("biomass_stab"," ~ ", 
    paste0(colnames(select(mod_press_data, -station)), sep = " + ")
    (str_c(colnames(select(mod_press_data, -station)), " + ")
    cat(colnames(select(mod_press_data, -station)), sep = " + ")
  )
)
spmod <- glmssn(
  biomass_stab ~ richness_med * (DBO + disolved_oxygen + flow + industry +
    mes + nitrates + ph + phosphore + polluants +
    temperature), ssn, family = "Gaussian", CorModels =
       c("LinearSill.tailup", "Mariah.taildown", "Exponential.Euclid"),
       use.nugget = TRUE, use.anisotropy = FALSE, addfunccol = "afv_area", trialscol = NULL)
summary(spmod)

model <- lm(biomass_stab ~ .*richness_med,
  select(mod_press_data, -station, -`matieres organiques`)) 
summary(model)
plot(model)
```


### Persistance of biomass composition

```{r}
mod_press_data <- biomass_com %>%
  select(-biomass_stab, -cv_press) %>%
  #filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, press)

model <- lm(betadiv ~ .*richness_med,
  select(mod_press_data, -station)) 
summary(model)
par(mfrow = c(2,2))
plot(model)
```

### Median diversity

```{r}
mod_press_data <- biomass_com %>%
  select(-biomass_stab, -betadiv, -cv_press) %>%
  filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, press)

model <- lm(richness_med ~ .,
  select(mod_press_data, -station)) 
summary(model)
par(mfrow = c(2,2))
plot(model)
```

## With CV of press

### Stability

```{r}
mod_press_data <- biomass_com %>%
  select(-betadiv, -press) %>%
  filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, cv_press)

model <- lm(biomass_stab ~ .*richness_med,
  select(mod_press_data, -station)) 
summary(model)
par(mfrow = c(2,2))
plot(model)
```

###Â Persistance of community composition

```{r}
mod_press_data <- biomass_com %>%
  select(-biomass_stab, -press) %>%
  filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, cv_press)

model <- lm(betadiv ~ .*richness_med,
  select(mod_press_data, -station)) 
summary(model)
par(mfrow = c(2,2))
plot(model)
```


### Model by hydrographic region

```{r}
myload(my_hydro_basin, dir = mypath("data-raw", "ssn_interpolation"))
myload(station_analysis, dir = mypath("data"))
station <- station_analysis %>%
  select(id)

mask <- sf::st_intersects(station, my_hydro_basin)

station$basin <- purrr::map_chr(mask, function (x){
  if (length(x) == 0) {
    return(as.integer(NA))
  } else {
    return(my_hydro_basin[["basin_name"]][[x]])
  }
  })
```

#### Stability of biomass

```{r, eval = FALSE}
mod_by_basin <- biomass_com %>%
  select(-betadiv, -cv_press) %>%
  #filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, press) %>%
  left_join(rename(station, station = id), by = "station") %>%
  select(-geometry, -station) %>%
  filter(!is.na(basin))

mod_by_basin %<>%
  group_by(basin) %>%
  nest()

model_basin <- function(df) {
  lm(biomass_stab ~ richness_med*., data = df)
}

mod_by_basin %<>%
  mutate(
    model = map(data, model_basin),
    coeff = map(model, broom::tidy)
  )

mod_by_basin %>%
  unnest(coeff) %>%
  filter(basin == "ouest")

```

#### Persistance of the community

```{r, eval = FALSE}
mod_by_basin <- biomass_com %>%
  select(-biomass_stab, -cv_press) %>%
  #filter(!category %in% c("nitrates", "phosphore", "mes", "disolved_oxygen")) %>%
  spread(category, press) %>%
  left_join(rename(station, station = id), by = "station") %>%
  select(-geometry, -station) %>%
  filter(!is.na(basin))

mod_by_basin %<>%
  group_by(basin) %>%
  nest()

model_basin <- function(df) {
  lm(betadiv ~ richness_med*., data = df)
}

mod_by_basin %<>%
  mutate(
    model = map(data, model_basin),
    coeff = map(model, broom::tidy)
  )

mod_by_basin %>%
  unnest(coeff)

```
