---
title: "Stability and pressure"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stability and pressure}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(10, 10),
  echo = FALSE
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(kableExtra)
library(magrittr)
library(igraph)
library(NetIndices)
library(tidygraph)
library(ggraph)
library(lubridate)
source(mypath("R", "misc.R"))
source(mypath("R", "plot_methods.R"))
#devtools::load_all()
theme_set(theme_alain())
```

```{r load dataset, include = FALSE}
myload(temporal_press_prob_analysis, temporal_press_cat_analysis,
  temporal_community_metrics,
  dir = mypath("data"))
myload(op_ODP, dir = mypath("data-raw", "fish_pressures"))
myload(press, dir = mypath("data-raw", "ssn_interpolation"))

```

# Raw data

```{r}
myload(quality_data, dir = mypath("data-raw"))
```
```{r}
# Number of variables: 
length(unique(quality_data$var_code))
# Keep interesting ones:
var_to_keep <- c(
"CONDUCTY", "DOC", "pH", "temp",
"TURB_NEPHEL", "NH4", "NO2",
"NO3", "PO4", "SO4", "D_OXY", "OXY_SAT",
"PHY_CHLA", "PHY_CHLB", "PHY_CHLC","SiO3", "TKN", "TP"
)
quality_data %<>%
  filter(var_code %in% var_to_keep) %>%
  mutate(year_month = paste0(year(meas_date), "-", month(meas_date)))
  
```

```{r}
var_table <- read_csv2(mypath("data-raw", "flow_quality", "var_donuts.csv")) %>%
  filter(fra_code %in% c("water_raw", "water_filtrated", "water_unknown")) %>%
  distinct(var_code, var_name, units)
kable(var_table)
```


## Correlation between variables

```{r}
var_values <- select(quality_data, id, meas_date, fraction, var_code, value) %>%
  tibble::rowid_to_column("ID") %>%
  spread(var_code, value) %>%
  mutate(
    year_month = myd(paste0(month(meas_date),"-", year(meas_date)), truncated = 1),
    year = year(meas_date)) %>%
  group_by(id, year) %>%
  summarise_if(is.double, ~ mean(., na.rm = TRUE))

var_enough_sampled <- ungroup(var_values) %>%
  summarise_if(is.double, ~sum(is.na(.))/n()) %>%
  unlist()
var_enough_sampled <- var_enough_sampled[var_enough_sampled < .5]

m <- cor(na.omit(select(var_values[, names(var_enough_sampled)], - meas_date,
      -year, -year_month)))

as.data.frame(round(m, 2)) %>%
  mutate_all(list(~cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)
```

##Â Temporal dynamics

```{r}
station_best_sampled <- var_values %>%
  group_by(id) %>%
  summarise_if(is.double, ~sum(is.na(.))/n()) %>%
  arrange(NO3, NH4, PO4) %>%
  sample_n(5, weigth = 1/(SO4 +1))
```

```{r, fig.dim = c(14, 14)}
best_sta_data <- quality_data %>%
  filter(id %in% station_best_sampled$id[1:5])

ggplot(best_sta_data, aes(x = meas_date, y = value)) +
  geom_line(aes(color = id)) +
  facet_wrap(~var_code, scale = "free_y")
```


## Sampling assessment

```{r}
test <- list(
  year_month = unique(quality_data$year_month),
  id = unique(quality_data$id),
  var_code = unique(quality_data$var_code)
)
comb_year_id <- expand.grid(test) %>%
  as_tibble
quality_data_complete <- comb_year_id %>%
  dplyr::left_join(dplyr::select(quality_data, id, var_code, value, year_month))

sampling <- quality_data_complete %>%
  group_by(var_code, id) %>%
  summarise(nb_obs = sum(!is.na(value)) / n()) %>%
  group_by(var_code) %>%
  summarise(nb_obs = mean(nb_obs, na.rm = TRUE)) %>%
  arrange(desc(nb_obs))

kable(sampling)
```

# Interpolation

## Map press

```{r}
myload(station_analysis, region_polygon, dir = mypath("data"))
station <- select(station_analysis, id)
station_press <- left_join(station, press)

g <- purrr::map(unique(station_press$var_code),
           function(x) {
	     ggplot(data = region_polygon) +
	       geom_sf() +
	       geom_sf(data = filter(station_press, var_code == x),
		 aes(color = press), size = 4) +
	       scale_color_gradient(low = "green", high = "red") +
	       ggtitle(x)
	   }
)

g2 <- cowplot::plot_grid(plotlist = g)
g2
```


## Press and stability

```{r}
press
biomass_com <- temporal_community_metrics %>%
  select(station, biomass_stab, richness_med, betadiv)
press %<>% mutate(station = id) %>%
  left_join(biomass_com, by = "station")
```

```{r}
press_scale <- press %>%
  group_by(var_code) %>%
  mutate(press_scale = scale(press))
p1 <- ggplot(press_scale, aes(x = press_scale, y = biomass_stab)) +
  geom_point() +
  facet_wrap(~ var_code) +
  labs(x = "Scaled press", y = "Biomass stability")
p1
```

```{r}
p2 <- ggplot(press_scale, aes(x = press, y = biomass_stab)) +
  geom_point() +
  facet_wrap(~ var_code, scales = "free_x") +
  labs(x = "Scaled press", y = "Biomass stability")
p2
```

### Model

```{r}
mod_press_data <- press_scale %>%
  select(station, var_code, press, biomass_stab, betadiv) %>%
  spread(var_code, press)

model <- lm(biomass_stab ~ CONDUCTY + D_OXY + PHY_CHLA + temp + TKN + TP,
  mod_press_data) 
summary(model)
```


## Correlation between variables

```{r}
M <- cor(
  select(press, var_code, press) %>%
    spread(var_code, press) %>%
    ungroup() %>%
    select(-id)
)
corrplot::corrplot(M, method = "circle")
```


# Olivier

```{r signification variable}
kable(op_AUC)
```

## Probability

```{r}
biomass_com <- temporal_community_metrics %>%
  select(station, biomass_stab, richness_med, betadiv)
press <- temporal_press_prob_analysis %>%
  select(station, pressure, prob) %>%
  left_join(select(biomass_com, station, biomass_stab)) %>%
  filter(!is.na(biomass_stab))
```

```{r}
p1 <- ggplot(press, aes(x = prob, y = biomass_stab)) +
  geom_point() +
  facet_wrap(~ pressure) +
  labs(x = "Average probability to impact", y = "Biomass stability")
p1
```

## Crap statistical model

```{r}
press_4_mod <- press %>%
  spread(pressure, prob) %>%
  select(-station)
mod <- lm(log(biomass_stab) ~ ., press_4_mod)
p2 <- jtools::plot_summs(mod)
p2
```

```{r}
par(mfrow = c(2, 2))
plot(mod)
dev.off()
```

## PCA

```{r}
library(ade4)
press_4_pca  <- select(press_4_mod, -biomass_stab) %>%
  na.omit
pca <- ade4::dudi.pca(as.data.frame(press_4_pca), scannf = FALSE, nf = 3, center = TRUE, scale = TRUE)

screeplot(pca)
summary(pca)
scatter(pca, posieig = "none")
par(mfrow = c(2,2))
s.corcircle(pca$co, xax = 1, yax = 2)
title("Axis x = Comp1", "Axis y = Comp2")
s.corcircle(pca$co, xax = 3, yax = 2)
title("Axis x = Comp3", "Axis y = Comp2")
s.corcircle(pca$co, xax = 1, yax = 3)
title("Axis x = Comp1", "Axis y = Comp3")
dev.off()
```

```{r}
stab <- temporal_community_metrics %>%
  select(station, biomass_stab)

press_spread <- press %>%
  spread(pressure, prob) %>%
  filter(!is.na(chem.3_pcb))
press_spread %<>%
  mutate(axis1 = pca$li[[1]], axis2 = pca$li[[2]])

### variable 
var_pca <- tibble(
  variable = rownames(pca$co),
  comp1 = 5 * pca$co[[1]],
  comp2 = 5 * pca$co[[2]]
)

p1 <- ggplot(data = press_spread, aes(x = axis1, y = axis2, color = biomass_stab, size = biomass_stab)) +
  geom_point() +
  geom_text(data = var_pca, aes(x = comp1, y = comp2, label = variable), inherit.aes = FALSE, size = 6) +
  labs(x = "Hydromorpho", y = "Pollution")
p1
```

```{r}
model_pca <- lm(biomass_stab ~ axis1 + axis2, press_spread)
summary(model_pca)
par(mfrow = c(2,2))
plot(model_pca)
dev.off()
#TODO: add network network metric
```

# Pressure lvl as category  

```{r}
press_cat <- temporal_press_cat_analysis %>%
  mutate_if(is.factor, as.character) %>%
  gather(pressure, category, - station) %>%
  left_join(select(biomass_com, station, biomass_stab)) %>%
  filter(!is.na(biomass_stab)) %>%
  mutate(category = fct_relevel(category, "Bad", "Poor", "Moderate", "Good", "High"))
```

```{r, fig.dim = c(14, 10)}
p1 <- ggplot(press_cat, aes(x = category, y = biomass_stab)) +
  geom_boxplot() +
  facet_wrap(~pressure) +
  labs(x = "Severity of the pressure", y = "Stability of the biomass")
p1
```

```{r}
mod_data <- spread(press_cat, pressure, category)
var_to_rm <- sapply(mod_data, function (x) {sum(is.na(x)) < 100 })
var_to_rm <- names(var_to_rm)[which(var_to_rm == TRUE)]
mod_data %<>%
  select_at(vars(var_to_rm, "biomass_stab")) %>%
  select(-station)
summary(mod_data)

mod <- lm(biomass_stab ~ ., mod_data)
summary(mod)
```
```{r}
summary(aov(mod))
```

## PCA

```{r}
press_4_pca  <- select(mod_data, -biomass_stab) %>%
  na.omit %>%
  mutate_all(as.numeric)
pca <- ade4::dudi.pca(as.data.frame(press_4_pca), scannf = FALSE, nf = 3, center = TRUE, scale = TRUE)

summary(pca)
scatter(pca, posieig = "none")
par(mfrow = c(2,2))
s.corcircle(pca$co, xax = 1, yax = 2)
title("Axis x = Comp1", "Axis y = Comp2")
s.corcircle(pca$co, xax = 3, yax = 2)
title("Axis x = Comp3", "Axis y = Comp2")
s.corcircle(pca$co, xax = 1, yax = 3)
title("Axis x = Comp1", "Axis y = Comp3")
dev.off()
```
