---
title: "Preliminary results"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preliminary results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7)
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(magrittr)
library(igraph)
library(NetIndices)
library(tidygraph)
library(ggraph)
library(lubridate)
devtools::load_all()
theme_set(theme_alain())
```

# Network exploration 

## Metaweb

```{r}
data(metaweb_analysis)
meta <- metaweb_analysis; rm(metaweb_analysis)

g <- igraph::graph_from_adjacency_matrix(meta$metaweb, mode = "directed")

# Define layout
lay <- layout.fruchterman.reingold(g)
# Compute trophic level
lay[, 2] <- TrophInd(meta$metaweb, Dead = meta$resource)$TL - 1
# Plot
par(mar=rep(5, 4))
plot.igraph(g,layout=lay,vertex.label=NA,vertex.size=2,edge.arrow.size=.5,edge.width=.5)

```

## Local network

```{r}
data(network_analysis)
net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest() %>%
  left_join(., dplyr::select(op_analysis, opcod, station, year)) %>%
 dplyr::select(from, to, everything())

# Get a station
net_ex <- filter(net, station == unique(net$station) %>% sample(., 1))
## Graph -------------------------
net_graph <- graph_from_data_frame(net_ex, directed = TRUE)
 
## Layout --------------------------------
lay <- create_layout(graph_from_adjacency_matrix(meta$metaweb, mode = "directed"), layout = "kk")
node_pos <- TrophInd(meta$metaweb,
  Dead = meta$resource)$TL - 1
lay$y <- node_pos


net_graph <- select(net_ex, from, to, year) %>%
  arrange(year) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    net_graph = pmap(list(net = data, title = year), 
    set_layout_graph, glay = lay)
  )
plot_grid(plotlist = net_graph$net_graph)
```

# Biomass and network 

```{r, fig.dim = c(7,7) }
# Get network metrics
data(biomass_analysis)
cv <- left_join(network_metrics, biomass_analysis, by = "opcod") %>%
  gather(metrics, values, connectance, richness, biomass) %>%
  group_by(station, metrics) %>%
  summarise(
    cv = sd(values) / mean(values),
    avg = mean(values)
  )

# plot
faceted_cv <- dplyr::select(cv, - avg) %>%
  spread(metrics, cv) %>%
  gather(network_metrics, values, connectance, richness)
# Facet label:
label <- as_labeller(c(
    connectance = "Connectance",
    richness = "Number of nodes"
    ))
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(faceted_cv, aes(y = biomass, x = values)) +
  geom_point() +
  facet_grid(cols = vars(network_metrics), labeller = label) +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "CV of the network indices",
    y = "CV of the community biomass"
  )
faceted_cv_avg <- gather(cv, mesurements, values, cv, avg) %>%
  filter(
    metrics == "biomass" & mesurements == "cv" |
    metrics %in% c("connectance", "richness") & mesurements == "avg"
  )
faceted_cv_avg <- left_join(
  filter(faceted_cv_avg, metrics == "biomass") %>%
    spread(mesurements, values) %>% spread(metrics, cv),
  filter(faceted_cv_avg, metrics != "biomass") %>%
    spread(mesurements, values) %>% spread(metrics, avg),
  by = "station"
) %>%
  gather(network_metrics, values, connectance, richness)
formula <- y ~ x #needed for stat_poly_eq
p2 <- ggplot(faceted_cv_avg,
  aes(y = biomass, x = values)) +
  geom_point() +
  facet_grid(cols = vars(network_metrics), labeller = label, scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Average of the network indices",
    y = "CV of the community biomass"
  )

plot_grid(p, p2, ncol = 1, labels = "AUTO")

```

