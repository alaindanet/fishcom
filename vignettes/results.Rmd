---
title: "Preliminary results"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preliminary results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7),
  echo = FALSE
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(kableExtra)
library(magrittr)
library(igraph)
library(NetIndices)
library(tidygraph)
library(ggraph)
library(lubridate)
devtools::load_all()
theme_set(theme_alain())
```

# Network exploration 

## Metaweb

```{r}
myload(metaweb_analysis, dir = data_common)
meta <- metaweb_analysis; rm(metaweb_analysis)

g <- igraph::graph_from_adjacency_matrix(meta$metaweb, mode = "directed")

# Define layout
lay <- layout.fruchterman.reingold(g)
# Compute trophic level
dead_material <- c("det", "biof")
lay[, 2] <- TrophInd(meta$metaweb, Dead = dead_material)$TL
# Plot
par(mar=rep(5, 4))
plot.igraph(g,layout=lay,vertex.label=NA,vertex.size=2,edge.arrow.size=.5,edge.width=.5)

```

## Local network

```{r}
myload(network_analysis, dir = dest_dir)
net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest() %>%
  left_join(., dplyr::select(op_analysis, opcod, station, year)) %>%
 dplyr::select(from, to, everything())

# Get a station
net_ex <- filter(net, station == unique(net$station) %>% sample(., 1))
## Graph -------------------------
net_graph <- graph_from_data_frame(net_ex, directed = TRUE)
 
## Layout --------------------------------
lay <- create_layout(graph_from_adjacency_matrix(meta$metaweb, mode = "directed"), layout = "kk")
node_pos <- TrophInd(meta$metaweb,
  Dead = dead_material)$TL - 1
lay$y <- node_pos
lay$species <- get_species(lay$name)

net_graph <- select(net_ex, from, to, year) %>%
  arrange(year) %>%
  group_by(year) %>%
  nest() %>%
  mutate(
    net_graph = pmap(list(net = data, title = year), 
    set_layout_graph, glay = NULL, color_scale = set_color_species(lay))
  )
## Get legend
species_colour_legend <- get_legend(net_graph[1,]$net_graph[[1]])
## Remove legend in the other plots
net_graph %<>%
  mutate(net_graph = map(net_graph, function(x) x + theme(legend.position = "none")))
plot_grid(plotlist = net_graph[1:4,]$net_graph,
species_colour_legend)
```

# Correlation between network indices

```{r}
# Get network metrics
myload(temporal_network_metrics, dir = dest_dir)
myload(temporal_community_metrics, dir = data_common)

cor_avg <- temporal_network_metrics %>%
  select_at(vars(matches("med"))) %>%
  cor()
#knitr::kable(cor_avg)
as.data.frame(round(cor_avg,2)) %>%
  mutate_all(funs(cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)

```

```{r}
cor_cv <- temporal_network_metrics %>%
  select_at(vars(matches("cv"))) %>%
  cor()
as.data.frame(round(cor_cv,2)) %>%
  mutate_all(funs(cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)
```

```{r}
cor_med <- temporal_network_metrics %>%
  select_at(vars(matches("med"))) %>%
  cor()
as.data.frame(round(cor_med,2)) %>%
  mutate_all(funs(cell_spec(., "html", color = ifelse(abs(.) > .65 & . != 1, "red",
	  "black")))) %>%
  mutate(variable = colnames(.)) %>%
  select(variable, everything()) %>%
  kable(format = "html", escape = F)
```



# Classic biomass and community

```{r}
biomass_com <- temporal_community_metrics %>%
  select(biomass_stab, richness_cv, richness_med, betadiv) %>%
  gather(type, diversity, richness_med, richness_cv, betadiv)
formula <- y ~ x #needed for stat_poly_eq
qplot(diversity, biomass_stab, data =  biomass_com, geom = "point") +
  facet_grid(cols = vars(type), labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(x = "diversity", y = "biomass_stab")
```

# Biomass and network structure

```{r, fig.dim = c(14, 7)}
# plot
avg_network <- temporal_network_metrics %>%
  select_at(vars(matches("med|station")))
biomass_stab_station <- temporal_community_metrics %>%
  select(station, biomass_stab)
stab_biomass_net_avg <- left_join(avg_network, biomass_stab_station) %>%
  gather(metrics, values, colnames(select_at(., vars((matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")

# TODO: think about not facetting (list of plots ?)
# Facet label:
formula <- y ~ x #needed for stat_poly_eq
p <- ggplot(stab_biomass_net_avg, aes(y = biomass_stab, x = values)) +
  geom_point() +
  facet_grid(cols = vars(metrics), labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median of the network indices",
    y = "Biomass stability"
  )
p

```

See this paper for an explanation of the negative effect of nestedness on
biomass stability [link](https://theoreticalecology.wordpress.com/2015/04/23/all-models-all-wrong-but-which-are-useful-for-understanding-the-effect-of-nestedness-on-plant-pollinator-dynamics/).

## Network structure and richness

```{r, fig.dim = c(6, 15)}
richness <- temporal_community_metrics %>%
  select(station, richness_med) %>%
  rename(richness = richness_med)
richness_net_avg <- left_join(avg_network, richness) %>%
  gather(metrics, values, colnames(select_at(., vars((matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")
p <- ggplot(richness_net_avg, aes(y = values, x = richness)) +
  geom_point() +
  facet_grid(rows = vars(metrics), labeller = mylabel(), scales = "free_y") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median species richness",
    y = "Median of the network indices"
  )
p
```


# Compartimentalization

```{r, fig.dim = c(20, 4)}
troph_group_labeller()
net_troph_group <- temporal_network_metrics %>% 
  unnest() %>%
  mutate(troph_group = as.factor(troph_group))
net_troph_group %<>%
  select_at(vars(matches("_med|stab|station|troph_group"))) %>%
  gather(metrics, values, colnames(select_at(., vars((matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", ""))
p <- ggplot(net_troph_group, aes(y = biomass_stab, x = values, color = troph_group)) +
  geom_point() +
  ggplot2::scale_fill_manual(
    labels = troph_group_labeller(),
    values = c("blue", "green", "red"),
    name = "Trophic level"
    ) +
  facet_grid(cols = vars(metrics), labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "network_med",
    y = "biomass_stab"
  )
p
```

## Stability of biomass compartment and richness 

### Total richness

```{r}
biomass_richness_troph <- left_join(
  select(net_troph_group, station, troph_group, biomass_stab),
  richness, by = "station")
p <- ggplot(biomass_richness_troph, aes(y = biomass_stab, x = richness, color = troph_group)) +
  geom_point() +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richess_med",
    y = "biomass_stab"
  )
p

```

Species richness of the community decreased the stability of the total
biomass of the community. At the trophic level, species richness decreased the
stability of the higher trophic level biomass. However the stability of lower
trophic level biomass increased with the increase of species richness of the
community.

### Richness by trophic level 

```{r}

net_troph_group <- temporal_network_metrics %>% 
  select(station, troph_group) %>%
  unnest() %>%
  filter(!is.na(troph_group)) %>%
  mutate(troph_group = as.factor(troph_group))
plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = biomass_stab, x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_stab"
  )
plot_stab_richness_troph_group
```

There was a negative relationship between the biomass stability and the richness
at high trophic level unlike biomass stability at medium trophic which increased
with the number of species in its trophic level.

We saw that biomass stability at highest decreased with richness. However, in
average, the biomass at the higher trophic level seemed more stable.



### Correlation between stability of trophic level and  richness

```{r}
correlation_troph_group <- net_troph_group %>%
  select(station, biomass_stab, troph_group, richness_avg) %>%
  gather(var, values, biomass_stab, richness_avg) %>%
  unite(by_troph, var, troph_group) %>%
  spread(by_troph, values) %>%
  select(-station)
library(GGally)
ggpairs(correlation_troph_group)
```

# Productivity

## With network structure


```{r, fig.dim = c(14, 7)}
biomass_prod_station <- temporal_community_metrics %>%
  select(station, biomass_avg)
prod_biomass_net_avg <- left_join(avg_network, biomass_prod_station) %>%
  gather(metrics, values, colnames(select_at(., vars((matches("med")))))) %>%
  mutate(metrics = str_replace(metrics, "_med", "")) %>%
  filter(metrics != "nbnode")

# TODO: think about not facetting (list of plots ?)
# Facet label:
formula <- y ~ x #needed for stat_poly_eq
plot_stab_biomass_net_avg <- ggplot(prod_biomass_net_avg, aes(y = biomass_avg, x = values)) +
  geom_point() +
  facet_grid(cols = vars(metrics), labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  labs(
    x = "Median of the network indices",
    y = "Average Biomass"
  )
plot_stab_biomass_net_avg
```

## By trophic level 

```{r, fig.cap="Biomass production and stability by trophic level", , fig.dim = c(10, 7)}
plot_prod_richness_troph_group <-
  ggplot(net_troph_group, aes(y = biomass_avg, x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_avg"
  )
plot_grid(
  plot_prod_richness_troph_group,
  plot_stab_richness_troph_group,
  nrow = 2
)
```
Overall, if the richness had an destabilizating effect on stability for the
highest trophic, we saw the same highest trophic level displayed the highest productivity and stability.


# Examine networks

Let's look at network that have particular network properties. 

## Modularity

```{r}
station_high_low_modularity <- temporal_network_metrics %>%
  arrange(desc(modularity_med)) %>%
  slice(c(1, n())) %>%
  select(station) %>%
  unlist
names(station_high_low_modularity) <- c("high", "low") 

```
```{r}
# High modularity
net_ex <- filter(net, station == station_high_low_modularity["high"])
plot_temporal_network(net_ex, lay = lay)
```
```{r}
# Low modularity
net_ex <- filter(net, station == station_high_low_modularity["low"])
plot_temporal_network(net_ex, lay = lay)
```

## Nestedness

```{r}
station_high_low_nestedness <- temporal_network_metrics %>%
  arrange(desc(nestedness_med)) %>%
  slice(c(1, n())) %>%
  select(station) %>%
  unlist
names(station_high_low_nestedness) <- c("high", "low") 
```
```{r}
# high nestedness
net_ex <- filter(net, station == station_high_low_nestedness["high"])
plot_temporal_network(net = net_ex, lay = NULL)
```

```{r}
# low nestedness
net_ex <- filter(net, station == station_high_low_nestedness["low"])
plot_temporal_network(net_ex, lay = NULL)
```

# Fine analysis

## Composition of the lowest trophic group  

```{r}
myload(network_analysis, dir = dest_dir)
low_troph_group <- network_analysis %>%
  unnest(composition) %>%
  filter(troph_group == 1)
```

```{r species low trophic group}
sp_low_troph_group <- low_troph_group %>%
  select(species) %>%
  unlist %>%
  unique()
```

```{r}
myload(species, dir = mypath("data"))
sp_low_troph_group <- species %>%
  filter(code %in% sp_low_troph_group)
kable(sp_low_troph_group)
```

```{r}
myload(nb_ind_sp, dir = mypath("data"))
filter(nb_ind_sp, species %in% sp_low_troph_group$code) %>%
  rename(`Number of individuals` = nind) %>%
  kable
```

```{r}
myload(diet_shift, dir = mypath("data"))
diet <- filter(diet_shift, species %in% sp_low_troph_group$code)
nrow(diet)
# All the species that are in low trop group do not have life traits.
```

## What does eat little Trutta

```{r}
# little TRF 
filter(diet_shift, species == "TRF") %>%
  select(-ref_diet, -ref_ods, -hypoth_ods, -remark) %>%
  kable()
```

```{r}
myload(metaweb_analysis, dir = mypath("data"))
metaweb_analysis$size_class %>%
  filter(species == "TRF", class_id %in% c(1, 2)) %>%
  kable()
```





