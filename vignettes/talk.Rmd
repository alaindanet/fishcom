---
title: "Produce talk figures"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Produce talk figures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(7, 7)
)
library(tidyverse)
library(ggpmisc)
library(cowplot)
library(magrittr)
library(igraph)
library(NetIndices)
library(tidygraph)
library(ggraph)
library(lubridate)
devtools::load_all()
theme_set(theme_alain())

mypath <- rprojroot::find_package_root_file
data_common <- mypath("data")
dest_dir <- mypath("data", "species")
```

```{r load data}
data(metaweb_analysis)
data(op_analysis)
myload(network_analysis, temporal_network_metrics, dir = dest_dir)
data(temporal_community_metrics)
```

## Ontogenic shift data

```{r}
data(diet_shift)
diet_tex <- xtable::xtable(
  dplyr::select(diet_shift[1:20,], -remark, -light, -species_name),
  caption = "Subset of ontogenic shift data.",
  auto = TRUE
)
print(
  diet_tex,
  file = "~/Documents/thesis/talks/fishcom_fig/diet_shift.tex",
  compress = FALSE,
  include.rownames = getOption("xtable.include.rownames", FALSE))
#?print.xtable
```


## Temporal network 

```{r}
meta <- metaweb_analysis; rm(metaweb_analysis)
dead_material <- c("det", "biof")
```

```{r}
net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest() %>%
  left_join(dplyr::select(op_analysis, opcod, station, date)) %>%
 dplyr::select(from, to, everything())

meta <- metaweb_analysis
# Get a station
#7800
#6966
net_ex <- filter(net, station == unique(net$station) %>% sample(., 1)) %>%
  mutate(date = year(date))

net_ex <- filter(net, station == 6966) %>%
  mutate(date = year(date)) %>%
  filter(! date %in% c(2015, 2016))

p2 <- my_crap_temporal_network(net = net_ex, metaweb = meta$metaweb, network_data
  = network_analysis)
save_plot("~/Documents/thesis/talks/fishcom_fig/temporal_colors.pdf",
  p2, base_height = 8, base_width = 12, bg = "transparent")
```

```{r station_loc}
station <- sf::read_sf("../data-raw/station_wgs84.shp")
espalion <- dplyr::filter(station) %>%
  dplyr::select(UH_NOM, ST_LOCA)
mapview::mapview(espalion)@map
```

```{r species}
species <- read_delim("../bonnafe_work/data/raw_data/Code_sp.txt", delim = "\t")
filter(diet_shift, species %in% c("VAI", "TRF", "CHA")) %>%
  select(species, species_name)
# CHA: Chabot commun
# TRF: Truite commune
# VAI: Vairon 
```


## Stability & diversity 

```{r}
myload(temporal_network_metrics, dir = mypath("data", "species") )
biomass_com <- temporal_community_metrics %>%
  select(station, biomass_stab) %>%
  left_join(select(temporal_network_metrics, station, mean_troph_level_med, nbnode_med))%>%
  gather(type, diversity, mean_troph_level_med, nbnode_med)
formula <- y ~ x #needed for stat_poly_eq
p2 <- qplot(diversity, biomass_stab, data =  biomass_com, geom = "point") +
  facet_grid(cols = vars(type), labeller = mylabel(), scales = "free_x") +
  geom_smooth(method = 'lm') +
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(y = "biomass_stab") +
  xlab("Median network descriptors")
p2
save_plot("~/Documents/thesis/talks/fishcom_fig/biomass_diversity2.pdf", p2, base_height = 3, bg = "transparent", ncol = 2)
```

## Stability & diversity by trophic group

```{r}
net_troph_group <- temporal_network_metrics %>% 
  select(station, troph_group) %>%
  unnest() %>%
  filter(!is.na(troph_group)) %>%
  mutate(troph_group = as.factor(troph_group))

troph_group_label <- c(
  `1` = "Low trophic level",
  `2` = "Medium trophic level",
  `3` = "High trophic level"
)

plot_stab_richness_troph_group <-
  ggplot(net_troph_group, aes(y = biomass_stab, x = richness_avg)) +
  geom_point() +
  facet_grid(cols = vars(troph_group), labeller = as_labeller(troph_group_label)) +
  geom_smooth(method = 'lm')+
  stat_poly_eq(
    formula = formula,
    eq.with.lhs = "italic(hat(y))~`=`~",
    aes(label = paste(..eq.label.., ..rr.label.., sep = "*plain(\",\")~")),
    parse = TRUE) +
  xylabs(
    x = "richness_avg",
    y = "biomass_stab"
  )
plot_stab_richness_troph_group

save_plot("~/Documents/thesis/talks/afb/fig/biomass_diversity_troph_group.pdf",
  plot_stab_richness_troph_group,
  base_height = 3,
  bg = "transparent",
  ncol = 3)
```

